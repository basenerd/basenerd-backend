{% extends "base.html" %}
{% block content %}

{# ============================
   DEBUG TOGGLES
   ============================ #}
{% set SHOW_DEBUG = true %}

{% if SHOW_DEBUG %}
  <div style="padding:8px 10px; border:1px solid rgba(255,255,255,.15); border-radius:12px; margin-bottom:10px;">
    <div class="mono" style="font-size:12px; opacity:.85;">
      TEAM.HTML MARKER • team_id={{ team["team_id"] }} • last_game={{ "yes" if last_game else "no" }} • next_game={{ "yes" if next_game else "no" }}
    </div>
  </div>

  <pre style="white-space:pre-wrap; font-size:12px; opacity:.85; border:1px solid rgba(255,255,255,.1); padding:10px; border-radius:12px; margin-bottom:12px;">
TEAM={{ team|tojson }}
LAST={{ last_game|tojson }}
NEXT={{ next_game|tojson }}
DIV={{ division_rows|tojson }}
LEADERS={{ leaders|tojson }}
  </pre>
{% endif %}

{# ---------------------------------
   Helper: player link (id optional)
   --------------------------------- #}
{% macro player_name(pid, name) -%}
  {%- if pid -%}
    <a class="playerlink" href="/player/{{ pid }}">{{ name }}</a>
  {%- else -%}
    {{ name }}
  {%- endif -%}
{%- endmacro %}

<div class="card">
  <div class="card-header">
    <div class="teamcell" style="gap:10px;">
      {% if team["logo_url"] %}
        <img class="teamlogo" src="{{ team["logo_url"] }}" alt="{{ team["name"] }} logo" style="height:28px;">
      {% endif %}
      <div>
        <div class="card-title">{{ team["name"] }}</div>
        <div class="card-subtitle">
          {% if team["division"] %}{{ team["division"] }}{% endif %}
          {% if team["venue"] %} • {{ team["venue"] }}{% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

{# -----------------------------
   Tabs (mimic game.html behavior)
   ----------------------------- #}
<div class="card" style="margin-top:18px;">
  <div class="card-header" style="padding-bottom:0;">
    <div class="tabs" style="display:flex; gap:10px; flex-wrap:wrap;">
      <button class="tab-btn" data-tab="overview" type="button">Overview</button>
      <button class="tab-btn" data-tab="roster" type="button">Roster</button>
      <button class="tab-btn" data-tab="schedule" type="button">Schedule</button>
      <button class="tab-btn" data-tab="transactions" type="button">Transactions</button>
    </div>
  </div>

  <div class="card-body" style="padding-top:14px;">

    <!-- ===================== -->
    <!-- OVERVIEW TAB -->
    <!-- ===================== -->
    <div class="tab-panel" id="tab-overview" data-tab="overview">
      <div class="grid" style="display:grid; grid-template-columns: 1.25fr 0.75fr; gap:14px; align-items:start;">
        <div style="display:flex; flex-direction:column; gap:14px;">

          <!-- Last Game -->
          <div class="subcard">
            <div class="subcard-title">Last Game</div>

            {% if last_game %}
              <a class="game-card" href="/game/{{ last_game['gamePk'] }}" style="margin-top:10px; display:block;">
                <div class="game-card-top">
                  <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                    {% if last_game.get("competitionLabel") %}
                      <div class="tag">{{ last_game["competitionLabel"] }}</div>
                    {% endif %}
                    <div class="pill">{{ last_game.get("statusPill","") }}</div>
                  </div>
                  <div class="muted mono game-time">{{ last_game.get("timeLocal","") }}</div>
                </div>

                <div class="matchup">
                  <!-- AWAY -->
                  {% set away = last_game.get("away") or {} %}
                  <div class="team-row">
                    <div class="team-left">
                      {% if away.get("logo") %}
                        <img class="team-logo" src="{{ away['logo'] }}" alt="{{ away.get('abbrev','') }} logo">
                      {% endif %}
                      <div class="team-line">
                        <div class="team-line-top">
                          <span class="team-abbrev">{{ away.get("abbrev","—") }}</span>
                          {% if away.get("record") %}
                            <span class="muted mono" style="font-size:12px;">{{ away["record"] }}</span>
                          {% endif %}
                          <span class="muted" style="opacity:.6;">•</span>

                          <span class="small muted">
                            PP:
                            {% if away.get("pp_id") and away.get("pp_name") %}
                              {{ player_name(away["pp_id"], away["pp_name"]) }}
                            {% else %}
                              {{ (away.get("pp") or "PP: TBD")|replace("PP: ", "") }}
                            {% endif %}
                          </span>
                        </div>
                      </div>
                    </div>
                    <div class="team-score mono">
                      {{ away["score"] if away.get("score") is not none else "—" }}
                    </div>
                  </div>

                  <!-- HOME -->
                  {% set home = last_game.get("home") or {} %}
                  <div class="team-row">
                    <div class="team-left">
                      {% if home.get("logo") %}
                        <img class="team-logo" src="{{ home['logo'] }}" alt="{{ home.get('abbrev','') }} logo">
                      {% endif %}
                      <div class="team-line">
                        <div class="team-line-top">
                          <span class="team-abbrev">{{ home.get("abbrev","—") }}</span>
                          {% if home.get("record") %}
                            <span class="muted mono" style="font-size:12px;">{{ home["record"] }}</span>
                          {% endif %}
                          <span class="muted" style="opacity:.6;">•</span>

                          <span class="small muted">
                            PP:
                            {% if home.get("pp_id") and home.get("pp_name") %}
                              {{ player_name(home["pp_id"], home["pp_name"]) }}
                            {% else %}
                              {{ (home.get("pp") or "PP: TBD")|replace("PP: ", "") }}
                            {% endif %}
                          </span>
                        </div>
                      </div>
                    </div>
                    <div class="team-score mono">
                      {{ home["score"] if home.get("score") is not none else "—" }}
                    </div>
                  </div>
                </div>

                <div class="game-meta">
                  {% if last_game.get("venue") %}
                    <div class="muted">
                      {{ last_game["venue"] }}
                      {% if last_game.get("venueLocation") %}
                        • {{ last_game["venueLocation"] }}
                      {% endif %}
                    </div>
                  {% endif %}

                  {% if last_game.get("statusPill") == "Final" %}
                    {% set pit = last_game.get("pitching") or {} %}
                    <div class="small muted">
                      {% if pit.get("winner") or pit.get("loser") %}
                        W:
                        {% if pit.get("winner_id") and pit.get("winner") %}
                          {{ player_name(pit["winner_id"], pit["winner"]) }}
                        {% else %}
                          {{ pit.get("winner","—") }}
                        {% endif %}
                        • L:
                        {% if pit.get("loser_id") and pit.get("loser") %}
                          {{ player_name(pit["loser_id"], pit["loser"]) }}
                        {% else %}
                          {{ pit.get("loser","—") }}
                        {% endif %}
                      {% endif %}
                    </div>
                  {% else %}
                    <div class="small muted">{{ last_game.get("detailedState","") }}</div>
                  {% endif %}
                </div>
              </a>
            {% else %}
              <div class="muted" style="margin-top:8px; font-size:13px;">No completed game found.</div>
            {% endif %}
          </div>

          <!-- Next Game -->
          <div class="subcard">
            <div class="subcard-title">Next Game</div>

            {% if next_game %}
              <a class="game-card" href="/game/{{ next_game['gamePk'] }}" style="margin-top:10px; display:block;">
                <div class="game-card-top">
                  <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                    {% if next_game.get("competitionLabel") %}
                      <div class="tag">{{ next_game["competitionLabel"] }}</div>
                    {% endif %}
                    <div class="pill">{{ next_game.get("statusPill","") }}</div>
                  </div>
                  <div class="muted mono game-time">{{ next_game.get("timeLocal","") }}</div>
                </div>

                <div class="matchup">
                  {% set away = next_game.get("away") or {} %}
                  <div class="team-row">
                    <div class="team-left">
                      {% if away.get("logo") %}
                        <img class="team-logo" src="{{ away['logo'] }}" alt="{{ away.get('abbrev','') }} logo">
                      {% endif %}
                      <div class="team-line">
                        <div class="team-line-top">
                          <span class="team-abbrev">{{ away.get("abbrev","—") }}</span>
                          {% if away.get("record") %}
                            <span class="muted mono" style="font-size:12px;">{{ away["record"] }}</span>
                          {% endif %}
                          <span class="muted" style="opacity:.6;">•</span>

                          <span class="small muted">
                            PP:
                            {% if away.get("pp_id") and away.get("pp_name") %}
                              {{ player_name(away["pp_id"], away["pp_name"]) }}
                            {% else %}
                              {{ (away.get("pp") or "PP: TBD")|replace("PP: ", "") }}
                            {% endif %}
                          </span>
                        </div>
                      </div>
                    </div>
                    <div class="team-score mono">
                      {{ away["score"] if away.get("score") is not none else "—" }}
                    </div>
                  </div>

                  {% set home = next_game.get("home") or {} %}
                  <div class="team-row">
                    <div class="team-left">
                      {% if home.get("logo") %}
                        <img class="team-logo" src="{{ home['logo'] }}" alt="{{ home.get('abbrev','') }} logo">
                      {% endif %}
                      <div class="team-line">
                        <div class="team-line-top">
                          <span class="team-abbrev">{{ home.get("abbrev","—") }}</span>
                          {% if home.get("record") %}
                            <span class="muted mono" style="font-size:12px;">{{ home["record"] }}</span>
                          {% endif %}
                          <span class="muted" style="opacity:.6;">•</span>

                          <span class="small muted">
                            PP:
                            {% if home.get("pp_id") and home.get("pp_name") %}
                              {{ player_name(home["pp_id"], home["pp_name"]) }}
                            {% else %}
                              {{ (home.get("pp") or "PP: TBD")|replace("PP: ", "") }}
                            {% endif %}
                          </span>
                        </div>
                      </div>
                    </div>
                    <div class="team-score mono">
                      {{ home["score"] if home.get("score") is not none else "—" }}
                    </div>
                  </div>
                </div>

                <div class="game-meta">
                  {% if next_game.get("venue") %}
                    <div class="muted">
                      {{ next_game["venue"] }}
                      {% if next_game.get("venueLocation") %}
                        • {{ next_game["venueLocation"] }}
                      {% endif %}
                    </div>
                  {% endif %}
                  <div class="small muted">{{ next_game.get("detailedState","") }}</div>
                </div>
              </a>
            {% else %}
              <div class="muted" style="margin-top:8px; font-size:13px;">No upcoming game found.</div>
            {% endif %}
          </div>

        </div>

        <div style="display:flex; flex-direction:column; gap:14px;">

          <!-- Division Standings -->
          <div class="subcard">
            <div class="subcard-title">Division Standings</div>

            {% if division_rows %}
              <table class="tbl" style="margin-top:10px;">
                <thead>
                  <tr>
                    <th style="text-align:left;">Team</th>
                    <th style="text-align:right;">W</th>
                    <th style="text-align:right;">L</th>
                    <th style="text-align:right;">Pct</th>
                    <th style="text-align:right;">GB</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in division_rows %}
                    <tr {% if r.get("is_selected") %}style="font-weight:700;"{% endif %}>
                      <td style="white-space:nowrap;">
                        <div style="display:flex; align-items:center; gap:8px;">
                          {% if r.get("logo") %}
                            <img src="{{ r['logo'] }}" alt="{{ r.get('abbrev','') }} logo" style="height:14px; width:14px; object-fit:contain;">
                          {% endif %}
                          <span class="mono">{{ r.get("abbrev","—") }}</span>
                        </div>
                      </td>
                      <td class="mono" style="text-align:right;">{{ r.get("w","—") }}</td>
                      <td class="mono" style="text-align:right;">{{ r.get("l","—") }}</td>
                      <td class="mono" style="text-align:right;">{{ r.get("pct","—") }}</td>
                      <td class="mono" style="text-align:right;">{{ r.get("gb","—") }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% else %}
              <div class="muted" style="margin-top:8px; font-size:13px;">No division standings found.</div>
            {% endif %}
          </div>

          <!-- Leaders -->
          <div class="subcard">
            <div class="subcard-title">Team Leaders</div>

            {% if leaders %}
              {% set hit = leaders.get("hitting") or [] %}
              {% set pit = leaders.get("pitching") or [] %}
              <div style="margin-top:10px;">

                <div class="small muted" style="font-weight:700; opacity:.9; margin-bottom:6px;">Hitting</div>
                {% if hit %}
                  <table class="tbl">
                    <thead>
                      <tr>
                        <th style="text-align:left;">Category</th>
                        <th style="text-align:left;">Player</th>
                        <th style="text-align:right;">Value</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for row in hit %}
                        <tr>
                          <td class="mono">{{ row.get("label","") }}</td>
                          <td style="white-space:nowrap;">
                            <div style="display:flex; align-items:center; gap:8px;">
                              {% if row.get("headshot") %}
                                <img class="mini-headshot" src="{{ row['headshot'] }}" alt="{{ row.get('player_name','') }}"
                                     style="height:18px; width:18px; border-radius:999px; object-fit:cover;"
                                     onerror="this.onerror=null; this.src='{{ row.get('fallback','') }}';">
                              {% endif %}
                              <a class="playerlink" href="/player/{{ row.get('player_id') }}">{{ row.get("player_name","—") }}</a>
                            </div>
                          </td>
                          <td class="mono" style="text-align:right;">{{ row.get("value","—") }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                {% else %}
                  <div class="muted" style="font-size:13px;">No hitting leaders found.</div>
                {% endif %}

                <div class="small muted" style="font-weight:700; opacity:.9; margin:12px 0 6px;">Pitching</div>
                {% if pit %}
                  <table class="tbl">
                    <thead>
                      <tr>
                        <th style="text-align:left;">Category</th>
                        <th style="text-align:left;">Player</th>
                        <th style="text-align:right;">Value</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for row in pit %}
                        <tr>
                          <td class="mono">{{ row.get("label","") }}</td>
                          <td style="white-space:nowrap;">
                            <div style="display:flex; align-items:center; gap:8px;">
                              {% if row.get("headshot") %}
                                <img class="mini-headshot" src="{{ row['headshot'] }}" alt="{{ row.get('player_name','') }}"
                                     style="height:18px; width:18px; border-radius:999px; object-fit:cover;"
                                     onerror="this.onerror=null; this.src='{{ row.get('fallback','') }}';">
                              {% endif %}
                              <a class="playerlink" href="/player/{{ row.get('player_id') }}">{{ row.get("player_name","—") }}</a>
                            </div>
                          </td>
                          <td class="mono" style="text-align:right;">{{ row.get("value","—") }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                {% else %}
                  <div class="muted" style="font-size:13px;">No pitching leaders found.</div>
                {% endif %}
              </div>
            {% else %}
              <div class="muted" style="margin-top:8px; font-size:13px;">No leaders found.</div>
            {% endif %}
          </div>

        </div>
      </div>
    </div>

    <!-- ===================== -->
    <!-- ROSTER TAB -->
    <!-- ===================== -->
    <div class="tab-panel" id="tab-roster" data-tab="roster" style="display:none;">
      {% set bucket_label = {
        "Pitcher": "Pitchers",
        "Catcher": "Catchers",
        "Infielder": "Infielders",
        "Outfielder": "Outfielders"
      } %}

      {% for bucket, players in (roster_grouped or {}).items() %}
        {% if players %}
          <div class="subcard" style="margin-top:12px;">
            <div class="subcard-title">{{ bucket_label.get(bucket, bucket ~ "s") }}</div>

            <table class="tbl" style="margin-top:10px;">
              <thead>
                <tr>
                  <th style="width:44px; text-align:right;">#</th>
                  <th style="text-align:left;">Player</th>
                  <th style="text-align:right;">Pos</th>
                  <th style="text-align:right;">B/T</th>
                  <th style="text-align:right;">Ht</th>
                  <th style="text-align:right;">Wt</th>
                  <th style="text-align:right;">Age</th>
                  <th style="text-align:right;">Svc</th>
                </tr>
              </thead>
              <tbody>
                {% for p in players %}
                  {% set pid = p.get("id") or p.get("player_id") %}
                  <tr>
                    <td class="mono" style="text-align:right;">{{ p.get("jersey") or "—" }}</td>
                    <td style="white-space:nowrap;">
                      <div style="display:flex; align-items:center; gap:10px;">
                        {% if p.get("headshot") %}
                          <img class="mini-headshot"
                               src="{{ p['headshot'] }}"
                               alt="{{ p.get('name','') }}"
                               style="height:22px; width:22px; border-radius:999px; object-fit:cover;"
                               onerror="this.onerror=null; this.src='{{ p.get('headshot_fallback','') }}';">
                        {% endif %}

                        {% if pid %}
                          <a class="playerlink" href="/player/{{ pid }}">{{ p.get("name","—") }}</a>
                        {% else %}
                          {{ p.get("name","—") }}
                        {% endif %}

                        {% if p.get("status_code") and p.get("status_code") not in ["A"] %}
                          {% set code = p.get("status_code") %}
                          <span class="status-pill
                            {% if code == 'IL' %} status-il
                            {% elif code == 'MIN' %} status-min
                            {% else %} status-other
                            {% endif %}"
                            title="{{ p.get('status_desc','') }}">
                            {{ code }}
                          </span>
                        {% endif %}
                      </div>
                    </td>

                    <td class="mono" style="text-align:right;">{{ p.get("pos") or "—" }}</td>
                    <td class="mono" style="text-align:right;">{{ p.get("bt") or "—" }}</td>
                    <td class="mono" style="text-align:right;">{{ p.get("ht") or "—" }}</td>
                    <td class="mono" style="text-align:right;">{{ p.get("wt") or "—" }}</td>
                    <td class="mono" style="text-align:right;">{{ p.get("age") or "—" }}</td>
                    <td class="mono" style="text-align:right;">{{ p.get("service") or "—" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      {% endfor %}

      {% if roster_other %}
        <div class="subcard" style="margin-top:12px;">
          <div class="subcard-title">Other</div>

          <table class="tbl" style="margin-top:10px;">
            <thead>
              <tr>
                <th style="width:44px; text-align:right;">#</th>
                <th style="text-align:left;">Player</th>
                <th style="text-align:right;">Pos</th>
                <th style="text-align:right;">B/T</th>
                <th style="text-align:right;">Ht</th>
                <th style="text-align:right;">Wt</th>
                <th style="text-align:right;">Age</th>
                <th style="text-align:right;">Svc</th>
              </tr>
            </thead>
            <tbody>
              {% for p in roster_other %}
                {% set pid = p.get("id") or p.get("player_id") %}
                <tr>
                  <td class="mono" style="text-align:right;">{{ p.get("jersey") or "—" }}</td>
                  <td style="white-space:nowrap;">
                    <div style="display:flex; align-items:center; gap:10px;">
                      {% if p.get("headshot") %}
                        <img class="mini-headshot"
                             src="{{ p['headshot'] }}"
                             alt="{{ p.get('name','') }}"
                             style="height:22px; width:22px; border-radius:999px; object-fit:cover;"
                             onerror="this.onerror=null; this.src='{{ p.get('headshot_fallback','') }}';">
                      {% endif %}
                      {% if pid %}
                        <a class="playerlink" href="/player/{{ pid }}">{{ p.get("name","—") }}</a>
                      {% else %}
                        {{ p.get("name","—") }}
                      {% endif %}
                      {% if p.get("status_code") and p.get("status_code") not in ["A"] %}
                        {% set code = p.get("status_code") %}
                        <span class="status-pill
                          {% if code == 'IL' %} status-il
                          {% elif code == 'MIN' %} status-min
                          {% else %} status-other
                          {% endif %}"
                          title="{{ p.get('status_desc','') }}">
                          {{ code }}
                        </span>
                      {% endif %}
                    </div>
                  </td>
                  <td class="mono" style="text-align:right;">{{ p.get("pos") or "—" }}</td>
                  <td class="mono" style="text-align:right;">{{ p.get("bt") or "—" }}</td>
                  <td class="mono" style="text-align:right;">{{ p.get("ht") or "—" }}</td>
                  <td class="mono" style="text-align:right;">{{ p.get("wt") or "—" }}</td>
                  <td class="mono" style="text-align:right;">{{ p.get("age") or "—" }}</td>
                  <td class="mono" style="text-align:right;">{{ p.get("service") or "—" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </div>

    <!-- ===================== -->
    <!-- SCHEDULE TAB -->
    <!-- ===================== -->
    <div class="tab-panel" id="tab-schedule" data-tab="schedule" style="display:none;">
      <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
        <div class="subcard-title" style="margin:0;">Schedule</div>
        <div style="margin-left:auto; display:flex; align-items:center; gap:10px;">
          <select id="scheduleSeason" class="season-select" aria-label="Select season"></select>
        </div>
      </div>

      <div id="scheduleContent">
        <div class="muted" style="font-size:13px;">Select a season to load schedule.</div>
      </div>
    </div>

    <!-- ===================== -->
    <!-- TRANSACTIONS TAB -->
    <!-- ===================== -->
    <div class="tab-panel" id="tab-transactions" data-tab="transactions" style="display:none;">
      <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
        <div class="subcard-title" style="margin:0;">Transactions</div>
        <div style="margin-left:auto; display:flex; align-items:center; gap:10px;">
          <select id="txDays" class="season-select" aria-label="Select transaction range">
            <option value="7">Last 7 days</option>
            <option value="14">Last 14 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="60">Last 60 days</option>
          </select>
        </div>
      </div>

      <div id="txContent">
        <div class="muted" style="font-size:13px;">Select a range to load transactions.</div>
      </div>
    </div>

  </div>
</div>

<style>
  /* Player links */
  a.playerlink{ color: inherit; text-decoration: none; }
  a.playerlink:hover{ text-decoration: underline; }

  .status-pill{
    display:inline-block;
    margin-left:8px;
    padding:2px 8px;
    border-radius:999px;
    font-size:11px;
    line-height:1.2;
    vertical-align:middle;
  }
  .status-il{
    background: rgba(255, 0, 0, 0.18);
    color: rgba(255, 170, 170, 0.95);
    border: 1px solid rgba(255, 0, 0, 0.28);
  }
  .status-min{
    background: rgba(160, 160, 160, 0.18);
    color: rgba(220, 220, 220, 0.95);
    border: 1px solid rgba(180, 180, 180, 0.22);
  }
  .status-other{
    background: rgba(255,255,255,0.10);
    color: rgba(235,235,235,0.95);
    border: 1px solid rgba(255,255,255,0.12);
    border: 1px solid rgba(255,255,255,0.12);
  }

  /* Shared selects */
  .season-select{
    padding:6px 10px;
    border-radius:10px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.06);
    color: inherit;
    font-size: 13px;
  }

  /* Schedule helpers */
  .sched-section-title{
    margin-top: 12px;
    margin-bottom: 6px;
    font-weight: 700;
    font-size: 13px;
    opacity: 0.95;
  }
  .opp-cell{ display:flex; align-items:center; gap:8px; white-space:nowrap; }
  .opp-logo{ height:14px; width:14px; object-fit:contain; }
  .scorecell{ display:flex; align-items:center; gap:8px; white-space:nowrap; }
  .wl{ font-weight:700; }
  .wl-win{ color:#2ecc71; }
  .wl-loss{ color:#e74c3c; }
  .wl-tie{ color:#f1c40f; }
  .pitchers-stack{ display:flex; flex-direction:column; line-height:1.05; }

  /* Transactions */
  .tx-desc a{ text-decoration:none; }
  .tx-desc a:hover{ text-decoration:underline; }
</style>

<script>
  // NOTE: ensure TEAM_ID is always a number
  const TEAM_ID = {{ team["team_id"]|int }};

  function mlbLogoUrl(teamId){
    return `https://www.mlbstatic.com/team-logos/${teamId}.svg`;
  }

  // ----------------------------
  // Tabs (fail-safe)
  // ----------------------------
  function setActiveTab(tab){
    try{
      const btns = document.querySelectorAll(".tab-btn");
      const panels = document.querySelectorAll(".tab-panel");

      if (!btns.length || !panels.length){
        // Nothing to toggle; don't hide content
        return;
      }

      btns.forEach(b => {
        const isOn = b.dataset.tab === tab;
        b.classList.toggle("active", isOn);
      });

      panels.forEach(p => {
        p.style.display = (p.dataset.tab === tab) ? "" : "none";
      });

      const url = new URL(window.location.href);
      url.searchParams.set("tab", tab);
      window.history.replaceState({}, "", url);

      if (tab === "schedule") ensureScheduleLoaded();
      if (tab === "transactions") ensureTransactionsLoaded();
    } catch(e){
      console.error("[team] setActiveTab error", e);
      // fail open: ensure overview is visible
      const ov = document.getElementById("tab-overview");
      if (ov) ov.style.display = "";
    }
  }

  // Bind safely after DOM exists
  window.addEventListener("DOMContentLoaded", () => {
    try{
      document.querySelectorAll(".tab-btn").forEach(b => {
        b.addEventListener("click", () => setActiveTab(b.dataset.tab));
      });

      const initialTab = new URLSearchParams(window.location.search).get("tab") || "overview";
      setActiveTab(initialTab);
    } catch(e){
      console.error("[team] tab init error", e);
      const ov = document.getElementById("tab-overview");
      if (ov) ov.style.display = "";
    }
  });

  // ----------------------------
  // Schedule
  // ----------------------------
  let _scheduleBootstrapped = false;
  let _scheduleLoadedOnce = false;

  function buildSeasons(){
    const sel = document.getElementById("scheduleSeason");
    if (!sel) return;

    const currentYear = new Date().getFullYear();
    sel.innerHTML = "";

    for (let y = currentYear; y >= 2021; y--){
      const opt = document.createElement("option");
      opt.value = y;
      opt.textContent = y;
      sel.appendChild(opt);
    }
    sel.value = currentYear;
  }

  function fmtLocalDate(iso){
    const d = new Date(iso);
    return d.toLocaleDateString(undefined, { weekday:"short", month:"short", day:"numeric" });
  }

  function fmtLocalTime(iso){
    const d = new Date(iso);
    return d.toLocaleTimeString(undefined, { hour:"numeric", minute:"2-digit" });
  }

  function isFinal(status){
    return status === "Final" || status === "Game Over";
  }

  function isUpcoming(status){
    return !isFinal(status) && status !== "Postponed" && status !== "Canceled";
  }

  function renderLocation(v){
    const parts = [];
    if (v?.name) parts.push(v.name);
    const cityState = [v?.city, v?.state].filter(Boolean).join(", ");
    if (cityState) parts.push(cityState);
    return parts.join(" — ") || "—";
  }

  function computeResult(g){
    if (!isFinal(g.status)) return null;

    const teamRuns = g.isHome ? g.score.home : g.score.away;
    const oppRuns  = g.isHome ? g.score.away : g.score.home;
    if (teamRuns == null || oppRuns == null) return null;

    if (teamRuns > oppRuns) return { wl:"W", teamRuns, oppRuns };
    if (teamRuns < oppRuns) return { wl:"L", teamRuns, oppRuns };
    return { wl:"T", teamRuns, oppRuns };
  }

  function sectionForGameType(gt){
    if (gt === "S" || gt === "E") return "Spring Training";
    if (gt === "R") return "Regular Season";
    if (["F","D","L","W"].includes(gt)) return "Postseason";
    return "Other";
  }

  function safeText(x){
    return (x == null || x === "") ? "—" : String(x);
  }

  function escapeHtml(s){
    return safeText(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }

  function playerLink(id, name){
    const nm = escapeHtml(name || "—");
    return id ? `<a href="/player/${id}">${nm}</a>` : nm;
  }

  function renderScheduleSection(title, games){
    if (!games.length) return "";

    const head = `
      <div class="sched-section-title">${title}</div>
      <table class="tbl" style="width:100%;">
        <thead>
          <tr>
            <th style="text-align:left;">Date</th>
            <th style="text-align:left;">Time</th>
            <th style="text-align:left;">Location</th>
            <th style="text-align:left;">Opponent</th>
            <th style="text-align:left;">Score</th>
            <th style="text-align:left;">Pitchers</th>
            <th style="text-align:right;"></th>
          </tr>
        </thead>
        <tbody>
    `;

    const rows = games.map(g => {
      const date = fmtLocalDate(g.gameDate);
      const time = fmtLocalTime(g.gameDate);
      const loc  = renderLocation(g.venue);

      const prefix = g.isHome ? "vs." : "@";
      const oppAbbrev = (g.opp?.abbrev || "—");
      const oppLogo = g.opp?.id
        ? `<img class="opp-logo" src="${mlbLogoUrl(g.opp.id)}" alt="${escapeHtml(oppAbbrev)}">`
        : "";

      const result = computeResult(g);
      let scoreHtml = `<span class="muted">—</span>`;
      if (result){
        const cls = result.wl === "W" ? "wl-win" : (result.wl === "L" ? "wl-loss" : "wl-tie");
        scoreHtml = `<span class="wl ${cls}">${result.wl}</span>
                     <span class="mono">${result.teamRuns}&ndash;${result.oppRuns}</span>`;
      } else if (!isUpcoming(g.status)) {
        scoreHtml = `<span class="muted">${escapeHtml(g.status || "—")}</span>`;
      }

      let pitchersHtml = `<span class="muted">—</span>`;
      if (isFinal(g.status)){
        const w = g.pitchers?.winner ? `W: ${playerLink(g.pitchers?.winnerId, g.pitchers.winner)}` : null;
        const l = g.pitchers?.loser ? `L: ${playerLink(g.pitchers?.loserId, g.pitchers.loser)}` : null;

        if (w || l){
          pitchersHtml = `
            <div class="pitchers-stack">
              ${w ? `<div>${w}</div>` : ""}
              ${l ? `<div>${l}</div>` : ""}
            </div>
          `;
        }
      } else {
        const tp = g.pitchers?.teamProbable || "TBD";
        const op = g.pitchers?.oppProbable || "TBD";

        pitchersHtml = `
          <div class="pitchers-stack">
            <div>${playerLink(g.pitchers?.teamProbableId, tp)}</div>
            <div>${playerLink(g.pitchers?.oppProbableId, op)}</div>
          </div>
        `;
      }

      const rightLabel = isFinal(g.status) ? "Recap" : "Preview";
      const rightHref = g.gamePk ? `/game/${g.gamePk}` : "#";

      return `
        <tr>
          <td class="mono" style="white-space:nowrap;">${date}</td>
          <td class="mono" style="white-space:nowrap;">${time}</td>
          <td>${loc}</td>
          <td>
            <div class="opp-cell">
              <span style="opacity:.85; width:32px; display:inline-block;">${prefix}</span>
              <span class="mono" style="font-weight:700;">${escapeHtml(oppAbbrev)}</span>
              ${oppLogo}
            </div>
          </td>
          <td><div class="scorecell">${scoreHtml}</div></td>
          <td>${pitchersHtml}</td>
          <td style="text-align:right;"><a href="${rightHref}">${rightLabel}</a></td>
        </tr>
      `;
    }).join("");

    return head + rows + `</tbody></table>`;
  }

  async function loadSchedule(){
    const sel = document.getElementById("scheduleSeason");
    const container = document.getElementById("scheduleContent");
    if (!sel || !container) return;

    const season = sel.value;
    container.innerHTML = `<div class="muted" style="font-size:13px;">Loading schedule…</div>`;

    try{
      const res = await fetch(`/team/${TEAM_ID}/schedule_json?season=${season}`);
      const data = await res.json();
      const games = data.games || [];

      if (!games.length){
        container.innerHTML = `<div class="muted" style="font-size:13px;">No games found for ${season}.</div>`;
        return;
      }

      const spring = [], regular = [], post = [], other = [];
      for (const g of games){
        const group = sectionForGameType(g.gameType);
        if (group === "Spring Training") spring.push(g);
        else if (group === "Regular Season") regular.push(g);
        else if (group === "Postseason") post.push(g);
        else other.push(g);
      }

      container.innerHTML =
        renderScheduleSection("Spring Training", spring) +
        renderScheduleSection("Regular Season", regular) +
        renderScheduleSection("Postseason", post) +
        renderScheduleSection("Other", other);

    } catch (e){
      console.error(e);
      container.innerHTML = `<div class="muted" style="font-size:13px;">Error loading schedule.</div>`;
    }
  }

  function ensureScheduleLoaded(){
    if (!_scheduleBootstrapped){
      buildSeasons();
      const sel = document.getElementById("scheduleSeason");
      if (sel){
        sel.addEventListener("change", () => {
          const panel = document.querySelector('.tab-panel[data-tab="schedule"]');
          if (panel && panel.style.display !== "none"){
            loadSchedule();
          }
        });
      }
      _scheduleBootstrapped = true;
    }
    if (!_scheduleLoadedOnce){
      _scheduleLoadedOnce = true;
      loadSchedule();
    }
  }

  // ----------------------------
  // Transactions
  // ----------------------------
  let _txLoadedOnce = false;

  function fmtLocalDateOnly(isoOrYmd){
    if (!isoOrYmd) return "—";
    const d = new Date(isoOrYmd);
    if (isNaN(d.getTime())) return isoOrYmd;
    return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" });
  }

  function renderTransactions(txs){
    if (!txs.length){
      return `<div class="muted" style="font-size:13px;">No transactions found for this range.</div>`;
    }

    const head = `
      <table class="tbl" style="width:100%;">
        <thead>
          <tr>
            <th style="text-align:left;">Date</th>
            <th style="text-align:left;">Description</th>
          </tr>
        </thead>
        <tbody>
    `;

    const rows = txs.map(t => {
      const date = fmtLocalDateOnly(t.date);

      const descRaw = safeText(t.description);
      let descHtml = escapeHtml(descRaw);

      const players = (t.players || []).filter(p => p && p.id && p.name);

      for (const p of players){
        const nameEsc = escapeHtml(p.name);
        const linked = `<a href="/player/${p.id}">${nameEsc}</a>`;
        if (descHtml.includes(nameEsc)){
          descHtml = descHtml.split(nameEsc).join(linked);
        }
      }

      const anyLinked = players.some(p => descHtml.includes(`/player/${p.id}`));
      if (players.length && !anyLinked){
        const plist = players
          .map(p => `<a href="/player/${p.id}">${escapeHtml(p.name)}</a>`)
          .join(", ");
        descHtml = `${plist} <span class="muted">—</span> ${descHtml}`;
      }

      return `
        <tr>
          <td class="mono" style="white-space:nowrap;">${date}</td>
          <td class="tx-desc">${descHtml}</td>
        </tr>
      `;
    }).join("");

    return head + rows + `</tbody></table>`;
  }

  async function loadTransactions(){
    const sel = document.getElementById("txDays");
    const container = document.getElementById("txContent");
    if (!sel || !container) return;

    const days = sel.value;
    container.innerHTML = `<div class="muted" style="font-size:13px;">Loading transactions…</div>`;

    try{
      const res = await fetch(`/team/${TEAM_ID}/transactions_json?days=${encodeURIComponent(days)}`);
      const data = await res.json();
      const txs = data.transactions || [];
      container.innerHTML = renderTransactions(txs);
    } catch(e){
      console.error(e);
      container.innerHTML = `<div class="muted" style="font-size:13px;">Error loading transactions.</div>`;
    }
  }

  function ensureTransactionsLoaded(){
    if (!_txLoadedOnce){
      _txLoadedOnce = true;
      loadTransactions();

      const sel = document.getElementById("txDays");
      if (sel){
        sel.addEventListener("change", () => {
          const panel = document.querySelector('.tab-panel[data-tab="transactions"]');
          if (panel && panel.style.display !== "none"){
            loadTransactions();
          }
        });
      }
    }
  }
</script>

{% endblock %}
