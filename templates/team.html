{% extends "base.html" %}
{% block content %}

<div class="card">
  <div class="card-header">
    <div class="teamcell" style="gap:10px;">
      {% if team.logo_url %}
        <img class="teamlogo" src="{{ team.logo_url }}" alt="{{ team.name }} logo" style="height:28px;">
      {% endif %}
      <div>
        <div class="card-title">{{ team.name }}</div>
        <div class="card-subtitle">
          {% if team.division %}{{ team.division }}{% endif %}
          {% if team.venue %} • {{ team.venue }}{% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===================== -->
<!-- 40-MAN ROSTER DROPDOWN -->
<!-- ===================== -->

<div class="card" style="margin-top:18px;">
  <div class="card-header">
    <details class="roster-details">
      <summary class="roster-summary">
        <div class="card-title" style="margin:0;">40-Man Roster</div>
        <span class="muted" style="font-size:12px;">Click to expand</span>
      </summary>

      <div class="card-body" style="padding-top:10px;">

        {% set bucket_label = {
          "Pitcher": "Pitchers",
          "Catcher": "Catchers",
          "Infielder": "Infielders",
          "Outfielder": "Outfielders"
        } %}

        {% for bucket, players in (roster_grouped or {}).items() %}
          {% if players %}
            <div class="subcard" style="margin-top:12px;">
              <div class="subcard-title">{{ bucket_label.get(bucket, bucket ~ "s") }}</div>

              <table class="table">
                <thead>
                  <tr>
                    <td style="width:44px; text-align:right;"><strong>#</strong></td>
                    <td><strong>Player</strong></td>
                    <td style="width:70px; text-align:right;"><strong>B/T</strong></td>
                    <td style="width:60px; text-align:right;"><strong>Pos</strong></td>
                  </tr>
                </thead>
                <tbody>
                  {% for p in players %}
                    <tr>
                      <td style="text-align:right; font-variant-numeric: tabular-nums;">
                        {{ p.jersey or "—" }}
                      </td>

                      <td style="white-space:nowrap;">
                        {{ p.name }}

                        {% if p.status_code and p.status_code not in ["A"] %}
                          {% set code = p.status_code %}
                          <span class="status-pill
                            {% if code == 'IL' %} status-il
                            {% elif code == 'MIN' %} status-min
                            {% else %} status-other
                            {% endif %}"
                            title="{{ p.status_desc }}">
                            {{ code }}
                          </span>
                        {% endif %}
                      </td>

                      <td style="text-align:right; font-variant-numeric: tabular-nums;">
                        {{ p.bt or "—" }}
                      </td>

                      <td style="text-align:right;">
                        {{ p.pos or "—" }}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>

            </div>
          {% endif %}
        {% endfor %}

        {% if roster_other %}
          <div class="subcard" style="margin-top:12px;">
            <div class="subcard-title">Other</div>

            <table class="table">
              <thead>
                <tr>
                  <td style="width:44px; text-align:right;"><strong>#</strong></td>
                  <td><strong>Player</strong></td>
                  <td style="width:70px; text-align:right;"><strong>B/T</strong></td>
                  <td style="width:60px; text-align:right;"><strong>Pos</strong></td>
                </tr>
              </thead>
              <tbody>
                {% for p in roster_other %}
                  <tr>
                    <td style="text-align:right; font-variant-numeric: tabular-nums;">{{ p.jersey or "—" }}</td>

                    <td style="white-space:nowrap;">
                      {{ p.name }}

                      {% if p.status_code and p.status_code not in ["A"] %}
                        {% set code = p.status_code %}
                        <span class="status-pill
                          {% if code == 'IL' %} status-il
                          {% elif code == 'MIN' %} status-min
                          {% else %} status-other
                          {% endif %}"
                          title="{{ p.status_desc }}">
                          {{ code }}
                        </span>
                      {% endif %}
                    </td>

                    <td style="text-align:right; font-variant-numeric: tabular-nums;">{{ p.bt or "—" }}</td>
                    <td style="text-align:right;">{{ p.pos or "—" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}

      </div>
    </details>
  </div>
</div>

<!-- ===================== -->
<!-- TEAM SCHEDULE DROPDOWN -->
<!-- ===================== -->

<div class="card" style="margin-top:18px;">
  <div class="card-header">
    <details class="roster-details" id="scheduleDetails">
      <summary class="roster-summary">
        <div style="display:flex; align-items:baseline; gap:12px; flex:1;">
          <div class="card-title" style="margin:0;">Schedule</div>

          <!-- Season dropdown on the right side of title bar -->
          <div style="margin-left:auto; display:flex; align-items:center; gap:10px;">
            <select id="scheduleSeason" class="season-select" aria-label="Select season"></select>
            <span class="muted" style="font-size:12px;">Click to expand</span>
          </div>
        </div>
      </summary>

      <div class="card-body" style="padding-top:10px;">
        <div id="scheduleContent">
          <div class="muted" style="font-size:13px;">Select a season to load schedule.</div>
        </div>
      </div>
    </details>
  </div>
</div>

<!-- ===================== -->
<!-- TRANSACTIONS DROPDOWN -->
<!-- ===================== -->

<div class="card" style="margin-top:18px;">
  <div class="card-header">
    <details class="roster-details" id="txDetails">
      <summary class="roster-summary">
        <div style="display:flex; align-items:baseline; gap:12px; flex:1;">
          <div class="card-title" style="margin:0;">Transactions</div>

          <div style="margin-left:auto; display:flex; align-items:center; gap:10px;">
            <select id="txDays" class="season-select" aria-label="Select transaction range">
              <option value="7">Last 7 days</option>
              <option value="14">Last 14 days</option>
              <option value="30" selected>Last 30 days</option>
              <option value="60">Last 60 days</option>
            </select>
            <span class="muted" style="font-size:12px;">Click to expand</span>
          </div>
        </div>
      </summary>

      <div class="card-body" style="padding-top:10px;">
        <div id="txContent">
          <div class="muted" style="font-size:13px;">Select a range to load transactions.</div>
        </div>
      </div>
    </details>
  </div>
</div>

<!-- Local styles for dropdown + schedule + status pills + transactions -->
<style>
  .roster-details { width: 100%; }
  .roster-summary {
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 12px;
    padding: 0;
    list-style: none;
  }
  .roster-summary::-webkit-details-marker { display: none; }

  .status-pill{
    display:inline-block;
    margin-left:8px;
    padding:2px 8px;
    border-radius:999px;
    font-size:11px;
    line-height:1.2;
    vertical-align:middle;
  }
  .status-il{
    background: rgba(255, 0, 0, 0.18);
    color: rgba(255, 170, 170, 0.95);
    border: 1px solid rgba(255, 0, 0, 0.28);
  }
  .status-min{
    background: rgba(160, 160, 160, 0.18);
    color: rgba(220, 220, 220, 0.95);
    border: 1px solid rgba(180, 180, 180, 0.22);
  }
  .status-other{
    background: rgba(255,255,255,0.10);
    color: rgba(235,235,235,0.95);
    border: 1px solid rgba(255,255,255,0.12);
  }

  /* Shared select style (schedule + transactions) */
  .season-select{
    padding:6px 10px;
    border-radius:10px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.06);
    color: inherit;
    font-size: 13px;
  }

  /* Schedule styles */
  .schedule-section-title{
    margin-top: 10px;
    margin-bottom: 6px;
    font-weight: 700;
    font-size: 13px;
    opacity: 0.95;
  }

  .schedule-table { width:100%; }

  /* TIGHTER ROWS */
  .schedule-row{
    display:grid;
    grid-template-columns: 100px 70px 1.8fr 150px 95px 1.3fr 78px;
    gap:6px;
    padding:3px 6px;
    border-bottom: 1px solid rgba(255,255,255,0.06);
    align-items:center;
    font-size: 11px;
    line-height: 1.1;
  }

  .schedule-header{
    font-weight:600;
    opacity:0.9;
    border-bottom: 1px solid rgba(255,255,255,0.14);
    padding:6px 6px;
    font-size: 11px;
  }

  /* Alternating row shading like table tbody zebra */
  .schedule-body .data-row:nth-child(odd){
    background: rgba(255,255,255,0.00);
  }
  .schedule-body .data-row:nth-child(even){
    background: rgba(255,255,255,0.06);
  }

  .opponent { display:flex; align-items:center; gap:8px; white-space:nowrap; }
  .opp-logo { height:14px; width:14px; object-fit:contain; }
  .scorecell { display:flex; align-items:center; gap:8px; white-space:nowrap; }

  .wl { font-weight:700; }
  .wl-win { color:#2ecc71; }
  .wl-loss { color:#e74c3c; }
  .wl-tie { color:#f1c40f; }

  .rightlink a { text-decoration:none; }
  .rightlink a:hover { text-decoration:underline; }

  /* Tight stacked pitchers */
  .pitchers-stack{
    display:flex;
    flex-direction:column;
    line-height:1.05;
  }

  /* Transactions styles */
  .tx-row{
    display:grid;
    grid-template-columns: 120px 170px 160px 90px 90px 1fr;
    gap:6px;
    padding:3px 6px;
    border-bottom: 1px solid rgba(255,255,255,0.06);
    align-items:center;
    font-size: 11px;
    line-height: 1.1;
  }

  .tx-header{
    font-weight:600;
    opacity:0.9;
    border-bottom: 1px solid rgba(255,255,255,0.14);
    padding:6px 6px;
    font-size: 11px;
  }

  .tx-body .data-row:nth-child(even){
    background: rgba(255,255,255,0.06);
  }

  .tx-player a{
    text-decoration:none;
  }
  .tx-player a:hover{
    text-decoration:underline;
  }

  .tx-desc{
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
</style>

<script>
  const TEAM_ID = {{ team.team_id }};

  function mlbLogoUrl(teamId){
    return `https://www.mlbstatic.com/team-logos/${teamId}.svg`;
  }

  // ----------------------------
  // Schedule
  // ----------------------------
  function buildSeasons(){
    const sel = document.getElementById("scheduleSeason");
    const currentYear = new Date().getFullYear();

    for (let y = currentYear; y >= 2021; y--){
      const opt = document.createElement("option");
      opt.value = y;
      opt.textContent = y;
      sel.appendChild(opt);
    }
    sel.value = currentYear;
  }

  function fmtLocalDate(iso){
    const d = new Date(iso);
    return d.toLocaleDateString(undefined, { weekday:"short", month:"short", day:"numeric" });
  }

  function fmtLocalTime(iso){
    const d = new Date(iso);
    return d.toLocaleTimeString(undefined, { hour:"numeric", minute:"2-digit" });
  }

  function isFinal(status){
    return status === "Final" || status === "Game Over";
  }

  function isUpcoming(status){
    return !isFinal(status) && status !== "Postponed" && status !== "Canceled";
  }

  function renderLocation(v){
    const parts = [];
    if (v?.name) parts.push(v.name);
    const cityState = [v?.city, v?.state].filter(Boolean).join(", ");
    if (cityState) parts.push(cityState);
    return parts.join(" — ") || "—";
  }

  function computeResult(g){
    if (!isFinal(g.status)) return null;

    const teamRuns = g.isHome ? g.score.home : g.score.away;
    const oppRuns  = g.isHome ? g.score.away : g.score.home;
    if (teamRuns == null || oppRuns == null) return null;

    if (teamRuns > oppRuns) return { wl:"W", teamRuns, oppRuns };
    if (teamRuns < oppRuns) return { wl:"L", teamRuns, oppRuns };
    return { wl:"T", teamRuns, oppRuns };
  }

  function sectionForGameType(gt){
    if (gt === "S" || gt === "E") return "Spring Training";
    if (gt === "R") return "Regular Season";
    if (["F","D","L","W"].includes(gt)) return "Postseason";
    return "Other";
  }

  function renderSection(title, sectionGames){
    if (!sectionGames.length) return "";

    const header = `
      <div class="schedule-section-title">${title}</div>
      <div class="schedule-table">
        <div class="schedule-row schedule-header">
          <div>Date</div>
          <div>Time</div>
          <div>Location</div>
          <div>Opponent</div>
          <div>Score</div>
          <div>Pitchers</div>
          <div></div>
        </div>
        <div class="schedule-body">
    `;

    const rows = sectionGames.map(g => {
      const date = fmtLocalDate(g.gameDate);
      const time = fmtLocalTime(g.gameDate);
      const loc  = renderLocation(g.venue);

      const prefix = g.isHome ? "vs." : "@";
      const oppAbbrev = (g.opp?.abbrev || "—");
      const oppLogo = g.opp?.id
        ? `<img class="opp-logo" src="${mlbLogoUrl(g.opp.id)}" alt="${oppAbbrev}">`
        : "";

      const result = computeResult(g);
      let scoreHtml = `<span class="muted">—</span>`;
      if (result){
        const cls = result.wl === "W" ? "wl-win" : (result.wl === "L" ? "wl-loss" : "wl-tie");
        scoreHtml = `<span class="wl ${cls}">${result.wl}</span>
                     <span>${result.teamRuns}&ndash;${result.oppRuns}</span>`;
      } else if (!isUpcoming(g.status)) {
        scoreHtml = `<span class="muted">${g.status || "—"}</span>`;
      }

      let pitchersHtml = `<span class="muted">—</span>`;
      if (isFinal(g.status)){
        const w = g.pitchers?.winner ? `W: ${g.pitchers.winner}` : null;
        const l = g.pitchers?.loser ? `L: ${g.pitchers.loser}` : null;

        if (w || l){
          pitchersHtml = `
            <div class="pitchers-stack">
              ${w ? `<div>${w}</div>` : ""}
              ${l ? `<div>${l}</div>` : ""}
            </div>
          `;
        }
      } else {
        const tp = g.pitchers?.teamProbable || "TBD";
        const op = g.pitchers?.oppProbable || "TBD";

        pitchersHtml = `
          <div class="pitchers-stack">
            <div>${tp}</div>
            <div>${op}</div>
          </div>
        `;
      }

      const rightLabel = isFinal(g.status) ? "Recap" : "Preview";
      const rightHref = g.gamePk ? `/game/${g.gamePk}` : "#";

      return `
        <div class="schedule-row data-row">
          <div>${date}</div>
          <div>${time}</div>
          <div>${loc}</div>
          <div class="opponent">
            <span style="opacity:0.85; width:32px; display:inline-block;">${prefix}</span>
            <span style="font-weight:600;">${oppAbbrev}</span>
            ${oppLogo}
          </div>
          <div class="scorecell">${scoreHtml}</div>
          <div>${pitchersHtml}</div>
          <div class="rightlink"><a href="${rightHref}">${rightLabel}</a></div>
        </div>
      `;
    }).join("");

    return header + rows + `</div></div>`;
  }

  async function loadSchedule(){
    const season = document.getElementById("scheduleSeason").value;
    const container = document.getElementById("scheduleContent");
    container.innerHTML = `<div class="muted" style="font-size:13px;">Loading schedule…</div>`;

    try{
      const res = await fetch(`/team/${TEAM_ID}/schedule_json?season=${season}`);
      const data = await res.json();
      const games = data.games || [];

      if (!games.length){
        container.innerHTML = `<div class="muted" style="font-size:13px;">No games found for ${season}.</div>`;
        return;
      }

      const spring = [];
      const regular = [];
      const post = [];
      const other = [];

      for (const g of games){
        const group = sectionForGameType(g.gameType);
        if (group === "Spring Training") spring.push(g);
        else if (group === "Regular Season") regular.push(g);
        else if (group === "Postseason") post.push(g);
        else other.push(g);
      }

      container.innerHTML =
        renderSection("Spring Training", spring) +
        renderSection("Regular Season", regular) +
        renderSection("Postseason", post) +
        renderSection("Other", other);

    } catch (e){
      console.error(e);
      container.innerHTML = `<div class="muted" style="font-size:13px;">Error loading schedule.</div>`;
    }
  }

  // Init schedule years
  buildSeasons();

  // Load when user expands Schedule
  const scheduleDetails = document.getElementById("scheduleDetails");
  scheduleDetails.addEventListener("toggle", () => {
    if (scheduleDetails.open){
      loadSchedule();
    }
  });

  // Reload when season changes (even if already open)
  document.getElementById("scheduleSeason").addEventListener("change", () => {
    if (scheduleDetails.open){
      loadSchedule();
    }
  });

  // ----------------------------
  // Transactions
  // ----------------------------
  function fmtLocalDateOnly(isoOrYmd){
    if (!isoOrYmd) return "—";
    const d = new Date(isoOrYmd);
    if (isNaN(d.getTime())) return isoOrYmd; // fallback to raw string
    return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" });
  }

  function safeText(x){
    return (x == null || x === "") ? "—" : String(x);
  }

  function escapeAttr(s){
    return safeText(s).replaceAll('"', "&quot;");
  }

  function renderTransactions(txs){
    if (!txs.length){
      return `<div class="muted" style="font-size:13px;">No transactions found for this range.</div>`;
    }

    const header = `
      <div class="tx-row tx-header">
        <div>Date</div>
        <div>Player</div>
        <div>Type</div>
        <div>From</div>
        <div>To</div>
        <div>Description</div>
      </div>
      <div class="tx-body">
    `;

    const rows = txs.map(t => {
      const date = fmtLocalDateOnly(t.date);
      const playerName = safeText(t.player?.name);
      const playerId = t.player?.id;

      const playerHtml = (playerId)
        ? `<a href="/player/${playerId}">${playerName}</a>`
        : playerName;

      return `
        <div class="tx-row data-row">
          <div>${date}</div>
          <div class="tx-player" style="white-space:nowrap;">${playerHtml}</div>
          <div style="white-space:nowrap;">${safeText(t.type)}</div>
          <div style="white-space:nowrap;">${safeText(t.from)}</div>
          <div style="white-space:nowrap;">${safeText(t.to)}</div>
          <div class="tx-desc" title="${escapeAttr(t.description)}">${safeText(t.description)}</div>
        </div>
      `;
    }).join("");

    return header + rows + `</div>`;
  }

  async function loadTransactions(){
    const days = document.getElementById("txDays").value;
    const container = document.getElementById("txContent");
    container.innerHTML = `<div class="muted" style="font-size:13px;">Loading transactions…</div>`;

    try{
      const res = await fetch(`/team/${TEAM_ID}/transactions_json?days=${encodeURIComponent(days)}`);
      const data = await res.json();
      const txs = data.transactions || [];
      container.innerHTML = renderTransactions(txs);
    } catch(e){
      console.error(e);
      container.innerHTML = `<div class="muted" style="font-size:13px;">Error loading transactions.</div>`;
    }
  }

  // Load when user expands Transactions
  const txDetails = document.getElementById("txDetails");
  txDetails.addEventListener("toggle", () => {
    if (txDetails.open){
      loadTransactions();
    }
  });

  // Reload when range changes (even if already open)
  document.getElementById("txDays").addEventListener("change", () => {
    if (txDetails.open){
      loadTransactions();
    }
  });
</script>

{% endblock %}
