<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{% if game %}{{ game.away.name }} @ {{ game.home.name }} — Game Report{% else %}Game Report{% endif %}</title>

  <!-- Match today's games fonts -->
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600;700&family=IBM+Plex+Mono:wght@500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#ffffff; --card:#ffffff; --muted:#5b6577; --text:#111318; --accent:#0b5cab;
      --row:#fafbfc; --rowAlt:#f4f6f9; --border:#e2e8f0;
      --header-bg:#ffffff; --header-text:#0b0e13;
      --chip-live:#e21d48; --chip-final:#32425c; --chip-upcoming:#6b7a94;
      --subtle:#8a94ab;
    }
    *{ box-sizing:border-box }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:"IBM Plex Sans", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      font-size:14px;
    }

    /* Top header */
    .game-header{
      display:grid; grid-template-columns:1fr auto 1fr; gap:24px; align-items:center;
      padding:18px 20px; border-bottom:2px solid var(--border); background:linear-gradient(180deg,#fff,#f6f9ff);
    }
    .team{
      display:grid; grid-template-columns:auto auto; align-items:center; justify-content:center; gap:14px;
    }
    .team.away{ justify-self:start; }
    .team.home{ justify-self:end; direction:rtl; } /* mirror so score sits on the left of logo visually */
    .team .logo{ width:92px; height:92px; object-fit:contain; }
    .team .score{
      font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace;
      font-variant-numeric: tabular-nums;
      font-size:42px; line-height:1; font-weight:800; letter-spacing:.5px;
      color:#0b0e13;
    }
    /* restore normal direction for inner text on home team */
    .team.home .score, .team.home .name{ direction:ltr; }

    .team .name{ font-weight:700; font-size:15px; text-align:center; color:#111318; grid-column:1 / -1; }
    .center-info{ display:grid; justify-items:center; text-align:center; gap:6px; padding:0 10px; }
    .center-info .date{ font-size:12px; color:#374151; }
    .center-info .status{ font-size:13px; font-weight:700; }
    .center-info .venue{ font-size:12px; color:#6b7280; }

    /* Chip styles to match today's games */
    .chip{ font-size:11px; padding:3px 8px; border-radius:999px; color:#fff; font-weight:700; letter-spacing:.3px; }
    .chip.live{ background:var(--chip-live); }
    .chip.final{ background:var(--chip-final); }
    .chip.upcoming{ background:var(--chip-upcoming); }

    .section{ max-width:1100px; margin:16px auto; padding:0 12px; }

    /* Inning-by-inning box (bigger than card version) */
    .ibox{
      background:var(--card); border:1px solid var(--border); border-radius:12px; overflow:hidden;
      box-shadow:0 10px 30px rgba(0,0,0,.03);
    }
    .ibox header{ padding:10px 12px; border-bottom:1px solid var(--border); background:#fff; display:flex; justify-content:space-between; align-items:center; }
    .ibox h3{ margin:0; font-size:14px; font-weight:700; color:#32425c; }
    .ibox .note{ color:var(--muted); font-size:12px; }

    .ibox table{ border-collapse:collapse; width:100%; font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace; font-size:13px; }
    .ibox thead th{ color:#5b6577; font-weight:700; border-bottom:1px solid var(--border); padding:8px 8px; text-align:center; }
    .ibox tbody td{ border-bottom:1px solid var(--border); padding:8px 8px; text-align:center; color:#394150; }
    .ibox td.name, .ibox th.name { text-align:left; font-family:"IBM Plex Sans", system-ui, -apple-system, "Segoe UI", Roboto, Arial; color:#111318; font-weight:700; }
    .ibox .wrap{ overflow:auto; background:#fff; }

    .placeholder{ padding:16px; color:#6b7280; text-align:center; }
  </style>
</head>
<body>

  {% if game %}
  <div class="game-header">
    <!-- Away: logo then score to its right -->
    <div class="team away">
      <img class="logo" src="https://www.mlbstatic.com/team-logos/{{ game.away.id }}.svg" alt="{{ game.away.name }} logo" />
      <div class="score">{{ game.away.score }}</div>
      <div class="name">{{ game.away.name }}</div>
    </div>

    <!-- Center info -->
    <div class="center-info">
      <div class="date">{{ game.date }}</div>
      <div class="status">
        {% set chip_class = 'live' if 'Top' in game.status or 'Bot' in game.status or 'MID' in game.status or 'END' in game.status else ('final' if game.status=='Final' else 'upcoming') %}
        <span class="chip {{ chip_class }}">{{ game.status }}</span>
      </div>
      <div class="venue">{{ game.venue }}</div>
    </div>

    <!-- Home: score to the left of logo (mirrored layout) -->
    <div class="team home">
      <div class="score">{{ game.home.score }}</div>
      <img class="logo" src="https://www.mlbstatic.com/team-logos/{{ game.home.id }}.svg" alt="{{ game.home.name }} logo" />
      <div class="name">{{ game.home.name }}</div>
    </div>
  </div>
  {% else %}
    <div class="placeholder">Loading game header...</div>
  {% endif %}

  <!-- Inning-by-inning box -->
  <div class="section">
    <div class="ibox" id="ibox" aria-live="polite" aria-busy="true">
      <header>
        <h3>Inning by Inning</h3>
        <div class="note" id="iboxNote">Fetching box score…</div>
      </header>
      <div class="wrap" id="iboxWrap"></div>
    </div>
  </div>

  <script>
    (async function(){
      const gamePk = {{ game_pk|int }};
      const $wrap = document.getElementById('iboxWrap');
      const $note = document.getElementById('iboxNote');
      function htmlEsc(s){ return String(s==null?'':s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

      function linescoreTable(g){
        const ls = g.linescore; if (!ls) return '';
        const n = ls.n || 9;
        const head = Array.from({length:n}, (_,i)=>`<th>${i+1}</th>`).join('');
        const aCells = Array.from({length:n}, (_,i)=>`<td>${htmlEsc(ls.away[i] ?? '')}</td>`).join('');
        const hCells = Array.from({length:n}, (_,i)=>`<td>${htmlEsc(ls.home[i] ?? '')}</td>`).join('');
        const aT = ls.totals.away, hT = ls.totals.home;

        // team labels: prefer abbr if present
        const aLbl = g.teams?.away?.abbr || 'AWY';
        const hLbl = g.teams?.home?.abbr || 'HOM';

        return `
          <table>
            <thead>
              <tr><th class="name"></th>${head}<th>R</th><th>H</th><th>E</th></tr>
            </thead>
            <tbody>
              <tr><td class="name">${htmlEsc(aLbl)}</td>${aCells}<td>${aT.R ?? ''}</td><td>${aT.H ?? ''}</td><td>${aT.E ?? ''}</td></tr>
              <tr><td class="name">${htmlEsc(hLbl)}</td>${hCells}<td>${hT.R ?? ''}</td><td>${hT.H ?? ''}</td><td>${hT.E ?? ''}</td></tr>
            </tbody>
          </table>`;
      }

      try{
        const res = await fetch("/api/game/" + gamePk, { cache: 'no-store' });
        const data = await res.json();
        const g = data.game || {};
        const hasLs = !!g.linescore;

        if (!hasLs){
          $note.textContent = g.status === 'scheduled'
            ? 'Inning-by-inning will appear at first pitch.'
            : 'No linescore available.';
          $wrap.innerHTML = '';
          document.getElementById('ibox').setAttribute('aria-busy','false');
          return;
        }

        $wrap.innerHTML = linescoreTable(g);
        $note.textContent = (g.status === 'final') ? 'Final' : g.chip || 'Live';
      }catch(err){
        console.error(err);
        $note.textContent = 'Error loading box score.';
        $wrap.innerHTML = '<div class="placeholder">Could not load inning-by-inning data.</div>';
      }finally{
        document.getElementById('ibox').setAttribute('aria-busy','false');
      }
    })();
  </script>

</body>
</html>
