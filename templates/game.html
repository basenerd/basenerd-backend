{% extends "base.html" %}
{% block content %}

{% set away = game.away if game.away is defined else {} %}
{% set home = game.home if game.home is defined else {} %}

{% if error %}
  <div class="card" style="border:1px solid rgba(239,68,68,.35); margin-bottom:14px;">
    <div class="card-header">
      <div class="card-title">Debug error</div>
      <div class="card-subtitle mono">{{ error }}</div>
    </div>
  </div>
{% endif %}

<!-- TOP: Matchup card -->
<div class="card">
  <div class="card-header" style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;">
    <div>
      <div class="card-title">
        {{ game.away.abbrev }} @ {{ game.home.abbrev }}
      </div>

      <div class="card-subtitle">
        {{ game.statusPill }}{% if game.when %}<span class="muted" style="opacity:.6;"> • </span>{{ game.when }}{% endif %}
        {% if game.venue %}<span class="muted" style="opacity:.6;"> • </span>{{ game.venue }}{% endif %}
      </div>

      <div class="muted small" style="margin-top:6px;">
        {% if away.record %}{{ away.abbrev }} {{ away.record }}{% endif %}
        {% if home.record %}<span class="muted" style="opacity:.6;"> • </span>{{ home.abbrev }} {{ home.record }}{% endif %}
      </div>

      {% if game.probables %}
        <div class="small" style="margin-top:10px;">
          <span class="mono muted">PP:</span>
          {% if game.probables.away %} {{ away.abbrev }} {{ game.probables.away }}{% endif %}
          {% if game.probables.home %}<span class="muted" style="opacity:.6;"> • </span>{{ home.abbrev }} {{ game.probables.home }}{% endif %}
        </div>
      {% endif %}

      {% if game.decisions %}
        <div class="small" style="margin-top:6px;">
          <span class="mono muted">Decisions:</span>
          {% if game.decisions.w %} W {{ game.decisions.w }}{% endif %}
          {% if game.decisions.l %}<span class="muted" style="opacity:.6;"> • </span>L {{ game.decisions.l }}{% endif %}
          {% if game.decisions.s %}<span class="muted" style="opacity:.6;"> • </span>S {{ game.decisions.s }}{% endif %}
        </div>
      {% endif %}
    </div>

    <div style="display:flex; align-items:center; gap:10px;">
      {% if away.logo_url %}
        <img class="teamlogo" src="{{ away.logo_url }}" alt="{{ away.abbrev }} logo" style="height:34px;">
      {% endif %}
      <span class="muted" style="opacity:.7;">@</span>
      {% if home.logo_url %}
        <img class="teamlogo" src="{{ home.logo_url }}" alt="{{ home.abbrev }} logo" style="height:34px;">
      {% endif %}
    </div>
  </div>
</div>

<!-- Tabs -->
<div class="tabs" style="margin-top:14px;">
  <button class="tab-btn active" data-tab="overview">Overview</button>
  <button class="tab-btn" data-tab="box">Box</button>
  <button class="tab-btn" data-tab="scoring">Scoring</button>
  <button class="tab-btn" data-tab="pbp">Play-by-Play</button>
</div>

<!-- OVERVIEW -->
<div class="tab-panel active" id="tab-overview">
  {% set innings = (game.linescore.innings if game.linescore and game.linescore.innings is defined else []) %}
  {% if innings %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Linescore</div>
        <div class="card-subtitle">By inning</div>
      </div>
      <div style="padding: 0 14px 14px 14px; overflow-x:auto;">
        <table class="tbl">
          <thead>
            <tr>
              <th></th>
              {% for inn in innings %}
                <th class="mono" style="text-align:center;">{{ inn.num }}</th>
              {% endfor %}
              <th class="mono" style="text-align:center;">R</th>
              <th class="mono" style="text-align:center;">H</th>
              <th class="mono" style="text-align:center;">E</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="mono">
                {% if away.logo_url %}<img class="teamlogo" src="{{ away.logo_url }}" style="height:18px; vertical-align:middle; margin-right:6px;">{% endif %}
                {{ away.abbrev }}
              </td>
              {% for inn in innings %}
                <td class="mono" style="text-align:center;">{{ (inn.away.runs if inn.away is defined else "") }}</td>
              {% endfor %}
              <td class="mono" style="text-align:center;">{{ game.linescore.teams.away.runs }}</td>
              <td class="mono" style="text-align:center;">{{ game.linescore.teams.away.hits }}</td>
              <td class="mono" style="text-align:center;">{{ game.linescore.teams.away.errors }}</td>
            </tr>
            <tr>
              <td class="mono">
                {% if home.logo_url %}<img class="teamlogo" src="{{ home.logo_url }}" style="height:18px; vertical-align:middle; margin-right:6px;">{% endif %}
                {{ home.abbrev }}
              </td>
              {% for inn in innings %}
                <td class="mono" style="text-align:center;">{{ (inn.home.runs if inn.home is defined else "") }}</td>
              {% endfor %}
              <td class="mono" style="text-align:center;">{{ game.linescore.teams.home.runs }}</td>
              <td class="mono" style="text-align:center;">{{ game.linescore.teams.home.hits }}</td>
              <td class="mono" style="text-align:center;">{{ game.linescore.teams.home.errors }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  {% else %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Overview</div>
        <div class="card-subtitle">Linescore not available for this status yet.</div>
      </div>
    </div>
  {% endif %}
</div>

<!-- BOX -->
<div class="tab-panel" id="tab-box">
  {% if not game.box %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Box</div>
        <div class="card-subtitle">Not available for this status yet.</div>
      </div>
    </div>
  {% else %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Box</div>
        <div class="card-subtitle">Batting + pitching</div>
      </div>

      <div style="padding: 0 14px 14px 14px;">
        <div class="grid2">
          <div>
            <div class="mono muted small" style="margin: 8px 0 6px 0;">{{ away.abbrev }} Batting</div>
            <div style="overflow-x:auto;">
              <table class="tbl">
                <thead>
                  <tr>
                    <th>Player</th>
                    <th class="mono">AB</th><th class="mono">R</th><th class="mono">H</th><th class="mono">RBI</th>
                    <th class="mono">BB</th><th class="mono">SO</th><th class="mono">HR</th><th class="mono">AVG</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in game.box.away.batting %}
                    <tr>
                      <td>
                        {% if r.playerId %}<a href="/player/{{ r.playerId }}">{{ r.name }}</a>{% else %}{{ r.name }}{% endif %}
                        {% if r.pos %}<span class="muted small"> {{ r.pos }}</span>{% endif %}
                      </td>
                      <td class="mono">{{ r.AB }}</td><td class="mono">{{ r.R }}</td><td class="mono">{{ r.H }}</td><td class="mono">{{ r.RBI }}</td>
                      <td class="mono">{{ r.BB }}</td><td class="mono">{{ r.SO }}</td><td class="mono">{{ r.HR }}</td><td class="mono">{{ r.AVG }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="mono muted small" style="margin: 16px 0 6px 0;">{{ away.abbrev }} Pitching</div>
            <div style="overflow-x:auto;">
              <table class="tbl">
                <thead>
                  <tr>
                    <th>Pitcher</th>
                    <th class="mono">IP</th><th class="mono">H</th><th class="mono">R</th><th class="mono">ER</th>
                    <th class="mono">BB</th><th class="mono">SO</th><th class="mono">HR</th><th class="mono">ERA</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in game.box.away.pitching %}
                    <tr>
                      <td>{% if r.playerId %}<a href="/player/{{ r.playerId }}">{{ r.name }}</a>{% else %}{{ r.name }}{% endif %}</td>
                      <td class="mono">{{ r.IP }}</td><td class="mono">{{ r.H }}</td><td class="mono">{{ r.R }}</td><td class="mono">{{ r.ER }}</td>
                      <td class="mono">{{ r.BB }}</td><td class="mono">{{ r.SO }}</td><td class="mono">{{ r.HR }}</td><td class="mono">{{ r.ERA }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div>
            <div class="mono muted small" style="margin: 8px 0 6px 0;">{{ home.abbrev }} Batting</div>
            <div style="overflow-x:auto;">
              <table class="tbl">
                <thead>
                  <tr>
                    <th>Player</th>
                    <th class="mono">AB</th><th class="mono">R</th><th class="mono">H</th><th class="mono">RBI</th>
                    <th class="mono">BB</th><th class="mono">SO</th><th class="mono">HR</th><th class="mono">AVG</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in game.box.home.batting %}
                    <tr>
                      <td>
                        {% if r.playerId %}<a href="/player/{{ r.playerId }}">{{ r.name }}</a>{% else %}{{ r.name }}{% endif %}
                        {% if r.pos %}<span class="muted small"> {{ r.pos }}</span>{% endif %}
                      </td>
                      <td class="mono">{{ r.AB }}</td><td class="mono">{{ r.R }}</td><td class="mono">{{ r.H }}</td><td class="mono">{{ r.RBI }}</td>
                      <td class="mono">{{ r.BB }}</td><td class="mono">{{ r.SO }}</td><td class="mono">{{ r.HR }}</td><td class="mono">{{ r.AVG }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="mono muted small" style="margin: 16px 0 6px 0;">{{ home.abbrev }} Pitching</div>
            <div style="overflow-x:auto;">
              <table class="tbl">
                <thead>
                  <tr>
                    <th>Pitcher</th>
                    <th class="mono">IP</th><th class="mono">H</th><th class="mono">R</th><th class="mono">ER</th>
                    <th class="mono">BB</th><th class="mono">SO</th><th class="mono">HR</th><th class="mono">ERA</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in game.box.home.pitching %}
                    <tr>
                      <td>{% if r.playerId %}<a href="/player/{{ r.playerId }}">{{ r.name }}</a>{% else %}{{ r.name }}{% endif %}</td>
                      <td class="mono">{{ r.IP }}</td><td class="mono">{{ r.H }}</td><td class="mono">{{ r.R }}</td><td class="mono">{{ r.ER }}</td>
                      <td class="mono">{{ r.BB }}</td><td class="mono">{{ r.SO }}</td><td class="mono">{{ r.HR }}</td><td class="mono">{{ r.ERA }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

          </div>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<!-- SCORING -->
<div class="tab-panel" id="tab-scoring">
  {% if not game.scoring %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Scoring</div>
        <div class="card-subtitle">Not available for this status yet.</div>
      </div>
    </div>
  {% else %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Scoring plays</div>
        <div class="card-subtitle">{{ game.scoring|length }} plays</div>
      </div>
      <div style="padding: 0 14px 14px 14px;">
        {% for x in game.scoring %}
          <div class="row" style="padding:10px 0; border-bottom:1px solid rgba(226,232,240,.7);">
            <div class="mono muted small">{{ x.half }} {{ x.inning }}</div>
            <div style="margin-top:3px;">{{ x.description }}</div>
            <div class="mono muted small" style="margin-top:3px;">{{ x.awayScore }}-{{ x.homeScore }}</div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}
</div>

<!-- PLAY-BY-PLAY (consolidated PA-style UI) -->
<div class="tab-panel" id="tab-pbp">
  {% if not game.pas %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Play-by-Play</div>
        <div class="card-subtitle">Not available for this status yet.</div>
      </div>
    </div>
  {% else %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Play-by-Play</div>
        <div class="card-subtitle">Grouped by inning • each at-bat includes pitch table + strike zone</div>
      </div>

      <div style="padding: 0 14px 14px 14px;">

        {# Build ordered unique inning list #}
        {% set ns = namespace(innings=[]) %}
        {% for pa in game.pas %}
          {% if pa.inning and (pa.inning not in ns.innings) %}
            {% set _ = ns.innings.append(pa.inning) %}
          {% endif %}
        {% endfor %}

        {% for inn in ns.innings %}
          <details class="inning-details" open style="margin-top:10px;">
            <summary class="inning-summary">
              <span class="mono">Inning {{ inn }}</span>
              <span class="muted small">Top + Bottom</span>
            </summary>

            <div style="margin-top:10px;">
              <div class="mono muted small" style="margin: 6px 0;">Top</div>
              {% set any_top = false %}
              {% for pa in game.pas %}
                {% if pa.inning == inn and pa.half == "Top" %}
                  {% set any_top = true %}
                  <details class="pa-details" style="margin-bottom:10px;">
                    <summary class="pa-summary">
                      <div class="pa-left">
                        <span>{{ pa.description or pa.event or "" }}</span>
                      </div>
                      <div class="pa-right">
                        <span class="mono">{{ pa.event or "" }}</span>
                        {% if pa.rbi is not none %}<span class="muted" style="opacity:.6;">•</span><span class="mono muted">RBI {{ pa.rbi }}</span>{% endif %}
                        <span class="muted" style="opacity:.6;">•</span>
                        <span class="mono">{{ pa.awayScore }}-{{ pa.homeScore }}</span>
                      </div>
                    </summary>

                    {% if pa.pitches %}
                      <div class="pa-grid">
                        <div class="zone-wrap">
                          <div class="zone-title">Strike zone</div>
                          <svg class="zone-plot"
                               width="160" height="210"
                               data-pitches='{{ pa.pitches|tojson }}'>
                          </svg>
                          <div class="muted small" style="margin-top:6px;">
                            Vertical axis is relative to the hitter's strike zone (0 = bottom of zone). Colors: ball/strike/foul/in-play.
                          </div>
                        </div>

                        <div class="table-wrap">
                          <div class="zone-title">Pitches</div>
                          <div style="overflow-x:auto;">
                            <table class="tbl">
                              <thead>
                                <tr>
                                  <th class="mono">#</th>
                                  <th class="mono">Type</th>
                                  <th class="mono">MPH</th>
                                  <th>Call</th>
                                  <th class="mono">pX</th>
                                  <th class="mono">pZ</th>
                                  <th class="mono">Count</th>
                                </tr>
                              </thead>
                              <tbody>
                                {% for p in pa.pitches %}
                                  <tr>
                                    <td class="mono">{{ p.n }}</td>
                                    <td class="mono">{{ p.type }}</td>
                                    <td class="mono">{{ p.mph }}</td>
                                    <td>{{ p.call }}</td>
                                    <td class="mono">{{ "%.2f"|format(p.px) if p.px is not none else "" }}</td>
                                    <td class="mono">{{ "%.2f"|format(p.pz) if p.pz is not none else "" }}</td>
                                    <td class="mono">{{ p.balls }}-{{ p.strikes }}</td>
                                  </tr>
                                {% endfor %}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  </details>
                {% endif %}
              {% endfor %}
              {% if not any_top %}
                <div class="muted small" style="margin: 6px 0 0 0;">No plays recorded.</div>
              {% endif %}

              <div class="mono muted small" style="margin: 14px 0 6px 0;">Bottom</div>
              {% set any_bot = false %}
              {% for pa in game.pas %}
                {% if pa.inning == inn and pa.half == "Bottom" %}
                  {% set any_bot = true %}
                  <details class="pa-details" style="margin-bottom:10px;">
                    <summary class="pa-summary">
                      <div class="pa-left">
                        <span>{{ pa.description or pa.event or "" }}</span>
                      </div>
                      <div class="pa-right">
                        <span class="mono">{{ pa.event or "" }}</span>
                        {% if pa.rbi is not none %}<span class="muted" style="opacity:.6;">•</span><span class="mono muted">RBI {{ pa.rbi }}</span>{% endif %}
                        <span class="muted" style="opacity:.6;">•</span>
                        <span class="mono">{{ pa.awayScore }}-{{ pa.homeScore }}</span>
                      </div>
                    </summary>

                    {% if pa.pitches %}
                      <div class="pa-grid">
                        <div class="zone-wrap">
                          <div class="zone-title">Strike zone</div>
                          <svg class="zone-plot"
                               width="160" height="210"
                               data-pitches='{{ pa.pitches|tojson }}'>
                          </svg>
                          <div class="muted small" style="margin-top:6px;">
                            Vertical axis is relative to the hitter's strike zone (0 = bottom of zone). Colors: ball/strike/foul/in-play.
                          </div>
                        </div>

                        <div class="table-wrap">
                          <div class="zone-title">Pitches</div>
                          <div style="overflow-x:auto;">
                            <table class="tbl">
                              <thead>
                                <tr>
                                  <th class="mono">#</th>
                                  <th class="mono">Type</th>
                                  <th class="mono">MPH</th>
                                  <th>Call</th>
                                  <th class="mono">pX</th>
                                  <th class="mono">pZ</th>
                                  <th class="mono">Count</th>
                                </tr>
                              </thead>
                              <tbody>
                                {% for p in pa.pitches %}
                                  <tr>
                                    <td class="mono">{{ p.n }}</td>
                                    <td class="mono">{{ p.type }}</td>
                                    <td class="mono">{{ p.mph }}</td>
                                    <td>{{ p.call }}</td>
                                    <td class="mono">{{ "%.2f"|format(p.px) if p.px is not none else "" }}</td>
                                    <td class="mono">{{ "%.2f"|format(p.pz) if p.pz is not none else "" }}</td>
                                    <td class="mono">{{ p.balls }}-{{ p.strikes }}</td>
                                  </tr>
                                {% endfor %}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  </details>
                {% endif %}
              {% endfor %}
              {% if not any_bot %}
                <div class="muted small" style="margin: 6px 0 0 0;">No plays recorded.</div>
              {% endif %}

            </div>
          </details>
        {% endfor %}

      </div>
    </div>
  {% endif %}
</div>

<script>
  // Tabs
  (function(){
    const btns = Array.from(document.querySelectorAll(".tab-btn"));
    const panels = {
      overview: document.getElementById("tab-overview"),
      box: document.getElementById("tab-box"),
      scoring: document.getElementById("tab-scoring"),
      pbp: document.getElementById("tab-pbp"),
    };

    btns.forEach(b => {
      b.addEventListener("click", () => {
        btns.forEach(x => x.classList.remove("active"));
        b.classList.add("active");
        const t = b.getAttribute("data-tab");
        Object.keys(panels).forEach(k => panels[k].classList.toggle("active", k === t));
      });
    });
  })();

  // Strike zone plots (zone-relative vertical axis)
  (function(){
    function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

    function drawZone(svg, pitches){
      const wAttr = svg.getAttribute("width");
      const hAttr = svg.getAttribute("height");
      const W = Number(wAttr || 160);
      const H = Number(hAttr || 210);

      // Layout
      const pad = 18;
      const zx = pad, zy = pad;
      const zw = W - pad*2, zh = H - pad*2;

      // Clear
      while (svg.firstChild) svg.removeChild(svg.firstChild);

      // Background
      const bg = document.createElementNS("http://www.w3.org/2000/svg","rect");
      bg.setAttribute("x", 0); bg.setAttribute("y", 0);
      bg.setAttribute("width", W); bg.setAttribute("height", H);
      bg.setAttribute("rx", 14);
      bg.setAttribute("fill", "rgba(255,255,255,.9)");
      bg.setAttribute("stroke", "rgba(226,232,240,.9)");
      svg.appendChild(bg);

      // Determine hitter-specific zone edges (feet off ground)
      const DEFAULT_TOP = 3.5, DEFAULT_BOT = 1.5;
      let szTop = DEFAULT_TOP, szBot = DEFAULT_BOT;
      for (const p of (pitches || [])){
        const t = Number(p.sz_top), b = Number(p.sz_bot);
        if (Number.isFinite(t) && Number.isFinite(b) && t > b){
          szTop = t; szBot = b;
          break;
        }
      }

      // Zone-relative vertical axis:
      // y=0 corresponds to sz_bot; y=zoneH corresponds to sz_top
      const zoneH = Math.max(0.1, szTop - szBot);

      // "Canvas" ranges (bigger than the strike zone)
      const xMin = -1.5, xMax =  1.5;      // feet, centered at 0
      const yMin = -1.0, yMax = zoneH + 1.0; // zone-relative feet

      function xToSvg(xFeet){
        return zx + ((clamp(xFeet, xMin, xMax) - xMin) / (xMax - xMin)) * zw;
      }
      function yToSvg(yRel){
        return zy + (1.0 - ((clamp(yRel, yMin, yMax) - yMin) / (yMax - yMin))) * zh;
      }

      // Strike zone rectangle (true horizontal edges, and vertical edges in zone-relative units)
      const ZLEFT = -0.83, ZRIGHT = 0.83;
      const zone = document.createElementNS("http://www.w3.org/2000/svg","rect");
      zone.setAttribute("x", xToSvg(ZLEFT));
      zone.setAttribute("y", yToSvg(zoneH));
      zone.setAttribute("width", xToSvg(ZRIGHT) - xToSvg(ZLEFT));
      zone.setAttribute("height", yToSvg(0) - yToSvg(zoneH));
      zone.setAttribute("fill", "rgba(15,23,42,.04)");
      zone.setAttribute("stroke", "rgba(15,23,42,.22)");
      zone.setAttribute("rx", 10);
      svg.appendChild(zone);

      function outcomeColor(p){
        const call = String(p.call || "").toLowerCase();
        const desc = String(p.desc || "").toLowerCase();
        const inPlay = (p.isInPlay === true) || desc.includes("in play") || call.includes("in play");
        if (inPlay) return "rgba(37,99,235,.85)"; // blue: in play
        if (call.includes("foul") || desc.includes("foul")) return "rgba(100,116,139,.85)"; // gray: foul
        if ((p.isBall === true) || call.includes("ball")) return "rgba(34,197,94,.85)"; // green: ball
        if ((p.isStrike === true) || call.includes("strike")) return "rgba(239,68,68,.85)"; // red: strike
        return "rgba(239,68,68,.85)";
      }

      // Plot dots using pX (feet) and pZ (feet off ground) converted to zone-relative:
      // yRel = pz - sz_bot
      (pitches || []).forEach((p) => {
        if (p.px == null || p.pz == null) return;

        const xFeet = Number(p.px);
        const pzAbs = Number(p.pz);
        if (!Number.isFinite(xFeet) || !Number.isFinite(pzAbs)) return;

        const yRel = pzAbs - szBot;

        const x = xToSvg(xFeet);
        const y = yToSvg(yRel);

        const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
        c.setAttribute("cx", x);
        c.setAttribute("cy", y);
        c.setAttribute("r", 6.0);
        c.setAttribute("fill", outcomeColor(p));
        c.setAttribute("stroke", "rgba(15,23,42,.35)");
        svg.appendChild(c);

        // sequence number
        const t = document.createElementNS("http://www.w3.org/2000/svg","text");
        t.setAttribute("x", x);
        t.setAttribute("y", y);
        t.setAttribute("text-anchor", "middle");
        t.setAttribute("dominant-baseline", "middle");
        t.setAttribute("font-size", "7");
        t.setAttribute("font-family", "IBM Plex Mono, ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace");
        t.setAttribute("fill", "rgba(255,255,255,.95)");
        t.setAttribute("stroke", "rgba(15,23,42,.45)");
        t.setAttribute("stroke-width", "2");
        t.setAttribute("paint-order", "stroke");
        t.textContent = String(p.n || "");
        svg.appendChild(t);
      });
    }

    document.querySelectorAll(".zone-plot").forEach(svg => {
      let pitches = [];
      try { pitches = JSON.parse(svg.getAttribute("data-pitches") || "[]"); } catch(e) {}
      drawZone(svg, pitches);
    });
  })();
</script>

{% endblock %}
