<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{% if game %}{{ game.away.name }} @ {{ game.home.name }} — Game Report{% else %}Game Report{% endif %}</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600;700&family=IBM+Plex+Mono:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#ffffff; --card:#ffffff; --muted:#5b6577; --text:#111318;
      --border:#e2e8f0; --chip-live:#e21d48; --chip-final:#32425c; --chip-upcoming:#6b7a94;
      --row:#fafbfc; --rowAlt:#f4f6f9;
    }
    *{ box-sizing:border-box }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:"IBM Plex Sans", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      font-size:14px;
    }

    /* Header */
    .game-header{
      display:grid;
      grid-template-columns: 1fr minmax(240px, 360px) 1fr;
      gap: 36px;
      align-items:center;
      padding:18px 20px;
      border-bottom:2px solid var(--border);
      background:linear-gradient(180deg,#fff,#f6f9ff);
    }
    .team { display:flex; flex-direction:column; align-items:center; gap:6px; }
    .team-top{ display:flex; align-items:center; gap:10px; }
    .team.away .team-top{ flex-direction:row; }     /* Away: logo | score (inside) */
    .team.home .team-top{ flex-direction:row; }     /* Home: score | logo (inside) */

    .logo{ width:96px; height:96px; object-fit:contain; }
    .score{
      font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace;
      font-variant-numeric: tabular-nums;
      font-size:64px; line-height:1; font-weight:800;
    }
    .record{ font-size:1.0rem; font-weight:600; text-align:center; margin-top:-2px; }
    .name{ font-size:15px; font-weight:700; text-align:center; }

    .center-info{ display:grid; justify-items:center; text-align:center; gap:4px; }
    .center-info .date{ font-size:12px; color:#374151; }
    .center-info .status{ font-size:13px; font-weight:700; }
    .center-info .venue{ font-size:12px; color:#6b7280; }
    .chip{ font-size:11px; padding:3px 8px; border-radius:999px; color:#fff; font-weight:700; }
    .chip.live{ background:var(--chip-live); }
    .chip.final{ background:var(--chip-final); }
    .chip.upcoming{ background:var(--chip-upcoming); }

    /* Sections */
    .section{ max-width:860px; margin:18px auto; padding:0 12px; }
    .ibox, .box { background:var(--card); border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .ibox .wrap{ overflow:auto; background:#fff; }

    /* Inning-by-inning */
    .ibox table{
      border-collapse:collapse; width:100%;
      font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace; font-size:13px;
    }
    .ibox thead th{
      color:#5b6577; font-weight:700; border-bottom:1px solid var(--border);
      padding:8px; text-align:center;
    }
    .ibox tbody td{
      border-bottom:1px solid var(--border); padding:8px; text-align:center; color:#394150;
    }
    .ibox td.name, .ibox th.name{
      text-align:left; font-family:"IBM Plex Sans", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      color:#111318; font-weight:700;
    }
    .ibox td.rhe, .ibox th.rhe{ font-weight:800; }
    .placeholder{ padding:16px; color:#6b7280; text-align:center; }

    /* Detailed player box score */
    .boxwrap{ display:grid; gap:12px; padding:10px; background:#fff; }

    .two-up{
      display:grid; grid-template-columns:1fr 1fr; gap:12px;
    }
    @media(max-width:900px){
      .two-up{ grid-template-columns:1fr; }
    }

    .teamhdr{
      text-align:left; font-weight:700; color:#394150;
      padding:6px 6px; border-bottom:1px solid var(--border);
    }
    .batters, .pitchers {
      overflow:auto; background:#fff; border:1px solid var(--border); border-radius:10px;
    }
    .batters table, .pitchers table{
      width:100%; border-collapse:collapse; font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace; font-size:12.5px;
    }
    .batters thead th, .pitchers thead th{
      color:#5b6577; font-weight:700; border-bottom:1px solid var(--border); padding:6px 6px; text-align:center;
    }
    .batters tbody td, .pitchers tbody td{
      border-bottom:1px solid var(--border); padding:6px 6px; text-align:center; color:#394150;
    }
    .batters td.name, .batters th.name, .pitchers td.name, .pitchers th.name{
      text-align:left; font-weight:600; color:#111318; font-family:"IBM Plex Sans", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    .batters td.pos, .pitchers td.pos, .batters th.pos, .pitchers th.pos{ color:#8a94ab; font-weight:700; text-transform:uppercase; text-align:left; }
    .indent .name { padding-left:16px; position:relative; }
    .indent .name::before{
      content:"";
      position:absolute; left:6px; top:50%;
      width:8px; height:0;
      border-top:1px solid var(--border);
      transform:translateY(-50%);
    }

    /* Decision badges */
    .badge{
      display:inline-block;
      font-size:10px;
      font-weight:700;
      color:#6b7280;
      border:1px solid var(--border);
      background:#f8fafc;
      padding:1px 6px;
      border-radius:999px;
      margin-left:6px;
      vertical-align:middle;
    }
  </style>
</head>
<body>

  {% if game %}
  <div class="game-header">
    <!-- Away: logo | score (inside) -->
    <div class="team away">
      <div class="team-top">
        <img class="logo" src="https://www.mlbstatic.com/team-logos/{{ game.away.id }}.svg" alt="{{ game.away.name }} logo" />
        <div class="score">{{ game.away.score }}</div>
      </div>
      <div class="record">{{ game.away.record }}</div>
      <div class="name">{{ game.away.name }}</div>
    </div>

    <!-- Center info -->
    <div class="center-info">
      <div class="date">{{ game.date or '' }}</div>
      {% set chip_class = 'live' if 'Top' in game.status or 'Bot' in game.status or 'MID' in game.status or 'END' in game.status else ('final' if game.status=='Final' else 'upcoming') %}
      <div class="status"><span class="chip {{ chip_class }}">{{ game.status or '' }}</span></div>
      <div class="venue">{{ game.venue or '' }}</div>
    </div>

    <!-- Home: score | logo (inside) -->
    <div class="team home">
      <div class="team-top">
        <div class="score">{{ game.home.score }}</div>
        <img class="logo" src="https://www.mlbstatic.com/team-logos/{{ game.home.id }}.svg" alt="{{ game.home.name }} logo" />
      </div>
      <div class="record">{{ game.home.record }}</div>
      <div class="name">{{ game.home.name }}</div>
    </div>
  </div>

  <!-- Inning-by-inning + Detailed player box score -->
  <div class="section">
    <!-- Inning-by-inning -->
    <div class="ibox" id="ibox" aria-live="polite" aria-busy="true">
      <div class="wrap" id="iboxWrap"></div>
    </div>

    <!-- Detailed player box score (two-up layout) -->
    <div class="box" id="playerBox" style="margin-top:12px;">
      <div class="boxwrap" id="playerBoxWrap">
        <!-- Filled by JS -->
      </div>
    </div>
  </div>

  <script>
    (async function(){
      const gamePk = {{ game_pk|int }};
      const $iboxWrap = document.getElementById('iboxWrap');
      const $ibox = document.getElementById('ibox');
      const $pwrap = document.getElementById('playerBoxWrap');

      function esc(s){ return String(s==null?'':s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
      function shortName(full){
        if(!full) return '';
        const parts = String(full).trim().split(/\s+/);
        if(parts.length === 1) return parts[0];
        const last = parts.pop(); const first = parts.shift();
        const initial = first ? first[0].toUpperCase() + '.' : '';
        return `${initial} ${last}`;
      }
      function lastName(full){
        if(!full) return '';
        const parts = String(full).trim().split(/\s+/);
        return parts[parts.length-1].replace(/[^\w'-]/g,'');
      }

      /* --- Extract decision names (W/L/SV) from final lines we already expose --- */
      function decisionsFromGame(g){
        let w='', l='', sv='';
        const sides = ['home', 'away'];
        for (const side of sides){
          const t = g?.teams?.[side] || {};
          const winStr = t.finalPitcher || '';
          const loseStr = t.finalPitcher || '';
          const saveStr = t.savePitcher || '';

          if (/^W:\s*/.test(winStr)) {
            const m = winStr.replace(/^W:\s*/,'').match(/^([^•(]+?)(?:\s*[•(]|$)/);
            if (m) w = m[1].trim();
          }
          if (/^L:\s*/.test(loseStr)) {
            const m = loseStr.replace(/^L:\s*/,'').match(/^([^•(]+?)(?:\s*[•(]|$)/);
            if (m) l = m[1].trim();
          }
          if (/^SV:\s*/.test(saveStr)) {
            const m = saveStr.replace(/^SV:\s*/,'').match(/^([^()]+?)(?:\s*\(|$)/);
            if (m) sv = m[1].trim();
          }
        }
        return {
          wLast: lastName(w),
          lLast: lastName(l),
          svLast: lastName(sv)
        };
      }

      /* ---------- Inning-by-inning ---------- */
      function linescoreTable(g){
        const ls = g.linescore; if (!ls) return '';
        const n = ls.n || 9;
        const headInnings = Array.from({length:n}, (_,i)=>`<th>${i+1}</th>`).join('');
        const aCells = Array.from({length:n}, (_,i)=>`<td>${esc(ls.away[i] ?? '')}</td>`).join('');
        const hCells = Array.from({length:n}, (_,i)=>`<td>${esc(ls.home[i] ?? '')}</td>`).join('');
        const aT = ls.totals.away || {}, hT = ls.totals.home || {};
        const aLbl = g.teams?.away?.abbr || 'AWY';
        const hLbl = g.teams?.home?.abbr || 'HOM';

        return `
          <table>
            <thead>
              <tr>
                <th class="name"></th>
                ${headInnings}
                <th class="rhe">R</th><th class="rhe">H</th><th class="rhe">E</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="name">${esc(aLbl)}</td>
                ${aCells}
                <td class="rhe">${aT.R ?? ''}</td>
                <td class="rhe">${aT.H ?? ''}</td>
                <td class="rhe">${aT.E ?? ''}</td>
              </tr>
              <tr>
                <td class="name">${esc(hLbl)}</td>
                ${hCells}
                <td class="rhe">${hT.R ?? ''}</td>
                <td class="rhe">${hT.H ?? ''}</td>
                <td class="rhe">${hT.E ?? ''}</td>
              </tr>
            </tbody>
          </table>`;
      }

      /* ---------- Batters (two-up; with sub indentation) ---------- */
      function battersTable(teamAbbr, rows){
        if (!rows || !rows.length) {
          return `
            <div class="batters">
              <div class="teamhdr">${esc(teamAbbr)} — Batting</div>
              <div style="padding:10px">No batter stats yet.</div>
            </div>`;
        }
        const enriched = rows.map((r, i) => ({...r, _idx: i}));
        enriched.sort((a,b) => {
          const ao = (a.orderCode ?? 9999), bo = (b.orderCode ?? 9999);
          if (ao !== bo) return ao - bo;
          return a._idx - b._idx;
        });

        let htmlRows = '';
        let lastOrder = null, lastPos = null;

        for (const r of enriched) {
          const curOrder = (r.orderCode ?? null);
          const indent = (curOrder != null)
            ? (lastOrder != null && curOrder === lastOrder)
            : (lastPos != null && r.pos && r.pos === lastPos);

          htmlRows += `
            <tr ${indent ? 'class="indent"' : ''}>
              <td class="pos">${esc(r.pos||'')}</td>
              <td class="name">${esc(shortName(r.name)||'')}</td>
              <td>${r.ab ?? ''}</td>
              <td>${r.r ?? ''}</td>
              <td>${r.h ?? ''}</td>
              <td>${r.rbi ?? ''}</td>
              <td>${r.bb ?? ''}</td>
              <td>${r.k ?? ''}</td>
            </tr>
          `;
          lastOrder = curOrder != null ? curOrder : lastOrder;
          lastPos = r.pos || lastPos;
        }

        return `
          <div class="batters">
            <div class="teamhdr">${esc(teamAbbr)} — Batting</div>
            <table>
              <thead>
                <tr><th class="pos">POS</th><th class="name">Player</th><th>AB</th><th>R</th><th>H</th><th>RBI</th><th>BB</th><th>K</th></tr>
              </thead>
              <tbody>${htmlRows}</tbody>
            </table>
          </div>`;
      }

      /* ---------- Pitchers (two-up; with decision badges) ---------- */
      function pitchersTable(teamAbbr, rows, badges){
        if (!rows || !rows.length) {
          return `
            <div class="pitchers">
              <div class="teamhdr">${esc(teamAbbr)} — Pitching</div>
              <div style="padding:10px">No pitching stats yet.</div>
            </div>`;
        }
        const trs = rows.map(r => {
          const lname = lastName(r.name||'').toLowerCase();
          let badge = '';
          if (lname && badges){
            if (badges.wLast && lname === badges.wLast.toLowerCase()) badge = '<span class="badge">W</span>';
            else if (badges.lLast && lname === badges.lLast.toLowerCase()) badge = '<span class="badge">L</span>';
            else if (badges.svLast && lname === badges.svLast.toLowerCase()) badge = '<span class="badge">SV</span>';
          }
          return `
            <tr ${r.indent ? 'class="indent"' : ''}>
              <td class="pos">${esc(r.pos||'P')}</td>
              <td class="name">${esc(shortName(r.name)||'')}${badge}</td>
              <td>${r.ip ?? ''}</td>
              <td>${r.h ?? ''}</td>
              <td>${r.r ?? ''}</td>
              <td>${r.er ?? ''}</td>
              <td>${r.bb ?? ''}</td>
              <td>${r.k ?? ''}</td>
              <td>${r.hr ?? ''}</td>
              <td>${r.p ?? ''}</td>
            </tr>
          `;
        }).join('');
        return `
          <div class="pitchers">
            <div class="teamhdr">${esc(teamAbbr)} — Pitching</div>
            <table>
              <thead>
                <tr><th class="pos">POS</th><th class="name">Pitcher</th><th>IP</th><th>H</th><th>R</th><th>ER</th><th>BB</th><th>K</th><th>HR</th><th>P</th></tr>
              </thead>
              <tbody>${trs}</tbody>
            </table>
          </div>`;
      }

      try{
        const res = await fetch("/api/game/" + gamePk, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const g = data.game || {};

        // Inning-by-inning
        const iboxHTML = (g && g.linescore)
          ? linescoreTable(g)
          : '<div class="placeholder">Inning-by-inning will appear at first pitch.</div>';
        $iboxWrap.innerHTML = iboxHTML;

        // Detailed player box score (two columns for batting, two columns for pitching)
        const awayAbbr = g?.teams?.away?.abbr || 'AWY';
        const homeAbbr = g?.teams?.home?.abbr || 'HOM';
        const awayBat = g?.batters?.away || [];
        const homeBat = g?.batters?.home || [];
        const awayPit = g?.pitchers?.away || [];
        const homePit = g?.pitchers?.home || [];

        const badges = decisionsFromGame(g);

        const playerHTML = `
          <div class="two-up">
            ${battersTable(awayAbbr, awayBat)}
            ${battersTable(homeAbbr, homeBat)}
          </div>
          <div class="two-up">
            ${pitchersTable(awayAbbr, awayPit, badges)}
            ${pitchersTable(homeAbbr, homePit, badges)}
          </div>
        `;
        $pwrap.innerHTML = playerHTML;

      }catch(err){
        console.error(err);
        $iboxWrap.innerHTML = '<div class="placeholder">Could not load inning-by-inning data.</div>';
        $pwrap.innerHTML = '<div class="placeholder">Could not load player box score.</div>';
      }finally{
        $ibox.setAttribute('aria-busy','false');
      }
    })();
  </script>

  {% else %}
    <div class="placeholder">Loading game header...</div>
  {% endif %}

</body>
</html>
