<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ game.away.name }} @ {{ game.home.name }} — Game Report</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#ffffff; --card:#ffffff; --muted:#5b6577; --text:#111318; --accent:#0b5cab;
      --row:#fafbfc; --rowAlt:#f4f6f9; --border:#e2e8f0; --subtle:#8a94ab;
      --chip-live:#e21d48; --chip-final:#32425c; --chip-upcoming:#6b7a94;
      --badge:#eef0f4; --badge-text:#394150;
    }
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--text); font-family:"IBM Plex Sans",-apple-system,Segoe UI,Roboto,Arial; }
    .wrap{ max-width:1150px; margin:20px auto; padding:0 14px; }

    /* Header: [away logo] [away score] [center] [home score] [home logo] */
    .header{
      display:grid; grid-template-columns:auto auto 1fr auto auto; align-items:center; gap:16px; margin-bottom:14px;
    }
    .logo{ width:84px; height:84px; object-fit:contain; }
    .big-score{ font-family:"IBM Plex Mono",ui-monospace,Menlo,monospace; font-weight:800; font-size:46px; line-height:1; min-width:46px; text-align:center; }
    .center-info{ display:flex; flex-direction:column; align-items:center; gap:6px; }
    .chip{ display:inline-flex; align-items:center; justify-content:center; padding:6px 10px; border-radius:999px; font-weight:700; letter-spacing:.4px; color:#fff; text-transform:uppercase; font-size:12px; background:var(--chip-final); }
    .chip.live{ background:var(--chip-live); } .chip.upcoming{ background:var(--chip-upcoming); }
    .status{ font-size:13px; font-weight:700; color:#0b0e13; }
    .venue{ font-size:12px; color:#6b7280; }

    /* Team names/records line */
    .team-under{ display:grid; grid-template-columns:1fr 1fr; gap:16px; margin:-6px 0 10px; }
    .team-name{ font-size:15px; font-weight:700; text-align:center; }
    .record{ font-size:12.5px; color:#6b7280; text-align:center; }

    /* Cards & order */
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; }
    .stack{ display:grid; gap:14px; margin-bottom:14px; }

    /* Decisions card – centered, no title */
    .decisions-center{ text-align:center; font-size:13px; color:#111318; }

    /* Linescore */
    .linescore{ overflow:auto }
    table{ border-collapse:collapse; width:100% }
    th,td{ padding:6px 8px; border-bottom:1px solid var(--border); text-align:center; font-size:13px }
    thead th{ background:linear-gradient(180deg,#fff,#f6f9ff); font-weight:700 }

    /* Box scores styled like todaysgames “box” */
    .boxes-grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    @media (max-width:980px){ .header{grid-template-columns:1fr; justify-items:center} .team-under{display:none} .boxes-grid{ grid-template-columns:1fr; } }
    .boxcol{ display:grid; gap:14px; }
    .box table{ border-collapse:collapse; width:100%; font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace; font-size:11.5px; }
    .box thead th{ color:#5b6577; font-weight:700; border-bottom:1px solid var(--border); padding:6px 6px; text-align:center; background:linear-gradient(180deg,#fff,#f6f9ff); }
    .box tbody td{ border-bottom:1px solid var(--border); padding:6px 6px; text-align:center; color:#394150; }
    .box .teamhdr{ text-align:left; font-weight:700; color:#394150; padding-top:2px; }
    .box td.name, .box th.name { text-align:left; font-weight:normal; color:#111318; }
    .box td.pos, .box th.pos { color:#8a94ab; font-weight:700; text-transform:uppercase; }
    .indent .name { padding-left:16px; position:relative; }
    .indent .name::before{ content:""; position:absolute; left:6px; top:50%; width:8px; height:0; border-top:1px solid var(--border); transform:translateY(-50%); }
    .badge-gray{ display:inline-block; margin-left:6px; padding:2px 6px; border-radius:6px; background:var(--badge); color:var(--badge-text); font-size:11px; font-weight:700; }

    /* PBP table with full-cell gradients (EV, xBA) */
    .pbp-card{ margin-top:14px; }
    .pbp-table{ width:100%; border-collapse:collapse }
    .pbp-table th{ background:linear-gradient(180deg,#fff,#f6f9ff); font-weight:700; position:sticky; top:0; }
    .pbp-table th, .pbp-table td{ padding:6px 8px; border-bottom:1px solid var(--border); font-size:12.5px; text-align:left }
    .center{ text-align:center }
    .when{ color:var(--muted); font-size:13px }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- Header -->
    {% if game %}
    <div class="header">
      <img class="logo" src="https://www.mlbstatic.com/team-logos/{{ game.away.id }}.svg" alt="{{ game.away.name }} logo">
      <div class="big-score" id="awayScore">{{ game.away.score }}</div>
      <div class="center-info">
        <div class="chip" id="statusChip">{{ game.status }}</div>
        <div class="status">{{ game.status }}</div>
        <div class="venue">{{ game.venue }} • {{ game.date }}</div>
        <div class="when" id="statcastLine">Loading latest play…</div>
      </div>
      <div class="big-score" id="homeScore">{{ game.home.score }}</div>
      <img class="logo" src="https://www.mlbstatic.com/team-logos/{{ game.home.id }}.svg" alt="{{ game.home.name }} logo">
    </div>

    <!-- Team names/records under logos (centered under each name) -->
    <div class="team-under">
      <div>
        <div class="team-name">{{ game.away.name }}</div>
        <div class="record">{{ game.away.record }}</div>
      </div>
      <div>
        <div class="team-name">{{ game.home.name }}</div>
        <div class="record">{{ game.home.record }}</div>
      </div>
    </div>
    {% else %}
    <p class="when">Could not load game header.</p>
    {% endif %}

    <!-- Decisions + Linescore -->
    <div class="stack">
      <div class="card">
        <div id="decisionsLine" class="decisions-center">Loading…</div>
      </div>

      <div class="card">
        <div class="linescore">
          <table id="linescoreBox"></table>
        </div>
      </div>
    </div>

    <!-- Box scores: two columns; each side has Batting and Pitching in separate cards (matching todaysgames) -->
    <div class="boxes-grid">
      <!-- Visiting (left) -->
      <div class="boxcol" id="visCol">
        <div class="card box">
          <div class="teamhdr" id="hdrAwayBat">Away — Batting</div>
          <table>
            <thead><tr><th class="pos">POS</th><th class="name">Player</th><th>AB</th><th>R</th><th>H</th><th>RBI</th><th>BB</th><th>K</th></tr></thead>
            <tbody id="batAway"></tbody>
          </table>
        </div>
        <div class="card box">
          <div class="teamhdr" id="hdrAwayPit">Away — Pitching</div>
          <table>
            <thead><tr><th class="pos">POS</th><th class="name">Player</th><th>IP</th><th>H</th><th>R</th><th>ER</th><th>BB</th><th>K</th><th>HR</th><th>P</th></tr></thead>
            <tbody id="pitAway"></tbody>
          </table>
        </div>
      </div>

      <!-- Home (right) -->
      <div class="boxcol" id="homeCol">
        <div class="card box">
          <div class="teamhdr" id="hdrHomeBat">Home — Batting</div>
          <table>
            <thead><tr><th class="pos">POS</th><th class="name">Player</th><th>AB</th><th>R</th><th>H</th><th>RBI</th><th>BB</th><th>K</th></tr></thead>
            <tbody id="batHome"></tbody>
          </table>
        </div>
        <div class="card box">
          <div class="teamhdr" id="hdrHomePit">Home — Pitching</div>
          <table>
            <thead><tr><th class="pos">POS</th><th class="name">Player</th><th>IP</th><th>H</th><th>R</th><th>ER</th><th>BB</th><th>K</th><th>HR</th><th>P</th></tr></thead>
            <tbody id="pitHome"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Play by Play -->
    <div class="card pbp-card">
      <h3>Play by Play</h3>
      <div style="overflow:auto">
        <table class="pbp-table" id="pbpTable">
          <thead>
            <tr>
              <th style="width:76px">Inning</th>
              <th>Play</th>
              <th class="center" style="width:90px">EV</th>
              <th class="center" style="width:70px">LA</th>
              <th class="center" style="width:80px">Dist</th>
              <th class="center" style="width:90px">xBA</th>
            </tr>
          </thead>
          <tbody id="pbpBody"><tr><td class="when" colspan="6">Loading…</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const gamePk = {{ game_pk }};
    const API = `/api/game/${gamePk}`;
    const $ = (id) => document.getElementById(id);

    // Linescore (uses team abbreviations)
    const th = (s) => `<th>${s}</th>`;
    const td = (s) => `<td>${s ?? ''}</td>`;
    function linescoreTable(ls, awayAbbr, homeAbbr){
      if(!ls || !ls.n){ return '<tr><td class="when">—</td></tr>'; }
      const n = ls.n;
      let thead = '<thead><tr><th></th>'; for(let i=1;i<=n;i++) thead += th(i);
      thead += th('R')+th('H')+th('E')+'</tr></thead>';
      function row(label, arr, totals){
        let cells = `<td style="font-weight:700">${label}</td>`;
        for(let i=0;i<n;i++) cells += td(arr[i] ?? '');
        cells += td(`<b>${(totals||{}).R ?? ''}</b>`) + td((totals||{}).H ?? '') + td((totals||{}).E ?? '');
        return `<tr>${cells}</tr>`;
      }
      const away = ls.away || [], home = ls.home || [];
      const ta = (ls.totals||{}).away || {}, thm = (ls.totals||{}).home || {};
      return thead + `<tbody>${row(awayAbbr, away, ta)}${row(homeAbbr, home, thm)}</tbody>`;
    }

    // Short name like today's page
    function fmtShortName(nm){
      if (!nm) return '';
      const parts = nm.split(' ');
      return parts.length>1 ? `${parts[0][0]}. ${parts.slice(1).join(' ')}` : nm;
    }

    // Build bat/pit tables in “box” style from todaysgames
    function fillBatTable(tbodyId, rows){
      const el = $(tbodyId);
      if(!rows || !rows.length){ el.innerHTML = `<tr><td class="when" colspan="8">—</td></tr>`; return; }
      el.innerHTML = rows.map(r => `
        <tr ${r.indent ? 'class="indent"' : ''}>
          <td class="pos">${r.pos||''}</td>
          <td class="name">${fmtShortName(r.name)||''}</td>
          <td>${r.ab ?? ''}</td><td>${r.r ?? ''}</td><td>${r.h ?? ''}</td><td>${r.rbi ?? ''}</td><td>${r.bb ?? ''}</td><td>${r.k ?? ''}</td>
        </tr>`).join('');
    }

    function fillPitTable(tbodyId, rows, decisions){
      const el = $(tbodyId);
      if(!rows || !rows.length){ el.innerHTML = `<tr><td class="when" colspan="10">—</td></tr>`; return; }
      const W = decisions?.winnerId, L = decisions?.loserId, S = decisions?.saveId;
      el.innerHTML = rows.map(r => {
        let name = fmtShortName(r.name)||'';
        let tags = '';
        if (r.pid === W) tags += `<span class="badge-gray">W</span>`;
        if (r.pid === L) tags += `<span class="badge-gray">L</span>`;
        if (r.pid === S) tags += `<span class="badge-gray">SV</span>`;
        if (tags) name += ' ' + tags;
        return `
          <tr ${r.indent ? 'class="indent"' : ''}>
            <td class="pos">${r.pos||'P'}</td>
            <td class="name">${name}</td>
            <td>${r.ip ?? ''}</td><td>${r.h ?? ''}</td><td>${r.r ?? ''}</td><td>${r.er ?? ''}</td><td>${r.bb ?? ''}</td><td>${r.k ?? ''}</td><td>${r.hr ?? ''}</td><td>${r.p ?? ''}</td>
          </tr>`;
      }).join('');
    }

    // ---- Gradient helpers (blue -> white -> red) for full cell (EV, xBA) ----
    function clamp01(x){ return Math.max(0, Math.min(1, x)); }
    function lerp(a,b,t){ return a + (b-a)*t; }
    function mixColor(c1, c2, t){ return [Math.round(lerp(c1[0], c2[0], t)), Math.round(lerp(c1[1], c2[1], t)), Math.round(lerp(c1[2], c2[2], t))]; }
    const BLUE=[30,58,138], WHITE=[255,255,255], RED=[185,28,28];
    function blueWhiteRed(t){ t=clamp01(t); const c = (t<=.5)? mixColor(BLUE,WHITE,t/.5) : mixColor(WHITE,RED,(t-.5)/.5); return `rgb(${c[0]},${c[1]},${c[2]})`; }
    function textColorFor(rgbStr){
      const m = rgbStr.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/); if(!m) return '#0b0e13';
      const r=+m[1], g=+m[2], b=+m[3]; const L = 0.2126*r+0.7152*g+0.0722*b;
      return L < 150 ? '#ffffff' : '#0b0e13';
    }
    function normEV(ev){ const v=parseFloat(ev); if (isNaN(v)) return null; return clamp01((v-60)/(115-60)); }
    function normXBA(x){ let v=(typeof x==='string'&&x.startsWith('.'))? parseFloat('0'+x) : parseFloat(x); if(isNaN(v)) return null; if(v>1) v=v/100; return clamp01(v); }

    function tdWithGrad(val, normFn){
      const display = (val==null || val==='') ? '—' : val;
      const n = normFn(val);
      if (n==null){ return `<td class="center">${display}</td>`; }
      const bg = blueWhiteRed(n), fg = textColorFor(bg);
      return `<td class="center" style="background:${bg}; color:${fg}">${display}</td>`;
    }

    // PBP table (no xSLG column)
    function renderPBPTable(list){
      const body = $('pbpBody');
      if(!Array.isArray(list) || !list.length){ body.innerHTML = '<tr><td class="when" colspan="6">—</td></tr>'; return; }
      body.innerHTML = list.map(r=>{
        const inning = r.inning || '';
        const desc = r.desc || '';
        return `<tr>
          <td class="center">${inning}</td>
          <td>${desc}</td>
          ${tdWithGrad(r.ev||'', normEV)}
          <td class="center">${r.la ? r.la + '°' : '—'}</td>
          <td class="center">${r.dist ? r.dist + ' ft' : '—'}</td>
          ${tdWithGrad(r.xba||'', normXBA)}
        </tr>`;
      }).join('');
    }

    async function load(){
      const res = await fetch(API, {cache:'no-store'});
      const data = await res.json();
      const g = data.game || {}; const meta = data.meta || {}; const plays = Array.isArray(data.plays) ? data.plays : [];

      // Decisions (centered, no title)
      $('decisionsLine').textContent = meta.decisionsText || '—';

      // Chip/status
      const chip = $('statusChip');
      if (chip){
        chip.textContent = g.chip || '';
        chip.classList.remove('live','upcoming');
        const chipLower = (g.chip||'').toLowerCase();
        if ((g.status||'').toLowerCase()==='in_progress' || chipLower.includes('top') || chipLower.includes('bot')) chip.classList.add('live');
        else if ((g.status||'').toLowerCase()==='scheduled') chip.classList.add('upcoming');
      }

      // Header statcast line + scores
      $('statcastLine').textContent = g.statcast || '—';
      if (g.teams){
        $('awayScore').textContent = (g.teams.away && g.teams.away.score!=null) ? g.teams.away.score : '-';
        $('homeScore').textContent = (g.teams.home && g.teams.home.score!=null) ? g.teams.home.score : '-';
      }

      // Linescore with team abbreviations
      const awayAbbr = g.teams?.away?.abbr || 'AWY';
      const homeAbbr = g.teams?.home?.abbr || 'HME';
      $('linescoreBox').innerHTML = linescoreTable(g.linescore || {}, awayAbbr, homeAbbr);

      // Box headers to match todaysgames style
      $('hdrAwayBat').textContent = `${awayAbbr} — Batting`;
      $('hdrAwayPit').textContent = `${awayAbbr} — Pitching`;
      $('hdrHomeBat').textContent = `${homeAbbr} — Batting`;
      $('hdrHomePit').textContent = `${homeAbbr} — Pitching`;

      // Fill box tables
      fillBatTable('batAway', (g.batters && g.batters.away) || []);
      fillBatTable('batHome', (g.batters && g.batters.home) || []);
      fillPitTable('pitAway', (g.pitchers && g.pitchers.away) || [], meta.decisions);
      fillPitTable('pitHome', (g.pitchers && g.pitchers.home) || [], meta.decisions);

      // PBP with full-cell gradients (EV, xBA), no MPH label and no xSLG column
      renderPBPTable(plays);
    }

    load().catch(e=>{
      console.error(e);
      $('linescoreBox').innerHTML = '<em class="when">Could not load inning-by-inning.</em>';
      $('pbpBody').innerHTML = '<tr><td class="when" colspan="6">—</td></tr>';
      $('decisionsLine').textContent = '—';
    });
  </script>
</body>
</html>
