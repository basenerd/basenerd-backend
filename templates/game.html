{% extends "base.html" %}
{% block content %}

{% set away = game.away if game.away is defined else {} %}
{% set home = game.home if game.home is defined else {} %}

{# -----------------------------
   Helpers (jinja-side)
   ----------------------------- #}
{% set status_lc = (game.statusPill|string)|lower %}
{% set is_final = ('final' in status_lc) or ('game over' in status_lc) or ('completed' in status_lc) %}

{% macro dash(v) -%}
  {%- if v is none or v == '' or v == 'None' -%}-{% else %}{{ v }}{% endif -%}
{%- endmacro %}

{% macro ordinal(n) -%}
  {%- set nn = (n|int) -%}
  {%- if 10 <= (nn % 100) <= 20 -%}
    {{ nn }}th
  {%- else -%}
    {%- set s = {1:'st',2:'nd',3:'rd'}.get(nn % 10, 'th') -%}
    {{ nn }}{{ s }}
  {%- endif -%}
{%- endmacro %}

<div class="card">
  <div class="card-header">
    <div class="card-title">{{ away.abbrev }} @ {{ home.abbrev }}</div>
    <div class="card-subtitle">
      {{ game.statusPill }}
      {% if game.gameDate %} • {{ game.gameDate }}{% endif %}
    </div>
  </div>

  {% if game.linescore %}
  <div style="padding: 0 14px 14px 14px;">
    <div style="overflow-x:auto;">
      <table class="tbl">
        <thead>
          <tr>
            <th>Team</th>
            {% for inn in game.linescore.innings %}
              <th class="mono">{{ inn.num }}</th>
            {% endfor %}
            <th class="mono">R</th>
            <th class="mono">H</th>
            <th class="mono">E</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="mono">{{ away.abbrev }}</td>
            {% for inn in game.linescore.innings %}
              <td class="mono">{{ dash(inn.away) }}</td>
            {% endfor %}
            <td class="mono">{{ dash(game.linescore.away.R) }}</td>
            <td class="mono">{{ dash(game.linescore.away.H) }}</td>
            <td class="mono">{{ dash(game.linescore.away.E) }}</td>
          </tr>
          <tr>
            <td class="mono">{{ home.abbrev }}</td>
            {% for inn in game.linescore.innings %}
              <td class="mono">{{ dash(inn.home) }}</td>
            {% endfor %}
            <td class="mono">{{ dash(game.linescore.home.R) }}</td>
            <td class="mono">{{ dash(game.linescore.home.H) }}</td>
            <td class="mono">{{ dash(game.linescore.home.E) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}
</div>

<!-- Tabs -->
<div class="tabs" style="margin-top:14px;">
  <button class="tab-btn active" data-tab="overview">Overview</button>
  <button class="tab-btn" data-tab="box">Box</button>
  <button class="tab-btn" data-tab="scoring">Scoring</button>
  <button class="tab-btn" data-tab="pbp">Play-by-Play</button>
</div>

<!-- OVERVIEW (kept empty for now) -->
<div class="tab-panel active" id="tab-overview">
  <div class="card" style="margin-top:14px;">
    <div class="card-header">
      <div class="card-title">Overview</div>
      <div class="card-subtitle">Coming soon.</div>
    </div>
  </div>
</div>

<!-- BOX -->
<div class="tab-panel" id="tab-box">
  {% if not game.box %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Box</div>
        <div class="card-subtitle">Not available for this status yet.</div>
      </div>
    </div>
  {% else %}

    {# Batting side-by-side #}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Batting</div>
        <div class="card-subtitle">{{ away.abbrev }} vs {{ home.abbrev }}</div>
      </div>

      <div style="padding: 0 14px 14px 14px;">
        <div class="grid2">
          <div>
            <div class="mono muted small" style="margin: 8px 0 6px 0;">{{ away.abbrev }} Batting</div>
            <div style="overflow-x:auto;">
              <table class="tbl">
                <thead>
                  <tr>
                    <th>Player</th>
                    <th class="mono">AB</th><th class="mono">R</th><th class="mono">H</th><th class="mono">RBI</th>
                    <th class="mono">BB</th><th class="mono">SO</th><th class="mono">HR</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in game.box.away.batting %}
                    {% set is_pitcher = (r.pos|string)|upper == 'P' %}
                    {% set abv = (r.AB if r.AB is defined else 0) %}
                    {% if not (is_pitcher and (abv == 0 or abv == '-' or abv is none)) %}
                      <tr>
                        <td>
                          {% if r.indent %}<span class="muted small" style="margin-right:6px;">↳</span>{% endif %}{% if r.playerId %}<a href="/player/{{ r.playerId }}">{{ r.name }}</a>{% else %}{{ r.name }}{% endif %}
                          {% if r.pos %}<span class="muted small"> {{ r.pos }}</span>{% endif %}
                        </td>
                        <td class="mono">{{ dash(r.AB) }}</td><td class="mono">{{ dash(r.R) }}</td><td class="mono">{{ dash(r.H) }}</td><td class="mono">{{ dash(r.RBI) }}</td>
                        <td class="mono">{{ dash(r.BB) }}</td><td class="mono">{{ dash(r.SO) }}</td><td class="mono">{{ dash(r.HR) }}</td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div>
            <div class="mono muted small" style="margin: 8px 0 6px 0;">{{ home.abbrev }} Batting</div>
            <div style="overflow-x:auto;">
              <table class="tbl">
                <thead>
                  <tr>
                    <th>Player</th>
                    <th class="mono">AB</th><th class="mono">R</th><th class="mono">H</th><th class="mono">RBI</th>
                    <th class="mono">BB</th><th class="mono">SO</th><th class="mono">HR</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in game.box.home.batting %}
                    {% set is_pitcher = (r.pos|string)|upper == 'P' %}
                    {% set abv = (r.AB if r.AB is defined else 0) %}
                    {% if not (is_pitcher and (abv == 0 or abv == '-' or abv is none)) %}
                      <tr>
                        <td>
                          {% if r.indent %}<span class="muted small" style="margin-right:6px;">↳</span>{% endif %}{% if r.playerId %}<a href="/player/{{ r.playerId }}">{{ r.name }}</a>{% else %}{{ r.name }}{% endif %}
                          {% if r.pos %}<span class="muted small"> {{ r.pos }}</span>{% endif %}
                        </td>
                        <td class="mono">{{ dash(r.AB) }}</td><td class="mono">{{ dash(r.R) }}</td><td class="mono">{{ dash(r.H) }}</td><td class="mono">{{ dash(r.RBI) }}</td>
                        <td class="mono">{{ dash(r.BB) }}</td><td class="mono">{{ dash(r.SO) }}</td><td class="mono">{{ dash(r.HR) }}</td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    {# Pitching side-by-side #}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Pitching</div>
        <div class="card-subtitle">{{ away.abbrev }} vs {{ home.abbrev }}</div>
      </div>

      <div style="padding: 0 14px 14px 14px;">
        <div class="grid2">
          <div>
            <div class="mono muted small" style="margin: 8px 0 6px 0;">{{ away.abbrev }} Pitching</div>
            <div style="overflow-x:auto;">
              <table class="tbl">
                <thead>
                  <tr>
                    <th>Pitcher</th>
                    <th class="mono">IP</th><th class="mono">H</th><th class="mono">R</th><th class="mono">ER</th>
                    <th class="mono">BB</th><th class="mono">SO</th><th class="mono">HR</th><th class="mono">P-S</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in game.box.away.pitching %}
                    <tr>
                      <td>{% if r.playerId %}<a href="/player/{{ r.playerId }}">{{ r.name }}</a>{% else %}{{ r.name }}{% endif %}</td>
                      <td class="mono">{{ dash(r.IP) }}</td><td class="mono">{{ dash(r.H) }}</td><td class="mono">{{ dash(r.R) }}</td><td class="mono">{{ dash(r.ER) }}</td>
                      <td class="mono">{{ dash(r.BB) }}</td><td class="mono">{{ dash(r.SO) }}</td><td class="mono">{{ dash(r.HR) }}</td><td class="mono">{{ dash(r.PS) }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div>
            <div class="mono muted small" style="margin: 8px 0 6px 0;">{{ home.abbrev }} Pitching</div>
            <div style="overflow-x:auto;">
              <table class="tbl">
                <thead>
                  <tr>
                    <th>Pitcher</th>
                    <th class="mono">IP</th><th class="mono">H</th><th class="mono">R</th><th class="mono">ER</th>
                    <th class="mono">BB</th><th class="mono">SO</th><th class="mono">HR</th><th class="mono">P-S</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in game.box.home.pitching %}
                    <tr>
                      <td>{% if r.playerId %}<a href="/player/{{ r.playerId }}">{{ r.name }}</a>{% else %}{{ r.name }}{% endif %}</td>
                      <td class="mono">{{ dash(r.IP) }}</td><td class="mono">{{ dash(r.H) }}</td><td class="mono">{{ dash(r.R) }}</td><td class="mono">{{ dash(r.ER) }}</td>
                      <td class="mono">{{ dash(r.BB) }}</td><td class="mono">{{ dash(r.SO) }}</td><td class="mono">{{ dash(r.HR) }}</td><td class="mono">{{ dash(r.PS) }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </div>

  {% endif %}
</div>

<!-- SCORING -->
<div class="tab-panel" id="tab-scoring">
  {% if not game.scoring or (game.scoring|length) == 0 %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Scoring</div>
        <div class="card-subtitle">No scoring plays found.</div>
      </div>
    </div>
  {% else %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Scoring</div>
        <div class="card-subtitle">Plays that changed the score.</div>
      </div>
      <div style="padding: 0 14px 14px 14px;">
        <div style="overflow-x:auto;">
          <table class="tbl">
            <thead>
              <tr>
                <th>Inning</th>
                <th>Description</th>
                <th class="mono">{{ away.abbrev }}</th>
                <th class="mono">{{ home.abbrev }}</th>
              </tr>
            </thead>
            <tbody>
              {% for s in game.scoring %}
                <tr>
                  <td class="mono">{{ s.inning }} {{ s.half }}</td>
                  <td>{{ s.description }}</td>
                  <td class="mono">{{ dash(s.awayScore) }}</td>
                  <td class="mono">{{ dash(s.homeScore) }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<!-- PLAY-BY-PLAY -->
<div class="tab-panel" id="tab-pbp">
  {% if not game.pas or (game.pas|length) == 0 %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Play-by-Play</div>
        <div class="card-subtitle">No plays found.</div>
      </div>
    </div>
  {% else %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Play-by-Play</div>
        <div class="card-subtitle">Plate appearances with pitches + batted-ball metrics.</div>
      </div>

      <div style="padding: 14px;">
        {% for pa in game.pas %}
          <div class="card" style="margin: 10px 0;">
            <div class="card-header">
              <div class="card-title">
                {{ pa.inningLabel }} {{ pa.half }}
                <span class="muted small">• {{ pa.summaryEvent }}</span>
              </div>
              <div class="card-subtitle">{{ pa.description }}</div>
            </div>

            <div style="padding: 0 14px 14px 14px;">
              <div class="grid2">
                <div>
                  {% if pa.pitches and (pa.pitches|length) > 0 %}
                    <div class="zone-wrap">
                      <div class="zone-title">Strike Zone</div>
                      <svg class="strike-zone"
                           data-pitches='{{ pa.pitches | tojson }}'
                           width="220" height="240"></svg>
                    </div>
                  {% endif %}
                </div>

                <div>
                  {% if pa.pitches and (pa.pitches|length) > 0 %}
                    <div class="pitch-wrap">
                      <div class="zone-title">Pitches</div>

                      <div style="overflow-x:auto;">
                        <table class="tbl">
                          <thead>
                            <tr>
                              <th class="mono">#</th>
                              <th>Result</th>
                              <th class="mono">Type</th>
                              <th class="mono">Velo</th>
                              <th class="mono">Spin</th>
                              <th class="mono">IVB</th>
                              <th class="mono">HB</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for p in pa.pitches %}
                              <tr>
                                <td class="mono">{{ p.n if p.n is defined and p.n is not none else loop.index }}</td>
                                <td>{{ p.call }}</td>
                                <td class="mono">{{ dash(p.pitchType) }}</td>
                                <td class="mono">{{ dash(p.startSpeed) }}</td>
                                <td class="mono">{{ dash(p.spinRate) }}</td>
                                <td class="mono">{{ dash(p.vertMove) }}</td>
                                <td class="mono">{{ dash(p.horizMove) }}</td>
                              </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  {% endif %}

                  {# Batted-ball metrics (scrapping hit-location mapping for now) #}
                  {% if pa.battedBall and (pa.battedBall.exitVelo is not none or pa.battedBall.launchAngle is not none or pa.battedBall.distance is not none or pa.battedBall.xBA is not none) %}
                    <div style="margin-top:10px;">
                      <table class="tbl" style="width:100%;">
                        <thead>
                          <tr>
                            <th class="mono">EV</th>
                            <th class="mono">LA</th>
                            <th class="mono">Dist</th>
                            {% if pa.battedBall.xBA is not none %}<th class="mono">xBA</th>{% endif %}
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td class="mono">{{ dash(pa.battedBall.exitVelo) }}</td>
                            <td class="mono">{{ dash(pa.battedBall.launchAngle) }}</td>
                            <td class="mono">{{ dash(pa.battedBall.distance) }}</td>
                            {% if pa.battedBall.xBA is not none %}<td class="mono">{{ dash(pa.battedBall.xBA) }}</td>{% endif %}
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  {% endif %}

                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

    </div>
  {% endif %}
</div>

<script>
(function(){
  // tabs
  const tabs = document.querySelectorAll(".tab-btn");
  const panels = document.querySelectorAll(".tab-panel");
  tabs.forEach(btn=>{
    btn.addEventListener("click", ()=>{
      tabs.forEach(b=>b.classList.remove("active"));
      panels.forEach(p=>p.classList.remove("active"));
      btn.classList.add("active");
      const id = "tab-" + btn.dataset.tab;
      const panel = document.getElementById(id);
      if(panel) panel.classList.add("active");
    });
  });

  // strike zone render
  function renderZone(svg, pitches){
    const w = parseFloat(svg.getAttribute("width") || 200);
    const h = parseFloat(svg.getAttribute("height") || 240);

    const tops = pitches.map(p=>p.sz_top).filter(v=>v!==null && v!==undefined);
    const bots = pitches.map(p=>p.sz_bot).filter(v=>v!==null && v!==undefined);

    const zoneTop = tops.length ? (tops.reduce((a,b)=>a+b,0)/tops.length) : 3.5;
    const zoneBot = bots.length ? (bots.reduce((a,b)=>a+b,0)/bots.length) : 1.5;

    // px is typically in feet from center; map [-1.5, 1.5] -> [0,w]
    const xMin = -1.5, xMax = 1.5;
    const yMin = zoneBot - 0.8, yMax = zoneTop + 0.8;

    function xScale(x){ return ( (x - xMin) / (xMax - xMin) ) * w; }
    function yScale(y){ return h - ( (y - yMin) / (yMax - yMin) ) * h; }

    svg.innerHTML = "";

    const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
    rect.setAttribute("x", xScale(-0.83));
    rect.setAttribute("y", yScale(zoneTop));
    rect.setAttribute("width", xScale(0.83) - xScale(-0.83));
    rect.setAttribute("height", yScale(zoneBot) - yScale(zoneTop));
    rect.setAttribute("fill", "rgba(15,23,42,.03)");
    rect.setAttribute("stroke", "rgba(226,232,240,.9)");
    rect.setAttribute("stroke-width", "1");
    svg.appendChild(rect);

    pitches.forEach(p=>{
      if(p.px === null || p.px === undefined || p.pz === null || p.pz === undefined) return;

      const g = document.createElementNS("http://www.w3.org/2000/svg","g");

      const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
      c.setAttribute("cx", xScale(p.px));
      c.setAttribute("cy", yScale(p.pz));
      c.setAttribute("r", 7);

      // color spec:
      // - balls + HBP: green
      // - called/swinging strikes: red
      // - fouls: gray
      // - ball in play: blue
      let fill = "rgba(91,101,119,.65)"; // default gray
      if(p.isInPlay) fill = "rgba(59,130,246,.75)";
      else if(p.isFoul) fill = "rgba(91,101,119,.70)";
      else if(p.isBall) fill = "rgba(34,197,94,.75)";
      else if(p.isStrike) fill = "rgba(239,68,68,.75)";

      c.setAttribute("fill", fill);
      c.setAttribute("stroke", "rgba(15,23,42,.25)");
      c.setAttribute("stroke-width", "0.6");
      g.appendChild(c);

      const t = document.createElementNS("http://www.w3.org/2000/svg","text");
      t.setAttribute("x", xScale(p.px));
      t.setAttribute("y", yScale(p.pz) + 3);
      t.setAttribute("text-anchor", "middle");
      t.setAttribute("font-size", "9");
      t.setAttribute("font-family", "IBM Plex Mono, ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace");
      t.setAttribute("fill", "rgba(255,255,255,.95)");
      t.textContent = (p.n != null) ? String(p.n) : "";
      g.appendChild(t);

      svg.appendChild(g);
    });
  }

  // render zones
  document.querySelectorAll("svg.strike-zone").forEach(svg=>{
    try{
      const pitches = JSON.parse(svg.getAttribute("data-pitches") || "[]");
      renderZone(svg, pitches);
    }catch(e){}
  });
})();
</script>

{% endblock %}
