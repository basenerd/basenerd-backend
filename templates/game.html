{% extends "base.html" %}
{% block content %}

{% set away = game.away if game.away is defined else {} %}
{% set home = game.home if game.home is defined else {} %}

{# -----------------------------
   Helpers (jinja-side)
   ----------------------------- #}
{% set status_lc = (game.statusPill|string)|lower %}
{% set is_final = ('final' in status_lc) or ('game over' in status_lc) or ('completed' in status_lc) %}

{% macro dash(v) -%}
  {%- if v is none or v == '' or v == 'None' -%}-{% else %}{{ v }}{% endif -%}
{%- endmacro %}

{% macro ordinal(n) -%}
  {%- set nn = (n|int) -%}
  {%- if 10 <= (nn % 100) <= 20 -%}
    {{ nn }}th
  {%- else -%}
    {%- set s = {1:'st',2:'nd',3:'rd'}.get(nn % 10, 'th') -%}
    {{ nn }}{{ s }}
  {%- endif -%}
{%- endmacro %}

{% if error %}
  <div class="card" style="border:1px solid rgba(239,68,68,.35); margin-bottom:14px;">
    <div class="card-header">
      <div class="card-title">Debug error</div>
      <div class="card-subtitle mono">{{ error }}</div>
    </div>
  </div>
{% endif %}

<!-- TOP: Game hero -->
<div class="card game-hero">
  <div class="game-hero-inner">
    <div class="game-hero-meta">
      <div class="game-hero-title">
        <span class="mono">{{ away.abbrev }}</span>
        <span class="muted">@</span>
        <span class="mono">{{ home.abbrev }}</span>
      </div>

      <div class="game-hero-sub">
        <span class="pill-status">{{ game.statusPill }}</span>
        {% if game.when %}<span class="muted">•</span><span>{{ game.when }}</span>{% endif %}
        {% if game.venue %}<span class="muted">•</span><span>{{ game.venue }}</span>{% endif %}
      </div>

      <div class="game-hero-notes">
        {% if away.record %}<span class="mono muted">{{ away.abbrev }} {{ away.record }}</span>{% endif %}
        {% if home.record %}<span class="muted">•</span><span class="mono muted">{{ home.abbrev }} {{ home.record }}</span>{% endif %}
      </div>

      {# Probables only if NOT final #}
      {% if (not is_final) and game.probables %}
        <div class="game-hero-row">
          <span class="mono muted">PP:</span>
          <span class="mono">{% if game.probables.away %}{{ away.abbrev }} {{ game.probables.away }}{% else %}{{ away.abbrev }} TBD{% endif %}</span>
          <span class="muted">•</span>
          <span class="mono">{% if game.probables.home %}{{ home.abbrev }} {{ game.probables.home }}{% else %}{{ home.abbrev }} TBD{% endif %}</span>
        </div>
      {% endif %}

      {# Decisions: support both old keys (w/l/s) and new keys (winner/loser/save) #}
      {% if is_final and game.decisions %}
        {% set wname = game.decisions.winner if game.decisions.winner is defined else game.decisions.w %}
        {% set lname = game.decisions.loser if game.decisions.loser is defined else game.decisions.l %}
        {% set sname = game.decisions.save if game.decisions.save is defined else game.decisions.s %}
        <div class="game-hero-row">
          <span class="pill-lite"><span class="mono muted">W</span> {{ dash(wname) }}</span>
          <span class="pill-lite"><span class="mono muted">L</span> {{ dash(lname) }}</span>
          <span class="pill-lite"><span class="mono muted">SV</span> {{ dash(sname) }}</span>
        </div>
      {% endif %}
    </div>

    <div class="game-hero-score">
      <div class="team-score">
        {% if away.logo_url %}<img class="teamlogo" src="{{ away.logo_url }}" alt="{{ away.abbrev }} logo">{% endif %}
        <div class="team-score-meta">
          <div class="team-score-line">
            <span class="mono team-abbrev">{{ away.abbrev }}</span>
            <span class="mono team-runs">{{ dash(away.score if away.score is defined else away.runs if away.runs is defined else none) }}</span>
          </div>
        </div>
      </div>

      <div class="team-score vs">@</div>

      <div class="team-score">
        {% if home.logo_url %}<img class="teamlogo" src="{{ home.logo_url }}" alt="{{ home.abbrev }} logo">{% endif %}
        <div class="team-score-meta">
          <div class="team-score-line">
            <span class="mono team-runs">{{ dash(home.score if home.score is defined else home.runs if home.runs is defined else none) }}</span>
            <span class="mono team-abbrev">{{ home.abbrev }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{# -----------------------------
   Linescore moved UNDER game details card
   ----------------------------- #}
{% set innings = (game.linescore.innings if game.linescore and game.linescore.innings is defined else []) %}
{% if innings %}
  <div class="card" style="margin-top:14px;">
    <div class="card-header">
      <div class="card-title">Linescore</div>
    </div>

    <div style="padding: 0 14px 14px 14px; overflow-x:auto;">
      <table class="tbl">
        <thead>
          <tr>
            <th></th>
            {% for inn in innings %}
              <th class="mono" style="text-align:center;">{{ inn.num }}</th>
            {% endfor %}
            <th class="mono" style="text-align:center;">R</th>
            <th class="mono" style="text-align:center;">H</th>
            <th class="mono" style="text-align:center;">E</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="mono">
              {% if away.logo_url %}<img class="teamlogo" src="{{ away.logo_url }}" style="height:18px; vertical-align:middle; margin-right:6px;">{% endif %}
              {{ away.abbrev }}
            </td>
            {% for inn in innings %}
              <td class="mono" style="text-align:center;">{{ dash(inn.away.runs if inn.away is defined else none) }}</td>
            {% endfor %}
            <td class="mono" style="text-align:center;">{{ dash(game.linescore.teams.away.runs) }}</td>
            <td class="mono" style="text-align:center;">{{ dash(game.linescore.teams.away.hits) }}</td>
            <td class="mono" style="text-align:center;">{{ dash(game.linescore.teams.away.errors) }}</td>
          </tr>

          <tr>
            <td class="mono">
              {% if home.logo_url %}<img class="teamlogo" src="{{ home.logo_url }}" style="height:18px; vertical-align:middle; margin-right:6px;">{% endif %}
              {{ home.abbrev }}
            </td>
            {% for inn in innings %}
              <td class="mono" style="text-align:center;">{{ dash(inn.home.runs if inn.home is defined else none) }}</td>
            {% endfor %}
            <td class="mono" style="text-align:center;">{{ dash(game.linescore.teams.home.runs) }}</td>
            <td class="mono" style="text-align:center;">{{ dash(game.linescore.teams.home.hits) }}</td>
            <td class="mono" style="text-align:center;">{{ dash(game.linescore.teams.home.errors) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
{% endif %}

<!-- Tabs -->
<div class="tabs" style="margin-top:14px;">
  <button class="tab-btn active" data-tab="overview">Overview</button>
  <button class="tab-btn" data-tab="box">Box</button>
  <button class="tab-btn" data-tab="scoring">Scoring</button>
  <button class="tab-btn" data-tab="pbp">Play-by-Play</button>
</div>

<!-- OVERVIEW (kept empty for now) -->
<div class="tab-panel active" id="tab-overview">
  <div class="card" style="margin-top:14px;">
    <div class="card-header">
      <div class="card-title">Overview</div>
      <div class="card-subtitle">Coming soon.</div>
    </div>
  </div>
</div>

<!-- BOX -->
<div class="tab-panel" id="tab-box">
  {% if not game.box %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Box</div>
        <div class="card-subtitle">Not available for this status yet.</div>
      </div>
    </div>
  {% else %}

    {# Batting side-by-side #}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Batting</div>
        <div class="card-subtitle">{{ away.abbrev }} vs {{ home.abbrev }}</div>
      </div>

      <div style="padding: 0 14px 14px 14px;">
        <div class="grid2">
          <div>
            <div class="mono muted small" style="margin: 8px 0 6px 0;">{{ away.abbrev }} Batting</div>
            <div style="overflow-x:auto;">
              <table class="tbl">
                <thead>
                  <tr>
                    <th>Player</th>
                    <th class="mono">AB</th><th class="mono">R</th><th class="mono">H</th><th class="mono">RBI</th>
                    <th class="mono">BB</th><th class="mono">SO</th><th class="mono">HR</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in game.box.away.batting %}
                    {% set is_pitcher = (r.pos|string)|upper == 'P' %}
                    {% set abv = (r.AB if r.AB is defined else 0) %}
                    {% if not (is_pitcher and (abv == 0 or abv == '-' or abv is none)) %}
                      <tr>
                        <td>
                          {% if r.playerId %}<a href="/player/{{ r.playerId }}">{{ r.name }}</a>{% else %}{{ r.name }}{% endif %}
                          {% if r.pos %}<span class="muted small"> {{ r.pos }}</span>{% endif %}
                        </td>
                        <td class="mono">{{ dash(r.AB) }}</td><td class="mono">{{ dash(r.R) }}</td><td class="mono">{{ dash(r.H) }}</td><td class="mono">{{ dash(r.RBI) }}</td>
                        <td class="mono">{{ dash(r.BB) }}</td><td class="mono">{{ dash(r.SO) }}</td><td class="mono">{{ dash(r.HR) }}</td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div>
            <div class="mono muted small" style="margin: 8px 0 6px 0;">{{ home.abbrev }} Batting</div>
            <div style="overflow-x:auto;">
              <table class="tbl">
                <thead>
                  <tr>
                    <th>Player</th>
                    <th class="mono">AB</th><th class="mono">R</th><th class="mono">H</th><th class="mono">RBI</th>
                    <th class="mono">BB</th><th class="mono">SO</th><th class="mono">HR</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in game.box.home.batting %}
                    {% set is_pitcher = (r.pos|string)|upper == 'P' %}
                    {% set abv = (r.AB if r.AB is defined else 0) %}
                    {% if not (is_pitcher and (abv == 0 or abv == '-' or abv is none)) %}
                      <tr>
                        <td>
                          {% if r.playerId %}<a href="/player/{{ r.playerId }}">{{ r.name }}</a>{% else %}{{ r.name }}{% endif %}
                          {% if r.pos %}<span class="muted small"> {{ r.pos }}</span>{% endif %}
                        </td>
                        <td class="mono">{{ dash(r.AB) }}</td><td class="mono">{{ dash(r.R) }}</td><td class="mono">{{ dash(r.H) }}</td><td class="mono">{{ dash(r.RBI) }}</td>
                        <td class="mono">{{ dash(r.BB) }}</td><td class="mono">{{ dash(r.SO) }}</td><td class="mono">{{ dash(r.HR) }}</td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    {# Pitching side-by-side #}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Pitching</div>
        <div class="card-subtitle">{{ away.abbrev }} vs {{ home.abbrev }}</div>
      </div>

      <div style="padding: 0 14px 14px 14px;">
        <div class="grid2">
          <div>
            <div class="mono muted small" style="margin: 8px 0 6px 0;">{{ away.abbrev }} Pitching</div>
            <div style="overflow-x:auto;">
              <table class="tbl">
                <thead>
                  <tr>
                    <th>Pitcher</th>
                    <th class="mono">IP</th><th class="mono">H</th><th class="mono">R</th><th class="mono">ER</th>
                    <th class="mono">BB</th><th class="mono">SO</th><th class="mono">HR</th><th class="mono">P-S</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in game.box.away.pitching %}
                    <tr>
                      <td>
                        {% if r.playerId %}<a href="/player/{{ r.playerId }}">{{ r.name }}</a>{% else %}{{ r.name }}{% endif %}
                      </td>
                      <td class="mono">{{ dash(r.IP) }}</td><td class="mono">{{ dash(r.H) }}</td><td class="mono">{{ dash(r.R) }}</td><td class="mono">{{ dash(r.ER) }}</td>
                      <td class="mono">{{ dash(r.BB) }}</td><td class="mono">{{ dash(r.SO) }}</td><td class="mono">{{ dash(r.HR) }}</td><td class="mono">{{ dash(r.PS) }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div>
            <div class="mono muted small" style="margin: 8px 0 6px 0;">{{ home.abbrev }} Pitching</div>
            <div style="overflow-x:auto;">
              <table class="tbl">
                <thead>
                  <tr>
                    <th>Pitcher</th>
                    <th class="mono">IP</th><th class="mono">H</th><th class="mono">R</th><th class="mono">ER</th>
                    <th class="mono">BB</th><th class="mono">SO</th><th class="mono">HR</th><th class="mono">P-S</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in game.box.home.pitching %}
                    <tr>
                      <td>
                        {% if r.playerId %}<a href="/player/{{ r.playerId }}">{{ r.name }}</a>{% else %}{{ r.name }}{% endif %}
                      </td>
                      <td class="mono">{{ dash(r.IP) }}</td><td class="mono">{{ dash(r.H) }}</td><td class="mono">{{ dash(r.R) }}</td><td class="mono">{{ dash(r.ER) }}</td>
                      <td class="mono">{{ dash(r.BB) }}</td><td class="mono">{{ dash(r.SO) }}</td><td class="mono">{{ dash(r.HR) }}</td><td class="mono">{{ dash(r.PS) }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

  {% endif %}
</div>

<!-- SCORING -->
<div class="tab-panel" id="tab-scoring">
  {% if not game.scoring %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Scoring</div>
        <div class="card-subtitle">Not available for this status yet.</div>
      </div>
    </div>
  {% else %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Scoring</div>
        <div class="card-subtitle">All scoring plays</div>
      </div>

      <div style="padding: 0 14px 14px 14px;">
        <div class="scoring-list">
          {% for s in game.scoring %}
            <div class="scoring-row">
              <div class="mono muted">{{ s.inningLabel }}</div>
              <div class="scoring-desc">{{ s.description }}</div>
              <div class="mono" style="text-align:right;">{{ dash(s.awayScore) }} - {{ dash(s.homeScore) }}</div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}
</div>

<!-- PLAY-BY-PLAY (PA-style UI) -->
<div class="tab-panel" id="tab-pbp">
  {% if not game.pas %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Play-by-Play</div>
        <div class="card-subtitle">Not available for this status yet.</div>
      </div>
    </div>
  {% else %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Play-by-Play</div>
        <div class="card-subtitle">Grouped by inning • each at-bat includes pitch table + strike zone</div>
      </div>

      <div style="padding: 0 14px 14px 14px;">

        {# Build ordered unique inning list #}
        {% set ns = namespace(innings=[]) %}
        {% for pa in game.pas %}
          {% if pa.inning and (pa.inning not in ns.innings) %}
            {% set _ = ns.innings.append(pa.inning) %}
          {% endif %}
        {% endfor %}

        {% for inn in ns.innings %}
          <details class="inning-details" open style="margin-top:10px;">
            <summary class="inning-summary">
              <span class="inning-pill mono">{{ ordinal(inn) }} Inning</span>
            </summary>

            <div style="margin-top:10px;">
              {% for pa in game.pas %}
                {% if pa.inning == inn %}
                  <details class="pa-details" style="margin-bottom:10px;">
                    <summary class="pa-summary">
                      <div class="pa-left">
                        <span class="half-pill mono">{{ pa.half }}</span>
                        <span>{{ pa.description or "" }}</span>
                      </div>
                      <div class="pa-right">
                        <span class="mono">{{ pa.summaryEvent if pa.summaryEvent is defined else (pa.event or "") }}</span>
                      </div>
                    </summary>

                    <div class="pa-body">
                      <div class="pa-grid">
                        <!-- Strike Zone Plot -->
                        <div class="zone-wrap">
                          <svg class="strike-zone" data-pitches='{{ (pa.pitches or []) | tojson }}' width="200" height="240"></svg>
                        </div>

                        <!-- Pitch Table -->
                        {% if pa.pitches and (pa.pitches|length) > 0 %}
                          <div class="pitch-wrap">
                            <div class="zone-title">Pitches</div>
                            <div style="overflow-x:auto;">
                              <table class="tbl">
                                <thead>
                                  <tr>
                                    <th class="mono">#</th>
                                    <th>Pitch</th>
                                    <th class="mono">MPH</th>
                                    <th class="mono">Spin</th>
                                    <th class="mono">VMov</th>
                                    <th class="mono">HMov</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  {% for p in pa.pitches %}
                                    <tr>
                                      <td class="mono">{{ p.n if p.n is defined else loop.index }}</td>
                                      <td>{{ p.pitchType if p.pitchType is defined else (p.pitch_name if p.pitch_name is defined else (p.type or "")) }}</td>
                                      <td class="mono">{{ dash(p.mph if p.mph is defined else p.startSpeed if p.startSpeed is defined else none) }}</td>
                                      <td class="mono">{{ dash(p.spinRate if p.spinRate is defined else none) }}</td>
                                      <td class="mono">{{ dash(p.vertMove if p.vertMove is defined else none) }}</td>
                                      <td class="mono">{{ dash(p.horizMove if p.horizMove is defined else none) }}</td>
                                    </tr>
                                  {% endfor %}
                                </tbody>
                              </table>
                            </div>
                          </div>
                        {% endif %}
                      </div>

                      {# Ball in play footer #}
                      {% if pa.battedBall is defined and pa.battedBall %}
                        <div class="bb-row muted small">
                          <div><span class="mono">EV:</span> {{ dash(pa.battedBall.exitVelo) }}{% if pa.battedBall.exitVelo is not none %} mph{% endif %}</div>
                          <div><span class="mono">LA:</span> {{ dash(pa.battedBall.launchAngle) }}{% if pa.battedBall.launchAngle is not none %}°{% endif %}</div>
                          <div>
                            <span class="mono">xBA:</span>
                            {% if pa.battedBall.xBA is not none %}
                              {{ '%.3f'|format(pa.battedBall.xBA) }}
                            {% else %}-{% endif %}
                          </div>
                          <div>
                            <span class="mono">Dir:</span>
                            {% if pa.battedBall.sprayAngle is not none %}
                              {{ '%.0f'|format(pa.battedBall.sprayAngle) }}°{% if pa.battedBall.directionLabel %} ({{ pa.battedBall.directionLabel }}){% endif %}
                            {% else %}
                              {{ dash(pa.battedBall.directionLabel) }}
                            {% endif %}
                          </div>
                        </div>
                      {% endif %}
                    </div>
                  </details>
                {% endif %}
              {% endfor %}
            </div>
          </details>
        {% endfor %}

      </div>
    </div>
  {% endif %}
</div>

<script>
(function(){
  // tabs
  const tabs = document.querySelectorAll(".tab-btn");
  const panels = document.querySelectorAll(".tab-panel");
  tabs.forEach(btn=>{
    btn.addEventListener("click", ()=>{
      tabs.forEach(b=>b.classList.remove("active"));
      panels.forEach(p=>p.classList.remove("active"));
      btn.classList.add("active");
      const id = "tab-" + btn.dataset.tab;
      const panel = document.getElementById(id);
      if(panel) panel.classList.add("active");
    });
  });

  // strike zone render
  function renderZone(svg, pitches){
    const w = parseFloat(svg.getAttribute("width") || 200);
    const h = parseFloat(svg.getAttribute("height") || 240);

    const pxs = pitches.map(p=>p.px).filter(v=>v!==null && v!==undefined);
    const pzs = pitches.map(p=>p.pz).filter(v=>v!==null && v!==undefined);
    const tops = pitches.map(p=>p.sz_top).filter(v=>v!==null && v!==undefined);
    const bots = pitches.map(p=>p.sz_bot).filter(v=>v!==null && v!==undefined);

    const zoneTop = tops.length ? (tops.reduce((a,b)=>a+b,0)/tops.length) : 3.5;
    const zoneBot = bots.length ? (bots.reduce((a,b)=>a+b,0)/bots.length) : 1.5;

    // px is typically in feet from center; map [-1.5, 1.5] -> [0,w]
    const xMin = -1.5, xMax = 1.5;
    const yMin = zoneBot - 0.8, yMax = zoneTop + 0.8;

    function xScale(x){ return ( (x - xMin) / (xMax - xMin) ) * w; }
    function yScale(y){ return h - ( (y - yMin) / (yMax - yMin) ) * h; }

    svg.innerHTML = "";

    const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
    rect.setAttribute("x", xScale(-0.83));
    rect.setAttribute("y", yScale(zoneTop));
    rect.setAttribute("width", xScale(0.83) - xScale(-0.83));
    rect.setAttribute("height", yScale(zoneBot) - yScale(zoneTop));
    rect.setAttribute("fill", "rgba(15,23,42,.03)");
    rect.setAttribute("stroke", "rgba(226,232,240,.9)");
    rect.setAttribute("stroke-width", "1");
    svg.appendChild(rect);

    pitches.forEach(p=>{
      if(p.px === null || p.px === undefined || p.pz === null || p.pz === undefined) return;
      const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
      c.setAttribute("cx", xScale(p.px));
      c.setAttribute("cy", yScale(p.pz));
      c.setAttribute("r", 4);

      let fill = "rgba(91,101,119,.65)";
      if(p.isInPlay) fill = "rgba(34,197,94,.75)";
      else if(p.isBall) fill = "rgba(59,130,246,.75)";
      else if(p.isStrike) fill = "rgba(239,68,68,.75)";
      c.setAttribute("fill", fill);
      c.setAttribute("stroke", "rgba(15,23,42,.25)");
      c.setAttribute("stroke-width", "0.5");
      svg.appendChild(c);
    });
  }

  document.querySelectorAll("svg.strike-zone").forEach(svg=>{
    try{
      const pitches = JSON.parse(svg.getAttribute("data-pitches") || "[]");
      renderZone(svg, pitches);
    }catch(e){}
  });
})();
</script>

{% endblock %}
