{% extends "base.html" %}
{% block content %}

{% set away = game.away if game.away is defined else {} %}
{% set home = game.home if game.home is defined else {} %}

{# -----------------------------
   Helpers (jinja-side)
   ----------------------------- #}
{% set status_lc = (game.statusPill|string)|lower %}
{% set is_final = ('final' in status_lc) or ('game over' in status_lc) or ('completed' in status_lc) %}

{% macro dash(v) -%}
  {%- if v is none or v == '' or v == 'None' -%}-{% else %}{{ v }}{% endif -%}
{%- endmacro %}

{% macro ordinal(n) -%}
  {%- set nn = (n|int) -%}
  {%- if 10 <= (nn % 100) <= 20 -%}
    {{ nn }}th
  {%- else -%}
    {%- set s = {1:'st',2:'nd',3:'rd'}.get(nn % 10, 'th') -%}
    {{ nn }}{{ s }}
  {%- endif -%}
{%- endmacro %}

{% if error %}
  <div class="card" style="border:1px solid rgba(239,68,68,.35); margin-bottom:14px;">
    <div class="card-header">
      <div class="card-title">Debug error</div>
      <div class="card-subtitle mono">{{ error }}</div>
    </div>
  </div>
{% endif %}

<!-- TOP: Game details card -->
<div class="card">
  <div class="card-header" style="display:flex; align-items:flex-start; justify-content:space-between; gap:14px; flex-wrap:wrap;">
    <div style="min-width:260px;">
      <div class="card-title">
        {{ away.abbrev }} @ {{ home.abbrev }}
      </div>

      <div class="card-subtitle">
        {{ game.statusPill }}
        {% if game.when %}<span class="muted" style="opacity:.6;"> • </span>{{ game.when }}{% endif %}
        {% if game.venue %}<span class="muted" style="opacity:.6;"> • </span>{{ game.venue }}{% endif %}
      </div>

      <div class="muted small" style="margin-top:6px;">
        {% if away.record %}{{ away.abbrev }} {{ away.record }}{% endif %}
        {% if home.record %}<span class="muted" style="opacity:.6;"> • </span>{{ home.abbrev }} {{ home.record }}{% endif %}
      </div>

      {# Probables only if NOT final #}
      {% if (not is_final) and game.probables %}
        <div class="small" style="margin-top:10px;">
          <span class="mono muted">PP:</span>
          {% if game.probables.away %} {{ away.abbrev }} {{ game.probables.away }}{% endif %}
          {% if game.probables.home %}<span class="muted" style="opacity:.6;"> • </span>{{ home.abbrev }} {{ game.probables.home }}{% endif %}
        </div>
      {% endif %}

      {# Decisions: support both old keys (w/l/s) and new keys (winner/loser/save) #}
      {% if is_final and game.decisions %}
        {% set wname = game.decisions.winner if game.decisions.winner is defined else game.decisions.w %}
        {% set lname = game.decisions.loser if game.decisions.loser is defined else game.decisions.l %}
        {% set sname = game.decisions.save if game.decisions.save is defined else game.decisions.s %}
        <div class="small" style="margin-top:10px; display:flex; gap:16px; flex-wrap:wrap;">
          <div><span class="mono muted">W:</span> {{ dash(wname) }}</div>
          <div><span class="mono muted">L:</span> {{ dash(lname) }}</div>
          <div><span class="mono muted">SV:</span> {{ dash(sname) }}</div>
        </div>
      {% endif %}
    </div>

    {# Scoreboard / logos #}
    <div style="flex:1; min-width:320px; display:flex; justify-content:flex-end;">
      <div style="display:flex; align-items:center; gap:14px; padding-top:2px;">
        <div style="display:flex; align-items:center; gap:10px;">
          {% if away.logo_url %}
            <img class="teamlogo" src="{{ away.logo_url }}" alt="{{ away.abbrev }} logo" style="height:38px;">
          {% endif %}
          <div style="display:flex; align-items:baseline; gap:8px;">
            <div class="mono" style="font-size:18px;">{{ away.abbrev }}</div>
            <div class="mono" style="font-size:34px; line-height:1;">{{ dash(away.score if away.score is defined else away.runs if away.runs is defined else none) }}</div>
          </div>
        </div>

        <div class="mono muted" style="opacity:.7; font-size:18px;">@</div>

        <div style="display:flex; align-items:center; gap:10px;">
          <div style="display:flex; align-items:baseline; gap:8px;">
            <div class="mono" style="font-size:34px; line-height:1;">{{ dash(home.score if home.score is defined else home.runs if home.runs is defined else none) }}</div>
            <div class="mono" style="font-size:18px;">{{ home.abbrev }}</div>
          </div>
          {% if home.logo_url %}
            <img class="teamlogo" src="{{ home.logo_url }}" alt="{{ home.abbrev }} logo" style="height:38px;">
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

{# -----------------------------
   Linescore moved UNDER game details card
   ----------------------------- #}
{% set innings = (game.linescore.innings if game.linescore and game.linescore.innings is defined else []) %}
{% if innings %}
  <div class="card" style="margin-top:14px;">
    <div class="card-header">
      <div class="card-title">Linescore</div>
    </div>

    <div style="padding: 0 14px 14px 14px; overflow-x:auto;">
      <table class="tbl">
        <thead>
          <tr>
            <th></th>
            {% for inn in innings %}
              <th class="mono" style="text-align:center;">{{ inn.num }}</th>
            {% endfor %}
            <th class="mono" style="text-align:center;">R</th>
            <th class="mono" style="text-align:center;">H</th>
            <th class="mono" style="text-align:center;">E</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="mono">
              {% if away.logo_url %}<img class="teamlogo" src="{{ away.logo_url }}" style="height:18px; vertical-align:middle; margin-right:6px;">{% endif %}
              {{ away.abbrev }}
            </td>
            {% for inn in innings %}
              <td class="mono" style="text-align:center;">{{ dash(inn.away.runs if inn.away is defined else none) }}</td>
            {% endfor %}
            <td class="mono" style="text-align:center;">{{ dash(game.linescore.teams.away.runs) }}</td>
            <td class="mono" style="text-align:center;">{{ dash(game.linescore.teams.away.hits) }}</td>
            <td class="mono" style="text-align:center;">{{ dash(game.linescore.teams.away.errors) }}</td>
          </tr>

          <tr>
            <td class="mono">
              {% if home.logo_url %}<img class="teamlogo" src="{{ home.logo_url }}" style="height:18px; vertical-align:middle; margin-right:6px;">{% endif %}
              {{ home.abbrev }}
            </td>
            {% for inn in innings %}
              <td class="mono" style="text-align:center;">{{ dash(inn.home.runs if inn.home is defined else none) }}</td>
            {% endfor %}
            <td class="mono" style="text-align:center;">{{ dash(game.linescore.teams.home.runs) }}</td>
            <td class="mono" style="text-align:center;">{{ dash(game.linescore.teams.home.hits) }}</td>
            <td class="mono" style="text-align:center;">{{ dash(game.linescore.teams.home.errors) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
{% endif %}

<!-- Tabs -->
<div class="tabs" style="margin-top:14px;">
  <button class="tab-btn active" data-tab="overview">Overview</button>
  <button class="tab-btn" data-tab="box">Box</button>
  <button class="tab-btn" data-tab="scoring">Scoring</button>
  <button class="tab-btn" data-tab="pbp">Play-by-Play</button>
</div>

<!-- OVERVIEW (kept empty for now) -->
<div class="tab-panel active" id="tab-overview">
  <div class="card" style="margin-top:14px;">
    <div class="card-header">
      <div class="card-title">Overview</div>
      <div class="card-subtitle">Coming soon.</div>
    </div>
  </div>
</div>

<!-- BOX -->
<div class="tab-panel" id="tab-box">
  {% if not game.box %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Box</div>
        <div class="card-subtitle">Not available for this status yet.</div>
      </div>
    </div>
  {% else %}

    {# Batting side-by-side #}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Batting</div>
        <div class="card-subtitle">{{ away.abbrev }} vs {{ home.abbrev }}</div>
      </div>

      <div style="padding: 0 14px 14px 14px;">
        <div class="grid2">
          <div>
            <div class="mono muted small" style="margin: 8px 0 6px 0;">{{ away.abbrev }} Batting</div>
            <div style="overflow-x:auto;">
              <table class="tbl">
                <thead>
                  <tr>
                    <th>Player</th>
                    <th class="mono">AB</th><th class="mono">R</th><th class="mono">H</th><th class="mono">RBI</th>
                    <th class="mono">BB</th><th class="mono">SO</th><th class="mono">HR</th>
                    {# AVG removed for now #}
                  </tr>
                </thead>
                <tbody>
                  {% for r in game.box.away.batting %}
                    {# extra safety: skip pitchers with no batting impact if backend didn't filter #}
                    {% set is_pitcher = (r.pos|string)|upper == 'P' %}
                    {% set abv = (r.AB if r.AB is defined else 0) %}
                    {% if not (is_pitcher and (abv == 0 or abv == '-' or abv is none)) %}
                      <tr>
                        <td>
                          {% if r.playerId %}<a href="/player/{{ r.playerId }}">{{ r.name }}</a>{% else %}{{ r.name }}{% endif %}
                          {% if r.pos %}<span class="muted small"> {{ r.pos }}</span>{% endif %}
                        </td>
                        <td class="mono">{{ dash(r.AB) }}</td><td class="mono">{{ dash(r.R) }}</td><td class="mono">{{ dash(r.H) }}</td><td class="mono">{{ dash(r.RBI) }}</td>
                        <td class="mono">{{ dash(r.BB) }}</td><td class="mono">{{ dash(r.SO) }}</td><td class="mono">{{ dash(r.HR) }}</td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div>
            <div class="mono muted small" style="margin: 8px 0 6px 0;">{{ home.abbrev }} Batting</div>
            <div style="overflow-x:auto;">
              <table class="tbl">
                <thead>
                  <tr>
                    <th>Player</th>
                    <th class="mono">AB</th><th class="mono">R</th><th class="mono">H</th><th class="mono">RBI</th>
                    <th class="mono">BB</th><th class="mono">SO</th><th class="mono">HR</th>
                    {# AVG removed for now #}
                  </tr>
                </thead>
                <tbody>
                  {% for r in game.box.home.batting %}
                    {% set is_pitcher = (r.pos|string)|upper == 'P' %}
                    {% set abv = (r.AB if r.AB is defined else 0) %}
                    {% if not (is_pitcher and (abv == 0 or abv == '-' or abv is none)) %}
                      <tr>
                        <td>
                          {% if r.playerId %}<a href="/player/{{ r.playerId }}">{{ r.name }}</a>{% else %}{{ r.name }}{% endif %}
                          {% if r.pos %}<span class="muted small"> {{ r.pos }}</span>{% endif %}
                        </td>
                        <td class="mono">{{ dash(r.AB) }}</td><td class="mono">{{ dash(r.R) }}</td><td class="mono">{{ dash(r.H) }}</td><td class="mono">{{ dash(r.RBI) }}</td>
                        <td class="mono">{{ dash(r.BB) }}</td><td class="mono">{{ dash(r.SO) }}</td><td class="mono">{{ dash(r.HR) }}</td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        {# Pitching (optional section below) #}
        <div class="grid2" style="margin-top:16px;">
          <div>
            <div class="mono muted small" style="margin: 8px 0 6px 0;">{{ away.abbrev }} Pitching</div>
            <div style="overflow-x:auto;">
              <table class="tbl">
                <thead>
                  <tr>
                    <th>Pitcher</th>
                    <th class="mono">IP</th><th class="mono">H</th><th class="mono">R</th><th class="mono">ER</th>
                    <th class="mono">BB</th><th class="mono">SO</th><th class="mono">HR</th><th class="mono">ERA</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in game.box.away.pitching %}
                    <tr>
                      <td>{% if r.playerId %}<a href="/player/{{ r.playerId }}">{{ r.name }}</a>{% else %}{{ r.name }}{% endif %}</td>
                      <td class="mono">{{ dash(r.IP) }}</td><td class="mono">{{ dash(r.H) }}</td><td class="mono">{{ dash(r.R) }}</td><td class="mono">{{ dash(r.ER) }}</td>
                      <td class="mono">{{ dash(r.BB) }}</td><td class="mono">{{ dash(r.SO) }}</td><td class="mono">{{ dash(r.HR) }}</td><td class="mono">{{ dash(r.ERA) }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div>
            <div class="mono muted small" style="margin: 8px 0 6px 0;">{{ home.abbrev }} Pitching</div>
            <div style="overflow-x:auto;">
              <table class="tbl">
                <thead>
                  <tr>
                    <th>Pitcher</th>
                    <th class="mono">IP</th><th class="mono">H</th><th class="mono">R</th><th class="mono">ER</th>
                    <th class="mono">BB</th><th class="mono">SO</th><th class="mono">HR</th><th class="mono">ERA</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in game.box.home.pitching %}
                    <tr>
                      <td>{% if r.playerId %}<a href="/player/{{ r.playerId }}">{{ r.name }}</a>{% else %}{{ r.name }}{% endif %}</td>
                      <td class="mono">{{ dash(r.IP) }}</td><td class="mono">{{ dash(r.H) }}</td><td class="mono">{{ dash(r.R) }}</td><td class="mono">{{ dash(r.ER) }}</td>
                      <td class="mono">{{ dash(r.BB) }}</td><td class="mono">{{ dash(r.SO) }}</td><td class="mono">{{ dash(r.HR) }}</td><td class="mono">{{ dash(r.ERA) }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  {% endif %}
</div>

<!-- SCORING -->
<div class="tab-panel" id="tab-scoring">
  {% if not game.scoring %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Scoring</div>
        <div class="card-subtitle">Not available for this status yet.</div>
      </div>
    </div>
  {% else %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Scoring plays</div>
        <div class="card-subtitle">{{ game.scoring|length }} plays</div>
      </div>

      <div style="padding: 0 14px 14px 14px;">
        {% for x in game.scoring %}
          <div class="row" style="padding:10px 0; border-bottom:1px solid rgba(226,232,240,.7); display:flex; justify-content:space-between; gap:14px; align-items:flex-start;">
            <div style="flex:1; min-width:0;">
              <div class="mono muted small">
                {{ x.inningLabel if x.inningLabel is defined else (x.half ~ ' ' ~ x.inning) }}
              </div>
              <div style="margin-top:3px;">{{ x.description }}</div>
            </div>

            <div style="display:flex; gap:12px; align-items:center;">
              <div style="display:flex; align-items:center; gap:8px; min-width:56px; justify-content:flex-end;">
                {% if away.logo_url %}<img class="teamlogo" src="{{ away.logo_url }}" style="height:16px;">{% endif %}
                <div class="mono">{{ dash(x.awayScore) }}</div>
              </div>
              <div style="display:flex; align-items:center; gap:8px; min-width:56px; justify-content:flex-end;">
                {% if home.logo_url %}<img class="teamlogo" src="{{ home.logo_url }}" style="height:16px;">{% endif %}
                <div class="mono">{{ dash(x.homeScore) }}</div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}
</div>

<!-- PLAY-BY-PLAY (PA-style UI) -->
<div class="tab-panel" id="tab-pbp">
  {% if not game.pas %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Play-by-Play</div>
        <div class="card-subtitle">Not available for this status yet.</div>
      </div>
    </div>
  {% else %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Play-by-Play</div>
        <div class="card-subtitle">Grouped by inning • each at-bat includes pitch table + strike zone</div>
      </div>

      <div style="padding: 0 14px 14px 14px;">

        {# Build ordered unique inning list #}
        {% set ns = namespace(innings=[]) %}
        {% for pa in game.pas %}
          {% if pa.inning and (pa.inning not in ns.innings) %}
            {% set _ = ns.innings.append(pa.inning) %}
          {% endif %}
        {% endfor %}

        {% for inn in ns.innings %}
          <details class="inning-details" open style="margin-top:10px;">
            <summary class="inning-summary">
              <span class="mono">{{ ordinal(inn) }} inning</span>
              <span class="muted small">Top + Bottom</span>
            </summary>

            <div style="margin-top:10px;">
              <div class="mono muted small" style="margin: 6px 0;">Top</div>

              {% set any_top = false %}
              {% for pa in game.pas %}
                {% set half_val = pa.half if pa.half is defined else '' %}
                {% if pa.inning == inn and (half_val == "Top" or half_val == "TOP") %}
                  {% set any_top = true %}
                  <details class="pa-details" style="margin-bottom:10px;">
                    <summary class="pa-summary">
                      <div class="pa-left">
                        <span>{{ pa.description or "" }}</span>
                      </div>
                      <div class="pa-right">
                        {# ONLY show event/summary on the right #}
                        <span class="mono">
                          {{ pa.summaryEvent if pa.summaryEvent is defined else (pa.event or "") }}
                        </span>
                      </div>
                    </summary>

                    {% if pa.pitches %}
                      <div class="pa-grid">
                        <div class="zone-wrap">
                          <div class="zone-title">Strike zone</div>
                          <svg class="zone-plot"
                               width="160" height="210"
                               data-pitches='{{ pa.pitches|tojson }}'>
                          </svg>
                          <div class="muted small" style="margin-top:6px;">
                            Vertical axis is relative to the hitter's strike zone (0 = bottom of zone). Colors: ball/strike/foul/in-play.
                          </div>
                        </div>

                        <div class="table-wrap">
                          <div class="zone-title">Pitches</div>
                          <div style="overflow-x:auto;">
                            <table class="tbl">
                              <thead>
                                <tr>
                                  <th class="mono">#</th>
                                  <th>Pitch</th>
                                  <th class="mono">MPH</th>
                                  <th class="mono">Spin</th>
                                  <th class="mono">VMov</th>
                                  <th class="mono">HMov</th>
                                </tr>
                              </thead>
                              <tbody>
                                {% for p in pa.pitches %}
                                  <tr>
                                    <td class="mono">{{ p.n if p.n is defined else loop.index }}</td>
                                    <td>
                                      {{ p.pitchType if p.pitchType is defined else (p.pitch_name if p.pitch_name is defined else (p.type or "")) }}
                                    </td>
                                    <td class="mono">
                                      {{ dash(p.mph if p.mph is defined else p.startSpeed if p.startSpeed is defined else none) }}
                                    </td>
                                    <td class="mono">{{ dash(p.spinRate if p.spinRate is defined else none) }}</td>
                                    <td class="mono">{{ dash(p.vertMove if p.vertMove is defined else none) }}</td>
                                    <td class="mono">{{ dash(p.horizMove if p.horizMove is defined else none) }}</td>
                                  </tr>
                                {% endfor %}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    {% endif %}

                    {# Batted ball footer #}
                    {% if pa.battedBall is defined and pa.battedBall %}
                      <div class="muted small" style="margin-top:10px; display:flex; gap:16px; flex-wrap:wrap;">
                        <div><span class="mono">EV:</span> {{ dash(pa.battedBall.exitVelo) }}{% if pa.battedBall.exitVelo is not none %} mph{% endif %}</div>
                        <div><span class="mono">Dist:</span> {{ dash(pa.battedBall.distance) }}{% if pa.battedBall.distance is not none %} ft{% endif %}</div>
                        <div><span class="mono">Dir:</span> {{ dash(pa.battedBall.direction) }}</div>
                      </div>
                    {% endif %}
                  </details>
                {% endif %}
              {% endfor %}
              {% if not any_top %}
                <div class="muted small" style="margin: 6px 0 0 0;">No plays recorded.</div>
              {% endif %}

              <div class="mono muted small" style="margin: 14px 0 6px 0;">Bottom</div>

              {% set any_bot = false %}
              {% for pa in game.pas %}
                {% set half_val = pa.half if pa.half is defined else '' %}
                {% if pa.inning == inn and (half_val == "Bottom" or half_val == "Bot" or half_val == "BOTTOM") %}
                  {% set any_bot = true %}
                  <details class="pa-details" style="margin-bottom:10px;">
                    <summary class="pa-summary">
                      <div class="pa-left">
                        <span>{{ pa.description or "" }}</span>
                      </div>
                      <div class="pa-right">
                        <span class="mono">
                          {{ pa.summaryEvent if pa.summaryEvent is defined else (pa.event or "") }}
                        </span>
                      </div>
                    </summary>

                    {% if pa.pitches %}
                      <div class="pa-grid">
                        <div class="zone-wrap">
                          <div class="zone-title">Strike zone</div>
                          <svg class="zone-plot"
                               width="160" height="210"
                               data-pitches='{{ pa.pitches|tojson }}'>
                          </svg>
                          <div class="muted small" style="margin-top:6px;">
                            Vertical axis is relative to the hitter's strike zone (0 = bottom of zone). Colors: ball/strike/foul/in-play.
                          </div>
                        </div>

                        <div class="table-wrap">
                          <div class="zone-title">Pitches</div>
                          <div style="overflow-x:auto;">
                            <table class="tbl">
                              <thead>
                                <tr>
                                  <th class="mono">#</th>
                                  <th>Pitch</th>
                                  <th class="mono">MPH</th>
                                  <th class="mono">Spin</th>
                                  <th class="mono">VMov</th>
                                  <th class="mono">HMov</th>
                                </tr>
                              </thead>
                              <tbody>
                                {% for p in pa.pitches %}
                                  <tr>
                                    <td class="mono">{{ p.n if p.n is defined else loop.index }}</td>
                                    <td>
                                      {{ p.pitchType if p.pitchType is defined else (p.pitch_name if p.pitch_name is defined else (p.type or "")) }}
                                    </td>
                                    <td class="mono">
                                      {{ dash(p.mph if p.mph is defined else p.startSpeed if p.startSpeed is defined else none) }}
                                    </td>
                                    <td class="mono">{{ dash(p.spinRate if p.spinRate is defined else none) }}</td>
                                    <td class="mono">{{ dash(p.vertMove if p.vertMove is defined else none) }}</td>
                                    <td class="mono">{{ dash(p.horizMove if p.horizMove is defined else none) }}</td>
                                  </tr>
                                {% endfor %}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    {% endif %}

                    {% if pa.battedBall is defined and pa.battedBall %}
                      <div class="muted small" style="margin-top:10px; display:flex; gap:16px; flex-wrap:wrap;">
                        <div><span class="mono">EV:</span> {{ dash(pa.battedBall.exitVelo) }}{% if pa.battedBall.exitVelo is not none %} mph{% endif %}</div>
                        <div><span class="mono">Dist:</span> {{ dash(pa.battedBall.distance) }}{% if pa.battedBall.distance is not none %} ft{% endif %}</div>
                        <div><span class="mono">Dir:</span> {{ dash(pa.battedBall.direction) }}</div>
                      </div>
                    {% endif %}
                  </details>
                {% endif %}
              {% endfor %}
              {% if not any_bot %}
                <div class="muted small" style="margin: 6px 0 0 0;">No plays recorded.</div>
              {% endif %}
            </div>
          </details>
        {% endfor %}
      </div>
    </div>
  {% endif %}
</div>

<script>
  // Tabs
  (function(){
    const btns = Array.from(document.querySelectorAll(".tab-btn"));
    const panels = {
      overview: document.getElementById("tab-overview"),
      box: document.getElementById("tab-box"),
      scoring: document.getElementById("tab-scoring"),
      pbp: document.getElementById("tab-pbp"),
    };

    btns.forEach(b => {
      b.addEventListener("click", () => {
        btns.forEach(x => x.classList.remove("active"));
        b.classList.add("active");
        const t = b.getAttribute("data-tab");
        Object.keys(panels).forEach(k => panels[k].classList.toggle("active", k === t));
      });
    });
  })();

  // Strike zone plots (zone-relative vertical axis)
  (function(){
    function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

    function drawZone(svg, pitches){
      const wAttr = svg.getAttribute("width");
      const hAttr = svg.getAttribute("height");
      const W = Number(wAttr || 160);
      const H = Number(hAttr || 210);

      // Layout
      const pad = 18;
      const zx = pad, zy = pad;
      const zw = W - pad*2, zh = H - pad*2;

      // Clear
      while (svg.firstChild) svg.removeChild(svg.firstChild);

      // Background
      const bg = document.createElementNS("http://www.w3.org/2000/svg","rect");
      bg.setAttribute("x", 0); bg.setAttribute("y", 0);
      bg.setAttribute("width", W); bg.setAttribute("height", H);
      bg.setAttribute("rx", 14);
      bg.setAttribute("fill", "rgba(255,255,255,.9)");
      bg.setAttribute("stroke", "rgba(226,232,240,.9)");
      svg.appendChild(bg);

      // Determine hitter-specific zone edges (feet off ground)
      const DEFAULT_TOP = 3.5, DEFAULT_BOT = 1.5;
      let szTop = DEFAULT_TOP, szBot = DEFAULT_BOT;
      for (const p of (pitches || [])){
        const t = Number(p.sz_top), b = Number(p.sz_bot);
        if (Number.isFinite(t) && Number.isFinite(b) && t > b){
          szTop = t; szBot = b;
          break;
        }
      }

      // Zone-relative vertical axis:
      // y=0 corresponds to sz_bot; y=zoneH corresponds to sz_top
      const zoneH = Math.max(0.1, szTop - szBot);

      // "Canvas" ranges (bigger than the strike zone)
      const xMin = -1.5, xMax =  1.5;        // feet, centered at 0
      const yMin = -1.0, yMax = zoneH + 1.0; // zone-relative feet

      function xToSvg(xFeet){
        return zx + ((clamp(xFeet, xMin, xMax) - xMin) / (xMax - xMin)) * zw;
      }
      function yToSvg(yRel){
        return zy + (1.0 - ((clamp(yRel, yMin, yMax) - yMin) / (yMax - yMin))) * zh;
      }

      // Strike zone rectangle (true horizontal edges, and vertical edges in zone-relative units)
      const ZLEFT = -0.83, ZRIGHT = 0.83;
      const zone = document.createElementNS("http://www.w3.org/2000/svg","rect");
      zone.setAttribute("x", xToSvg(ZLEFT));
      zone.setAttribute("y", yToSvg(zoneH));
      zone.setAttribute("width", xToSvg(ZRIGHT) - xToSvg(ZLEFT));
      zone.setAttribute("height", yToSvg(0) - yToSvg(zoneH));
      zone.setAttribute("fill", "rgba(15,23,42,.04)");
      zone.setAttribute("stroke", "rgba(15,23,42,.22)");
      zone.setAttribute("rx", 10);
      svg.appendChild(zone);

      function outcomeColor(p){
        const call = String(p.call || "").toLowerCase();
        const desc = String(p.desc || "").toLowerCase();
        const inPlay = (p.isInPlay === true) || desc.includes("in play") || call.includes("in play");
        if (inPlay) return "rgba(37,99,235,.85)"; // blue: in play
        if (call.includes("foul") || desc.includes("foul")) return "rgba(100,116,139,.85)"; // gray: foul
        if ((p.isBall === true) || call.includes("ball")) return "rgba(34,197,94,.85)"; // green: ball
        if ((p.isStrike === true) || call.includes("strike")) return "rgba(239,68,68,.85)"; // red: strike
        return "rgba(239,68,68,.85)";
      }

      // Plot dots using pX (feet) and pZ (feet off ground) converted to zone-relative:
      // yRel = pz - sz_bot
      (pitches || []).forEach((p) => {
        if (p.px == null || p.pz == null) return;

        const xFeet = Number(p.px);
        const pzAbs = Number(p.pz);
        if (!Number.isFinite(xFeet) || !Number.isFinite(pzAbs)) return;

        const yRel = pzAbs - szBot;

        const x = xToSvg(xFeet);
        const y = yToSvg(yRel);

        const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
        c.setAttribute("cx", x);
        c.setAttribute("cy", y);
        c.setAttribute("r", 6.0);
        c.setAttribute("fill", outcomeColor(p));
        c.setAttribute("stroke", "rgba(15,23,42,.35)");
        svg.appendChild(c);

        // sequence number
        const t = document.createElementNS("http://www.w3.org/2000/svg","text");
        t.setAttribute("x", x);
        t.setAttribute("y", y);
        t.setAttribute("text-anchor", "middle");
        t.setAttribute("dominant-baseline", "middle");
        t.setAttribute("font-size", "7");
        t.setAttribute("font-family", "IBM Plex Mono, ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace");
        t.setAttribute("fill", "rgba(255,255,255,.95)");
        t.setAttribute("stroke", "rgba(15,23,42,.45)");
        t.setAttribute("stroke-width", "2");
        t.setAttribute("paint-order", "stroke");
        t.textContent = String(p.n || "");
        svg.appendChild(t);
      });
    }

    document.querySelectorAll(".zone-plot").forEach(svg => {
      let pitches = [];
      try { pitches = JSON.parse(svg.getAttribute("data-pitches") || "[]"); } catch(e) {}
      drawZone(svg, pitches);
    });
  })();
</script>

{% endblock %}
