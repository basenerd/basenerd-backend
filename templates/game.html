{% extends "base.html" %}
{% block content %}

{% set away = game.away if game.away is defined else {} %}
{% set home = game.home if game.home is defined else {} %}

{# -----------------------------
   Helpers (jinja-side)
   ----------------------------- #}
{% set status_lc = (game.statusPill|string)|lower %}
{% set is_final = ('final' in status_lc) or ('game over' in status_lc) or ('completed' in status_lc) %}
{% set is_live = (not is_final) and (('in progress' in status_lc) or ('live' in status_lc) or ('warmup' in status_lc) or ('game delayed' in status_lc)) %}

{% macro dash(v) -%}
  {%- if v is none or v == '' or v == 'None' or v == '-' -%}-{% else %}{{ v }}{% endif -%}
{%- endmacro %}

{% macro ordinal(n) -%}
  {%- set nn = (n|int) -%}
  {%- if 10 <= (nn % 100) <= 20 -%}
    {{ nn }}th
  {%- else -%}
    {%- set s = {1:'st',2:'nd',3:'rd'}.get(nn % 10, 'th') -%}
    {{ nn }}{{ s }}
  {%- endif -%}
{%- endmacro %}


<style>

  /* ==========================================================
     GAMECAST (scoped to game.html only)
     ========================================================== */
  #tab-gamecast .gc-grid{
    display:grid;
    gap:14px;
    align-items:start;

    /* 3 columns: away | center | home */
    grid-template-columns: minmax(260px,320px) minmax(520px,1fr) minmax(260px,320px);
    align-items: start;
  }

  #tab-gamecast .gc-grid-wrap{
    overflow-x:auto;
  }
  #tab-gamecast .gc-grid{
    min-width: 1120px;
  }

  #tab-gamecast .gc-center{
    min-width:0;
  }
#tab-gamecast .gc-midgrid > .card{
  height:100%;
}
  #tab-gamecast .gc-lineup{
    padding:10px 10px 12px 10px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
#tab-gamecast .gc-bases-diamond{
  position:relative;
  width:140px;
  height:140px;
}
/* Zone + Bases layout */
#tab-gamecast .gc-midgrid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  align-items: start;
}

/* THIS is the key line */
#tab-gamecast .gc-midgrid .gc-pitchescard{
  grid-column: 1 / -1;
}
#tab-gamecast #gc-pitch-table{
  width:100%;
  table-layout:auto;
}

#tab-gamecast #gc-pitch-table th,
#tab-gamecast #gc-pitch-table td{
  white-space:nowrap;
}

#tab-gamecast #gc-pitch-table th:last-child,
#tab-gamecast #gc-pitch-table td:last-child{
  white-space:normal;
}
#tab-gamecast .gc-base{
  position:absolute;
  width:24px;
  height:24px;
  border-radius:6px;
  border:1px solid rgba(148,163,184,.35);
  background: rgba(255,255,255,.75);
  transform:translate(-50%,-50%) rotate(45deg);
}

#tab-gamecast .gc-base.on{
  background: rgba(250, 204, 21, .95);
  border-color: rgba(234,179,8,.95);
}

#tab-gamecast .gc-base.first{ left:80%; top:50%; }
#tab-gamecast .gc-base.second{ left:50%; top:20%; }
#tab-gamecast .gc-base.third{ left:20%; top:50%; }
#tab-gamecast .gc-base.home{ left:50%; top:80%; }
  /* Player row (NOT <details> for whole card) */
  #tab-gamecast .gc-player{
    border:1px solid rgba(148,163,184,.22);
    border-radius:12px;
    background: rgba(15,23,42,.02);
    overflow:hidden;
  }
  #tab-gamecast .gc-player.open{
    background: rgba(15,23,42,.03);
  }
  #tab-gamecast .gc-row{
    cursor:pointer;
    display:flex;
    gap:10px;
    align-items:center;
    padding:10px 10px;
  }
  #tab-gamecast .gc-headshot{
    width:34px; height:34px;
    border-radius:999px;
    object-fit:cover;
    background: rgba(0,0,0,.06);
    border:1px solid rgba(148,163,184,.25);
    flex:0 0 auto;
  }
  #tab-gamecast .gc-row-main{
    min-width:0;
    flex:1 1 auto;
  }
  #tab-gamecast .gc-name{
    font-weight:700;
    display:flex;
    align-items:center;
    gap:8px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  #tab-gamecast .gc-pos{
    font-size:12px;
    opacity:.7;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.25);
    background:rgba(255,255,255,.55);
    flex:0 0 auto;
  }
  #tab-gamecast .gc-statline{
    font-size:12px;
    opacity:.75;
    margin-top:2px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  #tab-gamecast .gc-pa{
    display:none;
    padding:8px 10px 10px 10px;
    border-top:1px solid rgba(148,163,184,.18);
    flex-direction:column;
    gap:6px;
  }
  #tab-gamecast .gc-player.open .gc-pa{
    display:flex;
  }
  #tab-gamecast .gc-pa-item{
    font-size:12px;
    opacity:.9;
    display:flex;
    gap:8px;
  }
  #tab-gamecast .gc-pa-inning{
    font-family: IBM Plex Mono, ui-monospace, Menlo, monospace;
    opacity:.7;
    width:44px;
    flex:0 0 auto;
  }

  #tab-gamecast .gc-matchup{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }
  #tab-gamecast .gc-person{
    border:1px solid rgba(148,163,184,.22);
    border-radius:14px;
    padding:10px 12px;
    background: rgba(255,255,255,.55);
    min-width:0;
  }
  #tab-gamecast .gc-person .gc-person-top{
    display:flex;
    gap:10px;
    align-items:center;
  }
  #tab-gamecast .gc-person .gc-person-hs{
    width:46px; height:46px;
    border-radius:999px;
    object-fit:cover;
    border:1px solid rgba(148,163,184,.25);
    background: rgba(0,0,0,.06);
    flex:0 0 auto;
  }
  #tab-gamecast .gc-person .gc-person-role{
    font-size:12px;
    opacity:.7;
  }
  #tab-gamecast .gc-person .gc-person-name{
    font-weight:800;
    font-size:16px;
    line-height:1.15;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  #tab-gamecast .gc-person .gc-person-line{
    margin-top:6px;
    font-size:12px;
    opacity:.8;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  #tab-gamecast .gc-midgrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
    align-items:stretch;
  }

  #tab-gamecast .gc-dots{
    display:flex;
    gap:6px;
    align-items:center;
  }
  #tab-gamecast .gc-dot{
    width:10px; height:10px; border-radius:999px;
    border:1px solid rgba(15,23,42,.18);
    background: rgba(148,163,184,.25);
  }
  #tab-gamecast .gc-dot.on.ball{ background: rgba(34,197,94,.95); }
  #tab-gamecast .gc-dot.on.strike{ background: rgba(239,68,68,.95); }
  #tab-gamecast .gc-dot.on.out{ background: rgba(239,68,68,.95); }

  /* Field */
  #tab-gamecast .gc-field{
    position:relative;
    width:100%;
    height:260px;
    border-radius:16px;
    background:
      radial-gradient(circle at 50% 88%, rgba(148,163,184,.22) 0%, rgba(148,163,184,0) 55%),
      linear-gradient(180deg, rgba(34,197,94,.12), rgba(34,197,94,.06));
    border:1px solid rgba(148,163,184,.22);
    overflow:hidden;
  }
  #tab-gamecast .gc-diamond{
    position:absolute;
    left:50%;
    top:54%;
    width:170px;
    height:170px;
    transform: translate(-50%, -50%) rotate(45deg);
    background: rgba(148,163,184,.14);
    border:1px solid rgba(148,163,184,.22);
    border-radius:18px;
  }
  #tab-gamecast .gc-base{
    position:absolute;
    width:16px; height:16px;
    background: rgba(255,255,255,.85);
    border:1px solid rgba(15,23,42,.2);
    border-radius:4px;
    transform: translate(-50%, -50%) rotate(45deg);
    box-shadow: 0 2px 10px rgba(15,23,42,.08);
  }
  #tab-gamecast .gc-base.on{
    background: rgba(250,204,21,.95);
    border-color: rgba(161,98,7,.35);
  }
  #tab-gamecast .gc-label{
    position:absolute;
    font-size:12px;
    font-weight:700;
    color: rgba(15,23,42,.88);
    text-shadow: 0 1px 0 rgba(255,255,255,.65);
    transform: translate(-50%, -50%);
    white-space:nowrap;
    padding:2px 6px;
    border-radius:999px;
    background: rgba(255,255,255,.55);
    border:1px solid rgba(148,163,184,.22);
  }
  #tab-gamecast .gc-label.small{
    font-size:11px;
    font-weight:650;
    opacity:.92;
  }

  /* Bases / runners (separate card) */
  #tab-gamecast .gc-bases-list{
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  #tab-gamecast .gc-base-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:8px 10px;
    border:1px solid rgba(148,163,184,.22);
    border-radius:12px;
    background: rgba(15,23,42,.02);
  }
  #tab-gamecast .gc-base-k{
    font-family: IBM Plex Mono, ui-monospace, Menlo, monospace;
    font-size:12px;
    opacity:.7;
    white-space:nowrap;
  }
  #tab-gamecast .gc-base-v{
    font-weight:800;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  /* --- GameCast: pulse new pitch dots in the strike zone --- */
  @keyframes gcPulse {
    0%   { transform: scale(0.35); opacity: 0; }
    35%  { transform: scale(1.15); opacity: 0.95; }
    100% { transform: scale(1.00); opacity: 1; }
  }
  #tab-gamecast .gc-pulse {
    transform-box: fill-box;
    transform-origin: center;
    animation: gcPulse 650ms ease-out 1;
  }



  @media (max-width: 650px){
    /* keep as scroll instead of stacking home lineup below */
    #tab-gamecast .gc-midgrid{ grid-template-columns: 1fr; }
  }

  /* ==========================================================
     PBP: 4-column layout inside each PA
     Zone | Pitches | Spray | BB metrics
     (Scoped to game.html only)
     ========================================================== */

  /* override global .pa-grid (styles.css sets 2 cols) */
  #tab-pbp .pa-grid{
    display:grid;
    grid-template-columns: 220px minmax(320px, 1fr) 240px 170px;
    gap:12px;
    align-items:start;
  }
  @media (max-width: 980px){
    #tab-pbp .pa-grid{
      grid-template-columns: 220px 1fr;
    }
  }
  @media (max-width: 720px){
    #tab-pbp .pa-grid{
      grid-template-columns: 1fr;
    }
  }

  /* Make sure panels can shrink without overflow */
  #tab-pbp .zone-wrap,
  #tab-pbp .pitch-wrap,
  #tab-pbp .spray-mini-wrap,
  #tab-pbp .bb-metrics-wrap{
    min-width:0;
  }

  /* Mini spray chart */
  .spray-mini-wrap{ min-width: 240px; }
  .spray-mini-card{
    border: 1px solid rgba(2,6,23,.12);
    border-radius: 12px;
    overflow: hidden;
    background: #fff;
  }
  .spray-svg-mini{
    width: 240px;
    height: 240px;
    display: block;
    background: #fff;
  }
  @media (max-width: 720px){
    .spray-svg-mini{ width: 220px; height: 220px; }
    .spray-mini-wrap{ min-width: 220px; }
  }
  .spray-missing-note{
    padding: 6px 8px;
    font-size: 11px;
    color: var(--muted);
    background: rgba(2,6,23,.03);
    border-top: 1px solid rgba(2,6,23,.10);
  }

  /* BB metrics: vertical stack so it doesn't eat horizontal space */
  .bb-metrics-wrap{
    border:1px solid rgba(226,232,240,.9);
    border-radius:14px;
    background:#fff;
    padding:10px 10px 8px 10px;
  }
  .bb-metrics-title{
    font-weight:900;
    margin-bottom:8px;
  }
  .bb-stack{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .bb-item{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:6px 8px;
    border:1px solid rgba(226,232,240,.65);
    border-radius:10px;
    background: rgba(15,23,42,.02);
  }
  .bb-k{
    font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace;
    font-size:10.5px;
    color:var(--muted);
    white-space:nowrap;
  }
  .bb-v{
    font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace;
    font-size:12px;
    font-weight:900;
    white-space:nowrap;
  }

  /* On the 2-col breakpoint, make spray + metrics sit nicely */
  @media (max-width: 980px){
    #tab-pbp .spray-mini-wrap{ justify-self:start; }
    #tab-pbp .bb-metrics-wrap{ justify-self:stretch; }
  }

  /* --- GameCast: takeover overlay (Ball In Play / Due Up) --- */
  #tab-gamecast .gc-midgrid{ position: relative; }
  #tab-gamecast .gc-takeover{
    position:absolute; inset:0; z-index:50;
    display:flex; align-items:stretch;
  }
  #tab-gamecast .gc-takeover-card{
    width:100%;
    border-radius:14px;
    overflow:hidden;
    box-shadow: 0 18px 50px rgba(0,0,0,.12);
    animation: gcTakeoverIn .18s ease-out;
  }
  @keyframes gcTakeoverIn{
    from{ transform: translateY(6px); opacity:0; }
    to{ transform: translateY(0); opacity:1; }
  }
  #tab-gamecast svg.gc-bip-svg{
    width:360px; height:360px; display:block;
    border:1px solid rgba(226,232,240,.9);
    border-radius:14px;
    background:#fff;
  }
  @media(max-width: 900px){
    #tab-gamecast svg.gc-bip-svg{ width:300px; height:300px; }
  }
  #tab-gamecast .gc-bip-wrap{
    display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
    flex-wrap:wrap;
  }
  #tab-gamecast .gc-bip-pop{
    margin-top:10px;
    padding:10px 12px;
    border:1px solid rgba(148,163,184,.35);
    border-radius:12px;
    background: rgba(15,23,42,.03);
    font-weight:900;
  }

</style>

{# Convert IP string like "7.2" into outs (23) for simple scoring #}
{% macro ip_outs(ip_val) -%}
  {%- set s = (ip_val|string)|trim -%}
  {%- if not s or s == '-' -%}
    0
  {%- elif '.' in s -%}
    {%- set parts = s.split('.', 1) -%}
    {%- set whole = (parts[0]|int) -%}
    {%- set frac = (parts[1]|int) -%}
    {{ whole*3 + frac }}
  {%- else -%}
    {{ (s|int) * 3 }}
  {%- endif -%}
{%- endmacro %}

{# MLB headshot (circle) #}
{% macro headshot_url(pid, size=80) -%}
  {%- if pid -%}
    https://img.mlbstatic.com/mlb-photos/image/upload/w_{{ size }},q_100/v1/people/{{ pid }}/headshot/67/current
  {%- else -%}
    ""
  {%- endif -%}
{%- endmacro %}

{# Shorten player names: "Augustin Ramirez" -> "A. Ramirez" (keeps already-abbrev) #}
{% macro short_name(full_name) -%}
  {%- set n = (full_name or '')|trim -%}
  {%- if not n -%}{% else -%}
    {%- if '.' in n and (n.split(' ')[0]|length) <= 3 -%}
      {{ n }}
    {%- else -%}
      {%- set parts = n.split() -%}
      {%- if (parts|length) == 1 -%}
        {{ n }}
      {%- else -%}
        {%- set suffixes = ['Jr.','Sr.','II','III','IV','V'] -%}
        {%- if parts[-1] in suffixes and (parts|length) >= 3 -%}
          {%- set last = parts[-2] ~ ' ' ~ parts[-1] -%}
        {%- else -%}
          {%- set last = parts[-1] -%}
        {%- endif -%}
        {{ parts[0][0] ~ '. ' ~ last }}
      {%- endif -%}
    {%- endif -%}
  {%- endif -%}
{%- endmacro %}

{# Shorten outcomes: 1B/2B/HR/F8/G6 etc. Best-effort from summary+description #}
{% macro outcome_short(summary, desc) -%}
  {%- set s = (summary or '') -%}
  {%- set d = (desc or '') -%}

  {%- if 'Home Run' in s -%}HR
  {%- elif 'Triple' in s -%}3B
  {%- elif 'Double' in s -%}2B
  {%- elif 'Single' in s -%}1B
  {%- elif 'Strikeout' in s -%}K
  {%- elif 'Walk' in s -%}BB
  {%- elif 'Hit By Pitch' in s -%}HBP
  {%- elif 'flyout' in (d|lower) -%}
    {%- if 'to left fielder' in (d|lower) -%}F7
    {%- elif 'to center fielder' in (d|lower) -%}F8
    {%- elif 'to right fielder' in (d|lower) -%}F9
    {%- else -%}FO{%- endif -%}
  {%- elif 'lineout' in (d|lower) -%}
    {%- if 'to shortstop' in (d|lower) -%}L6
    {%- elif 'to second baseman' in (d|lower) -%}L4
    {%- elif 'to first baseman' in (d|lower) -%}L3
    {%- elif 'to third baseman' in (d|lower) -%}L5
    {%- elif 'to left fielder' in (d|lower) -%}L7
    {%- elif 'to center fielder' in (d|lower) -%}L8
    {%- elif 'to right fielder' in (d|lower) -%}L9
    {%- else -%}LO{%- endif -%}
  {%- elif 'groundout' in (d|lower) -%}
    {%- if 'to shortstop' in (d|lower) -%}G6
    {%- elif 'to second baseman' in (d|lower) -%}G4
    {%- elif 'to first baseman' in (d|lower) -%}G3
    {%- elif 'to third baseman' in (d|lower) -%}G5
    {%- elif 'to pitcher' in (d|lower) -%}G1
    {%- elif 'to catcher' in (d|lower) -%}G2
    {%- else -%}GO{%- endif -%}
  {%- else -%}
    {{ (summary or '')[:8] }}
  {%- endif -%}
{%- endmacro %}

{# Find team logo for a player id using boxscore rows (bat or pit). Returns "logo|||abbr" #}
{% macro team_logo_for(pid, kind) -%}
  {%- set logo = '' -%}
  {%- set abbr = '' -%}
  {%- if game.box and pid -%}
    {%- if kind == 'bat' -%}
      {%- for r in (game.box.away.batting or []) -%}
        {%- if r.playerId == pid -%}{%- set logo = away.logo_url -%}{%- set abbr = away.abbrev -%}{%- endif -%}
      {%- endfor -%}
      {%- if not logo -%}
        {%- for r in (game.box.home.batting or []) -%}
          {%- if r.playerId == pid -%}{%- set logo = home.logo_url -%}{%- set abbr = home.abbrev -%}{%- endif -%}
        {%- endfor -%}
      {%- endif -%}
    {%- else -%}
      {%- for r in (game.box.away.pitching or []) -%}
        {%- if r.playerId == pid -%}{%- set logo = away.logo_url -%}{%- set abbr = away.abbrev -%}{%- endif -%}
      {%- endfor -%}
      {%- if not logo -%}
        {%- for r in (game.box.home.pitching or []) -%}
          {%- if r.playerId == pid -%}{%- set logo = home.logo_url -%}{%- set abbr = home.abbrev -%}{%- endif -%}
        {%- endfor -%}
      {%- endif -%}
    {%- endif -%}
  {%- endif -%}
  {{ logo }}|||{{ abbr }}
{%- endmacro %}

{# Overview scoring inning label: "â–¼2" / "â–²5" #}
{% macro score_inn_short(s) -%}
  {%- set il = (s.inningLabel if s.inningLabel is defined else '')|string -%}
  {%- set l = il|lower -%}
  {%- set icon = 'â–²' if 'top' in l else ('â–¼' if ('bot' in l or 'bottom' in l) else '') -%}
  {%- if s.inning is defined and s.inning -%}
    {{ icon }}{{ s.inning }}
  {%- else -%}
    {%- set n = il
      |replace('Top','')|replace('top','')
      |replace('Bottom','')|replace('bottom','')
      |replace('Inning','')|replace('inning','')
      |replace('st','')|replace('nd','')|replace('rd','')|replace('th','')
      |trim -%}
    {{ icon }}{{ n }}
  {%- endif -%}
{%- endmacro %}

{% if error %}
  <div class="card" style="border:1px solid rgba(239,68,68,.35); margin-bottom:14px;">
    <div class="card-header">
      <div class="card-title">Debug error</div>
      <div class="card-subtitle mono">{{ error }}</div>
    </div>
  </div>
{% endif %}

<!-- TOP: Game hero -->
<div class="card game-hero">
  <div class="game-hero-inner" style="gap:14px; align-items:stretch;">

    <!-- LEFT: meta -->
    <div class="game-hero-meta" style="min-width: 280px;">
      <div class="game-hero-title" style="display:flex; align-items:center; gap:10px;">
        <span class="mono">{{ away.abbrev }}</span>
        <span class="muted">@</span>
        <span class="mono">{{ home.abbrev }}</span>

        <!-- live mini: inning / state (filled by JS when GameCast is running) -->
        <span id="hero-live-pill" class="pill-lite" style="margin-left:auto; display:none;">
          <span class="mono muted" id="hero-live-inning">â€”</span>
        </span>
      </div>

      <div class="game-hero-sub" style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
        <span class="pill-status">{{ game.statusPill }}</span>
        {% if game.when %}<span class="muted">â€¢</span><span>{{ game.when }}</span>{% endif %}
        {% if game.venue %}<span class="muted">â€¢</span><span>{{ game.venue }}</span>{% endif %}
      </div>

      <div class="game-hero-notes" style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
        {% if away.record %}<span class="mono muted">{{ away.abbrev }} {{ away.record }}</span>{% endif %}
        {% if home.record %}<span class="muted">â€¢</span><span class="mono muted">{{ home.abbrev }} {{ home.record }}</span>{% endif %}
      </div>

      <!-- Probables: show ONLY before first pitch -->
      {% if (not is_live) and (not is_final) and game.probables %}
        <div class="game-hero-row" style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
          <span class="mono muted">PP:</span>
          <span class="mono">{% if game.probables.away %}{{ away.abbrev }} {{ game.probables.away }}{% else %}{{ away.abbrev }} TBD{% endif %}</span>
          <span class="muted">â€¢</span>
          <span class="mono">{% if game.probables.home %}{{ home.abbrev }} {{ game.probables.home }}{% else %}{{ home.abbrev }} TBD{% endif %}</span>
        </div>
      {% endif %}

      {% if is_final and game.decisions %}
        {% set wname = game.decisions.winner if game.decisions.winner is defined else game.decisions.w %}
        {% set lname = game.decisions.loser if game.decisions.loser is defined else game.decisions.l %}
        {% set sname = game.decisions.save if game.decisions.save is defined else game.decisions.s %}
        <div class="game-hero-row" style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
          <span class="pill-lite"><span class="mono muted">W</span> {{ dash(wname) }}</span>
          <span class="pill-lite"><span class="mono muted">L</span> {{ dash(lname) }}</span>
          <span class="pill-lite"><span class="mono muted">SV</span> {{ dash(sname) }}</span>
        </div>
      {% endif %}

      <!-- Live: last play (filled by JS). Hidden until we have GameCast data -->
      <div id="hero-lastplay-wrap" style="margin-top:10px; display:none;">
        <div class="mono muted" style="font-size:12px; letter-spacing:.04em; text-transform:uppercase;">
          Last play
        </div>
        <div id="hero-lastplay" style="margin-top:4px; line-height:1.2;"></div>
      </div>
    </div>

    <!-- RIGHT: score -->
    <div class="game-hero-score" style="flex:1; display:flex; flex-direction:column; gap:10px; justify-content:center;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <!-- away -->
        <div class="team-score" style="display:flex; align-items:center; gap:10px; min-width:0;">
          {% if away.logo_url %}<img class="teamlogo" src="{{ away.logo_url }}" alt="{{ away.abbrev }} logo">{% endif %}
          <div class="team-score-meta" style="min-width:0;">
            <div class="team-score-line" style="display:flex; align-items:baseline; gap:10px;">
              <span class="mono team-abbrev">{{ away.abbrev }}</span>
              <span class="mono team-runs">{{ dash(away.score if away.score is defined else away.runs if away.runs is defined else none) }}</span>
            </div>
          </div>
        </div>

        <div class="team-score vs muted" style="font-weight:600;">@</div>

        <!-- home -->
        <div class="team-score" style="display:flex; align-items:center; gap:10px; min-width:0; justify-content:flex-end;">
          <div class="team-score-meta" style="min-width:0;">
            <div class="team-score-line" style="display:flex; align-items:baseline; gap:10px; justify-content:flex-end;">
              <span class="mono team-runs">{{ dash(home.score if home.score is defined else home.runs if home.runs is defined else none) }}</span>
              <span class="mono team-abbrev">{{ home.abbrev }}</span>
            </div>
          </div>
          {% if home.logo_url %}<img class="teamlogo" src="{{ home.logo_url }}" alt="{{ home.abbrev }} logo">{% endif %}
        </div>
      </div>

      <!-- Live mini indicators (bases + outs), filled by JS; hidden until live data available -->
      <div id="hero-mini-wrap" style="display:none; align-items:center; justify-content:flex-end; gap:10px;">
        <div id="hero-mini-bases" style="display:flex; align-items:center; gap:6px;"></div>
        <div class="pill-lite" style="display:flex; align-items:center; gap:8px;">
          <span class="mono muted">OUTS</span>
          <span class="mono" id="hero-mini-outs">0</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Hook GameCast JSON to the hero (no new endpoints)
  // Requires your existing GAME_PK/GC_URL/IS_LIVE vars + polling to be active.

  function heroBasesHTML(runners){
    const on1 = !!(runners && runners.first);
    const on2 = !!(runners && runners.second);
    const on3 = !!(runners && runners.third);

    const sq = (on) => `<span style="
      width:10px;height:10px;border-radius:3px;
      border:1px solid rgba(148,163,184,.45);
      display:inline-block;
      background:${on ? 'rgba(250, 204, 21, .95)' : 'rgba(255,255,255,.6)'};
      transform: rotate(45deg);
    "></span>`;

    return `
      <span class="mono muted" style="font-size:12px; letter-spacing:.04em;">BASES</span>
      ${sq(on3)} ${sq(on2)} ${sq(on1)}
    `;
  }

  // Patch into your existing fetchGameCast without rewriting everything:
  // Call updateHeroFromGamecast(data) after you parse JSON.
  function updateHeroFromGamecast(data){
    try{
      if(!data || !data.ok) return;

      // last play
      const lpWrap = document.getElementById("hero-lastplay-wrap");
      const lp = document.getElementById("hero-lastplay");
      if(lpWrap && lp){
        lpWrap.style.display = "block";
        lp.textContent = data.lastPlay || "â€”";
      }

      // inning pill
      const pill = document.getElementById("hero-live-pill");
      const inn = document.getElementById("hero-live-inning");
      if(pill && inn){
        pill.style.display = "inline-flex";
        const half = (data.half || "").startsWith("Top") ? "Top" : ((data.half || "").startsWith("Bottom") ? "Bot" : "");
        inn.textContent = data.inning ? `${half} ${data.inning}`.trim() : "â€”";
      }

      // mini bases/outs
      const miniWrap = document.getElementById("hero-mini-wrap");
      const miniBases = document.getElementById("hero-mini-bases");
      const miniOuts = document.getElementById("hero-mini-outs");
      if(miniWrap && miniBases && miniOuts){
        miniWrap.style.display = "flex";
        miniBases.innerHTML = heroBasesHTML(data.runners);
        miniOuts.textContent = (data.outs ?? 0);
      }
    }catch(e){
      // silent: hero should never break GameCast
      console.warn("[Hero] update failed", e);
    }
  }
</script>
{# -----------------------------
   Linescore
   ----------------------------- #}
{% set innings = (game.linescore.innings if game.linescore and game.linescore.innings is defined else []) %}
{% if innings %}
  <div class="card" style="margin-top:14px;">
    <div class="card-header">
      <div class="card-title">Linescore</div>
    </div>

    <div style="padding: 0 14px 14px 14px; overflow-x:auto;">
      <table class="tbl">
        <thead>
          <tr>
            <th></th>
            {% for inn in innings %}
              <th class="mono" style="text-align:center;">{{ inn.num }}</th>
            {% endfor %}
            <th class="mono" style="text-align:center;">R</th>
            <th class="mono" style="text-align:center;">H</th>
            <th class="mono" style="text-align:center;">E</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="mono">
              {% if away.logo_url %}<img class="teamlogo" src="{{ away.logo_url }}" style="height:18px; vertical-align:middle; margin-right:6px;">{% endif %}
              {{ away.abbrev }}
            </td>
            {% for inn in innings %}
              <td class="mono" style="text-align:center;">{{ dash(inn.away.runs if inn.away is defined else none) }}</td>
            {% endfor %}
            <td class="mono" style="text-align:center;">{{ dash(game.linescore.teams.away.runs) }}</td>
            <td class="mono" style="text-align:center;">{{ dash(game.linescore.teams.away.hits) }}</td>
            <td class="mono" style="text-align:center;">{{ dash(game.linescore.teams.away.errors) }}</td>
          </tr>

          <tr>
            <td class="mono">
              {% if home.logo_url %}<img class="teamlogo" src="{{ home.logo_url }}" style="height:18px; vertical-align:middle; margin-right:6px;">{% endif %}
              {{ home.abbrev }}
            </td>
            {% for inn in innings %}
              <td class="mono" style="text-align:center;">{{ dash(inn.home.runs if inn.home is defined else none) }}</td>
            {% endfor %}
            <td class="mono" style="text-align:center;">{{ dash(game.linescore.teams.home.runs) }}</td>
            <td class="mono" style="text-align:center;">{{ dash(game.linescore.teams.home.hits) }}</td>
            <td class="mono" style="text-align:center;">{{ dash(game.linescore.teams.home.errors) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
{% endif %}

<!-- Tabs -->
<div class="tabs" style="margin-top:14px;">
  {% if is_live %}
    <button class="tab-btn active" data-tab="gamecast">GameCast</button>
    <button class="tab-btn" data-tab="overview">Overview</button>
  {% else %}
    <button class="tab-btn active" data-tab="overview">Overview</button>
  {% endif %}
  <button class="tab-btn" data-tab="box">Box</button>
  <button class="tab-btn" data-tab="scoring">Scoring</button>
  <button class="tab-btn" data-tab="pbp">Play-by-Play</button>
</div>

<!-- GAMECAST -->
{% if is_live %}
<div class="tab-panel active" id="tab-gamecast">

  <div class="card" style="margin-top:14px;">
    <div class="card-header">
      <div class="card-title">GameCast</div>
      <div class="card-subtitle" id="gc-status" style="display:flex; gap:10px; align-items:center;">
        <span class="pill" id="gc-inning">â€”</span>
        <span class="mono" id="gc-count" style="opacity:.85;">â€”</span>
      </div>
    </div>

    <div style="padding:14px;">
      <div id="gc-scorebar" style="display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap;">
        <div style="display:flex; align-items:center; gap:10px;">
          {% if away.logo_url %}<img class="teamlogo" src="{{ away.logo_url }}" alt="{{ away.abbrev }}">{% endif %}
          <div class="mono" style="font-size:18px; font-weight:700;">{{ away.abbrev }} <span id="gc-away-runs">0</span></div>
        </div>

        <div id="gc-bso" style="display:flex; align-items:center; gap:14px;">
          <div style="display:flex; align-items:center; gap:6px;">
            <div class="mono" style="opacity:.7; font-size:12px;">B</div>
            <div id="gc-balls" class="gc-dots"></div>
          </div>
          <div style="display:flex; align-items:center; gap:6px;">
            <div class="mono" style="opacity:.7; font-size:12px;">S</div>
            <div id="gc-strikes" class="gc-dots"></div>
          </div>
          <div style="display:flex; align-items:center; gap:6px;">
            <div class="mono" style="opacity:.7; font-size:12px;">O</div>
            <div id="gc-outs" class="gc-dots"></div>
          </div>
        </div>

        <div style="display:flex; align-items:center; gap:10px;">
          <div class="mono" style="font-size:18px; font-weight:700;"><span id="gc-home-runs">0</span> {{ home.abbrev }}</div>
          {% if home.logo_url %}<img class="teamlogo" src="{{ home.logo_url }}" alt="{{ home.abbrev }}">{% endif %}
        </div>
      </div>

      <div class="mono" id="gc-lastplay" style="margin-top:10px; padding:10px 12px; border:1px solid rgba(148,163,184,.25); border-radius:12px; background:rgba(15,23,42,.02);">
        â€”
      </div>

      {# -----------------------------
         FIXED: Proper nesting so home lineup stays on the RIGHT
         UPDATED: Zone + Bases side-by-side, Pitches table FULL-WIDTH underneath
         ----------------------------- #}
      <div class="gc-grid-wrap">
        <div class="gc-grid" style="margin-top:14px;">
      
          <!-- Away lineup -->
          <div class="card" style="margin:0;">
            <div class="card-header">
              <div class="card-title">{{ away.abbrev }} Lineup</div>
              <div class="card-subtitle mono" style="opacity:.75;">Tap a hitter</div>
            </div>
            <div class="gc-lineup" id="gc-lineup-away"></div>
          </div>
      
          <!-- Center -->
          <div class="gc-center">
            <div class="card" style="margin:0;">
              <div class="card-header">
                <div class="card-title">Current Matchup</div>
              </div>
      
              <div style="padding:14px;">
                <div class="gc-matchup">
                  <div class="gc-person" id="gc-batter"></div>
                  <div class="gc-person" id="gc-pitcher"></div>
                </div>
      
                <!-- MID: Zone + Bases row, then full-width Pitches table -->
                <div class="gc-midgrid" style="margin-top:14px;">
      
                  
                  <!-- GameCast takeover overlay (Ball In Play / Due Up) -->
                  <div id="gc-takeover" class="gc-takeover" style="display:none;">
                    <div class="card gc-takeover-card" style="margin:0;">
                      <div class="card-header">
                        <div class="card-title" id="gc-takeover-title">â€”</div>
                        <div class="card-subtitle mono" id="gc-takeover-subtitle" style="opacity:.75;"></div>
                      </div>
                      <div class="card-body" id="gc-takeover-body"></div>
                    </div>
                  </div>
<!-- Zone (LEFT) -->
                  <div class="card" style="margin:0;">
                    <div class="card-header">
                      <div class="card-title">Zone</div>
                    </div>
                    <div style="padding:12px; display:flex; justify-content:center;">
                      <svg id="gc-zone" class="strike-zone" width="220" height="260"></svg>
                    </div>
                  </div>
      
                  <!-- Bases (RIGHT) -->
                  <div class="card" style="margin:0;">
                    <div class="card-header">
                      <div class="card-title">Bases</div>
                      <div class="card-subtitle mono" style="opacity:.75;">Live runners</div>
                    </div>
      
                    <!-- Diamond visual -->
                    <div style="padding:12px 12px 4px 12px; display:flex; justify-content:center;">
                      <div id="gc-bases-diamond" class="gc-bases-diamond"></div>
                    </div>
      
                    <!-- Runner list (existing functionality stays) -->
                    <div style="padding:6px 12px 12px 12px;">
                      <div id="gc-bases" class="gc-bases" aria-label="Base runners"></div>
                    </div>
                  </div>
      
                  <!-- Pitches (FULL WIDTH under both) -->
                  <div class="card gc-pitchescard" style="margin:0;">
                    <div class="card-header">
                      <div class="card-title">Pitches</div>
                      <div class="card-subtitle mono" style="opacity:.75;">This plate appearance</div>
                    </div>
                    <div style="padding:0 12px 12px 12px; overflow:hidden;">
                      <table class="tbl" id="gc-pitch-table" style="margin-top:10px; width:100%; table-layout:auto;">
                        <thead>
                          <tr>
                            <th class="mono">#</th>
                            <th>Pitch</th>
                            <th class="mono" style="text-align:right;">MPH</th>
                            <th class="mono" style="text-align:right;">Spin</th>
                            <th class="mono" style="text-align:right;">VMov</th>
                            <th class="mono" style="text-align:right;">HMov</th>
                            <th>Outcome</th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                      </table>
                    </div>
                  </div>
      
                </div>
              </div>
            </div>
          </div>
      
          <!-- Home lineup (RIGHT column) -->
          <div class="card" style="margin:0;">
            <div class="card-header">
              <div class="card-title">{{ home.abbrev }} Lineup</div>
              <div class="card-subtitle mono" style="opacity:.75;">Tap a hitter</div>
            </div>
            <div class="gc-lineup" id="gc-lineup-home"></div>
          </div>
      
        </div>
      </div>
    </div>
  </div>

</div>
{% endif %}

<!-- OVERVIEW -->
<div class="tab-panel {% if not is_live %}active{% endif %}" id="tab-overview">


  {# -----------------------------
     Build Overview datasets
     ----------------------------- #}

  {# Top Exit Velos (from game.pas[].battedBall) #}
  {% set ev_rows = namespace(items=[]) %}
  {% for pa in (game.pas or []) %}
    {% if pa.battedBall is defined and pa.battedBall and pa.battedBall.exitVelo is not none %}
      {% set bb = pa.battedBall %}
      {% set _ = ev_rows.items.append({
        "pid": (pa.batterId if pa.batterId is defined else none),
        "name": (pa.batterName if pa.batterName is defined else ''),
        "inning": pa.inning,
        "ev": bb.exitVelo,
        "la": bb.launchAngle,
        "dist": bb.distance,
        "xba": bb.xBA,
        "summary": (pa.summaryEvent if pa.summaryEvent is defined else ''),
        "desc": (pa.description if pa.description is defined else ''),
        "evStyle": (bb.evStyle if bb.evStyle is defined else ''),
        "evFire": (bb.evFire if bb.evFire is defined else false)
      }) %}
    {% endif %}
  {% endfor %}
  {% set ev_sorted = (ev_rows.items|sort(attribute="ev", reverse=true)) %}
  {% set top_ev = ev_sorted[:10] %}

  {# Top Pitch Velos (flatten game.pas[].pitches) #}
  {% set pv_rows = namespace(items=[]) %}
  {% for pa in (game.pas or []) %}
    {% for p in (pa.pitches or []) %}
      {% if p.mph is defined and p.mph is not none %}
        {% set _ = pv_rows.items.append({
          "pid": (pa.pitcherId if pa.pitcherId is defined else none),
          "name": (pa.pitcherName if pa.pitcherName is defined else ''),
          "inning": pa.inning,
          "mph": p.mph,
          "pitchType": (p.pitchType if p.pitchType is defined else ''),
          "mphStyle": (p.mphStyle if p.mphStyle is defined else ''),
          "mphFire": (p.mphFire if p.mphFire is defined else false)
        }) %}
      {% endif %}
    {% endfor %}
  {% endfor %}
  {% set pv_sorted = (pv_rows.items|sort(attribute="mph", reverse=true)) %}
  {% set top_pv = pv_sorted[:10] %}

  {# Top Performers (5 best overall, hitter or pitcher) #}
  {% set perf = namespace(items=[]) %}

  {% if game.box %}
    {% for r in (game.box.away.batting or []) %}
      {% if (not r.isTotals) and r.playerId %}
        {% set ab = (r.AB|int) %}
        {% if ab > 0 %}
          {% set h = (r.H|int) %}
          {% set hr = (r.HR|int) %}
          {% set rbi = (r.RBI|int) %}
          {% set score = (hr*100) + (rbi*10) + (h*2) %}
          {% set line = (h|string) ~ "-" ~ (ab|string) ~ " â€¢ " ~ (hr|string) ~ " HR â€¢ " ~ (rbi|string) ~ " RBI" %}
          {% set _ = perf.items.append({
            "kind":"bat","pid":r.playerId,"name":r.name,"score":score,"line":line,
            "team_abbrev": away.abbrev,"team_logo": away.logo_url
          }) %}
        {% endif %}
      {% endif %}
    {% endfor %}

    {% for r in (game.box.home.batting or []) %}
      {% if (not r.isTotals) and r.playerId %}
        {% set ab = (r.AB|int) %}
        {% if ab > 0 %}
          {% set h = (r.H|int) %}
          {% set hr = (r.HR|int) %}
          {% set rbi = (r.RBI|int) %}
          {% set score = (hr*100) + (rbi*10) + (h*2) %}
          {% set line = (h|string) ~ "-" ~ (ab|string) ~ " â€¢ " ~ (hr|string) ~ " HR â€¢ " ~ (rbi|string) ~ " RBI" %}
          {% set _ = perf.items.append({
            "kind":"bat","pid":r.playerId,"name":r.name,"score":score,"line":line,
            "team_abbrev": home.abbrev,"team_logo": home.logo_url
          }) %}
        {% endif %}
      {% endif %}
    {% endfor %}

    {% for r in (game.box.away.pitching or []) %}
      {% if (not r.isTotals) and r.playerId %}
        {% set outs = (ip_outs(r.IP)|int) %}
        {% if outs > 0 %}
          {% set so = (r.SO|int) %}
          {% set er = (r.ER|int) %}
          {% set h = (r.H|int) %}
          {% set score = (outs*10) + (so*6) - (er*30) - (h*6) %}
          {% set line = (dash(r.IP)) ~ " IP â€¢ " ~ (h|string) ~ " H â€¢ " ~ (er|string) ~ " ER â€¢ " ~ (so|string) ~ " Ks" %}
          {% set _ = perf.items.append({
            "kind":"pit","pid":r.playerId,"name":r.name,"score":score,"line":line,
            "team_abbrev": away.abbrev,"team_logo": away.logo_url
          }) %}
        {% endif %}
      {% endif %}
    {% endfor %}

    {% for r in (game.box.home.pitching or []) %}
      {% if (not r.isTotals) and r.playerId %}
        {% set outs = (ip_outs(r.IP)|int) %}
        {% if outs > 0 %}
          {% set so = (r.SO|int) %}
          {% set er = (r.ER|int) %}
          {% set h = (r.H|int) %}
          {% set score = (outs*10) + (so*6) - (er*30) - (h*6) %}
          {% set line = (dash(r.IP)) ~ " IP â€¢ " ~ (h|string) ~ " H â€¢ " ~ (er|string) ~ " ER â€¢ " ~ (so|string) ~ " Ks" %}
          {% set _ = perf.items.append({
            "kind":"pit","pid":r.playerId,"name":r.name,"score":score,"line":line,
            "team_abbrev": home.abbrev,"team_logo": home.logo_url
          }) %}
        {% endif %}
      {% endif %}
    {% endfor %}
  {% endif %}

  {% set perf_sorted = (perf.items|sort(attribute="score", reverse=true)) %}
  {% set top_perf = perf_sorted[:5] %}

  <div class="grid2" style="margin-top:14px; align-items:stretch;">
    <!-- Top Performers -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Top Performers</div>
          <div class="card-subtitle">Best overall performances</div>
        </div>
      </div>

      <div style="padding: 8px 12px 10px 12px;">
        {% if top_perf and (top_perf|length) > 0 %}
          {% for tp in top_perf %}
            <div style="display:flex; align-items:center; gap:10px; padding:6px 0; border-bottom:1px solid rgba(226,232,240,.55);">
              <div style="display:flex; align-items:center; gap:6px;">
                <img src="{{ headshot_url(tp.pid, 80) }}" alt="{{ tp.name }}" style="width:32px;height:32px;border-radius:999px;object-fit:cover;border:1px solid rgba(226,232,240,.9); background:#fff;">
                {% if tp.team_logo %}
                  <img src="{{ tp.team_logo }}" alt="{{ tp.team_abbrev }} logo" style="width:20px;height:20px;object-fit:contain;">
                {% endif %}
              </div>

              <div style="min-width:0;">
                <div class="mono" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                  {% if tp.pid %}
                    <a href="/player/{{ tp.pid }}">{{ short_name(tp.name) }}</a>
                  {% else %}
                    {{ short_name(tp.name) }}
                  {% endif %}
                </div>
                <div class="mono muted small" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                  {{ tp.line }}
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="muted" style="padding:4px 0;">Not available yet.</div>
        {% endif %}
      </div>
    </div>

    <!-- Scoring Summary -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Scoring Summary</div>
          <div class="card-subtitle">Quick scoring overview</div>
        </div>
      </div>

      <div style="padding: 8px 12px 10px 12px;">
        {% if game.scoring and (game.scoring|length) > 0 %}
          {% set ss = game.scoring[:8] %}
          {% for s in ss %}
            <div style="display:flex; gap:10px; align-items:flex-start; padding:6px 0; border-bottom:1px solid rgba(226,232,240,.55);">
              <div class="mono muted" style="min-width:44px;">{{ score_inn_short(s) }}</div>
              <div style="flex:1; min-width:0;">
                <div class="small" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                  {{ s.description }}
                </div>
              </div>

              <div class="mono" style="display:flex; align-items:center; gap:6px; min-width:120px; justify-content:flex-end;">
                {% if away.logo_url %}<img src="{{ away.logo_url }}" alt="{{ away.abbrev }}" style="width:18px;height:18px;object-fit:contain;">{% endif %}
                <span>{{ dash(s.awayScore) }}</span>
                <span class="muted">-</span>
                <span>{{ dash(s.homeScore) }}</span>
                {% if home.logo_url %}<img src="{{ home.logo_url }}" alt="{{ home.abbrev }}" style="width:18px;height:18px;object-fit:contain;">{% endif %}
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="muted" style="padding:4px 0;">No scoring plays yet.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="grid2" style="margin-top:14px; align-items:stretch;">
    <!-- Top Exit Velocities -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Top Exit Velocities</div>
          <div class="card-subtitle">Top 10 batted balls by EV</div>
        </div>
      </div>

      <div style="padding: 0 12px 12px 12px; overflow-x:auto;">
        {% if top_ev and (top_ev|length) > 0 %}
          <table class="tbl ev-table">
            <thead>
              <tr>
                <th></th>
                <th>Player</th>
                <th class="mono">Inn</th>
                <th class="mono">EV</th>
                <th class="mono">LA</th>
                <th class="mono">Dist</th>
                <th class="mono">xBA</th>
                <th class="mono">Res</th>
              </tr>
            </thead>
            <tbody>
              {% for r in top_ev %}
                {% set team_bits = (team_logo_for(r.pid, 'bat')|string).split('|||') %}
                {% set tlogo = team_bits[0] if (team_bits|length) > 0 else '' %}
                {% set tabbr = team_bits[1] if (team_bits|length) > 1 else '' %}
                <tr>
                  <td style="width:60px;">
                    <div style="display:flex; align-items:center; gap:6px;">
                      <img src="{{ headshot_url(r.pid, 60) }}" alt="{{ r.name }}" style="width:26px;height:26px;border-radius:999px;object-fit:cover;border:1px solid rgba(226,232,240,.9); background:#fff;">
                      {% if tlogo %}
                        <img src="{{ tlogo }}" alt="{{ tabbr }} logo" style="width:18px;height:18px;object-fit:contain;">
                      {% endif %}
                    </div>
                  </td>
                  <td style="max-width:220px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                    {% if r.pid %}
                      <a class="mono" href="/player/{{ r.pid }}">{{ short_name(r.name) }}</a>
                    {% else %}
                      <span class="mono">{{ short_name(r.name) }}</span>
                    {% endif %}
                  </td>
                  <td class="mono">{{ dash(r.inning) }}</td>
                  <td class="mono">
                    {% if r.ev is not none %}
                      <span class="grad-pill" style="{{ r.evStyle }}">{{ '%.1f'|format(r.ev) }}{% if r.evFire %} ðŸ”¥{% endif %}</span>
                    {% else %}-{% endif %}
                  </td>
                  <td class="mono">{% if r.la is not none %}{{ '%.0f'|format(r.la) }}Â°{% else %}-{% endif %}</td>
                  <td class="mono">{% if r.dist is not none %}{{ '%.0f'|format(r.dist) }} ft{% else %}-{% endif %}</td>
                  <td class="mono">{% if r.xba is not none %}{{ '%.3f'|format(r.xba) }}{% else %}-{% endif %}</td>
                  <td class="mono">{{ outcome_short(r.summary, r.desc) }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div style="padding:12px 0;" class="muted">Not available yet.</div>
        {% endif %}
      </div>
    </div>

    <!-- Top Pitching Velocities -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Top Pitching Velocities</div>
          <div class="card-subtitle">Top 10 pitches by velocity</div>
        </div>
      </div>

      <div style="padding: 0 12px 12px 12px; overflow-x:auto;">
        {% if top_pv and (top_pv|length) > 0 %}
          <table class="tbl">
            <thead>
              <tr>
                <th></th>
                <th>Pitcher</th>
                <th class="mono">Inn</th>
                <th class="mono">Velo</th>
                <th>Pitch Type</th>
              </tr>
            </thead>
            <tbody>
              {% for r in top_pv %}
                {% set team_bits = (team_logo_for(r.pid, 'pit')|string).split('|||') %}
                {% set tlogo = team_bits[0] if (team_bits|length) > 0 else '' %}
                {% set tabbr = team_bits[1] if (team_bits|length) > 1 else '' %}
                <tr>
                  <td style="width:60px;">
                    <div style="display:flex; align-items:center; gap:6px;">
                      <img src="{{ headshot_url(r.pid, 60) }}" alt="{{ r.name }}" style="width:26px;height:26px;border-radius:999px;object-fit:cover;border:1px solid rgba(226,232,240,.9); background:#fff;">
                      {% if tlogo %}
                        <img src="{{ tlogo }}" alt="{{ tabbr }} logo" style="width:18px;height:18px;object-fit:contain;">
                      {% endif %}
                    </div>
                  </td>
                  <td style="max-width:260px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                    {% if r.pid %}
                      <a class="mono" href="/player/{{ r.pid }}">{{ short_name(r.name) }}</a>
                    {% else %}
                      <span class="mono">{{ short_name(r.name) }}</span>
                    {% endif %}
                  </td>
                  <td class="mono">{{ dash(r.inning) }}</td>
                  <td class="mono">
                    {% if r.mph is not none %}
                      <span class="grad-pill" style="{{ r.mphStyle }}">{{ '%.1f'|format(r.mph) }}{% if r.mphFire %} ðŸ”¥{% endif %}</span>
                    {% else %}-{% endif %}
                  </td>
                  <td>{{ r.pitchType }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div style="padding:12px 0;" class="muted">Not available yet.</div>
        {% endif %}
      </div>
    </div>
  </div>

</div>

<!-- BOX -->
<div class="tab-panel" id="tab-box">
  {% if not game.box %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Box</div>
        <div class="card-subtitle">Not available for this status yet.</div>
      </div>
    </div>
  {% else %}

    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Batting</div>
        <div class="card-subtitle">{{ away.abbrev }} vs {{ home.abbrev }}</div>
      </div>

      <div style="padding: 0 14px 14px 14px;">
        <div class="grid2">
          <div>
            <div class="mono muted small" style="margin: 8px 0 6px 0;">{{ away.abbrev }} Batting</div>
            <div style="overflow-x:auto;">
              <table class="tbl">
                <thead>
                  <tr>
                    <th>Player</th>
                    <th class="mono">AB</th><th class="mono">R</th><th class="mono">H</th><th class="mono">RBI</th>
                    <th class="mono">BB</th><th class="mono">SO</th><th class="mono">HR</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in game.box.away.batting %}
                    <tr class="{% if r.isTotals %}tr-totals{% endif %}">
                      <td>
                        <span class="{% if r.indent %}box-indent{% endif %}">
                          {% if r.playerId and (not r.isTotals) %}<a href="/player/{{ r.playerId }}">{{ r.name }}</a>{% else %}{{ r.name }}{% endif %}
                          {% if r.pos and (not r.isTotals) %}<span class="muted small"> {{ r.pos }}</span>{% endif %}
                        </span>
                      </td>
                      <td class="mono">{{ dash(r.AB) }}</td><td class="mono">{{ dash(r.R) }}</td><td class="mono">{{ dash(r.H) }}</td><td class="mono">{{ dash(r.RBI) }}</td>
                      <td class="mono">{{ dash(r.BB) }}</td><td class="mono">{{ dash(r.SO) }}</td><td class="mono">{{ dash(r.HR) }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div>
            <div class="mono muted small" style="margin: 8px 0 6px 0;">{{ home.abbrev }} Batting</div>
            <div style="overflow-x:auto;">
              <table class="tbl">
                <thead>
                  <tr>
                    <th>Player</th>
                    <th class="mono">AB</th><th class="mono">R</th><th class="mono">H</th><th class="mono">RBI</th>
                    <th class="mono">BB</th><th class="mono">SO</th><th class="mono">HR</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in game.box.home.batting %}
                    <tr class="{% if r.isTotals %}tr-totals{% endif %}">
                      <td>
                        <span class="{% if r.indent %}box-indent{% endif %}">
                          {% if r.playerId and (not r.isTotals) %}<a href="/player/{{ r.playerId }}">{{ r.name }}</a>{% else %}{{ r.name }}{% endif %}
                          {% if r.pos and (not r.isTotals) %}<span class="muted small"> {{ r.pos }}</span>{% endif %}
                        </span>
                      </td>
                      <td class="mono">{{ dash(r.AB) }}</td><td class="mono">{{ dash(r.R) }}</td><td class="mono">{{ dash(r.H) }}</td><td class="mono">{{ dash(r.RBI) }}</td>
                      <td class="mono">{{ dash(r.BB) }}</td><td class="mono">{{ dash(r.SO) }}</td><td class="mono">{{ dash(r.HR) }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Pitching</div>
        <div class="card-subtitle">{{ away.abbrev }} vs {{ home.abbrev }}</div>
      </div>

      <div style="padding: 0 14px 14px 14px;">
        <div class="grid2">
          <div>
            <div class="mono muted small" style="margin: 8px 0 6px 0;">{{ away.abbrev }} Pitching</div>
            <div style="overflow-x:auto;">
              <table class="tbl">
                <thead>
                  <tr>
                    <th>Pitcher</th>
                    <th class="mono">IP</th><th class="mono">H</th><th class="mono">R</th><th class="mono">ER</th>
                    <th class="mono">BB</th><th class="mono">SO</th><th class="mono">HR</th><th class="mono">P-S</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in game.box.away.pitching %}
                    <tr class="{% if r.isTotals %}tr-totals{% endif %}">
                      <td>{% if r.playerId and (not r.isTotals) %}<a href="/player/{{ r.playerId }}">{{ r.name }}</a>{% else %}{{ r.name }}{% endif %}</td>
                      <td class="mono">{{ dash(r.IP) }}</td><td class="mono">{{ dash(r.H) }}</td><td class="mono">{{ dash(r.R) }}</td><td class="mono">{{ dash(r.ER) }}</td>
                      <td class="mono">{{ dash(r.BB) }}</td><td class="mono">{{ dash(r.SO) }}</td><td class="mono">{{ dash(r.HR) }}</td><td class="mono">{{ dash(r.PS) }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div>
            <div class="mono muted small" style="margin: 8px 0 6px 0;">{{ home.abbrev }} Pitching</div>
            <div style="overflow-x:auto;">
              <table class="tbl">
                <thead>
                  <tr>
                    <th>Pitcher</th>
                    <th class="mono">IP</th><th class="mono">H</th><th class="mono">R</th><th class="mono">ER</th>
                    <th class="mono">BB</th><th class="mono">SO</th><th class="mono">HR</th><th class="mono">P-S</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in game.box.home.pitching %}
                    <tr class="{% if r.isTotals %}tr-totals{% endif %}">
                      <td>{% if r.playerId and (not r.isTotals) %}<a href="/player/{{ r.playerId }}">{{ r.name }}</a>{% else %}{{ r.name }}{% endif %}</td>
                      <td class="mono">{{ dash(r.IP) }}</td><td class="mono">{{ dash(r.H) }}</td><td class="mono">{{ dash(r.R) }}</td><td class="mono">{{ dash(r.ER) }}</td>
                      <td class="mono">{{ dash(r.BB) }}</td><td class="mono">{{ dash(r.SO) }}</td><td class="mono">{{ dash(r.HR) }}</td><td class="mono">{{ dash(r.PS) }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

  {% endif %}
</div>

<!-- SCORING -->
<div class="tab-panel" id="tab-scoring">
  {% if not game.scoring %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Scoring</div>
        <div class="card-subtitle">Not available for this status yet.</div>
      </div>
    </div>
  {% else %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Scoring</div>
        <div class="card-subtitle">All scoring plays</div>
      </div>

      <div style="padding: 0 14px 14px 14px;">
        <div class="scoring-list">
          {% for s in game.scoring %}
            <div class="scoring-row">
              <div class="mono muted">{{ s.inningLabel }}</div>
              <div class="scoring-desc">{{ s.description }}</div>
              <div class="mono" style="text-align:right;">{{ dash(s.awayScore) }} - {{ dash(s.homeScore) }}</div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}
</div>

<!-- PLAY-BY-PLAY (PA-style UI) -->
<div class="tab-panel" id="tab-pbp">
  {% if not game.pas %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Play-by-Play</div>
        <div class="card-subtitle">Not available for this status yet.</div>
      </div>
    </div>
  {% else %}
    <div class="card" style="margin-top:14px;">
      <div class="card-header">
        <div class="card-title">Play-by-Play</div>
        <div class="card-subtitle">Grouped by inning â€¢ each at-bat includes pitch table + strike zone</div>
      </div>

      <div style="padding: 0 14px 14px 14px;">

        {% set ns = namespace(innings=[]) %}
        {% for pa in game.pas %}
          {% if pa.inning and (pa.inning not in ns.innings) %}
            {% set _ = ns.innings.append(pa.inning) %}
          {% endif %}
        {% endfor %}

        {% for inn in ns.innings %}
          <details class="inning-details" style="margin-top:10px;">
            <summary class="inning-summary">
              <span class="inning-pill mono">{{ ordinal(inn) }} Inning</span>
            </summary>

            <div style="margin-top:10px;">
              {% for half in ['Top','Bottom'] %}
                {% set half_pas = (game.pas
                  | selectattr("inning", "equalto", inn)
                  | selectattr("half", "equalto", half)
                  | list) %}

                {% if half_pas and (half_pas|length) > 0 %}
                  <div class="half-header">
                    <span class="half-pill mono">{{ half }}</span>
                  </div>

                  {% for pa in half_pas %}
                    <details class="pa-details" style="margin-bottom:10px;">
                      <summary class="pa-summary">
                        <div class="pa-left">
                          <span>{{ pa.description or "" }}</span>
                        </div>
                        <div class="pa-right">
                          <span class="mono">{{ pa.summaryEvent if pa.summaryEvent is defined else (pa.event or "") }}</span>
                        </div>
                      </summary>

                      <div class="pa-body">
                        <div class="pa-grid">

                          <!-- 1) Strike zone (left, unchanged) -->
                          <div class="zone-wrap">
                            <div class="zone-title">Zone</div>
                            <svg class="strike-zone" data-pitches='{{ (pa.pitches or []) | tojson }}' width="200" height="240"></svg>
                          </div>

                          <!-- 2) Pitches table (ONLY pitches) -->
                          <div class="pitch-wrap">
                            <div class="zone-title">Pitches</div>
                            {% if pa.pitches and (pa.pitches|length) > 0 %}
                              <div style="overflow-x:auto;">
                                <table class="tbl">
                                  <thead>
                                    <tr>
                                      <th class="mono">#</th>
                                      <th>Pitch</th>
                                      <th class="mono">MPH</th>
                                      <th class="mono">Spin</th>
                                      <th class="mono">VMov</th>
                                      <th class="mono">HMov</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {% for p in pa.pitches %}
                                      <tr>
                                        <td class="mono">{{ p.n if p.n is defined else loop.index }}</td>
                                        <td>{{ p.pitchType if p.pitchType is defined else (p.pitch_name if p.pitch_name is defined else (p.type or "")) }}</td>
                                        <td class="mono">
                                          {% if p.mph is defined and p.mph is not none %}
                                            <span class="grad-pill" style="{{ p.mphStyle if p.mphStyle is defined else '' }}">{{ '%.1f'|format(p.mph) }}{% if p.mphFire %} ðŸ”¥{% endif %}</span>
                                          {% else %}-{% endif %}
                                        </td>
                                        <td class="mono">{{ dash(p.spinRate if p.spinRate is defined else none) }}</td>
                                        <td class="mono">{{ dash(p.vertMove if p.vertMove is defined else none) }}</td>
                                        <td class="mono">{{ dash(p.horizMove if p.horizMove is defined else none) }}</td>
                                      </tr>
                                    {% endfor %}
                                  </tbody>
                                </table>
                              </div>
                            {% else %}
                              <div class="muted" style="padding:6px 0;">No pitch data available.</div>
                            {% endif %}
                          </div>

                          <!-- 3) Spray chart (right of pitches, no "Spray" title) -->
                          {% if is_final %}
                            {% set bb = (pa.battedBall if pa.battedBall is defined else none) %}
                            <div class="spray-mini-wrap">
                              <div class="spray-mini-card">
                                <svg class="spray-svg-mini"
                                     viewBox="0 0 250 250"
                                     preserveAspectRatio="xMidYMid meet"
                                     data-bb='{{ {
                                       "has": 1 if bb else 0,
                                       "x": (bb.coordX if bb else none),
                                       "y": (bb.coordY if bb else none),
                                       "event": (pa.summaryEvent if pa.summaryEvent is defined else (pa.event or "")) 
                                     } | tojson }}'>
                                  <g class="sprayOverlay"></g>
                                  <g class="sprayPoints"></g>
                                </svg>
                                <div class="spray-missing-note" style="display:none;">batted ball coordinates not available for this play</div>
                              </div>
                            </div>
                          {% else %}
                            <div></div>
                          {% endif %}

                          <!-- 4) BB metrics (right of spray, vertical stack) -->
                          {% if pa.battedBall is defined and pa.battedBall %}
                            <div class="bb-metrics-wrap">
                              <div class="bb-metrics-title">Batted Ball</div>

                              <div class="bb-stack">
                                <div class="bb-item">
                                  <div class="bb-k">EV</div>
                                  <div class="bb-v">
                                    {% if pa.battedBall.exitVelo is not none %}
                                      <span class="grad-pill" style="{{ pa.battedBall.evStyle if pa.battedBall.evStyle is defined else '' }}">
                                        {{ '%.1f'|format(pa.battedBall.exitVelo) }}{% if pa.battedBall.evFire %} ðŸ”¥{% endif %}
                                      </span>
                                    {% else %}-{% endif %}
                                  </div>
                                </div>

                                <div class="bb-item">
                                  <div class="bb-k">LA</div>
                                  <div class="bb-v">
                                    {% if pa.battedBall.launchAngle is not none %}{{ '%.0f'|format(pa.battedBall.launchAngle) }}Â°{% else %}-{% endif %}
                                  </div>
                                </div>

                                <div class="bb-item">
                                  <div class="bb-k">Dist</div>
                                  <div class="bb-v">
                                    {% if pa.battedBall.distance is not none %}{{ '%.0f'|format(pa.battedBall.distance) }} ft{% else %}-{% endif %}
                                  </div>
                                </div>

                                <div class="bb-item">
                                  <div class="bb-k">xBA</div>
                                  <div class="bb-v">
                                    {% if pa.battedBall.xBA is not none %}{{ '%.3f'|format(pa.battedBall.xBA) }}{% else %}-{% endif %}
                                  </div>
                                </div>
                              </div>

                            </div>
                          {% else %}
                            <div></div>
                          {% endif %}

                        </div>
                      </div>
                    </details>
                  {% endfor %}
                {% endif %}
              {% endfor %}
            </div>
          </details>
        {% endfor %}

      </div>
    </div>
  {% endif %}
</div>

<script>
(function(){
  const tabs = document.querySelectorAll(".tab-btn");
  const panels = document.querySelectorAll(".tab-panel");

  // ensure default tab
  tabs.forEach(b=>b.classList.remove("active"));
  panels.forEach(p=>p.classList.remove("active"));

  const gcBtn = document.querySelector('.tab-btn[data-tab="gamecast"]');
  const gcPanel = document.getElementById("tab-gamecast");
  const ovBtn = document.querySelector('.tab-btn[data-tab="overview"]');
  const ovPanel = document.getElementById("tab-overview");

  if(gcBtn && gcPanel){
    gcBtn.classList.add("active");
    gcPanel.classList.add("active");
  }else{
    if(ovBtn) ovBtn.classList.add("active");
    if(ovPanel) ovPanel.classList.add("active");
  }

  tabs.forEach(btn=>{
    btn.addEventListener("click", ()=>{
      tabs.forEach(b=>b.classList.remove("active"));
      panels.forEach(p=>p.classList.remove("active"));
      btn.classList.add("active");
      const id = "tab-" + btn.dataset.tab;
      const panel = document.getElementById(id);
      if(panel) panel.classList.add("active");

      // start/stop GameCast polling
      if(btn.dataset.tab === "gamecast") startGameCast();
      else stopGameCast();
    });
  });

  // -----------------------------
  // GameCast live polling
  // -----------------------------
  const GAME_PK = {{ game_pk | tojson }};
  const GC_URL = GAME_PK ? (`/game/${GAME_PK}/gamecast.json`) : null;

  // ---- GameCast Takeover (Ball In Play / Due Up) ----
  let __gc_takeover_timer = null;
  let __gc_last_bip_id = null;
  let __gc_last_between = false;

  const __GC_STADIUM_URL = "/static/stadium_svgs/{{ stadium_svg|default('generic.svg') }}";

  // MUST mirror the play-by-play spray mapping constants
  const __GC_BASE_W = 250;
  const __GC_BASE_H = 250;
  const __GC_PLATE = { x: 125, y: 199 };
  const __GC_EXTRA_SPREAD = 1.045;
  const __GC_NUDGE_X = 0;
  const __GC_NUDGE_Y = -10;

  let __gc_overlay_svg_el = null;
  let __gc_spray_vb = { minX: 0, minY: 0, w: 250, h: 250 };
  let __gc_overlay_loaded = false;

  function __gc_parse_viewbox(vb){
    const parts = (vb || "").split(/\s+/).map(Number).filter(n=>isFinite(n));
    if(parts.length === 4) return { minX: parts[0], minY: parts[1], w: parts[2], h: parts[3] };
    return { minX: 0, minY: 0, w: 250, h: 250 };
  }

  function __gc_map_point(sx, sy, scaleX, scaleY){
    const dx = (sx - __GC_PLATE.x) * scaleX;
    const dy = (sy - __GC_PLATE.y) * scaleY;
    const x = __gc_spray_vb.minX + (__GC_PLATE.x * scaleX) + (dx * __GC_EXTRA_SPREAD) + __GC_NUDGE_X;
    const y = __gc_spray_vb.minY + (__GC_PLATE.y * scaleY) + (dy * __GC_EXTRA_SPREAD) + __GC_NUDGE_Y;
    return { x, y };
  }

  async function __gc_load_overlay_once(){
    if(__gc_overlay_loaded) return;
    __gc_overlay_loaded = true;
    try{
      const res = await fetch(__GC_STADIUM_URL, { cache: "force-cache" });
      if(!res.ok) throw new Error("stadium overlay fetch failed");
      const svgText = await res.text();
      const doc = new DOMParser().parseFromString(svgText, "image/svg+xml");
      __gc_overlay_svg_el = doc.documentElement;
      __gc_spray_vb = __gc_parse_viewbox(__gc_overlay_svg_el.getAttribute("viewBox"));
    }catch(e){
      console.error(e);
      __gc_overlay_svg_el = null;
    }
  }

  function __gc_inject_overlay(svg){
    if(!svg || !__gc_overlay_svg_el) return;
    const g = svg.querySelector("g.sprayOverlay");
    if(!g) return;
    if(g.childNodes && g.childNodes.length) return;

    const vb = __gc_overlay_svg_el.getAttribute("viewBox");
    if(vb) svg.setAttribute("viewBox", vb);

    const frag = document.createDocumentFragment();
    Array.from(__gc_overlay_svg_el.childNodes).forEach(n=>frag.appendChild(n.cloneNode(true)));
    g.appendChild(frag);

    // Flip ONLY the stadium overlay (NOT the dots)
    const ty = (2 * __gc_spray_vb.minY) + __gc_spray_vb.h;
    g.setAttribute("transform", `translate(0 ${ty}) scale(1 -1)`);
  }

  function __gc_show_takeover(title, subtitle, bodyHTML, ms){
    const wrap = document.getElementById("gc-takeover");
    const t = document.getElementById("gc-takeover-title");
    const st = document.getElementById("gc-takeover-subtitle");
    const b = document.getElementById("gc-takeover-body");
    if(!wrap || !t || !st || !b) return;

    t.textContent = title || "â€”";
    st.textContent = subtitle || "";
    b.innerHTML = bodyHTML || "";

    wrap.style.display = "flex";

    if(__gc_takeover_timer) clearTimeout(__gc_takeover_timer);
    __gc_takeover_timer = setTimeout(()=>{
      wrap.style.display = "none";
    }, ms || 3600);
  }

  async function __gc_show_bip_takeover(bip){
    // bip should be: { id, x, y, event, description }
    if(!bip || !bip.id) return;
    if(bip.id === __gc_last_bip_id) return;
    __gc_last_bip_id = bip.id;

    const body = `
      <div class="gc-bip-wrap">
        <div>
          <svg id="gc-bip-svg" class="gc-bip-svg" viewBox="0 0 250 250" xmlns="http://www.w3.org/2000/svg">
            <g class="sprayOverlay"></g>
            <g class="sprayPoints"></g>
          </svg>
          <div class="gc-bip-pop">${(bip.description || "Ball in play")}</div>
        </div>

        <div style="min-width:220px; flex:1; padding-top:2px;">
          <div class="mono" style="opacity:.75; font-size:12px;">RESULT</div>
          <div style="font-weight:1000; font-size:16px; margin-top:4px;">${(bip.event || "In play")}</div>
          <div class="mono" style="opacity:.7; margin-top:10px;">Returning to GameCast automaticallyâ€¦</div>
        </div>
      </div>
    `;

    __gc_show_takeover("Ball In Play", "Tracking batted-ball location", body, 3600);

    await __gc_load_overlay_once();
    const svg = document.getElementById("gc-bip-svg");
    if(!svg) return;

    __gc_inject_overlay(svg);

    const pointsG = svg.querySelector("g.sprayPoints");
    if(!pointsG) return;
    pointsG.innerHTML = "";

    const sx = Number(bip.x);
    const sy = Number(bip.y);
    if(!isFinite(sx) || !isFinite(sy)) return;

    const scaleX = __gc_spray_vb.w / __GC_BASE_W;
    const scaleY = __gc_spray_vb.h / __GC_BASE_H;
    const pt = __gc_map_point(sx, sy, scaleX, scaleY);

    const halo = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    halo.setAttribute("cx", pt.x.toFixed(2));
    halo.setAttribute("cy", pt.y.toFixed(2));
    halo.setAttribute("r", "9.0");
    halo.setAttribute("fill", "rgba(15,23,42,.14)");
    pointsG.appendChild(halo);

    const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    c.setAttribute("cx", pt.x.toFixed(2));
    c.setAttribute("cy", pt.y.toFixed(2));
    c.setAttribute("r", "6.4");
    c.setAttribute("fill", "rgba(59,130,246,.92)");
    c.setAttribute("stroke", "rgba(255,255,255,.85)");
    c.setAttribute("stroke-width", "1.2");
    pointsG.appendChild(c);
  }

  function __gc_show_due_up_takeover(dueUp, inning, half){
    if(!Array.isArray(dueUp) || !dueUp.length) return;

    const row = (p) => `
      <div style="display:flex; align-items:center; gap:10px; padding:8px 10px;
                  border:1px solid rgba(226,232,240,.9); border-radius:12px; background:#fff; margin-top:8px;">
        ${p.headshot ? `<img src="${p.headshot}" style="width:34px;height:34px;border-radius:999px;border:1px solid rgba(226,232,240,.9);object-fit:cover;">` : ``}
        <div style="min-width:0;">
          <div style="font-weight:1000; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${p.shortName || p.name || "â€”"}</div>
        </div>
      </div>
    `;

    const nextHalf = (String(half||"").toLowerCase().startsWith("top")) ? `Bottom ${inning||""}` : `Top ${inning||""}`;

    const body = `
      <div style="display:flex; gap:12px; flex-wrap:wrap;">
        <div style="min-width:260px;">
          ${dueUp.slice(0,3).map(row).join("")}
        </div>
        <div style="flex:1; min-width:220px;">
          <div class="mono" style="opacity:.75; font-size:12px;">NEXT HALF-INNING</div>
          <div style="font-weight:1000; font-size:16px; margin-top:4px;">${nextHalf}</div>
          <div class="mono" style="opacity:.7; margin-top:10px;">Returning to GameCast automaticallyâ€¦</div>
        </div>
      </div>
    `;

    __gc_show_takeover("Due Up", "Between innings", body, 4200);
  }
  const IS_LIVE = {{ is_live | tojson }};
  let gcTimer = null;
  let gcLastKey = "";
   
// Default tab (GameCast first), now SAFE because GC_URL/gcTimer exist
if(gcBtn && gcPanel){
  gcBtn.classList.add("active");
  gcPanel.classList.add("active");
  startGameCast();
}else{
  if(ovBtn) ovBtn.classList.add("active");
  if(ovPanel) ovPanel.classList.add("active");
}
   
  // Auto-start when GameCast panel is the initial active tab for live games
  if(IS_LIVE){
    startGameCast();
  }

  function setDots(el, n, onClass){
    if(!el) return;
    el.innerHTML = "";
    for(let i=0;i<3;i++){
      const d = document.createElement("span");
      d.className = "gc-dot" + (i < n ? (" on " + onClass) : "");
      el.appendChild(d);
    }
  }

  function renderPerson(el, role, obj){
    if(!el) return;
    const name = (obj && obj.name) ? obj.name : "â€”";
    const hs = (obj && obj.headshot) ? obj.headshot : "";
    const line = (obj && obj.line) ? obj.line : "";
    const pos = (obj && obj.pos) ? obj.pos : "";
    el.innerHTML = `
      <div class="gc-person-top">
        <img class="gc-person-hs" src="${hs}" alt="" onerror="this.style.visibility='hidden'">
        <div style="min-width:0;">
          <div class="gc-person-role mono">${role}${pos ? (" â€¢ " + pos) : ""}</div>
          <div class="gc-person-name">${name}</div>
        </div>
      </div>
      <div class="gc-person-line mono">${line || ""}</div>
    `;
  }

  function lastNameOnly(full){
    const s = (full || "").trim();
    if(!s) return "";
    const parts = s.split(/\s+/);
    return parts[parts.length-1];
  }

  function fmtShortName(name){
    const s = (name || "").trim();
    if(!s) return "";
    const parts = s.split(/\s+/);
    if(parts.length === 1) return s;
    return `${parts[0][0]}. ${parts[parts.length-1]}`;
  }

  // Updated: player rows expandable (NOT entire lineup card)
  function renderLineup(side, el, players){
    if(!el) return;
    el.innerHTML = "";
    (players || []).forEach((p, idx)=>{
      const hs = p.headshot || "";
      const nm = p.shortName || fmtShortName(p.name);
      const pos = p.pos || "";
      const line = p.batLine || "";
      const pas = p.pas || [];
      const spot = (p.spot != null) ? (p.spot + ".") : "";

      const wrap = document.createElement("div");
      wrap.className = "gc-player";

      const row = document.createElement("div");
      row.className = "gc-row";
      row.innerHTML = `
        <div class="mono" style="width:22px; opacity:.65;">${spot}</div>
        <img class="gc-headshot" src="${hs}" alt="" onerror="this.style.visibility='hidden'">
        <div class="gc-row-main">
          <div class="gc-name">${nm} <span class="gc-pos mono">${pos || "â€”"}</span></div>
          <div class="gc-statline mono">${line || ""}</div>
        </div>
      `;

      const paWrap = document.createElement("div");
      paWrap.className = "gc-pa";

      if(!pas.length){
        paWrap.innerHTML = `<div class="mono" style="opacity:.6; font-size:12px;">No PA yet</div>`;
      }else{
        paWrap.innerHTML = pas.map(x => `
          <div class="gc-pa-item">
            <div class="mono" style="opacity:.85;">${(x.inning || "")}${(x.inning ? " - " : "")}${x.desc || ""}</div>
          </div>
        `).join("");
      }

      row.addEventListener("click", ()=>{
        // optional: close others in same lineup
        Array.from(el.querySelectorAll(".gc-player.open")).forEach(n=>{
          if(n !== wrap) n.classList.remove("open");
        });
        wrap.classList.toggle("open");
      });

      wrap.appendChild(row);
      wrap.appendChild(paWrap);
      el.appendChild(wrap);
    });
  }
function renderBasesDiamond(el, runners){
  if(!el) return;

  if(!el.dataset.ready){
    el.innerHTML = `
      <div class="gc-base second"></div>
      <div class="gc-base third"></div>
      <div class="gc-base first"></div>
      <div class="gc-base home"></div>
    `;
    el.dataset.ready = "1";
  }

  el.querySelector(".gc-base.first")?.classList.toggle("on", !!runners?.first);
  el.querySelector(".gc-base.second")?.classList.toggle("on", !!runners?.second);
  el.querySelector(".gc-base.third")?.classList.toggle("on", !!runners?.third);
}
   
  function renderField(el, defense){
    if(!el) return;
    el.innerHTML = "";

    const diamond = document.createElement("div");
    diamond.className = "gc-diamond";
    el.appendChild(diamond);

    // positions (all 9)
    const posXY = {
      "CF": {x:50, y:14},
      "LF": {x:28, y:18},
      "RF": {x:72, y:18},

      "SS": {x:42, y:38},
      "2B": {x:58, y:38},
      "3B": {x:33, y:48},
      "1B": {x:67, y:48},

      "P":  {x:50, y:48},
      "C":  {x:50, y:72},
    };

    const d = defense || {};
    Object.keys(posXY).forEach(pos=>{
      const who = d[pos] || {};
      const nm = who.lastName || lastNameOnly(who.name) || "";
      if(!nm) return;

      const lab = document.createElement("div");
      lab.className = "gc-label small";
      lab.textContent = nm;
      lab.style.left = posXY[pos].x + "%";
      lab.style.top  = posXY[pos].y + "%";
      el.appendChild(lab);
    });
  }

  function renderBases(el, runners){
    if(!el) return;
    const list = document.createElement("div");
    list.className = "gc-bases-list";

    const baseMap = {"1B": "â€”", "2B": "â€”", "3B": "â€”"};

    // Expect object: {first:{name}, second:{name}, third:{name}}
    if(runners && typeof runners === "object"){
      const f = runners.first && runners.first.name ? runners.first.name : "";
      const s = runners.second && runners.second.name ? runners.second.name : "";
      const t = runners.third && runners.third.name ? runners.third.name : "";
      if(f) baseMap["1B"] = fmtShortName(f);
      if(s) baseMap["2B"] = fmtShortName(s);
      if(t) baseMap["3B"] = fmtShortName(t);
    }

    ["1B","2B","3B"].forEach(b=>{
      const row = document.createElement("div");
      row.className = "gc-base-row";
      row.innerHTML = `<div class="gc-base-k">${b}:</div><div class="gc-base-v">${baseMap[b]}</div>`;
      list.appendChild(row);
    });

    el.innerHTML = "";
    el.appendChild(list);
  }

  function pitchOutcomeLabel(p){
  // Backend provides: call (e.g. "Called Strike") and desc (sometimes "Foul")
  const call = (p && typeof p.call === "string") ? p.call.trim() : "";
  if(call) return call;

  const desc = (p && typeof p.desc === "string") ? p.desc.trim() : "";
  if(desc) return desc;

  // Last-ditch fallback using flags
  if(p?.isInPlay) return "In play";
  if(p?.isFoul) return "Foul";
  if(p?.isBall) return "Ball";
  if(p?.isStrike) return "Strike";
  return "â€”";
}

function renderPitchTable(tbody, pitches){
  if(!tbody) return;
  tbody.innerHTML = "";

  (pitches || []).forEach(p => {
    const tr = document.createElement("tr");

    const mph = (p.mph ?? "");
    const spin = (p.spinRate ?? "");
    const vm = (p.vertMove ?? "");
    const hm = (p.horizMove ?? "");
    const out = pitchOutcomeLabel(p);

    tr.innerHTML = `
      <td class="mono">${p.n ?? ""}</td>
      <td>${p.pitchType || ""}</td>
      <td class="mono" style="text-align:right;">${(mph !== "" && mph !== null) ? Number(mph).toFixed(1) : ""}</td>
      <td class="mono" style="text-align:right;">${(spin !== "" && spin !== null) ? Math.round(Number(spin)) : ""}</td>
      <td class="mono" style="text-align:right;">${(vm !== "" && vm !== null) ? Number(vm).toFixed(1) : ""}</td>
      <td class="mono" style="text-align:right;">${(hm !== "" && hm !== null) ? Number(hm).toFixed(1) : ""}</td>
      <td>${out}</td>
    `;
    tbody.appendChild(tr);
  });
}

  // FIXED: single async, no syntax error
  async function fetchGameCast(){
    if(!GC_URL) return;
    try{
      const res = await fetch(GC_URL, { cache: "no-store" });
      if(!res.ok){
        throw new Error(`gamecast.json HTTP ${res.status}`);
      }
      const data = await res.json();
      console.log("[GameCast] payload:", data);
      updateHeroFromGamecast(data);

      if(!data || data.ok === false){
        const msg = data && data.reason ? data.reason : "No live data available";
        const lastPlayEl = document.getElementById("gc-lastplay");
        if(lastPlayEl) lastPlayEl.textContent = `GameCast unavailable (${msg})`;
        return;
      }
      if(!data || !data.ok) return;

      const key = [
        data.inning, data.half, data.balls, data.strikes, data.outs,
        data.score?.away, data.score?.home,
        data.lastPlay || "",
        (data.pitches||[]).length
      ].join("|");
      if(key === gcLastKey) return;
      gcLastKey = key;


      // ---- Takeover triggers ----
      // 1) Between-innings Due Up takeover (trigger on transition into between-innings)
      if(!!data.betweenInnings && !__gc_last_between){
        __gc_show_due_up_takeover(data.dueUp || [], data.inning, data.half);
      }
      __gc_last_between = !!data.betweenInnings;

      // 2) Ball-in-play takeover (only when we get a new bip.id)
      if(data.bip && data.bip.id){
        __gc_show_bip_takeover(data.bip);
      }
      const innEl = document.getElementById("gc-inning");
      if(innEl) innEl.textContent = (data.half && data.inning) ? `${data.half} ${data.inning}` : "â€”";

      const awayRuns = document.getElementById("gc-away-runs");
      const homeRuns = document.getElementById("gc-home-runs");
      if(awayRuns) awayRuns.textContent = (data.score && data.score.away != null) ? data.score.away : "0";
      if(homeRuns) homeRuns.textContent = (data.score && data.score.home != null) ? data.score.home : "0";

      setDots(document.getElementById("gc-balls"), data.balls || 0, "ball");
      setDots(document.getElementById("gc-strikes"), data.strikes || 0, "strike");
      setDots(document.getElementById("gc-outs"), data.outs || 0, "out");

      const countEl = document.getElementById("gc-count");
      if(countEl) countEl.textContent = `${data.balls || 0}-${data.strikes || 0}, ${data.outs || 0} out${(data.outs||0)===1?"":"s"}`;

      const lastEl = document.getElementById("gc-lastplay");
      if(lastEl) lastEl.textContent = data.lastPlay || "â€”";

      renderPerson(document.getElementById("gc-batter"), "At Bat", data.batter);
      renderPerson(document.getElementById("gc-pitcher"), "Pitching", data.pitcher);

      renderLineup("away", document.getElementById("gc-lineup-away"), data.lineups?.away);
      renderLineup("home", document.getElementById("gc-lineup-home"), data.lineups?.home);

      renderField(document.getElementById("gc-field"), data.defense);
      renderBases(document.getElementById("gc-bases"), data.runners);
      renderBasesDiamond(document.getElementById("gc-bases-diamond"), data.runners);

      const ds = document.getElementById("gc-defense-side");
      if(ds) ds.textContent = data.defenseSide ? (`Defense: ${String(data.defenseSide).toUpperCase()}`) : "";

      const pitches = data.pitches || [];
      const zone = document.getElementById("gc-zone");
      {
        // Only pulse when a NEW pitch arrives (prevents re-pulsing every poll)
        const last = pitches.length ? (pitches[pitches.length - 1] || {}) : {};
        const lastN = (last.n != null) ? last.n : pitches.length;
        const prevN = window.__gc_lastPitchN;
        const pulse = (lastN != null) && (prevN == null || lastN !== prevN);
        window.__gc_lastPitchN = lastN;
        renderZone(zone, pitches, { pulseLast: pulse });
      }const tbody = document.querySelector("#gc-pitch-table tbody");
      renderPitchTable(tbody, pitches);

    }catch(e){
      console.error("GameCast fetch failed:", e);
      const st = document.getElementById("gc-status");
      if(st){
        st.style.display = "block";
        st.textContent = `Live data unavailable (${e?.message || e})`;
      }
      const lastEl = document.getElementById("gc-lastplay");
      if(lastEl){
        lastEl.textContent = `Live data unavailable (${e?.message || e})`;
      }
    }
  }

  function startGameCast(){
    if(gcTimer || !GC_URL) return;
    fetchGameCast();
    gcTimer = setInterval(fetchGameCast, 3000);
  }
  function stopGameCast(){
    if(!gcTimer) return;
    clearInterval(gcTimer);
    gcTimer = null;
  }

  function renderZone(svg, pitches, opts = {}){
    const w = parseFloat(svg.getAttribute("width") || 200);
    const h = parseFloat(svg.getAttribute("height") || 240);

    const tops = (pitches||[]).map(p=>p.sz_top).filter(v=>v!==null && v!==undefined);
    const bots = (pitches||[]).map(p=>p.sz_bot).filter(v=>v!==null && v!==undefined);

    const zoneTop = tops.length ? (tops.reduce((a,b)=>a+b,0)/tops.length) : 3.5;
    const zoneBot = bots.length ? (bots.reduce((a,b)=>a+b,0)/bots.length) : 1.5;

    const xMin = -1.5, xMax = 1.5;
    const yMin = zoneBot - 0.8, yMax = zoneTop + 0.8;

    function xScale(x){ return ( (x - xMin) / (xMax - xMin) ) * w; }
    function yScale(y){ return h - ( (y - yMin) / (yMax - yMin) ) * h; }

    svg.innerHTML = "";

    const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
    rect.setAttribute("x", xScale(-0.83));
    rect.setAttribute("y", yScale(zoneTop));
    rect.setAttribute("width", xScale(0.83) - xScale(-0.83));
    rect.setAttribute("height", yScale(zoneBot) - yScale(zoneTop));
    rect.setAttribute("fill", "rgba(15,23,42,.03)");
    rect.setAttribute("stroke", "rgba(226,232,240,.9)");
    rect.setAttribute("stroke-width", "1");
    svg.appendChild(rect);

    (pitches || []).forEach((p, idx)=>{
      if(p.px === null || p.px === undefined || p.pz === null || p.pz === undefined) return;
      const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
      c.setAttribute("cx", xScale(p.px));
      c.setAttribute("cy", yScale(p.pz));
      c.setAttribute("r", 8);


      // Pulse the latest pitch dot in GameCast
      if(opts && opts.pulseLast && idx === (pitches.length - 1)){
        c.classList.add("gc-pulse");
      }
      const t = document.createElementNS("http://www.w3.org/2000/svg","text");
      t.setAttribute("x", xScale(p.px));
      t.setAttribute("y", yScale(p.pz) + 3);
      t.setAttribute("text-anchor", "middle");
      t.setAttribute("font-size", "9");
      t.setAttribute("font-family", "IBM Plex Mono, ui-monospace, Menlo, monospace");
      t.setAttribute("fill", "rgba(255,255,255,.95)");
      t.textContent = (p.n != null ? p.n : "");

      let fill = "rgba(148,163,184,.75)";
      if(p.isFoul) fill = "rgba(148,163,184,.75)";
      else if(p.isInPlay) fill = "rgba(59,130,246,.75)";
      else if(p.isBall) fill = "rgba(34,197,94,.75)";
      else if(p.isStrike) fill = "rgba(239,68,68,.75)";
      c.setAttribute("fill", fill);
      c.setAttribute("stroke", "rgba(15,23,42,.25)");
      c.setAttribute("stroke-width", "0.5");
      svg.appendChild(c);
      if(t.textContent) svg.appendChild(t);
    });
  }

  // Render all strike zones in PBP
  document.querySelectorAll("svg.strike-zone").forEach(svg=>{
    try{
      const pitches = JSON.parse(svg.getAttribute("data-pitches") || "[]");
      // Only PBP strike zones have data-pitches attribute; GameCast zone doesn't.
      if(svg.getAttribute("data-pitches") !== null){
        renderZone(svg, pitches);
      }
    }catch(e){}
  });

  // -----------------------------
  // Mini Spray Chart (one PA)
  // -----------------------------
  const STADIUM_URL = "/static/stadium_svgs/{{ stadium_svg|default('generic.svg') }}";

  const BASE_W = 250;
  const BASE_H = 250;
  const PLATE = { x: 125, y: 199 };
  const EXTRA_SPREAD = 1.045;
  const NUDGE_X = 0;
  const NUDGE_Y = -10;

  let overlaySvgEl = null;
  let sprayVB = { minX: 0, minY: 0, w: 250, h: 250 };
  let overlayLoaded = false;

  function sprayColorForEvent(label){
    const raw = (label || "").toLowerCase().trim();
    const e = raw.replace(/\s+/g, " ");
    if(e === "single") return "#22c55e";
    if(e === "double") return "#3b82f6";
    if(e === "triple") return "#a855f7";
    if(e === "home run" || e === "home_run" || e === "home-run") return "#ef4444";
    return "#f59e0b";
  }

  function parseViewBox(vb){
    const parts = (vb || "").split(/\s+/).map(Number).filter(n=>isFinite(n));
    if(parts.length === 4){
      return { minX: parts[0], minY: parts[1], w: parts[2], h: parts[3] };
    }
    return { minX: 0, minY: 0, w: 250, h: 250 };
  }

  function mapPointToStadium(sx, sy, scaleX, scaleY){
    const dx = (sx - PLATE.x) * scaleX;
    const dy = (sy - PLATE.y) * scaleY;

    const x = sprayVB.minX + (PLATE.x * scaleX) + (dx * EXTRA_SPREAD) + NUDGE_X;
    const y = sprayVB.minY + (PLATE.y * scaleY) + (dy * EXTRA_SPREAD) + NUDGE_Y;
    return { x, y };
  }

  async function loadOverlayOnce(){
    if(overlayLoaded) return;
    overlayLoaded = true;

    try{
      const res = await fetch(STADIUM_URL, { cache: "force-cache" });
      if(!res.ok) throw new Error("stadium overlay fetch failed");
      const svgText = await res.text();

      const doc = new DOMParser().parseFromString(svgText, "image/svg+xml");
      overlaySvgEl = doc.documentElement;

      const vb = overlaySvgEl.getAttribute("viewBox");
      sprayVB = parseViewBox(vb);
    }catch(e){
      console.error(e);
      overlaySvgEl = null;
    }
  }

  function injectOverlayInto(svg){
    if(!svg) return;
    const g = svg.querySelector("g.sprayOverlay");
    if(!g) return;
    if(g.childNodes && g.childNodes.length) return;
    if(!overlaySvgEl) return;

    const vb = overlaySvgEl.getAttribute("viewBox");
    if(vb) svg.setAttribute("viewBox", vb);

    const frag = document.createDocumentFragment();
    Array.from(overlaySvgEl.childNodes).forEach(n=>{
      frag.appendChild(n.cloneNode(true));
    });
    g.appendChild(frag);

    // Flip ONLY the stadium overlay (not dots)
    const ty = (2 * sprayVB.minY) + sprayVB.h;
    g.setAttribute("transform", `translate(0 ${ty}) scale(1 -1)`);
  }

  function renderSingleDot(svg, bb, noteEl){
    const pointsG = svg.querySelector("g.sprayPoints");
    if(!pointsG) return;
    pointsG.innerHTML = "";

    const has = !!(bb && bb.has);
    const xRaw = bb ? bb.x : null;
    const yRaw = bb ? bb.y : null;

    if(noteEl){
      if(has && (xRaw === null || xRaw === undefined || yRaw === null || yRaw === undefined)){
        noteEl.style.display = "block";
      }else{
        noteEl.style.display = "none";
      }
    }

    if(!has) return;
    if(xRaw === null || xRaw === undefined || yRaw === null || yRaw === undefined) return;

    const sx = Number(xRaw);
    const sy = Number(yRaw);
    if(!isFinite(sx) || !isFinite(sy)) return;

    const scaleX = sprayVB.w / BASE_W;
    const scaleY = sprayVB.h / BASE_H;
    const pt = mapPointToStadium(sx, sy, scaleX, scaleY);

    const halo = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    halo.setAttribute("cx", pt.x.toFixed(2));
    halo.setAttribute("cy", pt.y.toFixed(2));
    halo.setAttribute("r", "7.2");
    halo.setAttribute("fill", "rgba(15,23,42,.22)");
    pointsG.appendChild(halo);

    const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    c.setAttribute("cx", pt.x.toFixed(2));
    c.setAttribute("cy", pt.y.toFixed(2));
    c.setAttribute("r", "5.2");
    c.setAttribute("fill", sprayColorForEvent(bb.event));
    c.setAttribute("fill-opacity", "0.96");
    c.setAttribute("stroke", "rgba(255,255,255,.9)");
    c.setAttribute("stroke-width", "1.2");
    pointsG.appendChild(c);
  }

  async function initMiniSprays(){
    const svgs = Array.from(document.querySelectorAll("svg.spray-svg-mini"));
    if(!svgs.length) return;

    await loadOverlayOnce();

    svgs.forEach(svg=>{
      injectOverlayInto(svg);

      let bb = null;
      try{
        bb = JSON.parse(svg.getAttribute("data-bb") || "null");
      }catch(e){
        bb = null;
      }
      const wrap = svg.closest(".spray-mini-card");
      const noteEl = wrap ? wrap.querySelector(".spray-missing-note") : null;
      renderSingleDot(svg, bb, noteEl);
    });
  }

  initMiniSprays();

})();
</script>

{% endblock %}
