<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ game.away.name }} @ {{ game.home.name }} — Game Report</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#ffffff; --card:#ffffff; --muted:#5b6577; --text:#111318; --accent:#0b5cab;
      --row:#fafbfc; --rowAlt:#f4f6f9; --border:#e2e8f0; --subtle:#8a94ab;
      --chip-live:#e21d48; --chip-final:#32425c; --chip-upcoming:#6b7a94;
    }
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--text); font-family:"IBM Plex Sans",-apple-system,Segoe UI,Roboto,Arial; }

    .wrap{ max-width:1150px; margin:20px auto; padding:0 14px; }

    /* Header block */
    .header{
      display:grid;
      grid-template-columns:1fr auto 1fr;
      align-items:center;
      gap:18px;
      margin-bottom:14px;
    }
    .center-info{ display:flex; flex-direction:column; align-items:center; gap:6px; }
    .chip{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px; border-radius:999px; font-weight:700; letter-spacing:.4px;
      color:#fff; text-transform:uppercase; font-size:12px;
      background:var(--chip-final);
    }
    .chip.live{ background:var(--chip-live); }
    .chip.upcoming{ background:var(--chip-upcoming); }
    .center-info .status{ font-size:13px; font-weight:700; color:#0b0e13; }
    .center-info .venue{ font-size:12px; color:#6b7280; }

    .team{ display:grid; grid-template-columns:1fr; justify-items:center; gap:6px; }
    .logo-row{
      display:flex; align-items:center; gap:10px;
      /* we keep logos outside, scores inside: away[score|logo], home[logo|score] */
    }
    .team .logo{ width:84px; height:84px; object-fit:contain; }
    .score{
      font-family:"IBM Plex Mono",ui-monospace,Menlo,monospace; font-weight:800; font-size:40px; line-height:1;
      min-width:38px; text-align:center;
    }
    .name{ font-size:15px; font-weight:700; text-align:center; }
    .record{ font-size:12.5px; color:#6b7280; }

    /* Grid */
    .grid{ display:grid; grid-template-columns:1.1fr .9fr; gap:14px; }
    @media (max-width:1000px){ .grid{ grid-template-columns:1fr; } }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; }
    .card h3{ margin:0 0 10px; font-size:15px; letter-spacing:.2px; }

    /* Linescore */
    .linescore{ overflow:auto }
    table{ border-collapse:collapse; width:100% }
    th,td{ padding:6px 8px; border-bottom:1px solid var(--border); text-align:center; font-size:13px }
    thead th{ background:#f7f8fb; font-weight:700 }

    /* Boxes */
    .split{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:800px){ .split{ grid-template-columns:1fr; } }
    .tbl th{ background:#f7f8fb }
    .tbl tr:nth-child(even){ background:var(--rowAlt) }
    .tbl tr:nth-child(odd){ background:var(--row) }
    .tbl td, .tbl th{ font-size:12.5px; padding:6px 8px; text-align:center }

    /* Decisions */
    .decisions{ font-size:13px; color:#111318; padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:#f8fafc; display:none }

    /* PBP */
    details{ border:1px solid var(--border); border-radius:10px; padding:8px 10px; background:#fff; margin-bottom:8px }
    summary{ cursor:pointer; font-weight:700 }
    .pbp-row{ display:grid; grid-template-columns:70px 1fr; gap:10px; padding:6px 0; border-bottom:1px dashed var(--border) }
    .pbp-row:last-child{ border-bottom:0 }
    .pbp-meta{ color:var(--subtle); font-size:12px }
    .pbp-stats{ color:var(--subtle); font-size:12px }

    .when{ color:var(--muted); font-size:13px }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- Header -->
    {% if game %}
    <div class="header">
      <!-- Away -->
      <div class="team">
        <div class="logo-row">
          <div class="score" id="awayScore">{{ game.away.score }}</div>
          <img class="logo" src="{{ game.away.logo }}" alt="{{ game.away.name }} logo">
        </div>
        <div class="name">{{ game.away.name }}</div>
        <div class="record">{{ game.away.record }}</div>
      </div>

      <!-- Center -->
      <div class="center-info">
        <div class="chip" id="statusChip">{{ game.status }}</div>
        <div class="status">{{ game.status }}</div>
        <div class="venue">{{ game.venue }} • {{ game.date }}</div>
        <div class="when" id="statcastLine">Loading latest play…</div>
      </div>

      <!-- Home -->
      <div class="team">
        <div class="logo-row">
          <img class="logo" src="{{ game.home.logo }}" alt="{{ game.home.name }} logo">
          <div class="score" id="homeScore">{{ game.home.score }}</div>
        </div>
        <div class="name">{{ game.home.name }}</div>
        <div class="record">{{ game.home.record }}</div>
      </div>
    </div>
    {% else %}
    <p class="when">Could not load game header.</p>
    {% endif %}

    <div class="grid">
      <!-- Left: Linescore + PBP -->
      <div class="card">
        <h3>Linescore</h3>
        <div class="linescore">
          <table id="linescoreBox"></table>
        </div>

        <h3 style="margin-top:16px;">Play by Play</h3>
        <div id="pbpBox">Loading…</div>
      </div>

      <!-- Right: Batting/Pitching boxes + Decisions + Scoring -->
      <div class="card">
        <h3>Batting</h3>
        <div class="split">
          <table class="tbl" id="batAway"></table>
          <table class="tbl" id="batHome"></table>
        </div>

        <h3 style="margin-top:16px;">Pitching</h3>
        <div class="split">
          <table class="tbl" id="pitAway"></table>
          <table class="tbl" id="pitHome"></table>
        </div>

        <h3 style="margin-top:16px;">Decisions</h3>
        <div id="decisionsLine" class="decisions"></div>

        <h3 style="margin-top:16px;">Scoring Summary</h3>
        <div id="scoringBox">Loading…</div>
      </div>
    </div>
  </div>

  <script>
    const gamePk = {{ game_pk }};
    const API = `/api/game/${gamePk}`;

    function th(s){ return `<th>${s}</th>`;}
    function td(s){ return `<td>${s ?? ''}</td>`;}

    function linescoreTable(ls){
      if(!ls || !ls.n){ return '<tr><td class="when">—</td></tr>'; }
      const n = ls.n;
      let thead = '<thead><tr><th></th>';
      for(let i=1;i<=n;i++) thead += th(i);
      thead += th('R')+th('H')+th('E')+'</tr></thead>';

      function row(label, arr, totals){
        let cells = `<td style="font-weight:700">${label}</td>`;
        for(let i=0;i<n;i++) cells += td(arr[i] ?? '');
        cells += td(`<b>${(totals||{}).R ?? ''}</b>`) + td((totals||{}).H ?? '') + td((totals||{}).E ?? '');
        return `<tr>${cells}</tr>`;
      }
      const away = ls.away || [], home = ls.home || [];
      const ta = (ls.totals||{}).away || {}, thm = (ls.totals||{}).home || {};
      return thead + `<tbody>${row('AWY', away, ta)}${row('HME', home, thm)}</tbody>`;
    }

    function batTable(abbr, rows){
      if(!rows || !rows.length) return '<tr><td class="when">—</td></tr>';
      const head = `
        <thead><tr>
          ${th(abbr)}${th('POS')}${th('AB')}${th('R')}${th('H')}${th('RBI')}${th('BB')}${th('K')}
        </tr></thead>`;
      const body = rows.map(r => `
        <tr>
          ${td(r.name)}${td(r.pos)}${td(r.ab)}${td(r.r)}${td(r.h)}${td(r.rbi)}${td(r.bb)}${td(r.k)}
        </tr>`).join('');
      return head + '<tbody>' + body + '</tbody>';
    }

    function pitTable(abbr, rows, decisions){
      if(!rows || !rows.length) return '<tr><td class="when">—</td></tr>';
      const W = decisions?.winnerId, L = decisions?.loserId, S = decisions?.saveId;
      const head = `
        <thead><tr>
          ${th(abbr)}${th('IP')}${th('H')}${th('R')}${th('ER')}${th('BB')}${th('K')}${th('HR')}${th('P')}
        </tr></thead>`;
      const body = rows.map(r => {
        let name = r.name || '';
        if (r.pid === W) name += ' (W)';
        if (r.pid === L) name += ' (L)';
        if (r.pid === S) name += ' (SV)';
        return `
          <tr>
            ${td(name)}${td(r.ip)}${td(r.h)}${td(r.r)}${td(r.er)}${td(r.bb)}${td(r.k)}${td(r.hr)}${td(r.p)}
          </tr>`;
      }).join('');
      return head + '<tbody>' + body + '</tbody>';
    }

    function renderPBPByInning(list){
      if(!Array.isArray(list) || !list.length){
        document.getElementById('pbpBox').innerHTML = '<div class="when">—</div>';
        return;
      }
      const map = new Map();
      for (const r of list){
        const k = r.inningNum || 0;
        if(!map.has(k)) map.set(k, []);
        map.get(k).push(r);
      }
      const keys = Array.from(map.keys()).sort((a,b)=>a-b);
      const html = keys.map(k=>{
        const rows = map.get(k) || [];
        const body = rows.map(r=>{
          const parts = [];
          if (r.ev) parts.push(`EV ${r.ev} mph`);
          if (r.la) parts.push(`LA ${r.la}°`);
          if (r.dist) parts.push(`${r.dist} ft`);
          if (r.xba) parts.push(`xBA ${r.xba}`);
          if (r.xslg) parts.push(`xSLG ${r.xslg}`);
          return `
            <div class="pbp-row">
              <div class="pbp-meta">${r.inning || ''}</div>
              <div>
                <div>${r.desc || ''}</div>
                <div class="pbp-stats">${parts.join(' • ')}</div>
              </div>
            </div>`;
        }).join('');
        const label = (k===1?'1st':k===2?'2nd':k===3?'3rd':k+'th') + ' Inning';
        return `<details><summary>${label}</summary><div>${body}</div></details>`;
      }).join('');
      document.getElementById('pbpBox').innerHTML = html;
    }

    async function load(){
      const res = await fetch(API, {cache:'no-store'});
      const data = await res.json();
      if (data.error){
        document.getElementById('linescoreBox').innerHTML = '<em class="when">Could not load inning-by-inning.</em>';
        return;
      }
      const g = data.game || {};
      const meta = data.meta || {};
      // decisions line
      const decLine = document.getElementById('decisionsLine');
      if (meta.decisionsText){
        decLine.textContent = meta.decisionsText;
        decLine.style.display = 'block';
      } else {
        decLine.style.display = 'none';
      }

      // chip text
      const chip = document.getElementById('statusChip');
      if (chip){
        chip.textContent = g.chip || '';
        chip.classList.remove('live','upcoming');
        if ((g.status||'').toLowerCase()==='in_progress' || (g.chip||'').toLowerCase().includes('top') || (g.chip||'').toLowerCase().includes('bot')){
          chip.classList.add('live');
        } else if ((g.status||'').toLowerCase()==='scheduled'){
          chip.classList.add('upcoming');
        }
      }

      // header statcast line
      document.getElementById('statcastLine').textContent = g.statcast || '—';

      // scores
      if (g.teams){
        document.getElementById('awayScore').textContent = (g.teams.away && g.teams.away.score!=null) ? g.teams.away.score : '-';
        document.getElementById('homeScore').textContent = (g.teams.home && g.teams.home.score!=null) ? g.teams.home.score : '-';
      }

      // linescore
      const ls = g.linescore || {};
      document.getElementById('linescoreBox').innerHTML = linescoreTable(ls);

      // batting
      const batA = (g.batters && g.batters.away) || [];
      const batH = (g.batters && g.batters.home) || [];
      document.getElementById('batAway').innerHTML = batTable(g.teams.away.abbr, batA);
      document.getElementById('batHome').innerHTML = batTable(g.teams.home.abbr, batH);
      // pitching
      const pitA = (g.pitchers && g.pitchers.away) || [];
      const pitH = (g.pitchers && g.pitchers.home) || [];
      document.getElementById('pitAway').innerHTML = pitTable(g.teams.away.abbr, pitA, meta.decisions);
      document.getElementById('pitHome').innerHTML = pitTable(g.teams.home.abbr, pitH, meta.decisions);
      // pbp
      renderPBPByInning(Array.isArray(data.plays)? data.plays : []);
    }

    load().catch(console.error);
  </script>
</body>
</html>
