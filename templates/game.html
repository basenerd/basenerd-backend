<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{% if game %}{{ game.away.name }} @ {{ game.home.name }} â€” Game Report{% else %}Game Report{% endif %}</title>

  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600;700&family=IBM+Plex+Mono:wght@500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#ffffff; --border:#e2e8f0; --chip-live:#e21d48; --chip-final:#32425c; --chip-upcoming:#6b7a94;
    }
    body{margin:0; background:var(--bg); font-family:"IBM Plex Sans", system-ui, sans-serif;}

    .game-header{
      display:grid; grid-template-columns:1fr auto 1fr; align-items:center;
      padding:18px 20px; border-bottom:2px solid var(--border);
      background:linear-gradient(180deg,#fff,#f6f9ff);
    }
    .team{
      display:grid; grid-template-columns:auto auto; align-items:center; gap:12px;
    }
    .team.away{ justify-self:end; }
    .team.home{ justify-self:start; direction:rtl; }
    .team .logo{ width:96px; height:96px; object-fit:contain; }
    .team .score{
      font-family:"IBM Plex Mono", monospace;
      font-size:54px; font-weight:800; line-height:1;
    }
    .team.home .score, .team.home .name{ direction:ltr; }
    .team .name{ font-size:15px; font-weight:700; grid-column:1 / -1; text-align:center; }

    .center-info{ display:grid; justify-items:center; text-align:center; gap:4px; }
    .center-info .date{ font-size:12px; color:#374151; }
    .center-info .status{ font-size:13px; font-weight:700; }
    .center-info .venue{ font-size:12px; color:#6b7280; }

    .chip{ font-size:11px; padding:3px 8px; border-radius:999px; color:#fff; font-weight:700; }
    .chip.live{ background:var(--chip-live); }
    .chip.final{ background:var(--chip-final); }
    .chip.upcoming{ background:var(--chip-upcoming); }

    .section{ max-width:1100px; margin:16px auto; padding:0 12px; }

    .ibox{ background:#fff; border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .ibox table{ border-collapse:collapse; width:100%; font-family:"IBM Plex Mono", monospace; font-size:13px; }
    .ibox thead th{ color:#5b6577; font-weight:700; border-bottom:1px solid var(--border); padding:8px; text-align:center; }
    .ibox tbody td{ border-bottom:1px solid var(--border); padding:8px; text-align:center; }
    .ibox td.name, .ibox th.name{ text-align:left; font-family:"IBM Plex Sans", sans-serif; font-weight:700; }
  </style>
</head>
<body>

  {% if game %}
  <div class="game-header">
    <div class="team away">
      <img class="logo" src="https://www.mlbstatic.com/team-logos/{{ game.away.id }}.svg" alt="{{ game.away.name }} logo" />
      <div class="score">{{ game.away.score }}</div>
      <div class="name">{{ game.away.name }}</div>
    </div>
    <div class="center-info">
      <div class="date">{{ game.date }}</div>
      {% set chip_class = 'live' if 'Top' in game.status or 'Bot' in game.status or 'MID' in game.status or 'END' in game.status else ('final' if game.status=='Final' else 'upcoming') %}
      <div class="status"><span class="chip {{ chip_class }}">{{ game.status }}</span></div>
      <div class="venue">{{ game.venue }}</div>
    </div>
    <div class="team home">
      <div class="score">{{ game.home.score }}</div>
      <img class="logo" src="https://www.mlbstatic.com/team-logos/{{ game.home.id }}.svg" alt="{{ game.home.name }} logo" />
      <div class="name">{{ game.home.name }}</div>
    </div>
  </div>
  {% endif %}

  <div class="section">
    <div class="ibox" id="ibox">
      <div class="wrap" id="iboxWrap"></div>
    </div>
  </div>

  <script>
    (async function(){
      const gamePk = {{ game_pk|int }};
      const $wrap = document.getElementById('iboxWrap');
      function htmlEsc(s){ return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
      function linescoreTable(g){
        const ls = g.linescore; if (!ls) return '';
        const n = ls.n || 9;
        const head = Array.from({length:n}, (_,i)=>`<th>${i+1}</th>`).join('');
        const aCells = Array.from({length:n}, (_,i)=>`<td>${htmlEsc(ls.away[i])}</td>`).join('');
        const hCells = Array.from({length:n}, (_,i)=>`<td>${htmlEsc(ls.home[i])}</td>`).join('');
        const aT = ls.totals.away, hT = ls.totals.home;
        return `<table>
          <thead><tr><th class="name"></th>${head}<th>R</th><th>H</th><th>E</th></tr></thead>
          <tbody>
            <tr><td class="name">${g.teams.away.abbr}</td>${aCells}<td>${aT.R}</td><td>${aT.H}</td><td>${aT.E}</td></tr>
            <tr><td class="name">${g.teams.home.abbr}</td>${hCells}<td>${hT.R}</td><td>${hT.H}</td><td>${hT.E}</td></tr>
          </tbody></table>`;
      }
      try{
        const res = await fetch("/api/game/" + gamePk);
        const data = await res.json();
        $wrap.innerHTML = linescoreTable(data.game);
      }catch(e){
        console.error(e);
        $wrap.innerHTML = '<div style="padding:16px; text-align:center;">Error loading box score.</div>';
      }
    })();
  </script>

</body>
</html>
