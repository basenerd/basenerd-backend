<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{% if game %}{{ game.away.name }} @ {{ game.home.name }} — Game Report{% else %}Game Report{% endif %}</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600;700&family=IBM+Plex+Mono:wght@500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#ffffff; --card:#ffffff; --muted:#5b6577; --text:#111318; --accent:#0b5cab;
      --row:#fafbfc; --rowAlt:#f4f6f9; --border:#e2e8f0;
      --chip-live:#e21d48; --chip-final:#32425c; --chip-upcoming:#6b7a94;
      --subtle:#8a94ab;
    }
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--text);
      font-family:"IBM Plex Sans",system-ui,-apple-system,"Segoe UI",Roboto,Arial; font-size:14px; }

    /* Page header (title bar) */
    header.page{ display:flex; align-items:flex-end; gap:10px; padding:12px 16px;
      border-bottom:2px solid var(--border); background:#fff; position:sticky; top:0; z-index:5;}
    header.page h1{ margin:0; font-size:18px; font-weight:700; letter-spacing:.2px; }
    header.page .when{ color:var(--muted); font-size:12px; }

    .wrap{ max-width:1100px; margin:16px auto 60px; padding:0 12px; }

    /* Game header band */
    .game-header{
      background:linear-gradient(180deg,#fff,#f6f9ff);
      border:1px solid var(--border); border-radius:14px; padding:14px;
      display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:14px;
    }
    .team{ display:grid; justify-items:center; gap:6px; }
    .stack{ display:flex; align-items:center; gap:10px; }
    .logo{ width:84px; height:84px; object-fit:contain; }
    .score{ font-family:"IBM Plex Mono",ui-monospace,Menlo,monospace; font-weight:800; font-size:40px; line-height:1; }
    .name{ font-size:16px; font-weight:700; text-align:center; }
    .record{ font-size:12.5px; color:#394150; text-align:center; margin-top:-2px; font-weight:600; }

    .center{ display:grid; justify-items:center; text-align:center; gap:6px; padding:0 10px; }
    .center .date{ font-size:13px; color:#374151; }
    .center .chip{ font-size:12px; padding:3px 8px; border-radius:999px; color:#fff; font-weight:700; letter-spacing:.3px; }
    .center .chip.live{ background:var(--chip-live); }
    .center .chip.final{ background:var(--chip-final); }
    .center .chip.upcoming{ background:var(--chip-upcoming); }
    .center .venue{ font-size:12px; color:#6b7280; }

    /* Cards */
    .card{ background:var(--card); border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .card header{ padding:10px 12px; border-bottom:1px solid var(--border); font-weight:700; color:#32425c;
      background:linear-gradient(180deg,#fff,#f6f9ff); }
    .placeholder{ padding:14px; color:var(--muted); }

    /* Inning by inning table */
    .ibox{ max-width:900px; margin:14px auto; }
    .ibox table{ border-collapse:collapse; width:100%; font-family:"IBM Plex Mono",ui-monospace,Menlo,monospace; font-size:12.5px; }
    .ibox thead th{ color:#5b6577; font-weight:700; border-bottom:1px solid var(--border); padding:8px 8px; text-align:center; }
    .ibox tbody td{ border-bottom:1px solid var(--border); padding:8px 8px; text-align:center; color:#394150; }
    .ibox td.name, .ibox th.name{ text-align:left; font-family:"IBM Plex Sans"; }

    .ibox th.rhe{ font-weight:800; }

    /* Boxscore grids (batting & pitching) */
    .box-grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px; margin:14px 0; }
    @media(max-width:900px){ .box-grid{ grid-template-columns:1fr; } }

    .box{ border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#fff; }
    .box .teamhdr{ padding:8px 12px; border-bottom:1px solid var(--border); background:#fff; font-weight:700; color:#5b6577; font-size:12px; }
    .box table{ border-collapse:collapse; width:100%; font-family:"IBM Plex Mono",ui-monospace,Menlo,monospace; font-size:11.5px; }
    .box thead th{ color:#5b6577; font-weight:700; border-bottom:1px solid var(--border); padding:6px 6px; text-align:center; }
    .box tbody td{ border-bottom:1px solid var(--border); padding:6px 6px; text-align:center; color:#394150; }
    .box td.name, .box th.name { text-align:left; font-family:"IBM Plex Sans"; font-weight:600; font-size:11.5px; }
    .box td.pos, .box th.pos { color:#8a94ab; font-weight:700; text-transform:uppercase; font-size:11px; }
    .indent .name { padding-left:16px; position:relative; }
    .indent .name::before{
      content:""; position:absolute; left:6px; top:50%; width:8px; height:0; border-top:1px solid var(--border); transform:translateY(-50%);
    }

    /* PBP table */
    .pbp-card{ max-width:1020px; margin:14px auto; background:#fff; border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .pbp-card header{ padding:10px 12px; border-bottom:1px solid var(--border); font-weight:700; color:#32425c; background:linear-gradient(180deg,#fff,#f6f9ff); }
    .pbp-wrap{ overflow:auto; }
    .pbp{ border-collapse:collapse; width:100%; font-family:"IBM Plex Sans",system-ui,-apple-system,"Segoe UI",Roboto,Arial; font-size:12px; }
    .pbp th, .pbp td{ border-bottom:1px solid var(--border); padding:8px 10px; text-align:left; vertical-align:top; }
    .pbp th{ font-weight:700; color:#5b6577; white-space:nowrap; }
    .pbp td.inn{ white-space:nowrap; width:88px; }
    .pbp td.desc{ color:#111318; }
    .pbp td.num{ font-family:"IBM Plex Mono",ui-monospace,Menlo,monospace; text-align:right; white-space:nowrap; }
    .pbp td.scale{ border-left:1px solid #eef2f7; }
    .pbp .legend{ font-size:11px; color:#5b6577; padding:8px 10px; }
  </style>
</head>
<body>

  <header class="page">
    <h1>Game Report</h1>
    <span class="when">{% if game and game.date %}{{ game.date }}{% endif %}</span>
  </header>

  <div class="wrap">
    {% if game %}
    <section class="game-header">
      <!-- Away: logo OUTSIDE (left), score INSIDE (right) -->
      <div class="team">
        <div class="stack">
          <img class="logo" src="https://www.mlbstatic.com/team-logos/{{ game.away.id }}.svg" alt="{{ game.away.name }} logo">
          <div class="score">{{ game.away.score }}</div>
        </div>
        <div class="record">{{ game.away.record }}</div>
        <div class="name">{{ game.away.name }}</div>
      </div>

      <!-- Center info -->
      <div class="center">
        <div class="date">{% if game.date %}{{ game.date }}{% endif %}</div>
        {% set state = game.status|lower %}
        <div class="chip {{ 'live' if 'Top' in game.status or 'Bot' in game.status or 'MID' in game.status or 'END' in game.status else ('final' if 'Final' in game.status else 'upcoming') }}">
          {{ game.status }}
        </div>
        <div class="venue">{{ game.venue }}</div>
      </div>

      <!-- Home: score INSIDE (left), logo OUTSIDE (right) -->
      <div class="team">
        <div class="stack">
          <div class="score">{{ game.home.score }}</div>
          <img class="logo" src="https://www.mlbstatic.com/team-logos/{{ game.home.id }}.svg" alt="{{ game.home.name }} logo">
        </div>
        <div class="record">{{ game.home.record }}</div>
        <div class="name">{{ game.home.name }}</div>
      </div>
    </section>
    {% else %}
      <div class="card"><div class="placeholder">Loading game header…</div></div>
    {% endif %}

    <!-- Inning-by-inning (R/H/E bold, constrained width, no LOB) -->
    <article class="card ibox" id="ibox" aria-busy="true">
      <header>Linescore</header>
      <div id="iboxWrap"><div class="placeholder">Loading inning-by-inning data…</div></div>
    </article>

    <!-- Boxscores: condensed side-by-side -->
    <section class="box-grid" id="boxGrid" aria-busy="true">
      <article class="box" id="batAway"><div class="teamhdr">Away — Batting</div><div class="placeholder">Loading…</div></article>
      <article class="box" id="batHome"><div class="teamhdr">Home — Batting</div><div class="placeholder">Loading…</div></article>
      <article class="box" id="pitAway"><div class="teamhdr">Away — Pitching</div><div class="placeholder">Loading…</div></article>
      <article class="box" id="pitHome"><div class="teamhdr">Home — Pitching</div><div class="placeholder">Loading…</div></article>
    </section>

    <!-- Play by Play (with colored EV/xBA) -->
    <article class="pbp-card" id="pbpCard" hidden>
      <header>Play by Play</header>
      <div class="pbp-wrap">
        <table class="pbp" id="pbpTable">
          <thead>
            <tr>
              <th>Inning</th>
              <th>Outcome / Description</th>
              <th title="Exit Velocity" style="text-align:right">EV (mph)</th>
              <th title="Launch Angle" style="text-align:right">LA (°)</th>
              <th title="Distance" style="text-align:right">Dist (ft)</th>
              <th title="Expected Batting Average" style="text-align:right">xBA</th>
              <th title="Expected Slugging" style="text-align:right">xSLG</th>
            </tr>
          </thead>
          <tbody id="pbpBody"></tbody>
        </table>
      </div>
      <div class="legend">
        Color scale (blue → red): EV midpoint 88 mph • xBA midpoint .242
      </div>
    </article>
  </div>

  <script>
    const gamePk = {{ game_pk|int if game_pk is not none else 'null' }};

    // ------- Helpers -------
    function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // Build linescore table HTML
    function renderLinescore(g){
      const ls = g.linescore; if (!ls) return '<div class="placeholder">No linescore available.</div>';
      const n = ls.n || 9;
      const head = Array.from({length:n}, (_,i)=>`<th>${i+1}</th>`).join('');
      const aCells = Array.from({length:n}, (_,i)=>`<td>${(ls.away[i] ?? '')}</td>`).join('');
      const hCells = Array.from({length:n}, (_,i)=>`<td>${(ls.home[i] ?? '')}</td>`).join('');
      const aT = ls.totals.away, hT = ls.totals.home;
      return `
        <div class="ibox">
          <table>
            <thead><tr><th class="name"></th>${head}<th class="rhe">R</th><th class="rhe">H</th><th class="rhe">E</th></tr></thead>
            <tbody>
              <tr><td class="name">${esc(g.teams.away.abbr||'AWY')}</td>${aCells}<td><strong>${aT.R ?? ''}</strong></td><td><strong>${aT.H ?? ''}</strong></td><td><strong>${aT.E ?? ''}</strong></td></tr>
              <tr><td class="name">${esc(g.teams.home.abbr||'HOM')}</td>${hCells}<td><strong>${hT.R ?? ''}</strong></td><td><strong>${hT.H ?? ''}</strong></td><td><strong>${hT.E ?? ''}</strong></td></tr>
            </tbody>
          </table>
        </div>`;
    }

    // Shorten names like "Mookie Betts" -> "M. Betts"
    function shortName(full){
      if(!full) return '';
      const parts = String(full).trim().split(/\s+/);
      if(parts.length===1) return parts[0];
      return `${parts[0][0].toUpperCase()}. ${parts.slice(-1)[0]}`;
    }

    function battersTable(teamAbbr, rows){
      if (!rows || !rows.length) return `<div class="placeholder">No batter stats yet.</div>`;
      const trs = rows.map(r => `
        <tr ${r.indent ? 'class="indent"' : ''}>
          <td class="pos">${esc(r.pos||'')}</td>
          <td class="name">${esc(shortName(r.name)||'')}</td>
          <td>${r.ab ?? ''}</td><td>${r.r ?? ''}</td><td>${r.h ?? ''}</td><td>${r.rbi ?? ''}</td><td>${r.bb ?? ''}</td><td>${r.k ?? ''}</td>
        </tr>`).join('');
      return `
        <div class="teamhdr">${esc(teamAbbr)} — Batting</div>
        <table>
          <thead><tr><th class="pos">POS</th><th class="name">Player</th><th>AB</th><th>R</th><th>H</th><th>RBI</th><th>BB</th><th>K</th></tr></thead>
          <tbody>${trs}</tbody>
        </table>`;
    }

    function pitchersTable(teamAbbr, rows){
      if (!rows || !rows.length) return `<div class="placeholder">No pitching stats yet.</div>`;
      const trs = rows.map(r => `
        <tr ${r.indent ? 'class="indent"' : ''}>
          <td class="pos">${esc(r.pos||'P')}</td>
          <td class="name">${esc(shortName(r.name)||'')}</td>
          <td>${r.ip ?? ''}</td><td>${r.h ?? ''}</td><td>${r.r ?? ''}</td><td>${r.er ?? ''}</td><td>${r.bb ?? ''}</td><td>${r.k ?? ''}</td><td>${r.hr ?? ''}</td><td>${r.p ?? ''}</td>
        </tr>`).join('');
      return `
        <div class="teamhdr">${esc(teamAbbr)} — Pitching</div>
        <table>
          <thead><tr><th class="pos">POS</th><th class="name">Pitcher</th><th>IP</th><th>H</th><th>R</th><th>ER</th><th>BB</th><th>K</th><th>HR</th><th>P</th></tr></thead>
          <tbody>${trs}</tbody>
        </table>`;
    }

    // ------- Fetch + Render -------
    async function fetchJson(url){
      const res = await fetch(url, { cache:'no-store' });
      const text = await res.text();
      if (!res.ok) throw new Error(`HTTP ${res.status} – ${text}`);
      try { return JSON.parse(text); } catch(e){ throw new Error("Invalid JSON: "+e.message+" — "+text); }
    }

    async function loadGame(){
      const $ibox = document.getElementById('ibox');
      const $iboxWrap = document.getElementById('iboxWrap');
      const $batAway = document.getElementById('batAway');
      const $batHome = document.getElementById('batHome');
      const $pitAway = document.getElementById('pitAway');
      const $pitHome = document.getElementById('pitHome');

      try{
        const data = await fetchJson(`/api/game/${gamePk}`);
        if (data.error) throw new Error(data.error);
        const g = data.game || {};

        // Linescore
        try{
          $iboxWrap.innerHTML = renderLinescore(g);
        }catch(e){
          $iboxWrap.innerHTML = '<div class="placeholder">Could not render inning-by-inning data.</div>';
        } finally { $ibox.setAttribute('aria-busy','false'); }

        // Batting (side-by-side)
        const aAbbr = (g.teams && g.teams.away && g.teams.away.abbr) || 'AWY';
        const hAbbr = (g.teams && g.teams.home && g.teams.home.abbr) || 'HOM';

        $batAway.innerHTML = battersTable(aAbbr, (g.batters && g.batters.away) || []);
        $batHome.innerHTML = battersTable(hAbbr, (g.batters && g.batters.home) || []);

        // Pitching
        $pitAway.innerHTML = pitchersTable(aAbbr, (g.pitchers && g.pitchers.away) || []);
        $pitHome.innerHTML = pitchersTable(hAbbr, (g.pitchers && g.pitchers.home) || []);

        document.getElementById('boxGrid').setAttribute('aria-busy','false');
      }catch(err){
        console.error(err);
        $iboxWrap.innerHTML = '<div class="placeholder">Could not load inning-by-inning data.<br><small>'+esc(err.message)+'</small></div>';
        $batAway.innerHTML = '<div class="teamhdr">Away — Batting</div><div class="placeholder">Could not load player box.</div>';
        $batHome.innerHTML = '<div class="teamhdr">Home — Batting</div><div class="placeholder">Could not load player box.</div>';
        $pitAway.innerHTML = '<div class="teamhdr">Away — Pitching</div><div class="placeholder">Could not load player box.</div>';
        $pitHome.innerHTML = '<div class="teamhdr">Home — Pitching</div><div class="placeholder">Could not load player box.</div>';
      }
    }

    // ------- PBP with color scales -------
    function sigmoid(x){ return 1/(1+Math.exp(-x)); }
    function midmap(x, m, k){ if (x==null || isNaN(x)) return null; return sigmoid((x - m) * k); }
    function hueInterp(t){
      t = Math.max(0, Math.min(1, t));
      const h = 220 * (1 - t), s = 85, l = 58;
      return `hsl(${h}, ${s}%, ${l}%)`;
    }
    function colorForEV(ev){ const t = midmap(Number(ev), 88, 0.18); return (t==null)? '' : hueInterp(t); }
    function colorForXBA(x){ const t = midmap(Number(x), 0.242, 14); return (t==null)? '' : hueInterp(t); }

    async function loadPBP(){
      const card = document.getElementById('pbpCard');
      const body = document.getElementById('pbpBody');
      try{
        const data = await fetchJson(`/api/game/${gamePk}/pbp`);
        const rows = (data && Array.isArray(data.pbp)) ? data.pbp : [];
        if (!rows.length){
          card.hidden = false;
          body.innerHTML = '<tr><td colspan="7" class="desc">No play-by-play available.</td></tr>';
          return;
        }
        const html = rows.map(r => {
          const ev = (r.ev!=null) ? Number(r.ev).toFixed(1) : '';
          const la = (r.la!=null) ? Number(r.la).toFixed(1) : '';
          const dist = (r.dist!=null) ? String(r.dist) : '';
          const xba = (r.xba!=null) ? (Number(r.xba)>=1? (Number(r.xba)/100).toFixed(3) : Number(r.xba).toFixed(3)) : '';
          const xslg = (r.xslg!=null) ? (Number(r.xslg)>=2? (Number(r.xslg)/100).toFixed(3) : Number(r.xslg).toFixed(3)) : '';
          const evBg = colorForEV(r.ev);
          const xbaBg = colorForXBA(r.xba);
          return `<tr>
            <td class="inn">${esc(r.inningLabel||'')}</td>
            <td class="desc">${esc(r.description||'')}</td>
            <td class="num scale" style="${evBg ? 'background:'+evBg+';color:#fff;' : ''}">${ev}</td>
            <td class="num">${la}</td>
            <td class="num">${dist}</td>
            <td class="num scale" style="${xbaBg ? 'background:'+xbaBg+';color:#fff;' : ''}">${xba}</td>
            <td class="num">${xslg}</td>
          </tr>`;
        }).join('');
        body.innerHTML = html;
        card.hidden = false;
      }catch(err){
        console.error(err);
        body.innerHTML = `<tr><td colspan="7" class="desc">Could not load play-by-play.</td></tr>`;
        card.hidden = false;
      }
    }

    (async function(){
      if (!gamePk) return;
      await loadGame();
      await loadPBP();
    })();
  </script>
</body>
</html>
