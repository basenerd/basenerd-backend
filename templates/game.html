<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Game Detail</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#ffffff;
      --fg:#0b0e13;
      --muted:#6b7280;
      --card:#f7f7f8;
      --border:#e5e7eb;
      --chip:#111827;
      --chipfg:#ffffff;
      --table-h:#f3f4f6;
      --accent:#0ea5e9;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}

    /* Header */
    .game-header{
      display:grid;grid-template-columns:1fr auto 1fr;gap:16px;align-items:center;margin-bottom:20px
    }
    .team{
      display:flex;flex-direction:column;align-items:center;gap:6px
    }
    .team .name{font-weight:700;font-size:18px;text-align:center}
    .team .record{color:var(--muted);font-size:13px}
    .at{font-size:14px;color:var(--muted);text-align:center}
    .status-chip{
      display:inline-flex;align-items:center;justify-content:center;
      padding:6px 10px;border-radius:999px;background:var(--chip);color:var(--chipfg);
      font-weight:700;font-size:12px;letter-spacing:.4px;text-transform:uppercase
    }

    /* Logo + score overlay */
    .logo-wrap{ position:relative; width:110px; height:110px; display:grid; place-items:center; }
    .logo{ width:100%; height:100%; object-fit:contain; filter: drop-shadow(0 2px 6px rgba(0,0,0,.06)); }
    .score-badge{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      min-width:72px; min-height:72px; padding:6px 12px; border-radius:999px;
      background:rgba(255,255,255,.9); border:1px solid var(--border);
      font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace;
      font-weight:800; font-size:clamp(44px, 7vw, 70px); line-height:1; color:#0b0e13; text-align:center;
    }

    .meta{
      margin-top:4px; display:flex; flex-direction:column; align-items:center; gap:6px;
    }
    .venue{font-size:13px;color:var(--muted)}
    .statcast{font-size:13px;color:var(--fg); background:var(--card); padding:8px 10px; border-radius:10px; border:1px solid var(--border);}

    /* Two-column content */
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:18px}
    @media (max-width:1000px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .card h3{margin:0 0 10px;font-size:15px;letter-spacing:.2px}

    /* Linescore */
    .linescore{overflow:auto}
    table{border-collapse:collapse;width:100%}
    th,td{padding:6px 8px;border-bottom:1px solid var(--border);text-align:center;font-size:13px}
    thead th{background:var(--table-h);font-weight:700}

    /* PBP Collapsibles */
    details{border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:#fff;margin-bottom:8px}
    summary{cursor:pointer;font-weight:700}
    .pbp-row{display:grid;grid-template-columns:70px 1fr;gap:10px;padding:6px 0;border-bottom:1px dashed var(--border)}
    .pbp-row:last-child{border-bottom:0}
    .pbp-meta{color:var(--muted);font-size:12px}
    .pbp-stats{color:var(--muted);font-size:12px}

    /* Small chips */
    .badge{display:inline-block;background:var(--chip);color:var(--chipfg);padding:2px 6px;border-radius:6px;font-size:11px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    {% if game %}
    <div class="game-header">
      <!-- Away -->
      <div class="team" id="awayTeam">
        <div class="logo-wrap">
          <img class="logo" src="{{ game.away.logo }}" alt="{{ game.away.name }} logo">
          <span class="score-badge" id="awayScore">{{ game.away.score }}</span>
        </div>
        <div class="name">{{ game.away.name }}</div>
        <div class="record">{{ game.away.record }}</div>
      </div>

      <!-- Center meta -->
      <div class="meta">
        <div class="status-chip" id="statusChip">{{ game.status }}</div>
        <div class="venue">{{ game.venue }} • {{ game.date }}</div>
        <div class="statcast" id="latestStatcast">Loading latest play…</div>
      </div>

      <!-- Home -->
      <div class="team" id="homeTeam">
        <div class="logo-wrap">
          <img class="logo" src="{{ game.home.logo }}" alt="{{ game.home.name }} logo">
          <span class="score-badge" id="homeScore">{{ game.home.score }}</span>
        </div>
        <div class="name">{{ game.home.name }}</div>
        <div class="record">{{ game.home.record }}</div>
      </div>
    </div>
    {% else %}
    <p>Could not load game header.</p>
    {% endif %}

    <div class="grid">
      <!-- Left: Linescore + PBP -->
      <div class="card">
        <h3>Linescore</h3>
        <div class="linescore">
          <table id="linescoreTbl"></table>
        </div>

        <h3 style="margin-top:16px;">Play by Play</h3>
        <div id="pbpContainer">Loading…</div>
      </div>

      <!-- Right: Decisions + Scoring Summary -->
      <div class="card">
        <h3>Decisions</h3>
        <div id="decisionsText" class="pbp-meta">Loading…</div>

        <h3 style="margin-top:16px;">Scoring Summary</h3>
        <div id="scoringContainer">Loading…</div>
      </div>
    </div>
  </div>

<script>
(async function(){
  const gamePk = {{ game_pk }};
  const res = await fetch(`/api/game/${gamePk}`);
  const data = await res.json();

  if (!data || data.error){
    document.getElementById('latestStatcast').textContent = 'No data available';
    return;
  }

  const game = data.game || {};
  const plays = data.plays || [];
  const meta = data.meta || {};

  // Header updates
  if (game && game.statcast){
    document.getElementById('latestStatcast').textContent = game.statcast;
  } else {
    document.getElementById('latestStatcast').textContent = '—';
  }
  if (game && game.teams){
    const a = game.teams.away || {};
    const h = game.teams.home || {};
    const awayScore = (a.score ?? "-");
    const homeScore = (h.score ?? "-");
    const awayEl = document.getElementById('awayScore');
    const homeEl = document.getElementById('homeScore');
    if (awayEl) awayEl.textContent = awayScore;
    if (homeEl) homeEl.textContent = homeScore;
  }
  if (game && game.chip){
    const chip = document.getElementById('statusChip');
    if (chip) chip.textContent = game.chip;
  }

  // Decisions text
  document.getElementById('decisionsText').textContent = meta.decisionsText || '—';

  // Scoring summary
  const scoring = game.scoring || [];
  const scoreBox = document.getElementById('scoringContainer');
  if (!scoring.length){
    scoreBox.textContent = '—';
  } else {
    scoreBox.innerHTML = scoring.map(s => `
      <div class="pbp-row">
        <div class="pbp-meta">${s.inning || ''}</div>
        <div>
          <div>${s.play || ''}</div>
          <div class="pbp-stats">Score: ${s.away ?? ''}–${s.home ?? ''}</div>
        </div>
      </div>
    `).join('');
  }

  // Linescore table
  const ls = (game.linescore || {});
  const tbl = document.getElementById('linescoreTbl');
  if (!ls || !ls.n){
    tbl.innerHTML = '<tr><td>—</td></tr>';
  } else {
    const n = ls.n;
    let thead = '<thead><tr><th></th>';
    for (let i=1;i<=n;i++) thead += `<th>${i}</th>`;
    thead += '<th>R</th><th>H</th><th>E</th></tr></thead>';

    function row(label, arr, totals){
      let tds = `<td class="badge">${label}</td>`;
      for (let i=0;i<n;i++) tds += `<td>${arr[i] ?? ''}</td>`;
      tds += `<td><b>${(totals||{}).R ?? ''}</b></td><td>${(totals||{}).H ?? ''}</td><td>${(totals||{}).E ?? ''}</td>`;
      return `<tr>${tds}</tr>`;
    }

    const away = ls.away || [];
    const home = ls.home || [];
    const totalsA = (ls.totals||{}).away || {};
    const totalsH = (ls.totals||{}).home || {};

    tbl.innerHTML = thead + `<tbody>${row('AWY', away, totalsA)}${row('HME', home, totalsH)}</tbody>`;
  }

  // Group plays by inning with collapsibles; show xBA/xSLG (from Savant) + EV/LA/Dist
  const byInning = new Map();
  for (const p of plays){
    const k = p.inningNum || 0;
    if (!byInning.has(k)) byInning.set(k, []);
    byInning.get(k).push(p);
  }

  const pbp = document.getElementById('pbpContainer');
  if (!plays.length){
    pbp.textContent = '—';
    return;
  }

  const innKeys = Array.from(byInning.keys()).sort((a,b)=>a-b);
  pbp.innerHTML = innKeys.map(k => {
    const rows = byInning.get(k) || [];
    const renderRow = (r) => {
      const rightBits = [];
      if (r.ev) rightBits.push(`EV ${r.ev} mph`);
      if (r.la) rightBits.push(`LA ${r.la}°`);
      if (r.dist) rightBits.push(`${r.dist} ft`);
      if (r.xba) rightBits.push(`xBA ${r.xba}`);
      if (r.xslg) rightBits.push(`xSLG ${r.xslg}`);

      return `
        <div class="pbp-row">
          <div class="pbp-meta">${r.inning || ''}</div>
          <div>
            <div>${r.desc || ''}</div>
            <div class="pbp-stats">${rightBits.join(' • ')}</div>
          </div>
        </div>
      `;
    };

    // Don’t auto-open the first inning
    return `
      <details>
        <summary>${k === 1 ? '1st Inning' : (k === 2 ? '2nd Inning' : (k === 3 ? '3rd Inning' : k + 'th Inning'))}</summary>
        <div>${rows.map(renderRow).join('')}</div>
      </details>
    `;
  }).join('');
})();
</script>
</body>
</html>
