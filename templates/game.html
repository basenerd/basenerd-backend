<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ game.away.name }} @ {{ game.home.name }} â€” Game Report</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+...amily=IBM+Plex+Mono:wght@500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#ffffff; --card:#ffffff; --muted:#5b6577; --text:#111318; --accent:#0b5cab;
      --row:#fafbfc; --rowAlt:#f4f6f9; --border:#e2e8f0; --subtle:#8a94ab;
      --chip-live:#e21d48; --chip-final:#32425c; --chip-upcoming:#6b7a94;
      --badge:#eef0f4; --badge-text:#394150;
      --ball:#16a34a;   /* green */
      --strike:#dc2626; /* red */
      --inplay:#2563eb; /* blue */
    }
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--text); font-family:"IBM Plex Sans",-apple-system,Segoe UI,Roboto,Arial; }
    .wrap{ max-width:1150px; margin:20px auto; padding:0 14px; }

    /* Header */
    .header{ display:grid; grid-template-columns:auto auto 1fr auto auto; align-items:center; gap:16px; margin-bottom:14px; }
    .logo{ width:84px; height:84px; object-fit:contain; }
    .big-score{ font-family:"IBM Plex Mono",ui-monospace,Menlo,monospace; font-weight:700; font-size:46px; line-height:1; min-width:46px; text-align:center; }
    .center-info{ display:flex; flex-direction:column; align-items:center; gap:6px; }
    .chip{ display:inline-flex; align-items:center; justify-content:center; height:24px; padding:0 8px; border-radius:12px; color:#fff; letter-spacing:.04em; text-transform:uppercase; font-size:12px; background:var(--chip-final); }
    .chip.live{ background:var(--chip-live); } .chip.upcoming{ background:var(--chip-upcoming); }
    .status{ font-size:13px; font-weight:700; color:#0b0e13; }
    .venue{ font-size:12px; color:#6b7280; }

    /* Team names/records (centered) */
    .team-under{ display:grid; grid-template-columns:1fr 1fr; align-items:center; text-align:center; gap:6px; margin-bottom:16px; }
    .team-under .name{ font-size:18px; font-weight:700; }
    .team-under .rec{ font-size:12px; color:#6b7280; }

    /* Sections grid */
    .grid{ display:grid; grid-template-columns:1.15fr .85fr; gap:16px; }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr } }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .card .hd{ padding:10px 12px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
    .card .hd h3{ margin:0; font-size:14px; letter-spacing:.02em; text-transform:uppercase; color:#374151; }
    .card .bd{ padding:10px 12px; }

    /* Linescore */
    .ls-table{ width:100%; border-collapse:collapse; font-size:13px; }
    .ls-table th, .ls-table td{ padding:6px 6px; border-bottom:1px solid var(--border); text-align:center; }
    .ls-table thead th{ color:#6b7280; font-weight:600; }
    .ls-team{ display:flex; align-items:center; gap:6px; justify-content:flex-start; font-weight:700; }
    .ls-team .abbr{ font-family:"IBM Plex Mono",ui-monospace,Menlo,monospace; font-weight:700; }

    /* Box tables */
    .mini-title{ font-size:12px; color:#6b7280; text-transform:uppercase; letter-spacing:.04em; margin:0 0 8px; }
    .mini-wrap{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width: 980px){ .mini-wrap{ grid-template-columns:1fr } }
    .mini-table{ width:100%; border-collapse:collapse; font-size:13px; }
    .mini-table th, .mini-table td{ padding:6px 6px; border-bottom:1px solid var(--border); text-align:center; }
    .mini-table thead th{ color:#6b7280; font-weight:600; }
    .mini-table .pos, .mini-table .name{ text-align:left; }
    .when{ color:#6b7280; font-style:italic; text-align:center; }

    /* PBP */
    .pbp-table{ width:100%; border-collapse:collapse; font-size:13px; }
    .pbp-table th, .pbp-table td{ padding:8px 8px; border-bottom:1px solid var(--border); }
    .pbp-table thead th{ color:#6b7280; font-weight:600; text-transform:uppercase; letter-spacing:.04em; font-size:12px; }
    .pbp-row{ background: #fff; }
    .pbp-row.alt{ background:#fafafa; }
    .pbp-play{ display:flex; align-items:center; gap:8px; }
    .badge{ display:inline-flex; align-items:center; justify-content:center; padding:0 6px; height:20px; font-size:11px; border-radius:10px; background:var(--badge); color:var(--badge-text); }

    .toggle{ cursor:pointer; color:var(--accent); font-weight:600; }
    .plots{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:8px; }
    .plot-box{ border:1px solid var(--border); border-radius:8px; padding:8px; }

    /* Pitch labels on dots (if you turn them on later) */
    svg text.pitch-label { font-size: 10px; font-weight: 700; text-anchor: middle; dominant-baseline: central;
      fill: #ffffff; paint-order: stroke; stroke: #111318; stroke-width: 1px; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="header">
      <img class="logo" src="https://midfield.mlbstatic.com/v1/team/{{ game.teams.away.id }}/logo" alt="{{ game.away.abbr }}">
      <div class="big-score">{{ game.teams.away.score if game.teams.away.score is not none else '-' }}</div>
      <div class="center-info">
        <div class="chip {{ 'live' if game.status=='in_progress' else ('upcoming' if game.status=='scheduled' else '') }}">
          {{ 'LIVE' if game.status=='in_progress' else ('Scheduled' if game.status=='scheduled' else 'Final') }}
        </div>
        <div class="status">{{ game.chip or game.date }}</div>
        <div class="venue">{{ game.venue }}</div>
      </div>
      <div class="big-score">{{ game.teams.home.score if game.teams.home.score is not none else '-' }}</div>
      <img class="logo" src="https://midfield.mlbstatic.com/v1/team/{{ game.teams.home.id }}/logo" alt="{{ game.home.abbr }}">
    </div>

    <div class="team-under">
      <div>
        <div class="name">{{ game.teams.away.name }}</div>
        <div class="rec">{{ game.away.record }}</div>
      </div>
      <div>
        <div class="name">{{ game.teams.home.name }}</div>
        <div class="rec">{{ game.home.record }}</div>
      </div>
    </div>

    <div class="grid">
      <!-- Left: Linescore + PBP -->
      <div class="card">
        <div class="hd"><h3>Linescore</h3></div>
        <div class="bd" id="linescore">
          <!-- filled by JS -->
        </div>
        <div class="hd"><h3>Play by Play</h3></div>
        <div class="bd">
          <table class="pbp-table" id="pbp">
            <thead>
              <tr>
                <th>Inning</th>
                <th>Count</th>
                <th>Play</th>
                <th class="right">Score</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody id="pbpBody">
              <!-- rows -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Right: Box -->
      <div class="card">
        <div class="hd"><h3>Box Score</h3></div>
        <div class="bd">
          <div class="mini-title">{{ game.teams.away.abbr }} Batting</div>
          <table class="mini-table" id="batAway">
            <thead><tr><th class="pos">Pos</th><th class="name">Player</th><th>AB</th><th>R</th><th>H</th><th>RBI</th><th>BB</th><th>K</th></tr></thead>
            <tbody></tbody>
          </table>
          <div style="height:10px"></div>
          <div class="mini-title">{{ game.teams.home.abbr }} Batting</div>
          <table class="mini-table" id="batHome">
            <thead><tr><th class="pos">Pos</th><th class="name">Player</th><th>AB</th><th>R</th><th>H</th><th>RBI</th><th>BB</th><th>K</th></tr></thead>
            <tbody></tbody>
          </table>
          <div style="height:12px"></div>
          <div class="mini-title">{{ game.teams.away.abbr }} Pitching</div>
          <table class="mini-table" id="pitAway">
            <thead><tr><th> </th><th class="name">Pitcher</th><th>IP</th><th>H</th><th>R</th><th>ER</th><th>BB</th><th>K</th><th>HR</th><th>P</th></tr></thead>
            <tbody></tbody>
          </table>
          <div style="height:10px"></div>
          <div class="mini-title">{{ game.teams.home.abbr }} Pitching</div>
          <table class="mini-table" id="pitHome">
            <thead><tr><th> </th><th class="name">Pitcher</th><th>IP</th><th>H</th><th>R</th><th>ER</th><th>BB</th><th>K</th><th>HR</th><th>P</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div style="height:24px"></div>
  </div>

  <script>
    const $ = id => document.getElementById(id);

    const gamePk = {{ game_pk|int }};
    let playsGlobal = [];

    async function loadGame(){
      const res = await fetch(`/api/game/${gamePk}`);
      const data = await res.json();

      // Linescore
      renderLinescore(data.game.linescore || {}, data.game.teams);

      // Box
      fillBattingTable($('batAway').querySelector('tbody'), data.game.batters?.away || []);
      fillBattingTable($('batHome').querySelector('tbody'), data.game.batters?.home || []);
      fillPitchingTable($('pitAway').querySelector('tbody'), data.game.pitchers?.away || []);
      fillPitchingTable($('pitHome').querySelector('tbody'), data.game.pitchers?.home || []);

      // PBP
      playsGlobal = data.plays || [];
      renderPBP(playsGlobal);
    }

    function renderLinescore(ls, teams){
      if(!ls || !ls.n){
        $('linescore').innerHTML = `<div class="when">No linescore yet.</div>`;
        return;
      }
      const cols = Array.from({length:ls.n}, (_,i)=> `<th>${i+1}</th>`).join('');
      const away = (ls.away||[]).map(v=>`<td>${v ?? ''}</td>`).join('');
      const home = (ls.home||[]).map(v=>`<td>${v ?? ''}</td>`).join('');
      const totA = ls.totals?.away || {}, totH = ls.totals?.home || {};
      $('linescore').innerHTML = `
        <table class="ls-table">
          <thead>
            <tr><th class="ls-team">Team</th>${cols}<th>R</th><th>H</th><th>E</th></tr>
          </thead>
          <tbody>
            <tr><td class="ls-team"><span class="abbr">${teams.away.abbr}</span></td>${away}<td>${totA.R ?? ''}</td><td>${totA.H ?? ''}</td><td>${totA.E ?? ''}</td></tr>
            <tr><td class="ls-team"><span class="abbr">${teams.home.abbr}</span></td>${home}<td>${totH.R ?? ''}</td><td>${totH.H ?? ''}</td><td>${totH.E ?? ''}</td></tr>
          </tbody>
        </table>
      `;
    }

    function fillBattingTable(el, rows){
      el.innerHTML = rows.map(r=>`
        <tr>
          <td class="pos">${r.pos||''}</td>
          <td class="name">${r.name||''}</td>
          <td>${r.ab ?? ''}</td><td>${r.r ?? ''}</td><td>${r.h ?? ''}</td><td>${r.rbi ?? ''}</td><td>${r.bb ?? ''}</td><td>${r.k ?? ''}</td>
        </tr>
      `).join('') || `<tr><td colspan="8" class="when">No batting stats</td></tr>`;
    }
    function fillPitchingTable(el, rows){
      el.innerHTML = rows.map((r,i)=>`
        <tr>
          <td>${i+1}</td>
          <td class="name">${r.name||''}</td>
          <td>${r.ip ?? ''}</td><td>${r.h ?? ''}</td><td>${r.r ?? ''}</td><td>${r.er ?? ''}</td><td>${r.bb ?? ''}</td><td>${r.k ?? ''}</td><td>${r.hr ?? ''}</td><td>${r.p ?? ''}</td>
        </tr>
      `).join('') || `<tr><td colspan="10" class="when">No pitching stats</td></tr>`;
    }

    function renderPBP(plays){
      const tbody = $('pbpBody');
      if(!plays.length){
        tbody.innerHTML = `<tr><td colspan="5" class="when">No play-by-play yet.</td></tr>`;
        return;
      }
      tbody.innerHTML = plays.map((p, idx)=>`
        <tr class="pbp-row ${idx%2 ? 'alt' : ''}">
          <td><span class="badge">${p.inning||''}</span></td>
          <td>${p.balls ?? 0}-${p.strikes ?? 0}, ${p.outs ?? 0} out</td>
          <td class="pbp-play">${p.desc || ''}</td>
          <td class="right">${p.away ?? ''}â€“${p.home ?? ''}</td>
          <td><span class="toggle" data-idx="${idx}">details â–¾</span></td>
        </tr>
        <tr id="drow-${idx}" style="display:none;">
          <td colspan="5">
            <div class="plots">
              <div class="plot-box"><div class="mini-title">Strike Zone</div><div id="sz-${idx}"></div></div>
              <div class="plot-box"><div class="mini-title">Contact Location</div><div id="fld-${idx}"></div></div>
            </div>
            <div style="height:8px"></div>
            <div class="plot-box">
              <div class="mini-title">Pitch-by-pitch</div>
              <table class="mini-table">
                <thead><tr><th>#</th><th>Type</th><th>Velo</th><th>Result</th></tr></thead>
                <tbody id="ptb-${idx}"></tbody>
              </table>
            </div>
          </td>
        </tr>
      `).join('');

      // toggles + first render on open
      tbody.querySelectorAll('.toggle').forEach(t => {
        t.addEventListener('click', e=>{
          const idx = Number(t.dataset.idx);
          const row = $('drow-'+idx);
          const open = row.style.display !== 'none';
          row.style.display = open ? 'none' : '';
          if (!open) renderDetails(idx);
        });
      });
    }

    // ---------- Charts ----------
    function drawStrikeZone(el, pitches) {
  const w = 220, h = 240, pad = 10;

  // Avg top/bottom from pitch data (fallback 3.5/1.5 ft)
  let tops = [], bots = [];
  (pitches || []).forEach(p => {
    if (p.sz_top != null) tops.push(+p.sz_top);
    if (p.sz_bot != null) bots.push(+p.sz_bot);
  });
  const zTop = tops.length ? tops.reduce((a,b)=>a+b)/tops.length : 3.5;
  const zBot = bots.length ? bots.reduce((a,b)=>a+b)/bots.length : 1.5;
  const halfWidth = 0.83;
  const zoneWft = halfWidth * 2;
  const zoneHft = Math.max(1, zTop - zBot);

  // Margin so out-of-zone pitches are visible
  const marginXft = 1.5, marginYft = 1.5;

  const usableW = w - 2*pad, usableH = h - 2*pad;
  const scale = Math.min(
    usableW / (zoneWft + 2*marginXft),
    usableH / (zoneHft + 2*marginYft)
  );

  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  svg.setAttribute("width", w);
  svg.setAttribute("height", h);
  const g = document.createElementNS(svg.namespaceURI, "g");
  svg.appendChild(g);

  const cx = w/2;
  const zMid = (zTop + zBot) / 2;
  const cy = h/2 + (marginYft * scale * 0.1);

  const xMap = x => cx + x * scale;
  const yMap = z => cy - (z - zMid) * scale;

  // Strike zone rect
  const zx = xMap(-halfWidth), zw = zoneWft * scale;
  const zy = yMap(zTop),       zh = zoneHft * scale;

  const rect = document.createElementNS(svg.namespaceURI, "rect");
  rect.setAttribute("x", zx); rect.setAttribute("y", zy);
  rect.setAttribute("width", zw); rect.setAttribute("height", zh);
  rect.setAttribute("fill", "rgba(148,163,184,0.08)");
  rect.setAttribute("stroke", "#94a3b8");
  rect.setAttribute("stroke-width", "2");
  g.appendChild(rect);

  // 3Ã—3 grid
  for (let i = 1; i <= 2; i++) {
    const v = document.createElementNS(svg.namespaceURI, "line");
    v.setAttribute("x1", zx + (zw/3)*i); v.setAttribute("y1", zy);
    v.setAttribute("x2", zx + (zw/3)*i); v.setAttribute("y2", zy + zh);
    v.setAttribute("stroke", "#cbd5e1"); g.appendChild(v);

    const hline = document.createElementNS(svg.namespaceURI, "line");
    hline.setAttribute("x1", zx); hline.setAttribute("y1", zy + (zh/3)*i);
    hline.setAttribute("x2", zx + zw); hline.setAttribute("y2", zy + (zh/3)*i);
    hline.setAttribute("stroke", "#cbd5e1"); g.appendChild(hline);
  }

  // Outer border
  const border = document.createElementNS(svg.namespaceURI, "rect");
  border.setAttribute("x", 0.5); border.setAttribute("y", 0.5);
  border.setAttribute("width", w-1); border.setAttribute("height", h-1);
  border.setAttribute("fill", "none"); border.setAttribute("stroke", "#e5e7eb");
  g.appendChild(border);

  // Pitches
  (pitches || []).forEach((p, i) => {
    if (p.px == null || p.pz == null) return;
    const code = (p.code || "").toUpperCase();
    let color = "var(--strike)";
    if (p.inPlay) color = "var(--inplay)";
    else if (code === "B") color = "var(--ball)";
    const cxp = xMap(+p.px);
    const cyp = yMap(+p.pz);
    const circ = document.createElementNS(svg.namespaceURI, "circle");
    circ.setAttribute("cx", cxp); circ.setAttribute("cy", cyp);
    circ.setAttribute("r", 6);    circ.setAttribute("fill", color);
    circ.setAttribute("stroke", "#111318"); circ.setAttribute("stroke-width", "0.6");
    g.appendChild(circ);
  });

  el.innerHTML = ""; el.appendChild(svg);
}
    function drawField(el, bip) {
  const w = 240, h = 240, pad = 10;

  // Feet â†’ pixels: uniform scale
  const fenceFt = 380, infieldFt = 95, baseFt = 90, moundFt = 60.5;
  const usableW = w - 2*pad, usableH = h - 2*pad;

  const s = Math.min(usableW / (2*fenceFt), usableH / (fenceFt + 20));
  const cx = w/2, cy = h - pad;  // home plate position (pixels)

  const sx = xf => cx + xf * s;
  const sy = yf => cy - yf * s;

  const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
  svg.setAttribute("width", w); svg.setAttribute("height", h);
  const g = document.createElementNS(svg.namespaceURI,"g");
  svg.appendChild(g);

  // Outfield fence arc (LF to RF)
  const xL = -fenceFt, yL = 0;
  const xR =  fenceFt, yR = 0;
  const fence = document.createElementNS(svg.namespaceURI,"path");
  fence.setAttribute("d", `M ${sx(xL)},${sy(yL)} A ${fenceFt*s},${fenceFt*s} 0 0 1 ${sx(xR)},${sy(yR)}`);
  fence.setAttribute("fill","none"); fence.setAttribute("stroke","#111"); fence.setAttribute("stroke-width","1.5");
  g.appendChild(fence);

  // Foul lines
  const fl = document.createElementNS(svg.namespaceURI,"line");
  fl.setAttribute("x1", sx(0)); fl.setAttribute("y1", sy(0));
  fl.setAttribute("x2", sx(xL)); fl.setAttribute("y2", sy(yL));
  fl.setAttribute("stroke","#111");
  const fr = document.createElementNS(svg.namespaceURI,"line");
  fr.setAttribute("x1", sx(0)); fr.setAttribute("y1", sy(0));
  fr.setAttribute("x2", sx(xR)); fr.setAttribute("y2", sy(yR));
  fr.setAttribute("stroke","#111");
  g.appendChild(fl); g.appendChild(fr);

  // Infield arc (95')
  const inArc = document.createElementNS(svg.namespaceURI,"path");
  inArc.setAttribute("d", `M ${sx(-infieldFt)},${sy(0)} A ${infieldFt*s},${infieldFt*s} 0 0 1 ${sx(infieldFt)},${sy(0)}`);
  inArc.setAttribute("fill","none"); inArc.setAttribute("stroke","#111"); inArc.setAttribute("stroke-width","1");
  g.appendChild(inArc);

  // Bases and diamond (90' apart)
  const H  = [  0,   0];
  const B1 = [ baseFt,  0];
  const B2 = [ baseFt,  baseFt];
  const B3 = [  0,  baseFt];

  const diamondPts = [B2, B1, H, B3].map(([x,y]) => `${sx(x)},${sy(y)}`).join(" ");
  const poly = document.createElementNS(svg.namespaceURI,"polygon");
  poly.setAttribute("points", diamondPts);
  poly.setAttribute("fill","none"); poly.setAttribute("stroke","#111");
  g.appendChild(poly);

  const home = document.createElementNS(svg.namespaceURI,"circle");
  home.setAttribute("cx", sx(H[0])); home.setAttribute("cy", sy(H[1]));
  home.setAttribute("r", 3); home.setAttribute("fill","#fff"); home.setAttribute("stroke","#111");
  g.appendChild(home);

  [[...B1], [...B2], [...B3]].forEach(([x,y]) => {
    const r = 3.5;
    const b = document.createElementNS(svg.namespaceURI,"rect");
    b.setAttribute("x", sx(x)-r); b.setAttribute("y", sy(y)-r);
    b.setAttribute("width", 2*r); b.setAttribute("height", 2*r);
    b.setAttribute("fill", "#fff"); b.setAttribute("stroke", "#111");
    g.appendChild(b);
  });

  // Mound at 60.5' along home->2B line (x=y=m/âˆš2)
  const m = moundFt / Math.sqrt(2);
  const mound = document.createElementNS(svg.namespaceURI,"circle");
  mound.setAttribute("cx", sx(m)); mound.setAttribute("cy", sy(m));
  mound.setAttribute("r", 3); mound.setAttribute("fill","#fff"); mound.setAttribute("stroke","#111");
  g.appendChild(mound);

  // Ball in play (assuming 0..250 coords -> map to feet)
  const bx = Number(bip?.x), by = Number(bip?.y);
  if (!Number.isNaN(bx) && !Number.isNaN(by)) {
    const xf = (bx/250) * (2*fenceFt) - fenceFt;
    const yf = (by/250) * fenceFt;
    const dot = document.createElementNS(svg.namespaceURI,"circle");
    dot.setAttribute("cx", sx(xf)); dot.setAttribute("cy", sy(yf));
    dot.setAttribute("r", 4.5); dot.setAttribute("fill","var(--inplay)");
    dot.setAttribute("stroke","#111"); dot.setAttribute("stroke-width","0.6");
    g.appendChild(dot);
  }

  // Border
  const border = document.createElementNS(svg.namespaceURI,"rect");
  border.setAttribute("x", 0.5); border.setAttribute("y", 0.5);
  border.setAttribute("width", w-1); border.setAttribute("height", h-1);
  border.setAttribute("fill", "none"); border.setAttribute("stroke","#e5e7eb");
  g.appendChild(border);

  el.innerHTML = ""; el.appendChild(svg);
}
    function fillPitchMiniTable(el, pitches){
      el.innerHTML = (pitches||[]).map((p,i)=>`
        <tr>
          <td>${i+1}</td>
          <td>${p.type || ''}</td>
          <td>${p.velo != null ? Math.round(p.velo) : 'â€”'}</td>
          <td>${p.result || ''}</td>
        </tr>
      `).join('') || `<tr><td colspan="4" class="when">No pitch data</td></tr>`;
    }

    function renderDetails(idx){
      const play = playsGlobal[idx] || {};
      // Charts
      drawStrikeZone($(`sz-${idx}`), play.pitches || []);
      drawField($(`fld-${idx}`), play.bip || {});

      // Mini pitch table
      fillPitchMiniTable($(`ptb-${idx}`), play.pitches || []);
    }

    window.addEventListener('DOMContentLoaded', loadGame);
  </script>
</body>
</html>
