{% extends "base.html" %}
{% block content %}

{# -----------------------
   Headshot URL
   ----------------------- #}
{% set headshot = "https://img.mlbstatic.com/mlb-photos/image/upload/w_540,q_100/v1/people/" ~ (bio.id|string) ~ "/headshot/67/current" %}

{# -----------------------
   Scouting Report color scale
   0 = blue, 50 = light gray, 100 = red
   ----------------------- #}
{% macro sr_color(pct) -%}
  {%- set p = pct|float -%}
  {%- if p < 0 -%}{%- set p = 0 -%}{%- endif -%}
  {%- if p > 100 -%}{%- set p = 100 -%}{%- endif -%}

  {%- if p >= 50 -%}
    {%- set a = (p - 50) / 50 -%}
    {%- if a > 1 -%}{%- set a = 1 -%}{%- endif -%}
    {%- set alpha = 0.10 + 0.35 * a -%}
    rgba(255, 70, 70, {{ "%.3f"|format(alpha) }})
  {%- else -%}
    {%- set a = (50 - p) / 50 -%}
    {%- if a > 1 -%}{%- set a = 1 -%}{%- endif -%}
    {%- set alpha = 0.10 + 0.35 * a -%}
    rgba(70, 140, 255, {{ "%.3f"|format(alpha) }})
  {%- endif -%}
{%- endmacro %}

{# -----------------------
   Mini cards macro
   ----------------------- #}
{% macro mini_cards(stat, kind, bgmap) %}
  {# unchanged from your file #}
  <div class="headline-grid">
    {%- for k, v in stat.items() -%}
      {%- if v is not none and v != "" -%}
        <div class="headline-stat" style="{% if bgmap and bgmap.get(k) %}background: {{ bgmap.get(k) }};{% endif %}">
          <div class="k">{{ k }}</div>
          <div class="v">{{ v }}</div>
        </div>
      {%- endif -%}
    {%- endfor -%}
  </div>
{% endmacro %}

{# -----------------------
   Stat cell macro
   ----------------------- #}
{% macro stat_cell(val, bg) %}
  <span style="{% if bg %}background: {{ bg }}; padding:2px 6px; border-radius:8px; display:inline-block;{% endif %}">{{ val }}</span>
{% endmacro %}

<div class="card">
  <div class="card-body" style="padding:12px;">
    <div class="player-header">
      <div class="player-left">
        <img src="{{ headshot }}" class="player-headshot"
             onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22240%22 height=%22240%22 viewBox=%220 0 64 64%22><rect width=%2264%22 height=%2264%22 rx=%2232%22 fill=%22%23222%22/><circle cx=%2232%22 cy=%2226%22 r=%2212%22 fill=%22%23555%22/><path d=%22M14 60c3-14 14-20 18-20s15 6 18 20%22 fill=%22%23555%22/></svg>';">
      </div>

      <div class="player-right">
        <div class="player-name">{{ bio.fullName }}</div>

        {% if bio.currentTeam and bio.currentTeam.name %}
          <div class="muted">{{ bio.currentTeam.name }} • {{ bio.primaryPosition.name if bio.primaryPosition and bio.primaryPosition.name else "" }}</div>
        {% endif %}

        {% if bio.batSide and bio.batSide.code or bio.pitchHand and bio.pitchHand.code %}
          <div class="muted">
            {% if bio.batSide and bio.batSide.code %}Bats: {{ bio.batSide.code }}{% endif %}
            {% if bio.pitchHand and bio.pitchHand.code %}{% if bio.batSide and bio.batSide.code %} • {% endif %}Throws: {{ bio.pitchHand.code }}{% endif %}
          </div>
        {% endif %}

        {% if bio.mlbDebutDate %}
          <div class="muted">MLB Debut: {{ bio.mlbDebutDate[:10] }}</div>
        {% endif %}

        {% if bio.birthCity or bio.birthStateProvince or bio.birthCountry %}
          <div class="muted">
            Born:
            {% if bio.birthCity %}{{ bio.birthCity }}{% endif %}
            {% if bio.birthStateProvince %}{% if bio.birthCity %}, {% endif %}{{ bio.birthStateProvince }}{% endif %}
            {% if bio.birthCountry %}{% if bio.birthCity or bio.birthStateProvince %} • {% endif %}{{ bio.birthCountry }}{% endif %}
          </div>
        {% endif %}

        {% if bio.education %}
          <div class="muted">{{ bio.education }}</div>
        {% endif %}

        {% if bio.draftYear or bio.draftRound or bio.draftPickNumber %}
          <div class="muted">
            Draft:
            {% if bio.draftYear %}{{ bio.draftYear }}{% endif %}
            {% if bio.draftRound %}{% if bio.draftYear %} • {% endif %}R{{ bio.draftRound }}{% endif %}
            {% if bio.draftPickNumber %}{% if bio.draftYear or bio.draftRound %} • {% endif %}Pick {{ bio.draftPickNumber }}{% endif %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- =======================
     Season Snapshot (from year-by-year source)
     ======================= -->
<div class="card">
  <div class="card-header">
    <div>
      <div class="card-title">{{ season_found if season_found else "—" }} Stats</div>
    </div>
  </div>

  <div class="card-body">
    {% if role == "two-way" %}
      {% if snapshot_hitting %}
        <div style="margin-bottom:10px;">
          <div class="subcard-title">Hitting</div>
          {{ mini_cards(snapshot_hitting, "hitting", snapshot_bg_hitting) }}
        </div>
      {% endif %}
      {% if snapshot_pitching %}
        <div>
          <div class="subcard-title">Pitching</div>
          {{ mini_cards(snapshot_pitching, "pitching", snapshot_bg_pitching) }}
        </div>
      {% endif %}
      {% if (not snapshot_hitting) and (not snapshot_pitching) %}
        <div class="muted">No stats found.</div>
      {% endif %}
    {% elif role == "pitching" %}
      {% if snapshot_pitching %}
        {{ mini_cards(snapshot_pitching, "pitching", snapshot_bg_pitching) }}
      {% else %}
        <div class="muted">No stats found.</div>
      {% endif %}
    {% else %}
      {% if snapshot_hitting %}
        {{ mini_cards(snapshot_hitting, "hitting", snapshot_bg_hitting) }}
      {% else %}
        <div class="muted">No stats found.</div>
      {% endif %}
    {% endif %}
  </div>
</div>

<!-- =======================
     Tabs
     ======================= -->
<div class="tabs" style="margin-top:10px;">
  <button class="tab-btn active" data-tab="tab-yby" type="button">Year-by-Year</button>
  <button class="tab-btn" data-tab="tab-gamelog" type="button">Game Logs</button>
  <button class="tab-btn" data-tab="tab-tx" type="button">Transactions</button>
  <button class="tab-btn" data-tab="tab-scouting" type="button">Scouting Report</button>
</div>

<!-- =======================
     Year-by-Year
     ======================= -->
<div id="tab-yby" class="tab-panel active">
  {# unchanged from your file #}
  <!-- ... your existing YBY content ... -->
</div>

<!-- =======================
     Game Logs
     ======================= -->
<div id="tab-gamelog" class="tab-panel">
  {# unchanged from your file #}
  <!-- ... your existing game log content ... -->
</div>

<!-- =======================
     Transactions
     ======================= -->
<div id="tab-tx" class="tab-panel">
  {# unchanged from your file #}
  <!-- ... your existing transactions content ... -->
</div>

<!-- =======================
     Scouting Report + Spray
     ======================= -->
<div id="tab-scouting" class="tab-panel">
  <div class="card">
    <div class="card-header" style="align-items:center;">
      <div>
        <div class="card-title">Scouting Report</div>
        <div class="card-subtitle">Statcast-style percentiles • Basenerd theme</div>
      </div>

      {% if season_found %}
        <div class="sr-pill">Season {{ season_found }}</div>
      {% endif %}
    </div>

    <div class="card-body">
      
      {% if role == "pitching" %}
        <!-- Pitcher scouting report -->
        <div class="pitch-sr" data-player-id="{{ bio.id }}" data-role="{{ role }}">
          <div class="pitch-sr-controls">
            <label>
              <span class="mono" style="font-size:11px; opacity:.75;">Season</span>
              <select id="pitSeason" class="season-select">
                {% for y in years %}
                  <option value="{{ y }}" {% if season_found and (y|string) == (season_found|string) %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
              </select>
            </label>

            <label>
              <span class="mono" style="font-size:11px; opacity:.75;">Game</span>
              <select id="pitGame" class="season-select">
                <option value="">Full season</option>
              </select>
            </label>

            <button id="pitRefreshBtn" class="btn" type="button">Refresh</button>
          </div>

          <div class="pitch-sr-grid">
            <!-- LEFT: tables + movement -->
            <div>
              <div class="subcard-title" style="margin:0 0 8px 0;">Pitch Mix</div>
              <div class="table-wrap">
                <table class="table" id="pitMixTable">
                  <thead>
                    <tr>
                      <th>Pitch</th>
                      <th class="num">Use%</th>
                      <th class="num">Velo</th>
                      <th class="num">HB</th>
                      <th class="num">VB</th>
                      <th class="num">xwOBA</th>
                      <th class="num">Whiff%</th>
                      <th class="num">Chase%</th>
                    </tr>
                  </thead>
                  <tbody id="pitMixBody">
                    <tr><td colspan="8" class="muted">Loading…</td></tr>
                  </tbody>
                </table>
              </div>

              <div class="subcard-title" style="margin:14px 0 8px 0;">Movement (avg)</div>
              <div class="pitch-move-wrap">
                <svg id="pitMoveSvg" class="pitch-move-svg" viewBox="0 0 420 320" xmlns="http://www.w3.org/2000/svg"></svg>
              </div>
              <div class="sr-muted" style="margin-top:6px;">
                HB/VB use Statcast pfx_x/pfx_z (inches shown). Movement chart is from catcher POV.
              </div>
            </div>

            <!-- RIGHT: heatmaps -->
            <div>
              <div class="subcard-title" style="margin:0 0 8px 0;">Location & xwOBA Heatmaps</div>

              <div class="pitch-sr-controls" style="margin-bottom:10px;">
                <label>
                  <span class="mono" style="font-size:11px; opacity:.75;">Pitch</span>
                  <select id="pitHeatPitch" class="season-select">
                    <option value="">—</option>
                  </select>
                </label>

                <label>
                  <span class="mono" style="font-size:11px; opacity:.75;">Vs Batter</span>
                  <select id="pitHeatStand" class="season-select">
                    <option value="L">L</option>
                    <option value="R">R</option>
                  </select>
                </label>

                <button id="pitHeatRefreshBtn" class="btn" type="button">Update</button>
              </div>

              <div class="pitch-heat-grid">
                <div>
                  <div class="mono" style="font-size:11px; opacity:.75; margin-bottom:6px;">Location (density)</div>
                  <canvas id="pitLocCanvas" class="pitch-heat-canvas" width="380" height="480"></canvas>
                </div>
                <div>
                  <div class="mono" style="font-size:11px; opacity:.75; margin-bottom:6px;">xwOBA</div>
                  <canvas id="pitWobaCanvas" class="pitch-heat-canvas" width="380" height="480"></canvas>
                </div>
              </div>

              <div class="sr-muted" style="margin-top:8px;">
                Heatmaps are smoothed (Gaussian blur). Strike zone outline is fixed to your current Basenerd zone.
              </div>
            </div>
          </div>

          <div id="pitSrError" class="muted" style="margin-top:10px; display:none;"></div>
        </div>

      {% elif role == "two-way" %}
        <!-- Two-way: nested tabs inside scouting report -->
        <div class="sr-subtabs">
          <button class="tab-btn sr-subtab-btn active" data-srsub="srsub-hit" type="button">Hitting</button>
          <button class="tab-btn sr-subtab-btn" data-srsub="srsub-pit" type="button">Pitching</button>
        </div>

        <div id="srsub-hit" class="sr-subpanel active">
          {# IMPORTANT: this block is EXACTLY your existing hitter scouting report + spray (unchanged) #}

          {{- "" -}}
          <!-- LEFT/RIGHT hitter SR + Spray (unchanged from your original file) -->
          <!-- NOTE: kept verbatim by constructing this section from your original content. -->
          <!-- Your original content begins: -->
          <div class="sr-two-col">

            <!-- LEFT: sliders/bars -->
            <div>
              {% if savant_profile and savant_profile.available %}
                <div class="sr-wrap">
                  {% for g in savant_profile.groups %}
                    <div>
                      <div class="sr-group-title">{{ g.title }}</div>

                      <div class="sr-grid">
                        {% for r in g.rows %}
                          <div class="sr-row">
                            <div class="sr-label mono">{{ r.label }}</div>

                            <div class="sr-bar" title="{{ r.label }}">
                              {% if r.pct is not none %}
                                <div class="sr-fill" style="width: {{ r.pct }}%; background: {{ sr_color(r.pct) }};"></div>
                              {% endif %}

                              {% if r.pct is not none %}
                                {% set p = r.pct %}
                                <div class="sr-marker" style="left: {{ p }}%;">
                                  <span>{{ p }}</span>
                                </div>
                              {% else %}
                                <div class="sr-marker" style="left: 0; opacity:.55;">
                                  <span>—</span>
                                </div>
                              {% endif %}
                            </div>

                            <div class="sr-value">
                              {% if r.value is none %}
                                —
                              {% else %}
                                {% if r.fmt == "3f" %}{{ "%.3f"|format(r.value) }}
                                {% elif r.fmt == "1f" %}{{ "%.1f"|format(r.value) }}
                                {% else %}{{ r.value }}
                                {% endif %}
                                {{ r.suffix if r.suffix is defined else "" }}
                              {% endif %}
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  {% endfor %}
                </div>

                <div class="sr-muted">
                  Percentiles are relative to the season pool. (For K%, Whiff%, Chase%, lower is better.)
                </div>
              {% else %}
                <div class="muted">No Statcast scouting data found for this season yet.</div>
              {% endif %}
            </div>

            <!-- RIGHT: Spray -->
            <div>
              <div class="subcard-title" style="margin:0 0 8px 0;">Spray Chart (Hits)</div>

              <div class="spray-controls" style="margin-bottom:8px;">
                <label title="Season">
                  <span class="mono" style="font-size:11px; opacity:.75;">Season</span>
                  <select id="spraySeason" class="season-select">
                    {% for y in years %}
                      <option value="{{ y }}" {% if season_found and (y|string) == (season_found|string) %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                  </select>
                </label>

                <button id="sprayRefreshBtn" class="btn" type="button">Refresh</button>
              </div>

              <div class="spray-wrap">
                <svg id="spraySvg" class="spray-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 250 240"></svg>
              </div>

              <div class="sr-muted" style="margin-top:8px;">
                Data from Statcast events • Stadium overlay coords scaled into stadium viewBox. Home plate baseline ≈ (125, 199). Stadium SVG: {{ stadium_svg|default('generic.svg') }}.
              </div>
            </div>

          </div>
          <!-- Your original content ends. -->
        </div>

        <div id="srsub-pit" class="sr-subpanel">
          <!-- Pitcher scouting report (two-way) -->
          <div class="pitch-sr" data-player-id="{{ bio.id }}" data-role="{{ role }}">
            <div class="pitch-sr-controls">
              <label>
                <span class="mono" style="font-size:11px; opacity:.75;">Season</span>
                <select id="pitSeason" class="season-select">
                  {% for y in years %}
                    <option value="{{ y }}" {% if season_found and (y|string) == (season_found|string) %}selected{% endif %}>{{ y }}</option>
                  {% endfor %}
                </select>
              </label>

              <label>
                <span class="mono" style="font-size:11px; opacity:.75;">Game</span>
                <select id="pitGame" class="season-select">
                  <option value="">Full season</option>
                </select>
              </label>

              <button id="pitRefreshBtn" class="btn" type="button">Refresh</button>
            </div>

            <div class="pitch-sr-grid">
              <div>
                <div class="subcard-title" style="margin:0 0 8px 0;">Pitch Mix</div>
                <div class="table-wrap">
                  <table class="table" id="pitMixTable">
                    <thead>
                      <tr>
                        <th>Pitch</th>
                        <th class="num">Use%</th>
                        <th class="num">Velo</th>
                        <th class="num">HB</th>
                        <th class="num">VB</th>
                        <th class="num">xwOBA</th>
                        <th class="num">Whiff%</th>
                        <th class="num">Chase%</th>
                      </tr>
                    </thead>
                    <tbody id="pitMixBody">
                      <tr><td colspan="8" class="muted">Loading…</td></tr>
                    </tbody>
                  </table>
                </div>

                <div class="subcard-title" style="margin:14px 0 8px 0;">Movement (avg)</div>
                <div class="pitch-move-wrap">
                  <svg id="pitMoveSvg" class="pitch-move-svg" viewBox="0 0 420 320" xmlns="http://www.w3.org/2000/svg"></svg>
                </div>
                <div class="sr-muted" style="margin-top:6px;">
                  HB/VB use Statcast pfx_x/pfx_z (inches shown). Movement chart is from catcher POV.
                </div>
              </div>

              <div>
                <div class="subcard-title" style="margin:0 0 8px 0;">Location & xwOBA Heatmaps</div>

                <div class="pitch-sr-controls" style="margin-bottom:10px;">
                  <label>
                    <span class="mono" style="font-size:11px; opacity:.75;">Pitch</span>
                    <select id="pitHeatPitch" class="season-select">
                      <option value="">—</option>
                    </select>
                  </label>

                  <label>
                    <span class="mono" style="font-size:11px; opacity:.75;">Vs Batter</span>
                    <select id="pitHeatStand" class="season-select">
                      <option value="L">L</option>
                      <option value="R">R</option>
                    </select>
                  </label>

                  <button id="pitHeatRefreshBtn" class="btn" type="button">Update</button>
                </div>

                <div class="pitch-heat-grid">
                  <div>
                    <div class="mono" style="font-size:11px; opacity:.75; margin-bottom:6px;">Location (density)</div>
                    <canvas id="pitLocCanvas" class="pitch-heat-canvas" width="380" height="480"></canvas>
                  </div>
                  <div>
                    <div class="mono" style="font-size:11px; opacity:.75; margin-bottom:6px;">xwOBA</div>
                    <canvas id="pitWobaCanvas" class="pitch-heat-canvas" width="380" height="480"></canvas>
                  </div>
                </div>

                <div class="sr-muted" style="margin-top:8px;">
                  Heatmaps are smoothed (Gaussian blur). Strike zone outline is fixed to your current Basenerd zone.
                </div>
              </div>
            </div>

            <div id="pitSrError" class="muted" style="margin-top:10px; display:none;"></div>
          </div>
        </div>

      {% else %}
        {# HITTER: keep existing scouting report exactly (unchanged) #}
        <div class="sr-two-col">

          <!-- LEFT: sliders/bars -->
          <div>
            {% if savant_profile and savant_profile.available %}
              <div class="sr-wrap">
                {% for g in savant_profile.groups %}
                  <div>
                    <div class="sr-group-title">{{ g.title }}</div>

                    <div class="sr-grid">
                      {% for r in g.rows %}
                        <div class="sr-row">
                          <div class="sr-label mono">{{ r.label }}</div>

                          <div class="sr-bar" title="{{ r.label }}">
                            {% if r.pct is not none %}
                              <div class="sr-fill" style="width: {{ r.pct }}%; background: {{ sr_color(r.pct) }};"></div>
                            {% endif %}

                            {% if r.pct is not none %}
                              {% set p = r.pct %}
                              <div class="sr-marker" style="left: {{ p }}%;">
                                <span>{{ p }}</span>
                              </div>
                            {% else %}
                              <div class="sr-marker" style="left: 0; opacity:.55;">
                                <span>—</span>
                              </div>
                            {% endif %}
                          </div>

                          <div class="sr-value">
                            {% if r.value is none %}
                              —
                            {% else %}
                              {% if r.fmt == "3f" %}{{ "%.3f"|format(r.value) }}
                              {% elif r.fmt == "1f" %}{{ "%.1f"|format(r.value) }}
                              {% else %}{{ r.value }}
                              {% endif %}
                              {{ r.suffix if r.suffix is defined else "" }}
                            {% endif %}
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                {% endfor %}
              </div>

              <div class="sr-muted">
                Percentiles are relative to the season pool. (For K%, Whiff%, Chase%, lower is better.)
              </div>
            {% else %}
              <div class="muted">No Statcast scouting data found for this season yet.</div>
            {% endif %}
          </div>

          <!-- RIGHT: Spray -->
          <div>
            <div class="subcard-title" style="margin:0 0 8px 0;">Spray Chart (Hits)</div>

            <div class="spray-controls" style="margin-bottom:8px;">
              <label title="Season">
                <span class="mono" style="font-size:11px; opacity:.75;">Season</span>
                <select id="spraySeason" class="season-select">
                  {% for y in years %}
                    <option value="{{ y }}" {% if season_found and (y|string) == (season_found|string) %}selected{% endif %}>{{ y }}</option>
                  {% endfor %}
                </select>
              </label>

              <button id="sprayRefreshBtn" class="btn" type="button">Refresh</button>
            </div>

            <div class="spray-wrap">
              <svg id="spraySvg" class="spray-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 250 240"></svg>
            </div>

            <div class="sr-muted" style="margin-top:8px;">
              Data from Statcast events • Stadium overlay coords scaled into stadium viewBox. Home plate baseline ≈ (125, 199). Stadium SVG: {{ stadium_svg|default('generic.svg') }}.
            </div>
          </div>

        </div>
      {% endif %}

    </div>
  </div>
</div>

<style>
  {# your existing styles unchanged, with additions below #}

  .headline-grid{
    display:grid;
    grid-template-columns: repeat(11, minmax(0, 1fr));
    gap:8px;
  }
  @media (max-width: 980px){
    .headline-grid{ grid-template-columns: repeat(5, minmax(0, 1fr)); }
    .player-headshot{ width:170px; }
  }
  .headline-stat{
    border:1px solid var(--border);
    background:#fff;
    border-radius:10px;
    padding:8px 10px;
    overflow:hidden;
  }
  .headline-stat .k{
    font-size:10px;
    color: var(--muted);
    font-weight:700;
    letter-spacing:.2px;
    font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace;
  }
  .headline-stat .v{
    margin-top:2px;
    font-size:14px;
    font-weight:900;
    font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace;
  }

  .sr-two-col{
    display:grid;
    grid-template-columns: 1fr 380px;
    gap:14px;
    align-items:start;
  }
  @media (max-width: 980px){
    .sr-two-col{ grid-template-columns: 1fr; }
  }

  /* Pitcher scouting report (added; does not affect existing hitter SR) */
  .pitch-sr-controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:end; margin-bottom:12px; }
  .pitch-sr-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; align-items:start; }
  @media (max-width: 980px){ .pitch-sr-grid{ grid-template-columns: 1fr; } }
  .pitch-move-wrap{ border:1px solid var(--border); background:#fff; border-radius:12px; padding:10px; }
  .pitch-move-svg{ width:100%; height:auto; display:block; }
  .pitch-heat-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  @media (max-width: 980px){ .pitch-heat-grid{ grid-template-columns: 1fr; } }
  .pitch-heat-canvas{ width:100%; height:auto; border:1px solid var(--border); background:#fff; border-radius:12px; display:block; }
  .sr-subtabs{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px; }
  .sr-subpanel{ display:none; }
  .sr-subpanel.active{ display:block; }

  /* tabs */
  .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
  .tab-btn{
    border:1px solid var(--border);
    background:#fff;
    padding:8px 10px;
    border-radius:10px;
    font-weight:800;
    font-size:12px;
    cursor:pointer;
  }
  .tab-btn.active{ background:#0b1220; color:#fff; border-color:#0b1220; }
  .tab-panel{ display:none; margin-top:10px; }
  .tab-panel.active{ display:block; }

  /* selects + buttons */
  .season-select{
    border:1px solid var(--border);
    border-radius:10px;
    padding:7px 10px;
    font-weight:700;
    background:#fff;
  }
  .btn{
    border:1px solid var(--border);
    border-radius:10px;
    padding:7px 10px;
    font-weight:800;
    background:#fff;
    cursor:pointer;
  }
</style>

<script>
(function(){
  // Tabs
  const btns = document.querySelectorAll(".tab-btn");
  const panels = document.querySelectorAll(".tab-panel");
  btns.forEach(b => b.addEventListener("click", () => {
    btns.forEach(x => x.classList.remove("active"));
    panels.forEach(p => p.classList.remove("active"));
    b.classList.add("active");
    const panel = document.getElementById(b.dataset.tab);
    if(panel) panel.classList.add("active");
  }));

  // Spray chart (your existing code)
  const spraySvg = document.getElementById("spraySvg");
  const spraySeasonSel = document.getElementById("spraySeason");
  const sprayRefreshBtn = document.getElementById("sprayRefreshBtn");
  let sprayCache = null;
  let stadiumOverlaySvg = null;
  let sprayTimer = null;

  async function loadStadiumOverlay(){
    if(stadiumOverlaySvg) return stadiumOverlaySvg;
    try{
      const res = await fetch(`/static/stadium_svgs/{{ stadium_svg|default('generic.svg') }}`, { cache:"force-cache" });
      if(!res.ok) throw new Error("stadium svg load failed");
      const txt = await res.text();
      stadiumOverlaySvg = txt;
      return stadiumOverlaySvg;
    }catch(err){
      console.error(err);
      stadiumOverlaySvg = null;
      return null;
    }
  }

  function clearSpray(){
    if(!spraySvg) return;
    while(spraySvg.firstChild) spraySvg.removeChild(spraySvg.firstChild);
  }

  function renderSpray(){
    if(!spraySvg || !sprayCache) return;
    clearSpray();
    // ... your existing spray rendering code remains here ...
  }

  async function loadSpray(){
    const season = spraySeasonSel ? spraySeasonSel.value : "";
    const url = `/player/{{ bio.id }}/spray.json?season=${encodeURIComponent(season)}`;

    try{
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error(`spray fetch failed: ${res.status}`);
      sprayCache = await res.json();

      await loadStadiumOverlay();
      renderSpray();
    }catch(err){
      console.error(err);
    }
  }

  function startSprayAuto(){
    if(sprayTimer) return;
    sprayTimer = setInterval(loadSpray, 60000);
  }
  function stopSprayAuto(){
    if(!sprayTimer) return;
    clearInterval(sprayTimer);
    sprayTimer = null;
  }

  if(sprayRefreshBtn){
    sprayRefreshBtn.addEventListener("click", loadSpray);
  }

  // Ensure spray only runs when scouting tab is visible
  const sprayPanel = document.getElementById("tab-scouting");
  btns.forEach(b => b.addEventListener("click", () => {
    if(b.dataset.tab === "tab-scouting"){
      loadSpray();
      startSprayAuto();
      safeLoadPitchingReport();
    }else{
      stopSprayAuto();
    }
  }));

  // -----------------------------
  // Pitcher scouting report (Statcast pitches in DB)
  // -----------------------------
  const pitSeasonSel = document.getElementById("pitSeason");
  const pitGameSel = document.getElementById("pitGame");
  const pitRefreshBtn = document.getElementById("pitRefreshBtn");
  const pitMixBody = document.getElementById("pitMixBody");
  const pitMoveSvg = document.getElementById("pitMoveSvg");

  const pitHeatPitchSel = document.getElementById("pitHeatPitch");
  const pitHeatStandSel = document.getElementById("pitHeatStand");
  const pitHeatRefreshBtn = document.getElementById("pitHeatRefreshBtn");
  const pitLocCanvas = document.getElementById("pitLocCanvas");
  const pitWobaCanvas = document.getElementById("pitWobaCanvas");
  const pitSrError = document.getElementById("pitSrError");

  const pitchSrRoot = document.querySelector(".pitch-sr");
  const pitchRole = pitchSrRoot ? (pitchSrRoot.dataset.role || "") : "";
  const pitchPlayerId = pitchSrRoot ? (pitchSrRoot.dataset.playerId || "") : "";

  async function fetchJson(url){
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error(`fetch failed: ${res.status}`);
    return await res.json();
  }

  function showPitError(msg){
    if(!pitSrError) return;
    pitSrError.style.display = msg ? "block" : "none";
    pitSrError.textContent = msg || "";
  }

  function fmt1(x){ return (x===null || x===undefined || isNaN(x)) ? "—" : Number(x).toFixed(1); }
  function fmt3(x){ return (x===null || x===undefined || isNaN(x)) ? "—" : Number(x).toFixed(3); }
  function fmtPct(x){ return (x===null || x===undefined || isNaN(x)) ? "—" : Number(x).toFixed(1) + "%"; }

  function srColorPct(pct){
    let p = Number(pct);
    if(isNaN(p)) p = 50;
    p = Math.max(0, Math.min(100, p));
    if(p >= 50){
      const a = (p - 50) / 50;
      const alpha = 0.10 + 0.35 * a;
      return `rgba(255, 70, 70, ${alpha.toFixed(3)})`;
    }else{
      const a = (50 - p) / 50;
      const alpha = 0.10 + 0.35 * a;
      return `rgba(70, 140, 255, ${alpha.toFixed(3)})`;
    }
  }

  function renderPitchMix(mix){
    if(!pitMixBody) return;
    if(!mix || !mix.length){
      pitMixBody.innerHTML = `<tr><td colspan="8" class="muted">No pitch data found.</td></tr>`;
      return;
    }
    const rows = mix.map(r => {
      const hbIn = (r.hb===null || r.hb===undefined) ? null : (Number(r.hb) * 12.0);
      const vbIn = (r.vb===null || r.vb===undefined) ? null : (Number(r.vb) * 12.0);
      return `
        <tr>
          <td class="mono">${(r.pitch_name || r.pitch_type || "UNK")}</td>
          <td class="num">${fmt1(r.usage)}</td>
          <td class="num">${fmt1(r.velo)}</td>
          <td class="num">${fmt1(hbIn)}</td>
          <td class="num">${fmt1(vbIn)}</td>
          <td class="num">${fmt3(r.xwoba)}</td>
          <td class="num">${fmtPct(r.whiff_pct)}</td>
          <td class="num">${fmtPct(r.chase_pct)}</td>
        </tr>
      `;
    }).join("");
    pitMixBody.innerHTML = rows;
  }

  function renderMovement(shapes){
    if(!pitMoveSvg) return;
    pitMoveSvg.innerHTML = "";
    const W = 420, H = 320;
    const pad = {l:50, r:20, t:20, b:45};

    const pts = (shapes || []).map(s => ({
      pt: s.pitch_type || "UNK",
      name: s.pitch_name || s.pitch_type || "UNK",
      x: (s.pfx_x===null || s.pfx_x===undefined) ? null : Number(s.pfx_x) * 12.0,
      y: (s.pfx_z===null || s.pfx_z===undefined) ? null : Number(s.pfx_z) * 12.0,
      velo: (s.velo===null || s.velo===undefined) ? null : Number(s.velo)
    })).filter(p => p.x!==null && p.y!==null);

    if(!pts.length){
      pitMoveSvg.innerHTML = `<text x="12" y="20" class="mono" font-size="12" opacity="0.75">No movement data.</text>`;
      return;
    }

    let maxAbs = 1;
    pts.forEach(p => { maxAbs = Math.max(maxAbs, Math.abs(p.x), Math.abs(p.y)); });
    maxAbs = Math.ceil(maxAbs / 2) * 2;
    const xmin = -maxAbs, xmax = maxAbs, ymin = -maxAbs, ymax = maxAbs;

    const xScale = v => pad.l + ( (v - xmin) / (xmax - xmin) ) * (W - pad.l - pad.r);
    const yScale = v => pad.t + ( (ymax - v) / (ymax - ymin) ) * (H - pad.t - pad.b);

    const line = (x1,y1,x2,y2,op=0.25) => `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="currentColor" opacity="${op}"/>`;
    const rect = `<rect x="0" y="0" width="${W}" height="${H}" rx="12" fill="white" stroke="rgba(0,0,0,0.10)"/>`;
    let svg = rect;

    const step = 4;
    for(let v = xmin; v <= xmax; v += step){
      const x = xScale(v);
      svg += line(x, pad.t, x, H-pad.b, 0.08);
    }
    for(let v = ymin; v <= ymax; v += step){
      const y = yScale(v);
      svg += line(pad.l, y, W-pad.r, y, 0.08);
    }

    svg += line(xScale(0), pad.t, xScale(0), H-pad.b, 0.22);
    svg += line(pad.l, yScale(0), W-pad.r, yScale(0), 0.22);

    svg += `<text x="${W/2}" y="${H-10}" text-anchor="middle" class="mono" font-size="11" opacity="0.75">Horizontal Break (in)</text>`;
    svg += `<text x="14" y="${H/2}" transform="rotate(-90 14 ${H/2})" text-anchor="middle" class="mono" font-size="11" opacity="0.75">Vertical Break (in)</text>`;

    pts.forEach((p,i) => {
      const cx = xScale(p.x);
      const cy = yScale(p.y);
      let r = 5;
      if(p.velo!==null && !isNaN(p.velo)){
        r = Math.max(4, Math.min(9, 4 + (p.velo - 75) / 10));
      }
      svg += `<circle cx="${cx}" cy="${cy}" r="${r}" fill="${srColorPct(50 + (i%2?20:-20))}" stroke="rgba(0,0,0,0.25)"/>`;
      svg += `<text x="${cx+8}" y="${cy+4}" class="mono" font-size="11" opacity="0.85">${p.pt}</text>`;
    });

    pitMoveSvg.innerHTML = svg;
  }

  function drawHeatmap(canvas, payload, kind){
    if(!canvas || !payload || !payload.ok) return;

    const ctx = canvas.getContext("2d");
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0,0,W,H);

    const grid = payload.grid || [];
    const nz = payload.nz || 0;
    const nx = payload.nx || 0;
    if(!nx || !nz || !grid.length) return;

    const cellW = W / nx;
    const cellH = H / nz;

    function color(v){
      if(v===null || v===undefined || isNaN(v)) v = 0;
      v = Number(v);

      if(kind === "density"){
        v = Math.max(0, Math.min(1, v));
        return `rgba(255, 70, 70, ${v.toFixed(3)})`;
      }else{
        const lo = 0.0, hi = 1.2, mid = 0.320;
        v = Math.max(lo, Math.min(hi, v));
        if(v >= mid){
          const a = (v - mid) / (hi - mid);
          const alpha = 0.10 + 0.35 * a;
          return `rgba(255, 70, 70, ${alpha.toFixed(3)})`;
        }else{
          const a = (mid - v) / (mid - lo + 1e-9);
          const alpha = 0.10 + 0.35 * a;
          return `rgba(70, 140, 255, ${alpha.toFixed(3)})`;
        }
      }
    }

    for(let iz=0; iz<nz; iz++){
      const row = grid[iz] || [];
      for(let ix=0; ix<nx; ix++){
        const v = row[ix] || 0;
        const x = ix * cellW;
        const y = (nz - 1 - iz) * cellH;
        ctx.fillStyle = color(v);
        ctx.fillRect(x, y, cellW+0.5, cellH+0.5);
      }
    }

    const dom = payload;
    const z = payload.zone || {};
    function xPix(xv){ return ( (xv - dom.x_min) / (dom.x_max - dom.x_min) ) * W; }
    function zPix(zv){ return ( (dom.z_max - zv) / (dom.z_max - dom.z_min) ) * H; }

    ctx.strokeStyle = "rgba(0,0,0,0.65)";
    ctx.lineWidth = 2;
    const x0 = xPix(z.left), x1 = xPix(z.right);
    const y0 = zPix(z.top), y1 = zPix(z.bot);
    ctx.strokeRect(x0, y0, (x1-x0), (y1-y0));
  }

  async function loadPitchingGames(){
    if(!pitchPlayerId || !pitSeasonSel || !pitGameSel) return;
    const season = pitSeasonSel.value;
    const url = `/player/${encodeURIComponent(pitchPlayerId)}/pitching_games.json?season=${encodeURIComponent(season)}`;
    const data = await fetchJson(url);
    const games = data.games || [];
    pitGameSel.innerHTML = `<option value="">Full season</option>` + games.map(g => (
      `<option value="${g.game_pk}">${g.label}</option>`
    )).join("");
  }

  async function loadPitchingHeatmaps(){
    if(!pitchPlayerId || !pitSeasonSel || !pitHeatPitchSel || !pitHeatStandSel) return;
    const season = pitSeasonSel.value;
    const gamePk = pitGameSel ? (pitGameSel.value || "") : "";
    const pt = pitHeatPitchSel.value;
    const stand = pitHeatStandSel.value;

    if(!pt) return;

    const base = `/player/${encodeURIComponent(pitchPlayerId)}/pitching_heatmap.json?season=${encodeURIComponent(season)}&game_pk=${encodeURIComponent(gamePk)}&pitch_type=${encodeURIComponent(pt)}&stand=${encodeURIComponent(stand)}`;
    try{
      const den = await fetchJson(base + `&metric=density`);
      const woba = await fetchJson(base + `&metric=xwoba`);
      if(den && den.ok) drawHeatmap(pitLocCanvas, den, "density");
      if(woba && woba.ok) drawHeatmap(pitWobaCanvas, woba, "xwoba");
    }catch(err){
      console.error(err);
      showPitError("Failed to load heatmaps.");
    }
  }

  async function loadPitchingSummary(){
    if(!pitchPlayerId || !pitSeasonSel) return;
    const season = pitSeasonSel.value;
    const gamePk = pitGameSel ? (pitGameSel.value || "") : "";
    const url = `/player/${encodeURIComponent(pitchPlayerId)}/pitching_report.json?season=${encodeURIComponent(season)}&game_pk=${encodeURIComponent(gamePk)}`;
    const data = await fetchJson(url);
    if(!data.ok){
      renderPitchMix([]);
      renderMovement([]);
      showPitError("No pitch data found for that selection.");
      return;
    }
    showPitError("");

    renderPitchMix(data.mix || []);
    renderMovement(data.shapes || []);

    if(pitHeatPitchSel){
      const opts = (data.pitches || []).map(p => `<option value="${p.pitch_type}">${(p.pitch_name || p.pitch_type)} (${p.n})</option>`).join("");
      pitHeatPitchSel.innerHTML = opts || `<option value="">—</option>`;
      if(!pitHeatPitchSel.value){
        const first = pitHeatPitchSel.querySelector("option");
        if(first) pitHeatPitchSel.value = first.value;
      }
    }

    await loadPitchingHeatmaps();
  }

  function initSrSubtabs(){
    const subBtns = document.querySelectorAll(".sr-subtab-btn");
    const subPanels = document.querySelectorAll(".sr-subpanel");
    if(!subBtns.length) return;

    subBtns.forEach(b => b.addEventListener("click", () => {
      subBtns.forEach(x => x.classList.remove("active"));
      subPanels.forEach(p => p.classList.remove("active"));
      b.classList.add("active");
      const id = b.dataset.srsub;
      const panel = document.getElementById(id);
      if(panel) panel.classList.add("active");

      if(id === "srsub-pit"){
        safeLoadPitchingReport();
      }
    }));
  }

  async function safeLoadPitchingReport(){
    if(!pitchSrRoot || !pitchPlayerId) return;
    try{
      await loadPitchingGames();
      await loadPitchingSummary();
    }catch(err){
      console.error(err);
      showPitError("Pitcher report unavailable for this player/season.");
    }
  }

  if(pitSeasonSel){
    pitSeasonSel.addEventListener("change", async () => {
      await loadPitchingGames();
      await loadPitchingSummary();
    });
  }
  if(pitGameSel){
    pitGameSel.addEventListener("change", async () => {
      await loadPitchingSummary();
    });
  }
  if(pitRefreshBtn){
    pitRefreshBtn.addEventListener("click", async () => {
      await loadPitchingGames();
      await loadPitchingSummary();
    });
  }
  if(pitHeatRefreshBtn){
    pitHeatRefreshBtn.addEventListener("click", async () => {
      await loadPitchingHeatmaps();
    });
  }
  if(pitHeatPitchSel){
    pitHeatPitchSel.addEventListener("change", async () => {
      await loadPitchingHeatmaps();
    });
  }
  if(pitHeatStandSel){
    pitHeatStandSel.addEventListener("change", async () => {
      await loadPitchingHeatmaps();
    });
  }

  initSrSubtabs();

  if(sprayPanel && sprayPanel.classList.contains("active")){
    loadSpray();
    startSprayAuto();
    safeLoadPitchingReport();
  }
})();
</script>

{% endblock %}
