{% extends "base.html" %}
{% block content %}

{# -----------------------
   Headshot URL
   ----------------------- #}
{% set headshot = "https://img.mlbstatic.com/mlb-photos/image/upload/w_540,q_100/v1/people/" ~ (bio.id|string) ~ "/headshot/67/current" %}

{# -----------------------
   Mini stat cards
   ----------------------- #}

<div class="card" style="margin-top:10px;">
  <div class="card-header" style="position:relative;">
    <div style="display:flex; gap:14px; align-items:center;">
      <img src="{{ headshot }}" alt="{{ bio.fullName }}" style="width:84px; height:84px; border-radius:14px; object-fit:cover; border:1px solid rgba(255,255,255,.18); background:rgba(0,0,0,.18);">
      <div style="min-width:0;">
        <div class="card-title" style="font-size:22px; line-height:1.1;">{{ bio.fullName }}</div>
        <div class="card-subtitle" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <span class="pill mono">{{ bio.primaryPosition.abbreviation if bio.primaryPosition else "—" }}</span>
          {% if bio.currentTeam %}
            <a class="pill mono" href="/team/{{ bio.currentTeam.id }}">{{ bio.currentTeam.abbreviation }}</a>
          {% endif %}
          {% if bio.batSide and bio.batSide.code %}
            <span class="pill mono">Bats: {{ bio.batSide.code }}</span>
          {% endif %}
          {% if bio.pitchHand and bio.pitchHand.code %}
            <span class="pill mono">Throws: {{ bio.pitchHand.code }}</span>
          {% endif %}
          {% if bio.currentAge %}
            <span class="pill mono">Age: {{ bio.currentAge }}</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="card-body">

    {# -----------------------
       Tabs
       ----------------------- #}
    <div class="tabs" style="margin-bottom:10px;">
      <button class="tab-btn active" data-tab="tab-overview">Overview</button>
      <button class="tab-btn" data-tab="tab-stats">Stats</button>
      <button class="tab-btn" data-tab="tab-savant">Savant</button>
      <button class="tab-btn" data-tab="tab-scouting">Scouting Report</button>
    </div>

    {# -----------------------
       OVERVIEW TAB
       ----------------------- #}
    <div id="tab-overview" class="tab-panel active">

      <div class="sr-two-col">

        <div>
          <div class="subcard-title">Bio</div>
          <div class="kv">
            <div class="kv-row"><div class="kv-k">Born</div><div class="kv-v">{{ bio.birthDate or "—" }}</div></div>
            <div class="kv-row"><div class="kv-k">Birthplace</div><div class="kv-v">{{ bio.birthCity or "" }}{% if bio.birthStateProvince %}, {{ bio.birthStateProvince }}{% endif %}{% if bio.birthCountry %} • {{ bio.birthCountry }}{% endif %}</div></div>
            <div class="kv-row"><div class="kv-k">Height</div><div class="kv-v">{{ bio.height or "—" }}</div></div>
            <div class="kv-row"><div class="kv-k">Weight</div><div class="kv-v">{{ bio.weight or "—" }}</div></div>
            <div class="kv-row"><div class="kv-k">Debut</div><div class="kv-v">{{ bio.mlbDebutDate or "—" }}</div></div>
          </div>
        </div>

        <div>
          <div class="subcard-title">Quick Links</div>
          <div class="quicklinks">
            {% if bio.currentTeam %}
              <a class="btn" href="/team/{{ bio.currentTeam.id }}">Team Page</a>
            {% endif %}
            <a class="btn" href="https://www.baseball-reference.com/search/search.fcgi?search={{ bio.fullName|urlencode }}" target="_blank" rel="noopener">Baseball-Reference</a>
            <a class="btn" href="https://baseballsavant.mlb.com/savant-player/{{ bio.fullName|replace(' ','-')|lower }}-{{ bio.id }}" target="_blank" rel="noopener">Baseball Savant</a>
          </div>
        </div>

      </div>

      {# career / year-by-year blocks (already in your file) #}
      {{ career_block|default("")|safe }}
      {{ year_by_year_block|default("")|safe }}

    </div>

    {# -----------------------
       STATS TAB
       ----------------------- #}
    <div id="tab-stats" class="tab-panel">
      {{ stats_block|default("")|safe }}
    </div>

    {# -----------------------
       SAVANT TAB
       ----------------------- #}
    <div id="tab-savant" class="tab-panel">
      {{ savant_block|default("")|safe }}
    </div>

    {# -----------------------
       SCOUTING REPORT TAB (REPLACED)
       ----------------------- #}
<div id="tab-scouting" class="tab-panel">
  <div class="card">
    <div class="card-header" style="align-items:center;">
      <div>
        <div class="card-title">Scouting Report</div>
        <div class="card-subtitle">Basenerd scouting • hitters + pitchers</div>
      </div>

      {% if season_found %}
        <div class="sr-pill">Season {{ season_found }}</div>
      {% endif %}
    </div>

    <div class="card-body">

      {# ----------------------------
         Two-way sub-tabs (only)
         ---------------------------- #}
      {% if role == "two-way" %}
        <div class="subtabs" style="margin-bottom:10px;">
          <button class="subtab-btn active" data-subtab="sr-hitting">Hitting</button>
          <button class="subtab-btn" data-subtab="sr-pitching">Pitching</button>
        </div>
      {% endif %}

      {# ----------------------------
         HITTING SCOUTING (existing)
         show for hitters + two-way
         ---------------------------- #}
      <div id="sr-hitting" class="subtab-panel active"
           {% if role == "pitching" %}style="display:none;"{% endif %}>

        <div class="sr-two-col">

          <!-- LEFT: sliders/bars -->
          <div>
            {% if savant_profile and savant_profile.available %}
              <div class="sr-wrap">
                {% for g in savant_profile.groups %}
                  <div>
                    <div class="sr-group-title">{{ g.title }}</div>

                    <div class="sr-grid">
                      {% for r in g.rows %}
                        <div class="sr-row">
                          <div class="sr-label mono">{{ r.label }}</div>

                          <div class="sr-bar" title="{{ r.label }}">
                            {% if r.pct is not none %}
                              <div class="sr-fill" style="width: {{ r.pct }}%; background: {{ sr_color(r.pct) }};"></div>
                            {% endif %}

                            {% if r.pct is not none %}
                              {% set p = r.pct %}
                              <div class="sr-marker" style="left: {{ p }}%;">
                                <span>{{ p }}</span>
                              </div>
                            {% else %}
                              <div class="sr-marker" style="left: 0; opacity:.55;">
                                <span>—</span>
                              </div>
                            {% endif %}
                          </div>

                          <div class="sr-value">
                            {% if r.value is none %}
                              —
                            {% else %}
                              {% if r.fmt == "3f" %}{{ "%.3f"|format(r.value) }}
                              {% elif r.fmt == "1f" %}{{ "%.1f"|format(r.value) }}
                              {% else %}{{ r.value }}
                              {% endif %}
                              {{ r.suffix if r.suffix is defined else "" }}
                            {% endif %}
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                {% endfor %}
              </div>

              <div class="sr-muted">
                Percentiles are relative to the season pool. (For K%, Whiff%, Chase%, lower is better.)
              </div>
            {% else %}
              <div class="muted">No Statcast scouting data found for this season yet.</div>
            {% endif %}
          </div>

          <!-- RIGHT: Spray -->
          <div>
            <div class="subcard-title" style="margin:0 0 8px 0;">Spray Chart (Hits)</div>

            <div class="spray-controls" style="margin-bottom:8px;">
              <label title="Season">
                <span class="mono" style="font-size:11px; opacity:.75;">Season</span>
                <select id="spraySeason" class="season-select">
                  {% for y in years %}
                    <option value="{{ y }}" {% if season_found and (y|string) == (season_found|string) %}selected{% endif %}>{{ y }}</option>
                  {% endfor %}
                </select>
              </label>

              <button id="sprayRefreshBtn" class="btn" type="button">Refresh</button>
            </div>

            <div class="spray-wrap">
              <svg id="spraySvg" class="spray-svg" xmlns="http://www.w3.org/2000/svg" aria-label="Spray chart stadium">
                <g id="sprayWorld">
                  <g id="sprayOverlay"></g>
                  <g id="sprayPoints"></g>
                </g>
              </svg>
            </div>

            <div class="spray-legend">
              <span class="spray-key"><span class="spray-swatch" style="background:#22c55e;"></span> 1B</span>
              <span class="spray-key"><span class="spray-swatch" style="background:#3b82f6;"></span> 2B</span>
              <span class="spray-key"><span class="spray-swatch" style="background:#a855f7;"></span> 3B</span>
              <span class="spray-key"><span class="spray-swatch" style="background:#ef4444;"></span> HR</span>
              <span class="spray-key"><span class="spray-swatch" style="background:#f59e0b;"></span> Other Hit</span>
            </div>

            <div class="spray-note">
              MLBAM-style coords scaled into stadium viewBox. Home plate baseline ≈ (125, 199). Stadium SVG: {{ stadium_svg|default('generic.svg') }}.
            </div>
          </div>

        </div>
      </div>

      {# ----------------------------
         PITCHING SCOUTING (new)
         show for pitchers + two-way
         ---------------------------- #}
      <div id="sr-pitching" class="subtab-panel"
           {% if role == "hitting" %}style="display:none;"{% endif %}>

        <div class="pr-controls">
          <label>
            <span class="mono pr-label">Season</span>
            <select id="prSeason" class="season-select">
              {% for y in years %}
                <option value="{{ y }}" {% if season_found and (y|string) == (season_found|string) %}selected{% endif %}>{{ y }}</option>
              {% endfor %}
            </select>
          </label>

          <label>
            <span class="mono pr-label">Game</span>
            <select id="prGame" class="season-select">
              <option value="">Season (all games)</option>
            </select>
          </label>

          <button id="prRefresh" class="btn" type="button">Refresh</button>

          <div class="muted" id="prStatus" style="margin-left:auto;"></div>
        </div>

        <div class="pr-grid">
          <!-- Pitch Mix + Whiff/Chase -->
          <div class="card" style="margin:0;">
            <div class="card-header">
              <div>
                <div class="card-title">Pitch Mix & Results</div>
                <div class="card-subtitle">Per-pitch (no bucketing)</div>
              </div>
            </div>
            <div class="card-body">
              <div id="prMixTable" class="mono" style="font-size:12px; overflow:auto;"></div>
            </div>
          </div>

          <!-- Pitch Shapes -->
          <div class="card" style="margin:0;">
            <div class="card-header">
              <div>
                <div class="card-title">Pitch Shapes</div>
                <div class="card-subtitle">pfx_x vs pfx_z (Statcast) • no flipping</div>
              </div>
            </div>
            <div class="card-body">
              <div class="pr-shapes-wrap">
                <svg id="prShapesSvg" class="pr-shapes-svg" xmlns="http://www.w3.org/2000/svg" aria-label="Pitch movement plot"></svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Heatmaps -->
        <div class="card" style="margin-top:10px;">
          <div class="card-header" style="gap:10px; flex-wrap:wrap;">
            <div>
              <div class="card-title">Command / Zone Usage</div>
              <div class="card-subtitle">Smooth KDE-style maps • fixed zone box</div>
            </div>

            <label style="margin-left:auto;">
              <span class="mono pr-label">Pitch</span>
              <select id="prPitchSel" class="season-select"></select>
            </label>

            <div class="pr-metric">
              <button class="btn pr-metric-btn active" data-metric="density" type="button">Usage</button>
              <button class="btn pr-metric-btn" data-metric="xwoba" type="button">xwOBA</button>
              <button class="btn pr-metric-btn" data-metric="whiff" type="button">Whiff%</button>
              <button class="btn pr-metric-btn" data-metric="chase" type="button">Chase%</button>
            </div>
          </div>

          <div class="card-body">
            <div class="pr-heat-row">
              <div>
                <div class="mono pr-heat-title">vs LHH</div>
                <canvas id="prHeatL" class="pr-heat"></canvas>
              </div>
              <div>
                <div class="mono pr-heat-title">vs RHH</div>
                <canvas id="prHeatR" class="pr-heat"></canvas>
              </div>
            </div>

            <div class="pr-heat-note">
              Zone: left=-0.83, right=0.83, top=3.3942716630565757, bot=1.594602333802632 • Domain: x=[-2,2], z=[0,5]
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

    {# end card-body (outer) #}
  </div>
</div>

<script>
(function(){
  // Tabs
  const btns = document.querySelectorAll(".tab-btn");
  const panels = document.querySelectorAll(".tab-panel");
  btns.forEach(b => b.addEventListener("click", () => {
    btns.forEach(x => x.classList.remove("active"));
    panels.forEach(p => p.classList.remove("active"));
    b.classList.add("active");
    const panel = document.getElementById(b.dataset.tab);
    if(panel) panel.classList.add("active");
    window.scrollTo({ top: 0, behavior: "smooth" });
  }));

  // Two-way subtabs inside Scouting Report (only present for role==two-way)
  document.querySelectorAll(".subtab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".subtab-btn").forEach(b => b.classList.remove("active"));
      document.querySelectorAll(".subtab-panel").forEach(p => p.classList.remove("active"));
      btn.classList.add("active");
      const panel = document.getElementById(btn.dataset.subtab);
      if(panel) panel.classList.add("active");

      // if switching to pitching subtab, load report
      if(btn.dataset.subtab === "sr-pitching"){
        if(typeof loadPitchingReport === "function") loadPitchingReport();
      }
      // if switching to hitting, keep spray lazy load behavior intact
      if(btn.dataset.subtab === "sr-hitting"){
        if(typeof loadSpray === "function") loadSpray();
      }
    });
  });

  // Expand/collapse year children
  document.querySelectorAll(".yexp").forEach(b => {
    b.addEventListener("click", () => {
      const year = b.getAttribute("data-year");
      const kind = b.getAttribute("data-kind");
      const rows = document.querySelectorAll(`.ychild-${kind}.ychild-${year}`);
      const isOpen = b.classList.toggle("open");
      rows.forEach(r => r.style.display = isOpen ? "table-row" : "none");
    });
  });

  // -------------------------
  // Spray Chart (Hits only)
  // -------------------------
  const sprayPanel = document.getElementById("tab-scouting");
  const spraySvg = document.getElementById("spraySvg");
  const sprayWorld = document.getElementById("sprayWorld");
  const sprayOverlayG = document.getElementById("sprayOverlay");
  const sprayPointsG = document.getElementById("sprayPoints");
  const spraySeasonSel = document.getElementById("spraySeason");
  const sprayRefreshBtn = document.getElementById("sprayRefreshBtn");

  let sprayCache = null;
  let sprayTimer = null;
  let overlayReady = false;

  // Stadium viewBox info
  let sprayVB = { minX: 0, minY: 0, w: 250, h: 250 };

  // ---- TUNING KNOBS (small!) ----
  // Makes the cloud match Savant a touch better.
  // If you want "more up": make NUDGE_Y more negative.
  // If you want "more spread": bump EXTRA_SPREAD slightly (1.00–1.08 is sane).
  const BASE_W = 250;
  const BASE_H = 250;
  const PLATE = { x: 125, y: 199 };
  const EXTRA_SPREAD = 1.045;  // tiny outward spread around home plate
  const NUDGE_X = 0;           // px in stadium viewBox space
  const NUDGE_Y = -10;         // px in stadium viewBox space (negative = up)
  const SHOW_DEBUG = false;    // turn on if you want anchor dots

  function clearNode(n){
    if(!n) return;
    while(n.firstChild) n.removeChild(n.firstChild);
  }

  function sprayColorFor(ev){
    const e = (ev || "").toLowerCase();
    if(e === "single") return "#22c55e";
    if(e === "double") return "#3b82f6";
    if(e === "triple") return "#a855f7";
    if(e === "home_run") return "#ef4444";
    return "#f59e0b";
  }

  function parseVB(){
    if(!spraySvg) return;
    const vb = (spraySvg.getAttribute("viewBox") || "").trim().split(/\s+/).map(Number);
    if(vb.length === 4 && vb.every(x => Number.isFinite(x))){
      sprayVB = { minX: vb[0], minY: vb[1], w: vb[2], h: vb[3] };
    }else{
      sprayVB = { minX: 0, minY: 0, w: BASE_W, h: BASE_H };
      spraySvg.setAttribute("viewBox", `0 0 ${BASE_W} ${BASE_H}`);
    }
  }

  function yFlip(y){
    return sprayVB.minY + sprayVB.h - (y - sprayVB.minY);
  }

  // Move points relative to home plate in the stadium coordinate system
  function applySpread(x, y){
    const dx = x - PLATE.x;
    const dy = y - PLATE.y;
    const nx = PLATE.x + dx * EXTRA_SPREAD + NUDGE_X;
    const ny = PLATE.y + dy * EXTRA_SPREAD + NUDGE_Y;
    return { x: nx, y: ny };
  }

  function drawDebugAnchors(){
    if(!SHOW_DEBUG || !sprayOverlayG) return;
    const mk = (x,y,color,label) => {
      const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
      c.setAttribute("cx", x); c.setAttribute("cy", y); c.setAttribute("r", 3.5);
      c.setAttribute("fill", color);
      const t = document.createElementNS("http://www.w3.org/2000/svg","title");
      t.textContent = label;
      c.appendChild(t);
      sprayOverlayG.appendChild(c);
    };
    mk(PLATE.x, PLATE.y, "#ef4444", "Home plate anchor");
  }

  async function loadStadiumOverlay(){
    if(overlayReady) return;
    if(!sprayOverlayG) return;

    try{
      const url = `/static/stadiums/{{ stadium_svg|default('generic.svg') }}`;
      const res = await fetch(url, { cache: "force-cache" });
      if(!res.ok) throw new Error(`stadium svg fetch failed: ${res.status}`);

      const svgText = await res.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(svgText, "image/svg+xml");
      const inner = doc.querySelector("svg");

      clearNode(sprayOverlayG);

      if(inner){
        const vb = inner.getAttribute("viewBox");
        if(vb && spraySvg) spraySvg.setAttribute("viewBox", vb);

        const kids = Array.from(inner.childNodes).filter(n => n.nodeType === 1);
        kids.forEach(n => sprayOverlayG.appendChild(document.importNode(n, true)));
      }

      overlayReady = true;
      parseVB();
      drawDebugAnchors();
    }catch(err){
      console.error(err);
      overlayReady = true;
      parseVB();
      drawDebugAnchors();
    }
  }

  function renderSpray(){
    if(!sprayCache || !sprayPointsG) return;
    clearNode(sprayPointsG);

    const pts = sprayCache.points || [];

    for(const p of pts){
      const rawx = Number(p.x);
      const rawy = Number(p.y);
      if(!Number.isFinite(rawx) || !Number.isFinite(rawy)) continue;

      // Your JSON gives coords in stadium viewBox space already (per your existing route).
      // Apply optional flip/spread tuning
      // Note: We intentionally do not flip here; the stadium SVG is already oriented.
      const sp = applySpread(rawx, rawy);
      const sx = sp.x;
      const sy = sp.y;

      const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
      c.setAttribute("cx", sx);
      c.setAttribute("cy", sy);
      c.setAttribute("r", 3.6);
      c.setAttribute("fill", sprayColorFor(p.event));
      c.setAttribute("opacity", "0.92");
      c.setAttribute("stroke", "rgba(0,0,0,.25)");
      c.setAttribute("stroke-width", "0.8");

      const title = document.createElementNS("http://www.w3.org/2000/svg","title");
      title.textContent = `${p.player || ""} • ${(p.event || "").replace(/_/g," ")}${p.inning ? " • " + p.inning : ""} • (${sx.toFixed(1)}, ${sy.toFixed(1)})`;
      c.appendChild(title);

      sprayPointsG.appendChild(c);
    }
  }

  async function loadSpray(){
    const season = spraySeasonSel ? spraySeasonSel.value : "";
    const url = `/player/{{ bio.id }}/spray.json?season=${encodeURIComponent(season)}`;

    try{
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error(`spray fetch failed: ${res.status}`);
      sprayCache = await res.json();

      await loadStadiumOverlay();
      renderSpray();
    }catch(err){
      console.error(err);
    }
  }

  function startSprayAuto(){
    stopSprayAuto();
    sprayTimer = setInterval(() => {
      const active = sprayPanel && sprayPanel.classList.contains("active");
      if(active) loadSpray();
    }, 30000);
  }

  function stopSprayAuto(){
    if(sprayTimer){
      clearInterval(sprayTimer);
      sprayTimer = null;
    }
  }

  if(sprayRefreshBtn) sprayRefreshBtn.addEventListener("click", loadSpray);
  if(spraySeasonSel) spraySeasonSel.addEventListener("change", loadSpray);


  // -------------------------
  // Pitching Report (new)
  // -------------------------
  const prSeasonSel = document.getElementById("prSeason");
  const prGameSel   = document.getElementById("prGame");
  const prRefresh   = document.getElementById("prRefresh");
  const prStatus    = document.getElementById("prStatus");
  const prMixTable  = document.getElementById("prMixTable");
  const prShapesSvg = document.getElementById("prShapesSvg");
  const prPitchSel  = document.getElementById("prPitchSel");
  const heatL = document.getElementById("prHeatL");
  const heatR = document.getElementById("prHeatR");

  let prMetric = "density";
  let prLoadedGamesSeason = null;

  function qs(obj){
    const p = new URLSearchParams();
    Object.entries(obj).forEach(([k,v]) => {
      if(v === null || v === undefined) return;
      if(v === "") return;
      p.set(k, String(v));
    });
    return p.toString();
  }

  async function fetchJSON(url){
    const r = await fetch(url, { headers: { "Accept": "application/json" }, cache: "no-store" });
    return await r.json();
  }

  function setStatus(msg){ if(prStatus) prStatus.textContent = msg || ""; }

  async function loadPitchingGames(){
    if(!prSeasonSel || !prGameSel) return;
    const season = prSeasonSel.value;

    if(prLoadedGamesSeason === season && prGameSel.options.length > 1) return;

    setStatus("Loading games…");
    const data = await fetchJSON(`/player/{{ bio.id }}/pitching_games.json?` + qs({ season }));
    prGameSel.innerHTML = `<option value="">Season (all games)</option>`;

    if(data && data.ok && Array.isArray(data.games)){
      data.games.forEach(g => {
        const opt = document.createElement("option");
        opt.value = g.game_pk;
        opt.textContent = g.label;
        prGameSel.appendChild(opt);
      });
    }
    prLoadedGamesSeason = season;
    setStatus("");
  }

  function renderMixTable(summary){
    if(!prMixTable) return;
    const rows = summary.mix || [];
    const rows2 = summary.whiff_chase || [];

    const byPT = new Map();
    rows.forEach(r => byPT.set(r.pitch_type, { ...r }));
    rows2.forEach(r => {
      const cur = byPT.get(r.pitch_type) || {};
      byPT.set(r.pitch_type, { ...cur, ...r });
    });

    const merged = Array.from(byPT.values()).sort((a,b) => (b.n||0) - (a.n||0));

    const html = `
      <table class="yby-table" style="width:100%;">
        <thead>
          <tr>
            <th>Pitch</th>
            <th>N</th>
            <th>Usage%</th>
            <th>Velo</th>
            <th>Spin</th>
            <th>Whiff%</th>
            <th>Chase%</th>
          </tr>
        </thead>
        <tbody>
          ${merged.map(r => `
            <tr>
              <td><span class="mono">${(r.pitch_name||r.pitch_type||"")}</span> <span class="muted">(${r.pitch_type||""})</span></td>
              <td>${r.n ?? ""}</td>
              <td>${(r.usage ?? 0).toFixed(1)}</td>
              <td>${(r.velo ?? 0).toFixed(1)}</td>
              <td>${r.spin ? Math.round(r.spin).toLocaleString() : ""}</td>
              <td>${(r.whiff_pct ?? 0).toFixed(1)}</td>
              <td>${(r.chase_pct ?? 0).toFixed(1)}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
    prMixTable.innerHTML = html;
  }

  function renderShapes(summary){
    if(!prShapesSvg) return;
    const pts = (summary.shapes || []).slice().sort((a,b) => (b.n||0)-(a.n||0));
    if(!pts.length){
      prShapesSvg.innerHTML = `<text x="10" y="20" fill="currentColor" opacity="0.7">No pitch shape data.</text>`;
      return;
    }

    const xs = pts.map(p => p.pfx_x).filter(v => typeof v === "number");
    const zs = pts.map(p => p.pfx_z).filter(v => typeof v === "number");
    const xmin = Math.min(...xs, -1), xmax = Math.max(...xs, 1);
    const zmin = Math.min(...zs, -1), zmax = Math.max(...zs, 1);

    const W = 520, H = 320, pad = 42;
    prShapesSvg.setAttribute("viewBox", `0 0 ${W} ${H}`);

    const xScale = (v) => pad + ( (v - xmin) / (xmax - xmin || 1) ) * (W - 2*pad);
    const yScale = (v) => (H - pad) - ( (v - zmin) / (zmax - zmin || 1) ) * (H - 2*pad);

    const axis = `
      <line x1="${pad}" y1="${H-pad}" x2="${W-pad}" y2="${H-pad}" stroke="currentColor" opacity="0.25"/>
      <line x1="${pad}" y1="${pad}" x2="${pad}" y2="${H-pad}" stroke="currentColor" opacity="0.25"/>
      <text x="${W/2}" y="${H-10}" text-anchor="middle" fill="currentColor" opacity="0.7" font-size="12">pfx_x</text>
      <text x="14" y="${H/2}" text-anchor="middle" fill="currentColor" opacity="0.7" font-size="12" transform="rotate(-90 14 ${H/2})">pfx_z</text>
    `;

    const dots = pts.map(p => {
      const cx = xScale(p.pfx_x || 0);
      const cy = yScale(p.pfx_z || 0);
      const label = `${p.pitch_name||p.pitch_type} • n=${p.n} • velo=${(p.velo??0).toFixed(1)}`;
      return `
        <g>
          <circle cx="${cx}" cy="${cy}" r="6" fill="currentColor" opacity="0.85"/>
          <text x="${cx+8}" y="${cy+4}" fill="currentColor" opacity="0.85" font-size="11">${p.pitch_type}</text>
          <title>${label}</title>
        </g>
      `;
    }).join("");

    prShapesSvg.innerHTML = axis + dots;
  }

  function ensurePitchSelect(summary){
    if(!prPitchSel) return;
    const pitches = summary.pitches || [];
    if(!pitches.length){
      prPitchSel.innerHTML = `<option value="">No pitch data</option>`;
      return;
    }
    const cur = prPitchSel.value;
    prPitchSel.innerHTML = pitches.map(p => {
      const name = p.pitch_name || p.pitch_type;
      return `<option value="${p.pitch_type}">${name} (${p.pitch_type})</option>`;
    }).join("");

    if(cur && pitches.some(p => p.pitch_type === cur)){
      prPitchSel.value = cur;
    }
  }

  function drawHeat(canvas, payload){
    if(!canvas || !payload || !payload.grid) return;

    const displayW = canvas.clientWidth || 380;
    const displayH = Math.round(displayW * 0.85);
    canvas.width = displayW * window.devicePixelRatio;
    canvas.height = displayH * window.devicePixelRatio;

    const ctx = canvas.getContext("2d");
    ctx.setTransform(window.devicePixelRatio,0,0,window.devicePixelRatio,0,0);
    ctx.clearRect(0,0,displayW,displayH);

    const grid = payload.grid;
    const nz = payload.nz, nx = payload.nx;

    const img = ctx.createImageData(displayW, displayH);
    for(let py=0; py<displayH; py++){
      const gz = Math.floor((py / (displayH-1)) * (nz-1));
      for(let px=0; px<displayW; px++){
        const gx = Math.floor((px / (displayW-1)) * (nx-1));
        const v = grid[gz][gx];

        let t = v;
        if(prMetric === "xwoba"){
          t = Math.max(0, Math.min(1, v / 1.2));
        }else{
          t = Math.max(0, Math.min(1, v));
        }

        const mid = 0.5;
        let r,g,b,a;
        a = 220;
        if(t < mid){
          const u = t/mid;
          r = Math.round(120 + (229-120)*u);
          g = Math.round(140 + (231-140)*u);
          b = Math.round(200 + (235-200)*u);
        }else{
          const u = (t-mid)/(1-mid);
          r = Math.round(229 + (239-229)*u);
          g = Math.round(231 + (68-231)*u);
          b = Math.round(235 + (68-235)*u);
        }

        const i = (py*displayW + px)*4;
        img.data[i+0]=r; img.data[i+1]=g; img.data[i+2]=b; img.data[i+3]=a;
      }
    }
    ctx.putImageData(img, 0, 0);

    const zone = payload.zone;
    const xMin = payload.x_min, xMax = payload.x_max;
    const zMin = payload.z_min, zMax = payload.z_max;

    const xToPx = (x) => ( (x - xMin) / (xMax - xMin) ) * displayW;
    const zToPy = (z) => displayH - ( (z - zMin) / (zMax - zMin) ) * displayH;

    const left = xToPx(zone.left);
    const right = xToPx(zone.right);
    const top = zToPy(zone.top);
    const bot = zToPy(zone.bot);

    ctx.strokeStyle = "rgba(255,255,255,0.85)";
    ctx.lineWidth = 2;
    ctx.strokeRect(left, top, (right-left), (bot-top));
  }

  async function loadHeatmaps(){
    if(!prPitchSel || !heatL || !heatR || !prSeasonSel) return;
    const season = prSeasonSel.value;
    const game_pk = prGameSel ? prGameSel.value : "";
    const pitch_type = prPitchSel.value;
    if(!pitch_type) return;

    setStatus("Loading heatmaps…");
    const base = `/player/{{ bio.id }}/pitching_heatmap.json?`;
    const qBase = { season, game_pk, pitch_type, metric: prMetric };

    const [L, R] = await Promise.all([
      fetchJSON(base + qs({ ...qBase, stand:"L" })),
      fetchJSON(base + qs({ ...qBase, stand:"R" })),
    ]);

    if(L && L.ok) drawHeat(heatL, L); else heatL.getContext("2d").clearRect(0,0,heatL.width,heatL.height);
    if(R && R.ok) drawHeat(heatR, R); else heatR.getContext("2d").clearRect(0,0,heatR.width,heatR.height);

    setStatus("");
  }

  async function loadPitchingReport(){
    if(!prSeasonSel || !prMixTable) return;

    await loadPitchingGames();

    const season = prSeasonSel.value;
    const game_pk = prGameSel ? prGameSel.value : "";

    setStatus("Loading report…");
    const summary = await fetchJSON(`/player/{{ bio.id }}/pitching_report.json?` + qs({ season, game_pk }));

    if(!summary || !summary.ok){
      prMixTable.innerHTML = `<div class="muted">No pitching data found for this selection.</div>`;
      if(prShapesSvg) prShapesSvg.innerHTML = "";
      if(prPitchSel) prPitchSel.innerHTML = "";
      setStatus("");
      return;
    }

    renderMixTable(summary);
    renderShapes(summary);
    ensurePitchSelect(summary);
    await loadHeatmaps();
    setStatus("");
  }

  // metric buttons
  document.querySelectorAll(".pr-metric-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      document.querySelectorAll(".pr-metric-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      prMetric = btn.dataset.metric;
      await loadHeatmaps();
    });
  });

  if(prRefresh) prRefresh.addEventListener("click", loadPitchingReport);
  if(prSeasonSel){
    prSeasonSel.addEventListener("change", async () => {
      prLoadedGamesSeason = null;
      await loadPitchingReport();
    });
  }
  if(prGameSel) prGameSel.addEventListener("change", loadPitchingReport);
  if(prPitchSel) prPitchSel.addEventListener("change", loadHeatmaps);

  // Lazy-load scouting visuals when Scouting tab opens
  const ROLE = "{{ role }}"; // "hitting" | "pitching" | "two-way"

  function activeScoutingSubtab(){
    const pitchBtn = document.querySelector('.subtab-btn[data-subtab="sr-pitching"]');
    const hitBtn   = document.querySelector('.subtab-btn[data-subtab="sr-hitting"]');
    if(pitchBtn && pitchBtn.classList.contains("active")) return "pitching";
    if(hitBtn && hitBtn.classList.contains("active")) return "hitting";
    return (ROLE === "pitching") ? "pitching" : "hitting";
  }

  btns.forEach(b => b.addEventListener("click", () => {
    if(b.dataset.tab === "tab-scouting"){
      const which = activeScoutingSubtab();
      if(which === "pitching"){
        loadPitchingReport();
        stopSprayAuto();
      }else{
        loadSpray();
        startSprayAuto();
      }
    }else{
      stopSprayAuto();
    }
  }));

  if(sprayPanel && sprayPanel.classList.contains("active")){
    const which = activeScoutingSubtab();
    if(which === "pitching"){
      loadPitchingReport();
      stopSprayAuto();
    }else{
      loadSpray();
      startSprayAuto();
    }
  }
})();
</script>

{% endblock %}
