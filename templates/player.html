{% extends "base.html" %}
{% block content %}

{# -----------------------
   Headshot URL
   ----------------------- #}
{% set headshot = "https://img.mlbstatic.com/mlb-photos/image/upload/w_540,q_100/v1/people/" ~ (bio.id|string) ~ "/headshot/67/current" %}

{# -----------------------
   Mini stat cards
   ----------------------- #}
{% macro stat_cell(val, bg) %}
  {% if bg %}
    <span class="statcell" style="background: {{ bg }};">{{ val }}</span>
  {% else %}
    {{ val }}
  {% endif %}
{% endmacro %}

{# -----------------------
   Scouting Report color scale
   0 = blue, 50 = light gray, 100 = red
   ----------------------- #}
{% macro sr_color(pct) %}
  {%- if pct is none -%}
    rgba(229,231,235,1)
  {%- else -%}
    {%- set p = pct|int -%}
    {%- if p < 0 -%}{%- set p = 0 -%}{%- endif -%}
    {%- if p > 100 -%}{%- set p = 100 -%}{%- endif -%}

    {# anchor colors (RGB) #}
    {# blue: 37, 99, 235 (#2563eb) #}
    {# gray: 229, 231, 235 (#e5e7eb) #}
    {# red: 239, 68, 68 (#ef4444) #}

    {%- if p <= 50 -%}
      {%- set t = p / 50 -%}
      {%- set r = (37  + (229-37)  * t) | round | int -%}
      {%- set g = (99  + (231-99)  * t) | round | int -%}
      {%- set b = (235 + (235-235) * t) | round | int -%}
      rgb({{ r }}, {{ g }}, {{ b }})
    {%- else -%}
      {%- set t = (p - 50) / 50 -%}
      {%- set r = (229 + (239-229) * t) | round | int -%}
      {%- set g = (231 + (68-231)  * t) | round | int -%}
      {%- set b = (235 + (68-235)  * t) | round | int -%}
      rgb({{ r }}, {{ g }}, {{ b }})
    {%- endif -%}
  {%- endif -%}
{% endmacro %}

{% macro mini_cards(stat, kind, bg_map) %}
  <div class="headline-grid">
    {% if kind == "pitching" %}
      {% for key, label in [
        ('wins','W'),('losses','L'),('era','ERA'),('whip','WHIP'),
        ('inningsPitched','IP'),('strikeOuts','SO'),
        ('saves','SV'),('holds','HLD'),
        ('gamesPlayed','G'),('gamesStarted','GS')
      ] %}
        {% if stat and stat.get(key) is not none and stat.get(key) != '' %}
          <div class="headline-stat" {% set _bg = (bg_map.get(key) if bg_map is defined and bg_map else None) %}{% if _bg %}style="background: {{ _bg }};"{% endif %}>
            <div class="k">{{ label }}</div>
            <div class="v">{{ stat.get(key) }}</div>
          </div>
        {% endif %}
      {% endfor %}
    {% else %}
      {% for key, label in [
        ('gamesPlayed','G'),('atBats','AB'),('hits','H'),('homeRuns','HR'),
        ('rbi','RBI'),('runs','R'),('stolenBases','SB'),
        ('avg','AVG'),('obp','OBP'),('slg','SLG'),('ops','OPS')
      ] %}
        {% if stat and stat.get(key) is not none and stat.get(key) != '' %}
          <div class="headline-stat" {% set _bg = (bg_map.get(key) if bg_map is defined and bg_map else None) %}{% if _bg %}style="background: {{ _bg }};"{% endif %}>
            <div class="k">{{ label }}</div>
            <div class="v">{{ stat.get(key) }}</div>
          </div>
        {% endif %}
      {% endfor %}
    {% endif %}
  </div>
{% endmacro %}

<style>
  .player-header-card{ align-items:stretch; }
  .player-header{
    display:flex;
    align-items:stretch;
    gap:14px;
    width:100%;
  }
  .player-headshot{
    width:150px;
    height:100%;
    min-height:170px;
    object-fit:cover;
    border-radius:12px;
    border:1px solid var(--border);
    background:#0b1220;
    flex:0 0 auto;
  }
  .player-meta{ min-width:0; display:flex; flex-direction:column; justify-content:center; }
  .player-name{ font-size:18px; font-weight:800; letter-spacing:.2px; }
  .player-lines{ margin-top:6px; display:flex; flex-direction:column; gap:4px; }

  .headline-grid{
    display:grid;
    grid-template-columns: repeat(11, minmax(0, 1fr));
    gap:8px;
  }
  @media (max-width: 980px){
    .headline-grid{ grid-template-columns: repeat(5, minmax(0, 1fr)); }
    .player-headshot{ width:170px; }
  }
  .headline-stat{
    border:1px solid var(--border);
    background:#fff;
    border-radius:10px;
    padding:8px 10px;
    overflow:hidden;
  }
  .headline-stat .k{
    font-size:10px;
    color: var(--muted);
    font-weight:700;
    letter-spacing:.2px;
    font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace;
  }
  .headline-stat .v{
    margin-top:2px;
    font-size:14px;
    font-weight:900;
    font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace;
  }

  .sr-two-col{
    display:grid;
    grid-template-columns: 1fr 380px;
    gap:14px;
    align-items:start;
  }
  @media (max-width: 980px){
    .sr-two-col{ grid-template-columns: 1fr; }
  }

  /* tabs */
  .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
  .tab-btn{
    border:1px solid var(--border);
    background:#fff;
    padding:8px 10px;
    border-radius:10px;
    font-weight:800;
    font-size:12px;
    cursor:pointer;
  }
  .tab-btn.active{ background:#0b1220; color:#fff; border-color:#0b1220; }
  .tab-panel{ display:none; margin-top:10px; }
  .tab-panel.active{ display:block; }

  /* selects + buttons */
  .season-select{
    border:1px solid var(--border);
    border-radius:10px;
    padding:7px 10px;
    font-weight:700;
    background:#fff;
  }
  .btn{
    border:1px solid var(--border);
    border-radius:10px;
    padding:7px 10px;
    font-weight:800;
    background:#fff;
    cursor:pointer;
  }

  /* transactions */
  .tx-list{ display:flex; flex-direction:column; gap:10px; }
  .tx-row{
    display:grid;
    grid-template-columns: 110px 1fr;
    gap:12px;
    padding:10px 10px;
    border:1px solid var(--border);
    border-radius:12px;
    background:#fff;
  }
  .tx-date{
    font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace;
    font-size:11px;
    font-weight:900;
    color:#394150;
    white-space:nowrap;
  }
  .tx-desc{ font-size:12px; color:#111827; }

  /* Year-by-year expanders */
  .yearcell{ display:inline-flex; align-items:center; gap:8px; }
  .yspacer{ display:inline-block; width:18px; height:18px; }
  .yexp{
    width:18px;
    height:18px;
    border-radius:6px;
    border:1px solid var(--border);
    background:#fff;
    color:#111827;
    font-weight:900;
    line-height:1;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    justify-content:center;
  }
  .yexp.open{ transform: rotate(180deg); }

  .acc-pill{
    font-size:10px;
    font-weight:900;
    padding:2px 7px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#fff;
    color:#111827;
    display:inline-block;
    margin-right:6px;
    margin-bottom:4px;
  }

  /* ==========================
     Scouting Report (Savant-style)
     ========================== */
  .sr-wrap{ display:flex; flex-direction:column; gap:14px; }
  .sr-group-title{
    font-weight:900;
    letter-spacing:.2px;
    color:#111827;
    margin:6px 0 6px;
    padding-bottom:4px;
    border-bottom:1px dashed var(--border);
  }
  .sr-grid{ display:flex; flex-direction:column; gap:9px; }

  .sr-row{
    display:grid;
    grid-template-columns: 120px 1fr 72px;
    gap:12px;
    align-items:center;
  }
  @media (max-width: 980px){
    .sr-row{ grid-template-columns: 110px 1fr 64px; }
  }

  .sr-label{
    font-size:12px;
    font-weight:700;
    color:#374151;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .sr-value{
    text-align:right;
    font-size:12px;
    font-weight:800;
    letter-spacing:.2px;
    font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace;
    color:#111827;
    white-space:nowrap;
  }

  .sr-marker{
    position:absolute;
    top:50%;
    transform:translate(-50%, -50%);
    width:22px;
    height:22px;
    border-radius:999px;
    background:#0b1220;
    border:2px solid #ffffff;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow:0 4px 10px rgba(0,0,0,.18);
    pointer-events:none;
  }
  .sr-marker span{
    font-size:10px;
    font-weight:900;
    color:#ffffff;
    font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace;
    line-height:1;
  }

  .sr-bar{
    position:relative;
    height:14px;
    border-radius:999px;
    
    border:1px solid var(--border);
    background:#f1f5f9;
  }
  .sr-fill{
    position:absolute;
    inset:0 auto 0 0;
    width:0%;
    border-radius:999px;
  }

  .sr-muted{ margin-top:10px; font-size:11px; color:var(--muted); }
  .sr-pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    font-size:10px;
    font-weight:900;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#fff;
    color:#111827;
    font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace;
  }

  /* ==========================
     Spray Chart (Hits only)
     ========================== */
  .spray-controls{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
  .spray-controls label{
    display:inline-flex;
    align-items:center;
    gap:6px;
    font-size:12px;
    font-weight:800;
    color:#111827;
    cursor:pointer;
  }

  .spray-legend{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    margin-top:10px;
    font-size:11px;
    color: var(--muted);
  }
  .spray-key{ display:inline-flex; align-items:center; gap:6px; }
  .spray-swatch{ width:10px; height:10px; border-radius:999px; border:1px solid rgba(0,0,0,.15); }

  .spray-wrap{
    margin-top:10px;
    border:1px solid var(--border);
    border-radius:14px;
    background: linear-gradient(180deg, rgba(2,6,23,.05), rgba(2,6,23,0));
    overflow:hidden;
  }
  .spray-svg{
    width:100%;
    height:auto;
    display:block;
    background:#ffffff;
  }
  .spray-note{ margin-top:10px; font-size:11px; color: var(--muted); }
</style>

<!-- =======================
     Header card
     ======================= -->
<div class="card player-top">
  <div class="card-header player-header-card">
    <div class="player-header">
      <img class="player-headshot" src="{{ headshot }}" alt="{{ bio.fullName }}">

      <div class="player-meta">
        <div class="player-name">{{ bio.fullName }}</div>

        <div class="player-lines">
          <div class="muted">
            {% if bio.currentTeam and bio.currentTeam.name %}{{ bio.currentTeam.name }}{% endif %}
            {% if bio.primaryPosition and bio.primaryPosition.name %} • {{ bio.primaryPosition.name }}{% endif %}
          </div>

          {% if bio.currentAge or bio.height or bio.weight %}
            <div class="muted">
              {% if bio.currentAge %}Age {{ bio.currentAge }}{% endif %}
              {% if bio.height %}{% if bio.currentAge %} • {% endif %}{{ bio.height }}{% endif %}
              {% if bio.weight %}{% if bio.currentAge or bio.height %} • {% endif %}{{ bio.weight }} lb{% endif %}
            </div>
          {% endif %}

          {% if (bio.batSide and bio.batSide.code) or (bio.pitchHand and bio.pitchHand.code) %}
            <div class="muted">
              {% if bio.batSide and bio.batSide.code %}Bats: {{ bio.batSide.code }}{% endif %}
              {% if bio.pitchHand and bio.pitchHand.code %}{% if bio.batSide and bio.batSide.code %} • {% endif %}Throws: {{ bio.pitchHand.code }}{% endif %}
            </div>
          {% endif %}

          {% if bio.mlbDebutDate %}
            <div class="muted">MLB Debut: {{ bio.mlbDebutDate[:10] }}</div>
          {% endif %}

          {% if bio.birthCity or bio.birthStateProvince or bio.birthCountry %}
            <div class="muted">
              Born:
              {% if bio.birthCity %}{{ bio.birthCity }}{% endif %}
              {% if bio.birthStateProvince %}{% if bio.birthCity %}, {% endif %}{{ bio.birthStateProvince }}{% endif %}
              {% if bio.birthCountry %}{% if bio.birthCity or bio.birthStateProvince %} • {% endif %}{{ bio.birthCountry }}{% endif %}
            </div>
          {% endif %}

          {% if bio.education %}
            <div class="muted">{{ bio.education }}</div>
          {% endif %}

          {% if bio.draftYear or bio.draftRound or bio.draftPickNumber %}
            <div class="muted">
              Draft:
              {% if bio.draftYear %}{{ bio.draftYear }}{% endif %}
              {% if bio.draftRound %}{% if bio.draftYear %} • {% endif %}R{{ bio.draftRound }}{% endif %}
              {% if bio.draftPickNumber %}{% if bio.draftYear or bio.draftRound %} • {% endif %}Pick {{ bio.draftPickNumber }}{% endif %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- =======================
     Season Snapshot (from year-by-year source)
     ======================= -->
<div class="card">
  <div class="card-header">
    <div>
      <div class="card-title">{{ season_found if season_found else "—" }} Stats</div>
    </div>
  </div>

  <div class="card-body">
    {% if role == "two-way" %}
      {% if snapshot_hitting %}
        <div style="margin-bottom:10px;">
          <div class="subcard-title">Hitting</div>
          {{ mini_cards(snapshot_hitting, "hitting", snapshot_bg_hitting) }}
        </div>
      {% endif %}
      {% if snapshot_pitching %}
        <div>
          <div class="subcard-title">Pitching</div>
          {{ mini_cards(snapshot_pitching, "pitching", snapshot_bg_pitching) }}
        </div>
      {% endif %}
      {% if (not snapshot_hitting) and (not snapshot_pitching) %}
        <div class="muted">No stats found.</div>
      {% endif %}
    {% elif role == "pitching" %}
      {% if snapshot_pitching %}
        {{ mini_cards(snapshot_pitching, "pitching", snapshot_bg_pitching) }}
      {% else %}
        <div class="muted">No stats found.</div>
      {% endif %}
    {% else %}
      {% if snapshot_hitting %}
        {{ mini_cards(snapshot_hitting, "hitting", snapshot_bg_hitting) }}
      {% else %}
        <div class="muted">No stats found.</div>
      {% endif %}
    {% endif %}
  </div>
</div>

<!-- =======================
     Career Stats
     ======================= -->
<div class="card">
  <div class="card-header">
    <div class="card-title">Career Stats</div>
  </div>

  <div class="card-body">
    {% if role == "two-way" %}
      <div style="margin-bottom:12px;">
        <div class="subcard-title">Hitting</div>
        {% if career_hitting %}{{ mini_cards(career_hitting, "hitting", {}) }}{% else %}<div class="muted">—</div>{% endif %}
      </div>
      <div>
        <div class="subcard-title">Pitching</div>
        {% if career_pitching %}{{ mini_cards(career_pitching, "pitching", {}) }}{% else %}<div class="muted">—</div>{% endif %}
      </div>
    {% elif role == "pitching" %}
      {% if career_pitching %}{{ mini_cards(career_pitching, "pitching", {}) }}{% else %}<div class="muted">—</div>{% endif %}
    {% else %}
      {% if career_hitting %}{{ mini_cards(career_hitting, "hitting", {}) }}{% else %}<div class="muted">—</div>{% endif %}
    {% endif %}
  </div>
</div>

<!-- ===== Tabs ===== -->
<div class="tabs" style="margin-top:12px;">
  <button class="tab-btn active" data-tab="tab-yby">Year-by-Year</button>
  <button class="tab-btn" data-tab="tab-gamelog">Game Logs</button>
  <button class="tab-btn" data-tab="tab-tx">Transactions</button>
  <button class="tab-btn" data-tab="tab-scouting">Scouting Report</button>
</div>

<!-- =======================
     Year-by-Year
     ======================= -->
<div id="tab-yby" class="tab-panel active">

  {% set _hg = (hitting_groups if hitting_groups is defined else []) %}
  {% set _pg = (pitching_groups if pitching_groups is defined else []) %}
  {% set has_hitting = (_hg|length) > 0 %}
  {% set has_pitching = (_pg|length) > 0 %}

  {% if has_hitting %}
  <div class="card" style="margin-top:14px;">
    <div class="card-header">
      <div class="card-title">Year-by-Year Hitting</div>
    </div>

    <div style="overflow:auto;">
      <table class="table" style="width:100%; min-width:900px;">
        <thead>
          <tr>
            <th>Year</th>
            <th>Team</th>
            <th>G</th><th>PA</th><th>AB</th><th>H</th>
            <th>HR</th><th>RBI</th><th>SB</th>
            <th>AVG</th><th>OBP</th><th>SLG</th><th>OPS</th><th>Awards</th>
          </tr>
        </thead>
        <tbody>

          {% for g in _hg %}
            {% set r = g.total %}
            {% if r %}
              {% set s = r.stat %}
              {% set has_parts = (g.parts and (g.parts|length) > 0) %}
              {% set rk = g.year ~ ':Total' %}

              <tr class="year-row">
                <td style="white-space:nowrap;">
                  <span class="yearcell">
                    <span>{{ g.year }}</span>

                    {% if has_parts %}
                      <button class="yexp" type="button" data-kind="hitting" data-year="{{ g.year }}" aria-label="Expand year">▾</button>
                    {% else %}
                      <span class="yspacer"></span>
                    {% endif %}
                  </span>
                </td>

                <td style="min-width:220px;">{{ "Total" if has_parts else r.team }}</td>

                <td>{{ stat_cell(s.gamesPlayed or "—", (yby_bg_hitting.get(rk) or {}).get('gamesPlayed')) }}</td>
                <td>{{ stat_cell(s.plateAppearances or "—", (yby_bg_hitting.get(rk) or {}).get('plateAppearances')) }}</td>
                <td>{{ stat_cell(s.atBats or "—", (yby_bg_hitting.get(rk) or {}).get('atBats')) }}</td>
                <td>{{ stat_cell(s.hits or "—", (yby_bg_hitting.get(rk) or {}).get('hits')) }}</td>
                <td>{{ stat_cell(s.homeRuns or "—", (yby_bg_hitting.get(rk) or {}).get('homeRuns')) }}</td>
                <td>{{ stat_cell(s.rbi or "—", (yby_bg_hitting.get(rk) or {}).get('rbi')) }}</td>
                <td>{{ stat_cell(s.stolenBases or "—", (yby_bg_hitting.get(rk) or {}).get('stolenBases')) }}</td>
                <td>{{ stat_cell(s.avg or "—", (yby_bg_hitting.get(rk) or {}).get('avg')) }}</td>
                <td>{{ stat_cell(s.obp or "—", (yby_bg_hitting.get(rk) or {}).get('obp')) }}</td>
                <td>{{ stat_cell(s.slg or "—", (yby_bg_hitting.get(rk) or {}).get('slg')) }}</td>
                <td>{{ stat_cell(s.ops or "—", (yby_bg_hitting.get(rk) or {}).get('ops')) }}</td>
                <td>
                  {% set y = g.year %}
                  {% if award_year_map is defined and award_year_map[y] is defined %}
                    {% set award_labels = {
                      "mvp":"MVP",
                      "cyyoung":"CY",
                      "roy":"ROY",
                      "goldglove":"GG",
                      "platinumglove":"PG",
                      "silverslugger":"SS",
                      "allstar":"AS",
                      "battingchamp":"BC",
                      "hrderby":"HRD",
                      "wsmvp":"WS-MVP",
                      "wschamp":"WS",
                      "hof":"HOF"
                    } %}
                    {% for k in award_year_map[y] %}
                      <span class="acc-pill acc-{{ k }}">
                        {{ award_labels[k] if award_labels[k] is defined else k|upper }}
                      </span>
                    {% endfor %}
                  {% endif %}
                </td>
              </tr>

              {% if has_parts %}
                {% for p in g.parts %}
                  {% set ps = p.stat %}
                  {% set rk2 = g.year ~ ':' ~ p.team %}
                  <tr class="ychild ychild-hitting ychild-{{ g.year }}" style="display:none; opacity:.92;">
                    <td style="white-space:nowrap; padding-left:16px;">{{ p.year }}</td>
                    <td style="min-width:220px;">{{ p.team }}</td>
                    <td>{{ stat_cell(ps.gamesPlayed or "—", (yby_bg_hitting.get(rk2) or {}).get('gamesPlayed')) }}</td>
                    <td>{{ stat_cell(ps.plateAppearances or "—", (yby_bg_hitting.get(rk2) or {}).get('plateAppearances')) }}</td>
                    <td>{{ stat_cell(ps.atBats or "—", (yby_bg_hitting.get(rk2) or {}).get('atBats')) }}</td>
                    <td>{{ stat_cell(ps.hits or "—", (yby_bg_hitting.get(rk2) or {}).get('hits')) }}</td>
                    <td>{{ stat_cell(ps.homeRuns or "—", (yby_bg_hitting.get(rk2) or {}).get('homeRuns')) }}</td>
                    <td>{{ stat_cell(ps.rbi or "—", (yby_bg_hitting.get(rk2) or {}).get('rbi')) }}</td>
                    <td>{{ stat_cell(ps.stolenBases or "—", (yby_bg_hitting.get(rk2) or {}).get('stolenBases')) }}</td>
                    <td>{{ stat_cell(ps.avg or "—", (yby_bg_hitting.get(rk2) or {}).get('avg')) }}</td>
                    <td>{{ stat_cell(ps.obp or "—", (yby_bg_hitting.get(rk2) or {}).get('obp')) }}</td>
                    <td>{{ stat_cell(ps.slg or "—", (yby_bg_hitting.get(rk2) or {}).get('slg')) }}</td>
                    <td>{{ stat_cell(ps.ops or "—", (yby_bg_hitting.get(rk2) or {}).get('ops')) }}</td>
                    <td></td>
                  </tr>
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}

        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {% if has_pitching %}
  <div class="card" style="margin-top:14px;">
    <div class="card-header">
      <div class="card-title">Year-by-Year Pitching</div>
    </div>

    <div style="overflow:auto;">
      <table class="table" style="width:100%; min-width:980px;">
        <thead>
          <tr>
            <th>Year</th>
            <th>Team</th>
            <th>G</th><th>GS</th><th>IP</th>
            <th>W</th><th>L</th><th>SV</th><th>SO</th>
            <th>ERA</th><th>WHIP</th><th>Awards</th>
          </tr>
        </thead>
        <tbody>

          {% for g in _pg %}
            {% set r = g.total %}
            {% if r %}
              {% set s = r.stat %}
              {% set has_parts = (g.parts and (g.parts|length) > 0) %}
              {% set rk = g.year ~ ':Total' %}

              <tr class="year-row">
                <td style="white-space:nowrap;">
                  <span class="yearcell">
                    <span>{{ g.year }}</span>

                    {% if has_parts %}
                      <button class="yexp" type="button" data-kind="pitching" data-year="{{ g.year }}" aria-label="Expand year">▾</button>
                    {% else %}
                      <span class="yspacer"></span>
                    {% endif %}
                  </span>
                </td>

                <td style="white-space:nowrap;">{{ "Total" if has_parts else r.team }}</td>

                <td>{{ s.gamesPitched or "—" }}</td>
                <td>{{ stat_cell(s.gamesStarted or "—", (yby_bg_pitching.get(rk) or {}).get('gamesStarted')) }}</td>
                <td>{{ stat_cell(s.inningsPitched or "—", (yby_bg_pitching.get(rk) or {}).get('inningsPitched')) }}</td>
                <td>{{ stat_cell(s.wins or "—", (yby_bg_pitching.get(rk) or {}).get('wins')) }}</td>
                <td>{{ stat_cell(s.losses or "—", (yby_bg_pitching.get(rk) or {}).get('losses')) }}</td>
                <td>{{ stat_cell(s.saves or "—", (yby_bg_pitching.get(rk) or {}).get('saves')) }}</td>
                <td>{{ stat_cell(s.strikeOuts or "—", (yby_bg_pitching.get(rk) or {}).get('strikeOuts')) }}</td>
                <td>{{ stat_cell(s.era or "—", (yby_bg_pitching.get(rk) or {}).get('era')) }}</td>
                <td>{{ stat_cell(s.whip or "—", (yby_bg_pitching.get(rk) or {}).get('whip')) }}</td>
                <td>
                  {% set y = g.year %}
                  {% if award_year_map is defined and award_year_map[y] is defined %}
                    {% set award_labels = {
                      "mvp":"MVP",
                      "cyyoung":"CY",
                      "roy":"ROY",
                      "goldglove":"GG",
                      "platinumglove":"PG",
                      "silverslugger":"SS",
                      "allstar":"AS",
                      "battingchamp":"BC",
                      "hrderby":"HRD",
                      "wsmvp":"WS-MVP",
                      "wschamp":"WS",
                      "hof":"HOF"
                    } %}
                    {% for k in award_year_map[y] %}
                      <span class="acc-pill acc-{{ k }}">
                        {{ award_labels[k] if award_labels[k] is defined else k|upper }}
                      </span>
                    {% endfor %}
                  {% endif %}
                </td>
              </tr>

              {% if has_parts %}
                {% for p in g.parts %}
                  {% set ps = p.stat %}
                  {% set rk2 = g.year ~ ':' ~ p.team %}
                  <tr class="ychild ychild-pitching ychild-{{ g.year }}" style="display:none; opacity:.92;">
                    <td style="white-space:nowrap; padding-left:16px;">{{ p.year }}</td>
                    <td style="white-space:nowrap;">{{ p.team }}</td>
                    <td>{{ ps.gamesPitched or "—" }}</td>
                    <td>{{ stat_cell(ps.gamesStarted or "—", (yby_bg_pitching.get(rk2) or {}).get('gamesStarted')) }}</td>
                    <td>{{ stat_cell(ps.inningsPitched or "—", (yby_bg_pitching.get(rk2) or {}).get('inningsPitched')) }}</td>
                    <td>{{ stat_cell(ps.wins or "—", (yby_bg_pitching.get(rk2) or {}).get('wins')) }}</td>
                    <td>{{ stat_cell(ps.losses or "—", (yby_bg_pitching.get(rk2) or {}).get('losses')) }}</td>
                    <td>{{ stat_cell(ps.saves or "—", (yby_bg_pitching.get(rk2) or {}).get('saves')) }}</td>
                    <td>{{ stat_cell(ps.strikeOuts or "—", (yby_bg_pitching.get(rk2) or {}).get('strikeOuts')) }}</td>
                    <td>{{ stat_cell(ps.era or "—", (yby_bg_pitching.get(rk2) or {}).get('era')) }}</td>
                    <td>{{ stat_cell(ps.whip or "—", (yby_bg_pitching.get(rk2) or {}).get('whip')) }}</td>
                    <td></td>
                  </tr>
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}

        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {% if (not has_hitting) and (not has_pitching) %}
    <div class="card" style="margin-top:14px;">
      <div class="card-body">
        <div class="muted">No year-by-year rows available.</div>
      </div>
    </div>
  {% endif %}
</div>

<!-- =======================
     Game Logs
     ======================= -->
<div id="tab-gamelog" class="tab-panel">
  <div class="card">
    <div class="card-header" style="align-items:center;">
      <div>
        <div class="card-title">Game Logs</div>
        <div class="card-subtitle">Season selector loads one year at a time.</div>
      </div>
      <form method="get" action="/player/{{ bio.id }}" style="display:flex; gap:8px; align-items:center;">
        <select name="log_year" class="season-select">
          {% for y in years %}
            <option value="{{ y }}" {% if y == log_year %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
        <button class="btn" type="submit">Load</button>
      </form>
    </div>

    <div class="card-body">
      {% if role != "pitching" %}
        <div class="subcard-title">Hitting</div>
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Opponent</th>
                <th class="num">AB</th>
                <th class="num">H</th>
                <th class="num">2B</th>
                <th class="num">3B</th>
                <th class="num">HR</th>
                <th class="num">RBI</th>
                <th class="num">R</th>
                <th class="num">BB</th>
                <th class="num">SO</th>
              </tr>
            </thead>
            <tbody>
              {% for g in (game_logs.hitting or []) %}
                {% set s = g.stat or {} %}
                <tr>
                  <td>{{ g.date }}</td>
                  <td>{{ g.opponent }}</td>
                  <td class="num">{{ s.get('atBats','') }}</td>
                  <td class="num">{{ s.get('hits','') }}</td>
                  <td class="num">{{ s.get('doubles','') }}</td>
                  <td class="num">{{ s.get('triples','') }}</td>
                  <td class="num">{{ s.get('homeRuns','') }}</td>
                  <td class="num">{{ s.get('rbi','') }}</td>
                  <td class="num">{{ s.get('runs','') }}</td>
                  <td class="num">{{ s.get('baseOnBalls','') }}</td>
                  <td class="num">{{ s.get('strikeOuts','') }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}

      {% if role != "hitting" %}
        <div class="subcard-title" style="margin-top:16px;">Pitching</div>
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Opponent</th>
                <th class="num">IP</th>
                <th class="num">H</th>
                <th class="num">R</th>
                <th class="num">ER</th>
                <th class="num">BB</th>
                <th class="num">SO</th>
                <th class="num">HR</th>
              </tr>
            </thead>
            <tbody>
              {% for g in (game_logs.pitching or []) %}
                {% set s = g.stat or {} %}
                <tr>
                  <td>{{ g.date }}</td>
                  <td>{{ g.opponent }}</td>
                  <td class="num">{{ s.get('inningsPitched','') }}</td>
                  <td class="num">{{ s.get('hits','') }}</td>
                  <td class="num">{{ s.get('runs','') }}</td>
                  <td class="num">{{ s.get('earnedRuns','') }}</td>
                  <td class="num">{{ s.get('baseOnBalls','') }}</td>
                  <td class="num">{{ s.get('strikeOuts','') }}</td>
                  <td class="num">{{ s.get('homeRuns','') }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- =======================
     Transactions
     ======================= -->
<div id="tab-tx" class="tab-panel">
  <div class="card">
    <div class="card-header">
      <div class="card-title">Transactions</div>
      <div class="card-subtitle">Entire history • newest first.</div>
    </div>
    <div class="card-body">
      {% if transactions and transactions|length %}
        <div class="tx-list">
          {% for t in transactions %}
            <div class="tx-row">
              <div class="tx-date">{{ t.date }}</div>
              <div class="tx-desc">{{ t.description }}</div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="muted">No transactions found.</div>
      {% endif %}
    </div>
  </div>
</div>

<!-- =======================
     Scouting Report + Spray
     ======================= -->
<div id="tab-scouting" class="tab-panel">
  {% set _hg = (hitting_groups if hitting_groups is defined else []) %}
  {% set _pg = (pitching_groups if pitching_groups is defined else []) %}
  {% set has_hitting = (_hg|length) > 0 %}
  {% set has_pitching = (_pg|length) > 0 %}
  {% set is_two_way = has_hitting and has_pitching %}

  <div class="card">
    <div class="card-header" style="align-items:center; justify-content:space-between; gap:10px;">
      <div>
        <div class="card-title">Scouting Report</div>
        <div class="card-subtitle">Statcast-style percentiles • Basenerd theme</div>
      </div>

      <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        {% if season_found %}
          <div class="sr-pill">Season {{ season_found }}</div>
        {% endif %}

        {% if is_two_way %}
          <label style="display:flex; flex-direction:column; gap:2px;">
            <span class="mono" style="font-size:11px; opacity:.75;">View</span>
            <select id="srModeSelect" class="season-select">
              <option value="hitting">Hitting</option>
              <option value="pitching">Pitching</option>
            </select>
          </label>
        {% endif %}
      </div>
    </div>

    <div class="card-body">

      <!-- ============================
           HITTING VIEW (UNCHANGED)
           ============================ -->
      <div id="srHittingView" style="{% if (not has_hitting) and has_pitching %}display:none;{% endif %}">
        <div class="sr-two-col">

          <!-- LEFT: sliders/bars -->
          <div>
            {% if savant_profile and savant_profile.available %}
              <div class="sr-wrap">
                {% for g in savant_profile.groups %}
                  <div>
                    <div class="sr-group-title">{{ g.title }}</div>

                    <div class="sr-grid">
                      {% for r in g.rows %}
                        <div class="sr-row">
                          <div class="sr-label mono">{{ r.label }}</div>

                          <div class="sr-bar" title="{{ r.label }}">
                            {% if r.pct is not none %}
                              <div class="sr-fill" style="width: {{ r.pct }}%; background: {{ sr_color(r.pct) }};"></div>
                            {% endif %}

                            {% if r.pct is not none %}
                              {% set p = r.pct %}
                              <div class="sr-marker" style="left: {{ p }}%;">
                                <span>{{ p }}</span>
                              </div>
                            {% else %}
                              <div class="sr-marker" style="left: 0; opacity:.55;">
                                <span>—</span>
                              </div>
                            {% endif %}
                          </div>

                          <div class="sr-value">
                            {% if r.value is none %}
                              —
                            {% else %}
                              {% if r.fmt == "pct" %}
                                {{ (r.value * 100)|round(1) }}{{ r.suffix if r.suffix is defined else "" }}
                              {% elif r.fmt == "float1" %}
                                {{ r.value|round(1) }}{{ r.suffix if r.suffix is defined else "" }}
                              {% elif r.fmt == "float3" %}
                                {{ r.value|round(3) }}{{ r.suffix if r.suffix is defined else "" }}
                              {% else %}
                                {{ r.value }}{{ r.suffix if r.suffix is defined else "" }}
                              {% endif %}
                            {% endif %}
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                {% endfor %}

                <div class="sr-muted mono">
                  Percentiles are computed within season pool • colors: blue (low) → gray (avg) → red (high).
                </div>
              </div>
            {% else %}
              <div class="muted">No Statcast percentile data available.</div>
            {% endif %}
          </div>

          <!-- RIGHT: Spray chart -->
          <div>
            <div class="card" style="margin:0;">
              <div class="card-header">
                <div class="card-title">Spray Chart</div>
                <div class="card-subtitle">Hits only • Stadium overlay</div>
              </div>

              <div class="card-body">

                <div class="spray-controls">
                  <label><input type="checkbox" id="sprSingle" checked> Single</label>
                  <label><input type="checkbox" id="sprDouble" checked> Double</label>
                  <label><input type="checkbox" id="sprTriple" checked> Triple</label>
                  <label><input type="checkbox" id="sprHR" checked> HR</label>
                  <label><input type="checkbox" id="sprOther" checked> Other</label>
                </div>

                <div class="spray-wrap">
                  <svg id="spraySvg" class="spray-svg" viewBox="0 0 250 230" preserveAspectRatio="xMidYMid meet">
                    <image href="/static/stadiums/{{ stadium_svg|default('generic.svg') }}" x="0" y="0" width="250" height="230" opacity="1"></image>
                    <g id="sprayDots"></g>
                  </svg>
                </div>

                <div class="spray-legend">
                  <span class="spray-key"><span class="spray-swatch" style="background:#10b981;"></span> 1B</span>
                  <span class="spray-key"><span class="spray-swatch" style="background:#3b82f6;"></span> 2B</span>
                  <span class="spray-key"><span class="spray-swatch" style="background:#a855f7;"></span> 3B</span>
                  <span class="spray-key"><span class="spray-swatch" style="background:#ef4444;"></span> HR</span>
                  <span class="spray-key"><span class="spray-swatch" style="background:#f59e0b;"></span> Other Hit</span>
                </div>

                <div class="spray-note">
                  MLBAM-style coords scaled into stadium viewBox. Home plate baseline ≈ (125, 199). Stadium SVG: {{ stadium_svg|default('generic.svg') }}.
                </div>
              </div>

            </div>
          </div>

        </div>
      </div>

      <!-- ============================
           PITCHING VIEW (NEW)
           ============================ -->
      <div id="srPitchingView" style="{% if (has_hitting and not has_pitching) %}display:none;{% elif has_pitching %}display:block;{% else %}display:none;{% endif %}">
        <div style="display:flex; flex-direction:column; gap:12px;">

          <!-- Controls (no refresh button) -->
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; justify-content:space-between; border:1px solid rgba(226,232,240,.9); border-radius:12px; padding:10px 12px; background:#fff;">
            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
              <label>
                <div class="mono" style="font-size:11px; opacity:.75;">Season</div>
                <select id="pitchSeason" class="season-select">
                  {% for y in years %}
                    <option value="{{ y }}" {% if season_found and (y|string) == (season_found|string) %}selected{% endif %}>{{ y }}</option>
                  {% endfor %}
                </select>
              </label>

              <label>
                <div class="mono" style="font-size:11px; opacity:.75;">Game</div>
                <select id="pitchGame" class="season-select">
                  <option value="">All games</option>
                </select>
              </label>
            </div>

            <div class="mono" id="pitchStatus" style="font-size:11px; opacity:.75;">Ready</div>
          </div>

          <!-- Basic stats (season/game) -->
          <div id="pitchBasicCard" style="border:1px solid rgba(226,232,240,.9); border-radius:12px; background:#fff; overflow:hidden;">
            <div style="padding:10px 12px; border-bottom:1px solid rgba(226,232,240,.9); display:flex; justify-content:space-between; align-items:center;">
              <div style="font-weight:900;">Basic Line</div>
              <div class="mono" id="pitchBasicSub" style="font-size:11px; opacity:.75;">Season / Game</div>
            </div>
            <div id="pitchBasicBody" style="padding:10px 12px;">
              <div class="muted">Loading…</div>
            </div>
          </div>

          <!-- Arsenal + shapes -->
          <div style="display:grid; grid-template-columns: 1.1fr .9fr; gap:12px; align-items:start;">
            <div style="border:1px solid rgba(226,232,240,.9); border-radius:12px; background:#fff; overflow:hidden;">
              <div style="padding:10px 12px; border-bottom:1px solid rgba(226,232,240,.9); display:flex; align-items:center; justify-content:space-between;">
                <div style="font-weight:900;">Pitch Arsenal</div>
                <div class="mono" style="font-size:11px; opacity:.75;">Usage • Velo • Break • Spin • xwOBA</div>
              </div>
              <div style="padding:10px 12px; overflow:auto;">
                <table class="table" style="min-width:680px;">
                  <thead>
                    <tr>
                      <th>Pitch</th>
                      <th class="num">N</th>
                      <th class="num">Use%</th>
                      <th class="num">Velo</th>
                      <th class="num">HB</th>
                      <th class="num">IVB</th>
                      <th class="num">Spin</th>
                      <th class="num">xwOBA</th>
                      <th class="num">Whiff%</th>
                    </tr>
                  </thead>
                  <tbody id="arsenalBody">
                    <tr><td colspan="9" class="muted">Loading…</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div style="border:1px solid rgba(226,232,240,.9); border-radius:12px; background:#fff; overflow:hidden;">
              <div style="padding:10px 12px; border-bottom:1px solid rgba(226,232,240,.9); display:flex; align-items:center; justify-content:space-between;">
                <div style="font-weight:900;">Notes</div>
                <div class="mono" style="font-size:11px; opacity:.75;">Primary pitch summary</div>
              </div>
              <div style="padding:10px 12px;">
                <div id="pitchNotes" class="mono" style="font-size:12px; line-height:1.45; color:#111827;">—</div>
              </div>
            </div>
          </div>


          <!-- Pitch Usage (vs. LHH / vs. RHH) -->
          <div id="pitchUsageSplitCard" style="border:1px solid rgba(226,232,240,.9); border-radius:12px; background:#fff; overflow:hidden; display:none;">
            <div style="padding:10px 12px; border-bottom:1px solid rgba(226,232,240,.9); display:flex; align-items:center; justify-content:space-between;">
              <div style="font-weight:900;">Pitch Usage</div>
              <div class="mono" style="font-size:11px; opacity:.75;">vs. LHH / vs. RHH</div>
            </div>
            <div style="padding:10px 12px;">
              <div id="pitchUsageSplitBody" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;"></div>
            </div>
          </div>

          <!-- Break scatter + movement -->
          <div style="border:1px solid rgba(226,232,240,.9); border-radius:12px; background:#fff; overflow:hidden;">
            <div style="padding:10px 12px; border-bottom:1px solid rgba(226,232,240,.9); display:flex; align-items:center; justify-content:space-between;">
                <div style="font-weight:900;">Movement Profile (Induced Break)</div>
                <div class="mono" style="font-size:11px; opacity:.75;">Arm-side / Glove-side vs Rise / Drop (in)</div>
              </div>
              <div style="padding:10px 12px;">
                <canvas id="breakCanvas" width="520" height="360" style="width:100%; max-width:100%; border:1px solid rgba(226,232,240,.9); border-radius:12px; background:linear-gradient(180deg, rgba(246,248,251,1), rgba(238,242,247,.95));"></canvas>
                <div class="mono" style="font-size:11px; opacity:.75; margin-top:8px;">
                  Circles: 12/18/24 in • Dots = pitch types (size ~ pitch count)
                </div>
              </div>
          </div>

          <!-- Heatmaps -->
          <div style="border:1px solid rgba(226,232,240,.9); border-radius:12px; background:#fff; overflow:hidden;">
            <div style="padding:10px 12px; border-bottom:1px solid rgba(226,232,240,.9); display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px;">
              <div>
                <div style="font-weight:900;">Pitch Location Heatmaps</div>
                <div class="mono" style="font-size:11px; opacity:.75;">KDE-style blur • fixed zone • catcher POV</div>
              </div>

              <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
                <label>
                  <div class="mono" style="font-size:11px; opacity:.75;">Pitch</div>
                  <select id="heatPitchType" class="season-select"></select>
                </label>

                <label>
                  <div class="mono" style="font-size:11px; opacity:.75;">Metric</div>
                  <select id="heatMetric" class="season-select">
                    <option value="density">Density</option>
                    <option value="xwoba">xwOBA</option>
                  </select>
                </label>
              </div>
            </div>

            <div style="padding:10px 12px; display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
              <div>
                <div class="mono" style="font-size:11px; opacity:.75; font-weight:900; margin-bottom:6px;">vs. LHH</div>
                <canvas id="heatL" width="420" height="420" style="width:100%; border:1px solid rgba(226,232,240,.9); border-radius:12px; background:#fff;"></canvas>
              </div>
              <div>
                <div class="mono" style="font-size:11px; opacity:.75; font-weight:900; margin-bottom:6px;">vs. RHH</div>
                <canvas id="heatR" width="420" height="420" style="width:100%; border:1px solid rgba(226,232,240,.9); border-radius:12px; background:#fff;"></canvas>
              </div>
            </div>

            <div style="padding:0 12px 12px;">
              <div class="mono" style="font-size:11px; opacity:.75;">
                Zone: left {{ -0.83 }} / right {{ 0.83 }} • bot {{ 1.5946|round(3) }} / top {{ 3.3943|round(3) }} • Domain: X [-2,2], Z [0,5]
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>

<script>
(function(){
  // ---- Tabs ----
  const buttons = document.querySelectorAll(".tab-btn");
  const panels = document.querySelectorAll(".tab-panel");

  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      buttons.forEach(b => b.classList.remove("active"));
      panels.forEach(p => p.classList.remove("active"));

      btn.classList.add("active");
      const id = btn.dataset.tab;
      const panel = document.getElementById(id);
      if(panel) panel.classList.add("active");
    });
  });

  // ---- Year-by-year expanders ----
  document.querySelectorAll(".yexp").forEach(btn => {
    btn.addEventListener("click", () => {
      const year = btn.dataset.year;
      const kind = btn.dataset.kind;

      btn.classList.toggle("open");
      const open = btn.classList.contains("open");

      document.querySelectorAll(`.ychild-${kind}.ychild-${year}`).forEach(row => {
        row.style.display = open ? "table-row" : "none";
      });
    });
  });

  // ---- Spray chart ----
  const sprayDots = document.getElementById("sprayDots");
  const sprSingle = document.getElementById("sprSingle");
  const sprDouble = document.getElementById("sprDouble");
  const sprTriple = document.getElementById("sprTriple");
  const sprHR = document.getElementById("sprHR");
  const sprOther = document.getElementById("sprOther");

  function allowedTypes(){
    const allow = new Set();
    if(sprSingle && sprSingle.checked) allow.add("single");
    if(sprDouble && sprDouble.checked) allow.add("double");
    if(sprTriple && sprTriple.checked) allow.add("triple");
    if(sprHR && sprHR.checked) allow.add("home_run");
    if(sprOther && sprOther.checked) allow.add("other");
    return allow;
  }

  function hitColor(t){
    if(t === "single") return "#10b981";
    if(t === "double") return "#3b82f6";
    if(t === "triple") return "#a855f7";
    if(t === "home_run") return "#ef4444";
    return "#f59e0b";
  }

  function renderSpray(points){
    if(!sprayDots) return;
    sprayDots.innerHTML = "";
    const allow = allowedTypes();

    for(const p of (points || [])){
      if(!allow.has(p.type)) continue;
      const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
      c.setAttribute("cx", p.x);
      c.setAttribute("cy", p.y);
      c.setAttribute("r", 4);
      c.setAttribute("fill", hitColor(p.type));
      c.setAttribute("opacity", "0.92");
      c.setAttribute("stroke", "rgba(0,0,0,.18)");
      c.setAttribute("stroke-width", "1");
      sprayDots.appendChild(c);
    }
  }

  // You already populate spray_points in app.py, so keep existing behavior.
  // This template expects `spray_points` variable (list of scaled points).
  try{
    const points = {{ (spray_points if spray_points is defined else [])|tojson }};
    renderSpray(points);
  }catch(e){ /* ignore */ }

  [sprSingle, sprDouble, sprTriple, sprHR, sprOther].forEach(el => {
    if(el) el.addEventListener("change", () => {
      try{
        const points = {{ (spray_points if spray_points is defined else [])|tojson }};
        renderSpray(points);
      }catch(e){}
    });
  });

  // ============================
  // Pitching report client
  // ============================
  const playerId = {{ bio.id }};
  const pitchSeasonSel = document.getElementById("pitchSeason");
  const pitchGameSel = document.getElementById("pitchGame");
  const statusEl = document.getElementById("pitchStatus");

  const basicBody = document.getElementById("pitchBasicBody");
  const basicSub  = document.getElementById("pitchBasicSub");

  const arsenalBody = document.getElementById("arsenalBody");
  const pitchNotes = document.getElementById("pitchNotes");

  const breakCanvas = document.getElementById("breakCanvas");

  const heatPitchTypeSel = document.getElementById("heatPitchType");
  const heatMetricSel = document.getElementById("heatMetric");
  const heatL = document.getElementById("heatL");
  const heatR = document.getElementById("heatR");

  const modeSel = document.getElementById("srModeSelect");
  const hitView = document.getElementById("srHittingView");
  const pitView = document.getElementById("srPitchingView");

  const isTwoWay = {{ 'true' if is_two_way else 'false' }};
  const hasHitting = {{ 'true' if has_hitting else 'false' }};
  const hasPitching = {{ 'true' if has_pitching else 'false' }};

  function setStatus(s){ if(statusEl) statusEl.textContent = s; }

  function fmt1(x){
    if(x==null || !isFinite(Number(x))) return "—";
    return Number(x).toFixed(1);
  }
  function fmt0(x){
    if(x==null || !isFinite(Number(x))) return "—";
    return String(Math.round(Number(x)));
  }
  function fmt3(x){
    if(x==null || !isFinite(Number(x))) return "—";
    return Number(x).toFixed(3);
  }

  async function getJSON(url){
    const r = await fetch(url, {credentials:"same-origin"});
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
  }

  async function loadGames(season){
    if(!pitchGameSel) return;
    pitchGameSel.innerHTML = `<option value="">All games</option>`;

    try{
      const data = await getJSON(`/player/${playerId}/pitching_games.json?season=${encodeURIComponent(season)}`);
      const games = (data && data.games) ? data.games : [];
      for(const g of games){
        const opt = document.createElement("option");
        opt.value = String(g.game_pk);
        opt.textContent = `${g.date} vs ${g.opp || ""}`.trim();
        pitchGameSel.appendChild(opt);
      }
    }catch(e){
      // keep "All games"
    }
  }

  async function findMostRecentPitchSeason(){
    const years = Array.from(pitchSeasonSel ? pitchSeasonSel.options : []).map(o => Number(o.value)).filter(Boolean);
    years.sort((a,b)=>b-a);
    for(const y of years){
      try{
        await loadGames(y);
        // If loadGames worked and games exist, prefer that season; otherwise, still try report
        const report = await getJSON(`/player/${playerId}/pitching_report.json?season=${encodeURIComponent(y)}`);
        if(report && report.ok && report.total && report.total > 0){
          return y;
        }
      }catch(e){}
    }
    return null;
  }

  function renderBasic(report){
    if(!basicBody) return;
    const b = report && report.basic ? report.basic : (report || {});
    const total = report && report.total ? report.total : 0;
    const season = report && report.season ? report.season : (pitchSeasonSel ? pitchSeasonSel.value : "");
    const gamePk = report && report.game_pk ? report.game_pk : "";

    if(basicSub){
      basicSub.textContent = gamePk ? `Season ${season} • Game ${gamePk}` : `Season ${season} • All games`;
    }

    basicBody.innerHTML = `
      <div style="display:flex; flex-wrap:wrap; gap:10px;">
        <div class="sr-pill">Pitches: ${fmt0(total)}</div>
        <div class="sr-pill">K%: ${b.k_pct != null ? fmt1(b.k_pct) + "%" : "—"}</div>
        <div class="sr-pill">BB%: ${b.bb_pct != null ? fmt1(b.bb_pct) + "%" : "—"}</div>
        <div class="sr-pill">Whiff%: ${b.whiff_pct != null ? fmt1(b.whiff_pct) + "%" : "—"}</div>
        <div class="sr-pill">Chase%: ${b.chase_pct != null ? fmt1(b.chase_pct) + "%" : "—"}</div>
        <div class="sr-pill">xwOBA: ${b.xwoba != null ? fmt3(b.xwoba) : "—"}</div>
      </div>
    `;
  }

  function renderArsenal(report){
    if(!arsenalBody) return;
    const mix = (report && report.mix) ? report.mix : [];
    const total = mix.reduce((a,r)=>a+(r.n||0),0) || 0;

    if(!mix.length){
      arsenalBody.innerHTML = `<tr><td colspan="9" class="muted">No pitches found for this selection.</td></tr>`;
      if(pitchNotes) pitchNotes.textContent = "—";
      return;
    }

    arsenalBody.innerHTML = mix.map(r => {
      const pt = (r.pitch_type || "UNK");
      const usage = (total ? ((r.n||0)/total*100) : (r.usage||0));
      const hb_in = (r.hb==null) ? null : Number(r.hb) * 12.0;
      const vb_in = (r.vb==null) ? null : Number(r.vb) * 12.0;

      return `
        <tr>
          <td style="font-weight:900;">${pt}</td>
          <td class="num mono">${fmt0(r.n)}</td>
          <td class="num mono">${fmt1(usage)}</td>
          <td class="num mono">${fmt1(r.velo)}</td>
          <td class="num mono">${fmt1(hb_in)}</td>
          <td class="num mono">${fmt1(vb_in)}</td>
          <td class="num mono">${fmt0(r.spin)}</td>
          <td class="num mono">${fmt3(r.xwoba)}</td>
          <td class="num mono">${fmt1(r.whiff_pct)}</td>
        </tr>
      `;
    }).join("");

    const pts = mix.map(r => ({ pt: r.pitch_type || "UNK", name: r.pitch_name || r.pitch_type || "UNK", n: r.n || 0 }))
                  .sort((a,b)=> (b.n||0)-(a.n||0));
    if(heatPitchTypeSel){
      heatPitchTypeSel.innerHTML = pts.map(p => `<option value="${p.pt}">${p.name}</option>`).join("");
    }

    const top = pts[0];
    const topRow = mix.find(x => (x.pitch_type||"UNK") === (top ? top.pt : ""));
    if(topRow && pitchNotes){
      const hb = (topRow.hb==null) ? null : topRow.hb*12.0;
      const vb = (topRow.vb==null) ? null : topRow.vb*12.0;
      pitchNotes.innerHTML = `
        <div><b>Primary:</b> ${topRow.pitch_name || topRow.pitch_type} (${fmt1(topRow.usage)}% usage)</div>
        <div><b>Shape:</b> HB ${fmt1(hb)} in • IVB ${fmt1(vb)} in • Velo ${fmt1(topRow.velo)} mph</div>
        <div><b>Result:</b> xwOBA ${fmt3(topRow.xwoba)} • Whiff% ${fmt1(topRow.whiff_pct)}</div>
      `;
    }else if(pitchNotes){
      pitchNotes.textContent = "—";
    }
  }

  function renderUsageSplit(report){
    const card = document.getElementById("pitchUsageSplitCard");
    const body = document.getElementById("pitchUsageSplitBody");
    if(!card || !body) return;

    const split = report && (report.usage_split || report.usage_by_stand || null);
    if(!split || (!split.L && !split.R)){
      card.style.display = "none";
      body.innerHTML = "";
      return;
    }

    const PITCH_COLORS = {
      "FF":"#d9534f","FT":"#f0ad4e","SI":"#f0ad4e","FC":"#5bc0de",
      "SL":"#ffd54f","ST":"#ffd54f","SV":"#9b59b6","CU":"#5dade2",
      "KC":"#5dade2","CH":"#5cb85c","FS":"#5cb85c","KN":"#95a5a6"
    };

    function pctFmt(x){
      if(x == null || !isFinite(Number(x))) return "—";
      return (Math.round(Number(x)) + "%");
    }

    function pill(pt){
      const c = PITCH_COLORS[pt] || "#94a3b8";
      return `<span style="
        display:inline-flex; align-items:center; justify-content:center;
        min-width:22px; height:22px; padding:0 7px;
        border-radius:999px; font-weight:900; font-size:11px;
        border:1px solid rgba(15,23,42,.12); background:${c}; color:#0b1220;
        font-family: \"IBM Plex Mono\", ui-monospace, Menlo, monospace;
      ">${pt}</span>`;
    }

    function renderSide(label, rows){
      const sorted = (rows || []).slice().sort((a,b)=>(b.pct||0)-(a.pct||0));
      if(!sorted.length) return `<div style="padding:10px; border:1px solid rgba(226,232,240,.9); border-radius:12px; background:#fff;">
        <div class="mono" style="font-size:11px; opacity:.75; font-weight:900; margin-bottom:6px;">${label}</div>
        <div class="muted" style="font-size:12px;">No data</div>
      </div>`;

      const items = sorted.map(r => {
        const pt = (r.pitch_type || r.pt || "UNK").toString();
        const p = Number(r.pct ?? r.usage ?? 0);
        return `<div style="display:flex; align-items:center; gap:8px; margin:6px 0;">
          ${pill(pt)}
          <div class="mono" style="font-size:12px; font-weight:900;">${pctFmt(p)}</div>
        </div>`;
      }).join("");

      return `<div style="padding:10px; border:1px solid rgba(226,232,240,.9); border-radius:12px; background:#fff;">
        <div class="mono" style="font-size:11px; opacity:.75; font-weight:900; margin-bottom:6px;">${label}</div>
        ${items}
      </div>`;
    }

    body.innerHTML = renderSide("vs. LHH", split.L) + renderSide("vs. RHH", split.R);
    card.style.display = "block";
  }

  function renderBreakChart(report){
    const ctx = breakCanvas.getContext("2d");
    const W = breakCanvas.width, H = breakCanvas.height;
    ctx.clearRect(0,0,W,H);

    // background
    ctx.fillStyle = "rgba(255,255,255,1)";
    ctx.fillRect(0,0,W,H);

    const pad = 26;
    const size = Math.min(W, H) - pad*2;
    const cx = W/2;
    const cy = H/2;
    const R = size/2;

    // grid rings (12/18/24)
    const rings = [12,18,24];
    const maxV = 24;

    ctx.strokeStyle = "rgba(15,23,42,.12)";
    ctx.lineWidth = 1;

    for(const r of rings){
      const rr = (r/maxV) * R;
      ctx.beginPath();
      ctx.arc(cx, cy, rr, 0, Math.PI*2);
      ctx.stroke();
    }

    // crosshairs
    ctx.beginPath();
    ctx.moveTo(cx-R, cy); ctx.lineTo(cx+R, cy);
    ctx.moveTo(cx, cy-R); ctx.lineTo(cx, cy+R);
    ctx.stroke();

    // labels
    ctx.fillStyle = "rgba(15,23,42,.70)";
    ctx.font = "12px ui-monospace, Menlo, monospace";
    ctx.textAlign = "center";
    ctx.fillText("MORE RISE", cx - R + 40, cy - R + 14);
    ctx.fillText("MORE DROP", cx - R + 40, cy + R - 6);

    ctx.textAlign = "center";
    ctx.fillText("MOVES TOWARD 1B", cx - R + 92, cy - R + 30);

    ctx.textAlign = "center";
    ctx.fillText("MOVES TOWARD 3B", cx + R - 92, cy - R + 30);

    // ring numbers
    ctx.fillStyle = "rgba(15,23,42,.55)";
    ctx.textAlign = "left";
    for(const r of rings){
      const rr = (r/maxV) * R;
      ctx.fillText(`${r}"`, cx + 6, cy - rr + 4);
    }

    // points (from report.shapes)
    const shapes = (report && report.shapes) ? report.shapes : [];
    if(!shapes.length) return;

    const PITCH_COLORS = {
      "FF":"#d9534f","FT":"#f0ad4e","SI":"#f0ad4e","FC":"#5bc0de",
      "SL":"#ffd54f","ST":"#ffd54f","SV":"#9b59b6","CU":"#5dade2",
      "KC":"#5dade2","CH":"#5cb85c","FS":"#5cb85c","KN":"#95a5a6"
    };

    // scale feet->inches, clamp to chart
    function toXY(hb_ft, vb_ft){
      const hb = (hb_ft==null) ? null : Number(hb_ft) * 12.0;
      const vb = (vb_ft==null) ? null : Number(vb_ft) * 12.0;
      if(hb==null || vb==null || !isFinite(hb) || !isFinite(vb)) return null;
      const x = Math.max(-maxV, Math.min(maxV, hb));
      const y = Math.max(-maxV, Math.min(maxV, vb));
      // canvas: +x right, +y up
      return {
        x: cx + (x/maxV)*R,
        y: cy - (y/maxV)*R,
        hb, vb
      };
    }

    // draw dots (largest first)
    const ordered = shapes.slice().sort((a,b)=>(b.n||0)-(a.n||0));
    const nmax = Math.max(1, ...ordered.map(d=>d.n||1));

    for(const d of ordered){
      const pt = (d.pitch_type || "UNK").toString();
      const xy = toXY(d.pfx_x, d.pfx_z);
      if(!xy) continue;

      const t = (d.n||0) / nmax;
      const rad = 6 + 10*t;

      ctx.beginPath();
      ctx.fillStyle = (PITCH_COLORS[pt] || "#94a3b8");
      ctx.globalAlpha = 0.92;
      ctx.arc(xy.x, xy.y, rad, 0, Math.PI*2);
      ctx.fill();

      ctx.globalAlpha = 1;
      ctx.lineWidth = 2;
      ctx.strokeStyle = "rgba(255,255,255,.95)";
      ctx.stroke();

      // tiny label
      ctx.fillStyle = "rgba(15,23,42,.85)";
      ctx.font = "11px ui-monospace, Menlo, monospace";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(pt, xy.x, xy.y);
    }
  }

  function renderHeatmap(canvas, payload, metric){
    const ctx = canvas.getContext("2d");
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,W,H);

    if(!payload || !payload.grid){
      // draw zone only
      drawZone(ctx, payload && payload.zone ? payload.zone : null, W, H);
      return;
    }

    const grid = payload.grid;
    const nx = payload.nx, nz = payload.nz;
    const xMin = payload.x_min, xMax = payload.x_max;
    const zMin = payload.z_min, zMax = payload.z_max;

    // find min/max for color scale
    let vmin = Infinity, vmax = -Infinity;
    for(let iz=0; iz<nz; iz++){
      for(let ix=0; ix<nx; ix++){
        const v = grid[iz][ix];
        if(v == null) continue;
        if(v < vmin) vmin = v;
        if(v > vmax) vmax = v;
      }
    }
    if(!isFinite(vmin) || !isFinite(vmax) || vmax === vmin){
      drawZone(ctx, payload.zone, W, H);
      return;
    }

    // blue->gray->red
    function srRGB(t){
      t = Math.max(0, Math.min(1, t));
      // 0..0.5 : blue->gray ; 0.5..1 : gray->red
      if(t <= 0.5){
        const u = t/0.5;
        const r = Math.round(37  + (229-37)*u);
        const g = Math.round(99  + (231-99)*u);
        const b = Math.round(235 + (235-235)*u);
        return [r,g,b];
      }else{
        const u = (t-0.5)/0.5;
        const r = Math.round(229 + (239-229)*u);
        const g = Math.round(231 + (68-231)*u);
        const b = Math.round(235 + (68-235)*u);
        return [r,g,b];
      }
    }

    // draw pixels (bilinear-ish)
    const img = ctx.createImageData(W,H);
    for(let py=0; py<H; py++){
      const z = zMax - (py/(H-1))*(zMax-zMin);
      const fz = (z - zMin)/(zMax - zMin) * (nz-1);
      const iz = Math.max(0, Math.min(nz-1, Math.round(fz)));

      for(let px=0; px<W; px++){
        const x = xMin + (px/(W-1))*(xMax-xMin);
        const fx = (x - xMin)/(xMax - xMin) * (nx-1);
        const ix = Math.max(0, Math.min(nx-1, Math.round(fx)));

        const v = grid[iz][ix];
        const t = (v - vmin)/(vmax - vmin);
        const [r,g,b] = srRGB(t);

        const i = (py*W + px)*4;
        img.data[i]   = r;
        img.data[i+1] = g;
        img.data[i+2] = b;
        img.data[i+3] = 230;
      }
    }
    ctx.putImageData(img,0,0);

    drawZone(ctx, payload.zone, W, H);
  }

  function drawZone(ctx, zone, W, H){
    if(!zone) return;
    const xMin = -2.0, xMax = 2.0;
    const zMin = 0.0, zMax = 5.0;

    const left = zone.left, right = zone.right;
    const top = zone.top, bot = zone.bot;

    const x0 = ((left - xMin)/(xMax-xMin))*W;
    const x1 = ((right - xMin)/(xMax-xMin))*W;
    const y0 = ((zMax - top)/(zMax-zMin))*H;
    const y1 = ((zMax - bot)/(zMax-zMin))*H;

    ctx.strokeStyle = "rgba(0,0,0,.85)";
    ctx.lineWidth = 2;
    ctx.strokeRect(x0,y0,x1-x0,y1-y0);
  }

  async function loadHeatmaps(){
    const pt = heatPitchTypeSel ? heatPitchTypeSel.value : "";
    const metric = heatMetricSel ? heatMetricSel.value : "density";
    const season = pitchSeasonSel ? Number(pitchSeasonSel.value) : null;
    const gamePk = pitchGameSel && pitchGameSel.value ? Number(pitchGameSel.value) : null;

    if(!pt || !season) return;

    const qp = `season=${encodeURIComponent(season)}&pitch_type=${encodeURIComponent(pt)}&metric=${encodeURIComponent(metric)}${gamePk ? `&game_pk=${encodeURIComponent(gamePk)}` : ""}`;

    const left = await getJSON(`/player/${playerId}/pitching_heatmap.json?${qp}&stand_lr=L`);
    const right = await getJSON(`/player/${playerId}/pitching_heatmap.json?${qp}&stand_lr=R`);

    renderHeatmap(heatL, left && left.ok ? left : null, metric);
    renderHeatmap(heatR, right && right.ok ? right : null, metric);
  }

  async function loadReportAndRender(){
    const season = pitchSeasonSel ? Number(pitchSeasonSel.value) : null;
    const gamePk = (pitchGameSel && pitchGameSel.value) ? Number(pitchGameSel.value) : null;

    setStatus("Loading pitching report…");

    const url = `/player/${playerId}/pitching_report.json?season=${encodeURIComponent(season)}${gamePk ? `&game_pk=${encodeURIComponent(gamePk)}` : ""}`;
    const report = await getJSON(url);

    if(!report || !report.ok){
      setStatus("No pitch data for this selection.");
      renderBasic(report || {});
      renderArsenal({mix:[]});
      renderUsageSplit(report || {});
      renderBreakChart({shapes:[]});
      if(heatPitchTypeSel) heatPitchTypeSel.innerHTML = "";
      renderHeatmap(heatL, null, "density");
      renderHeatmap(heatR, null, "density");
      return;
    }

    renderBasic(report);
    renderArsenal(report);
    renderUsageSplit(report);
    renderBreakChart(report);

    if(heatPitchTypeSel && heatPitchTypeSel.options.length){
      heatPitchTypeSel.value = heatPitchTypeSel.options[0].value;
    }

    setStatus(`Loaded ${report.total} pitches`);
    await loadHeatmaps();
  }

  let hasLoadedOnce = false;

  async function loadPitchingAll(){
    if(!pitchSeasonSel || !pitchGameSel) return;
    if(!pitView || pitView.style.display === "none") return;
    if(hasLoadedOnce) return;

    try{
      setStatus("Finding most recent season…");
      const bestSeason = await findMostRecentPitchSeason();
      if(!bestSeason){
        setStatus("No pitching seasons found.");
        if(arsenalBody) arsenalBody.innerHTML = `<tr><td colspan="9" class="muted">No pitches found for this player.</td></tr>`;
        if(pitchNotes) pitchNotes.textContent = "—";
        renderBasic({});
        renderHeatmap(heatL, null, "density");
        renderHeatmap(heatR, null, "density");
        return;
      }

      pitchSeasonSel.value = String(bestSeason);
      // loadGames(bestSeason) already ran inside findMostRecentPitchSeason and set dropdown; run again to be safe:
      await loadGames(bestSeason);

      setStatus(`Loading ${bestSeason}…`);
      await loadReportAndRender();
      setStatus("Ready");
      hasLoadedOnce = true;
    }catch(e){
      console.error(e);
      setStatus("Error loading pitching data.");
    }
  }

  if(pitchSeasonSel){
    pitchSeasonSel.addEventListener("change", async () => {
      try{
        setStatus("Loading season…");
        await loadGames(Number(pitchSeasonSel.value));
        await loadReportAndRender();
        setStatus("Ready");
      }catch(e){
        console.error(e);
        setStatus("Error loading season.");
      }
    });
  }

  if(pitchGameSel){
    pitchGameSel.addEventListener("change", async () => {
      try{
        await loadReportAndRender();
      }catch(e){
        console.error(e);
        setStatus("Error loading game.");
      }
    });
  }

  if(heatPitchTypeSel){
    heatPitchTypeSel.addEventListener("change", () => loadHeatmaps().catch(console.error));
  }
  if(heatMetricSel){
    heatMetricSel.addEventListener("change", () => loadHeatmaps().catch(console.error));
  }

  // Lazy-load pitching when Scouting tab opens (and pitching view is visible)
  document.querySelectorAll(".tab-btn").forEach(b => b.addEventListener("click", () => {
    if(b.dataset.tab === "tab-scouting"){
      if(isTwoWay){
        if(modeSel && modeSel.value === "pitching") loadPitchingAll();
      }else if(hasPitching && !hasHitting){
        loadPitchingAll();
      }
    }
  }));

  // Two-way toggle
  if(modeSel){
    modeSel.addEventListener("change", () => {
      if(modeSel.value === "pitching") loadPitchingAll();
    });
  }

  // If page loads with scouting already active
  const scoutingPanel = document.getElementById("tab-scouting");
  if(scoutingPanel && scoutingPanel.classList.contains("active")){
    if(isTwoWay){
      if(modeSel && modeSel.value === "pitching") loadPitchingAll();
    }else if(hasPitching && !hasHitting){
      loadPitchingAll();
    }
  }
})();
</script>

{% endblock %}
