{% extends "base.html" %}
{% block content %}

{# -----------------------
   helpers inside template
   ----------------------- #}
{% set headshot = "https://img.mlbstatic.com/mlb-photos/image/upload/w_540,q_100/v1/people/" ~ (bio.id|string) ~ "/headshot/67/current" %}

{% macro mini_cards(stat, kind) %}
  <div class="headline-grid">
    {% if kind == "pitching" %}
      {% for key, label in [
        ('wins','W'),('losses','L'),('era','ERA'),('whip','WHIP'),
        ('inningsPitched','IP'),('strikeOuts','SO'),
        ('saves','SV'),('holds','HLD'),
        ('gamesPlayed','G'),('gamesStarted','GS')
      ] %}
        {% if stat.get(key) is not none and stat.get(key) != '' %}
          <div class="headline-stat">
            <div class="k">{{ label }}</div>
            <div class="v">{{ stat.get(key) }}</div>
          </div>
        {% endif %}
      {% endfor %}
    {% else %}
      {% for key, label in [
        ('gamesPlayed','G'),('atBats','AB'),('hits','H'),('homeRuns','HR'),
        ('rbi','RBI'),('runs','R'),('stolenBases','SB'),
        ('avg','AVG'),('obp','OBP'),('slg','SLG'),('ops','OPS')
      ] %}
        {% if stat.get(key) is not none and stat.get(key) != '' %}
          <div class="headline-stat">
            <div class="k">{{ label }}</div>
            <div class="v">{{ stat.get(key) }}</div>
          </div>
        {% endif %}
      {% endfor %}
    {% endif %}
  </div>
{% endmacro %}

{% macro pick_stat_from_blocks(blocks, want_kind) %}
  {# want_kind: "hitting" or "pitching" #}
  {% for b in blocks or [] %}
    {% set g = ((b.get('group') or {}).get('displayName') or "") %}
    {% if want_kind == "hitting" and "Hitting" in g %}
      {% if b.splits and b.splits|length and b.splits[0].stat %}
        {{ mini_cards(b.splits[0].stat, "hitting") }}
      {% endif %}
    {% endif %}
    {% if want_kind == "pitching" and "Pitching" in g %}
      {% if b.splits and b.splits|length and b.splits[0].stat %}
        {{ mini_cards(b.splits[0].stat, "pitching") }}
      {% endif %}
    {% endif %}
  {% endfor %}
{% endmacro %}

<!-- =======================
     Header card (photo fills height)
     ======================= -->
<div class="card player-top">
  <div class="card-header player-header-card">
    <div class="player-header">
      <img class="player-headshot" src="{{ headshot }}" alt="{{ bio.fullName }}">

      <div class="player-meta">
        <div class="player-name">{{ bio.fullName }}</div>

        <div class="player-lines">
          <div class="muted">
            {% if bio.currentTeam and bio.currentTeam.name %}{{ bio.currentTeam.name }}{% endif %}
            {% if bio.primaryPosition and bio.primaryPosition.name %} • {{ bio.primaryPosition.name }}{% endif %}
          </div>

          {# Multi-lines to the right of photo. Hide if missing. #}
          {% if bio.currentAge or bio.height or bio.weight %}
            <div class="muted">
              {% if bio.currentAge %}Age {{ bio.currentAge }}{% endif %}
              {% if bio.height %}{% if bio.currentAge %} • {% endif %}{{ bio.height }}{% endif %}
              {% if bio.weight %}{% if bio.currentAge or bio.height %} • {% endif %}{{ bio.weight }} lb{% endif %}
            </div>
          {% endif %}

          {% if bio.batSide and bio.batSide.code or bio.pitchHand and bio.pitchHand.code %}
            <div class="muted">
              {% if bio.batSide and bio.batSide.code %}Bats: {{ bio.batSide.code }}{% endif %}
              {% if bio.pitchHand and bio.pitchHand.code %}{% if bio.batSide and bio.batSide.code %} • {% endif %}Throws: {{ bio.pitchHand.code }}{% endif %}
            </div>
          {% endif %}

          {% if bio.mlbDebutDate %}
            <div class="muted">MLB Debut: {{ bio.mlbDebutDate[:10] }}</div>
          {% endif %}

          {% if bio.birthCity or bio.birthStateProvince or bio.birthCountry %}
            <div class="muted">
              Born:
              {% if bio.birthCity %}{{ bio.birthCity }}{% endif %}
              {% if bio.birthStateProvince %}{% if bio.birthCity %}, {% endif %}{{ bio.birthStateProvince }}{% endif %}
              {% if bio.birthCountry %}{% if bio.birthCity or bio.birthStateProvince %} • {% endif %}{{ bio.birthCountry }}{% endif %}
            </div>
          {% endif %}

          {# Education & draft: hide if missing (per your rule) #}
          {% if bio.education %}
            <div class="muted">{{ bio.education }}</div>
          {% endif %}

          {% if bio.draftYear or bio.draftRound or bio.draftPickNumber %}
            <div class="muted">
              Draft:
              {% if bio.draftYear %}{{ bio.draftYear }}{% endif %}
              {% if bio.draftRound %}{% if bio.draftYear %} • {% endif %}R{{ bio.draftRound }}{% endif %}
              {% if bio.draftPickNumber %}{% if bio.draftYear or bio.draftRound %} • {% endif %}Pick {{ bio.draftPickNumber }}{% endif %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- =======================
     Season Snapshot
     ======================= -->
<div class="card">
  <div class="card-header">
    <div>
      <div class="card-title">{{ season_found if season_found else "—" }} Stats</div>
      <div class="card-subtitle">
        Falls back from current year until stats exist (stops at debut year).
      </div>
    </div>
  </div>

  <div class="card-body">
    {% if season_blocks and season_blocks|length %}
      {% if role == "two-way" %}
        <div style="margin-bottom:12px;">
          <div class="subcard-title">Hitting</div>
          {{ pick_stat_from_blocks(season_blocks, "hitting") }}
        </div>
        <div>
          <div class="subcard-title">Pitching</div>
          {{ pick_stat_from_blocks(season_blocks, "pitching") }}
        </div>
      {% elif role == "pitching" %}
        {{ pick_stat_from_blocks(season_blocks, "pitching") }}
      {% else %}
        {{ pick_stat_from_blocks(season_blocks, "hitting") }}
      {% endif %}
    {% else %}
      <div class="muted">No stats found.</div>
    {% endif %}
  </div>
</div>
<!-- =======================
     Career Stats
     ======================= -->
<div class="card">
  <div class="card-header">
    <div class="card-title">Career Stats</div>
  </div>

  <div class="card-body">
    {% if role == "two-way" %}
      {% if career_hitting %}
        <div style="margin-bottom:10px;">
          <div class="subcard-title">Hitting</div>
          {{ mini_cards(career_hitting, "hitting") }}
        </div>
      {% endif %}
      {% if career_pitching %}
        <div>
          <div class="subcard-title">Pitching</div>
          {{ mini_cards(career_pitching, "pitching") }}
        </div>
      {% endif %}
    {% elif role == "pitching" %}
      {{ mini_cards(career_pitching, "pitching") if career_pitching else "" }}
    {% else %}
      {{ mini_cards(career_hitting, "hitting") if career_hitting else "" }}
    {% endif %}
  </div>
</div>

<!-- ===== Tabs ===== -->
<div class="tabs" style="margin-top:12px;">
  <button class="tab-btn active" data-tab="tab-yby">Year-by-Year</button>
  <button class="tab-btn" data-tab="tab-gamelog">Game Logs</button>
  <button class="tab-btn" data-tab="tab-tx">Transactions</button>
</div>

<!-- =======================
     Year-by-Year + Career
     ======================= -->
<div id="tab-yby" class="tab-panel active">

  <!-- Year-by-year tables -->
  {% set hitter_cols = ['G','AB','H','HR','RBI','R','SB','AVG','OBP','SLG','OPS'] %}
  {% set pitcher_cols = ['W','L','ERA','WHIP','IP','SO','SV','HLD','G','GS'] %}

  {% if role != "pitching" %}
    <div class="card">
      <div class="card-header">
        <div class="card-title">Year-by-Year</div>
        <div class="card-subtitle">Hitting</div>
      </div>
      <div class="card-body">
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Year</th>
                <th>Team</th>
                <th class="num">G</th>
                <th class="num">AB</th>
                <th class="num">H</th>
                <th class="num">2B</th>
                <th class="num">3B</th> 
                <th class="num">HR</th>
                <th class="num">RBI</th>
                <th class="num">R</th>
                <th class="num">SB</th>
                <th class="num">AVG</th>
                <th class="num">OBP</th>
                <th class="num">SLG</th>
                <th class="num">OPS</th>
              </tr>
            </thead>
            <tbody>
              {% for r in yby if r.kind == "hitting" %}
                {% set s = r.stat or {} %}
                <tr>
                  <td class="num">{{ r.year }}</td>
                  <td>{{ r.team }}</td>
                  <td class="num">{{ s.get('gamesPlayed','') }}</td>
                  <td class="num">{{ s.get('atBats','') }}</td>
                  <td class="num">{{ s.get('hits','') }}</td>
                  <td class="num">{{ s.get('doubles','') }}</td>
                  <td class="num">{{ s.get('triples','') }}</td>
                  <td class="num">{{ s.get('homeRuns','') }}</td>
                  <td class="num">{{ s.get('rbi','') }}</td>
                  <td class="num">{{ s.get('runs','') }}</td>
                  <td class="num">{{ s.get('stolenBases','') }}</td>
                  <td class="num">{{ s.get('avg','') }}</td>
                  <td class="num">{{ s.get('obp','') }}</td>
                  <td class="num">{{ s.get('slg','') }}</td>
                  <td class="num">{{ s.get('ops','') }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endif %}

  {% if role != "hitting" %}
    <div class="card">
      <div class="card-header">
        <div class="card-title">Year-by-Year</div>
        <div class="card-subtitle">Pitching</div>
      </div>
      <div class="card-body">
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Year</th>
                <th>Team</th>
                <th class="num">W</th>
                <th class="num">L</th>
                <th class="num">ERA</th>
                <th class="num">WHIP</th>
                <th class="num">IP</th>
                <th class="num">SO</th>
                <th class="num">SV</th>
                <th class="num">HLD</th>
                <th class="num">G</th>
                <th class="num">GS</th>
              </tr>
            </thead>
            <tbody>
              {% for r in yby if r.kind == "pitching" %}
                {% set s = r.stat or {} %}
                <tr>
                  <td class="num">{{ r.year }}</td>
                  <td>{{ r.team }}</td>
                  <td class="num">{{ s.get('wins','') }}</td>
                  <td class="num">{{ s.get('losses','') }}</td>
                  <td class="num">{{ s.get('era','') }}</td>
                  <td class="num">{{ s.get('whip','') }}</td>
                  <td class="num">{{ s.get('inningsPitched','') }}</td>
                  <td class="num">{{ s.get('strikeOuts','') }}</td>
                  <td class="num">{{ s.get('saves','') }}</td>
                  <td class="num">{{ s.get('holds','') }}</td>
                  <td class="num">{{ s.get('gamesPlayed','') }}</td>
                  <td class="num">{{ s.get('gamesStarted','') }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endif %}

</div>

<!-- =======================
     Game Logs (table)
     ======================= -->
<div id="tab-gamelog" class="tab-panel">
  <div class="card">
    <div class="card-header" style="align-items:center;">
      <div>
        <div class="card-title">Game Logs</div>
        <div class="card-subtitle">Season selector loads one year at a time.</div>
      </div>
      <form method="get" action="/player/{{ bio.id }}" style="display:flex; gap:8px; align-items:center;">
        <select name="log_year" class="season-select">
          {% for y in years %}
            <option value="{{ y }}" {% if y == log_year %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
        <button class="btn" type="submit">Load</button>
      </form>
    </div>

    <div class="card-body">
      {% if role != "pitching" %}
        <div class="subcard-title">Hitting</div>
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Opponent</th>
                <th class="num">AB</th>
                <th class="num">H</th>
                <th class="num">HR</th>
                <th class="num">RBI</th>
                <th class="num">R</th>
                <th class="num">BB</th>
                <th class="num">SO</th>
              </tr>
            </thead>
            <tbody>
              {% for g in (game_logs.hitting or []) %}
                {% set s = g.stat or {} %}
                <tr>
                  <td>{{ g.date }}</td>
                  <td>{{ g.opponent }}</td>
                  <td class="num">{{ s.get('atBats','') }}</td>
                  <td class="num">{{ s.get('hits','') }}</td>
                  <td class="num">{{ s.get('homeRuns','') }}</td>
                  <td class="num">{{ s.get('rbi','') }}</td>
                  <td class="num">{{ s.get('runs','') }}</td>
                  <td class="num">{{ s.get('baseOnBalls','') }}</td>
                  <td class="num">{{ s.get('strikeOuts','') }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}

      {% if role != "hitting" %}
        <div class="subcard-title" style="margin-top:16px;">Pitching</div>
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Opponent</th>
                <th class="num">IP</th>
                <th class="num">H</th>
                <th class="num">R</th>
                <th class="num">ER</th>
                <th class="num">BB</th>
                <th class="num">SO</th>
                <th class="num">HR</th>
              </tr>
            </thead>
            <tbody>
              {% for g in (game_logs.pitching or []) %}
                {% set s = g.stat or {} %}
                <tr>
                  <td>{{ g.date }}</td>
                  <td>{{ g.opponent }}</td>
                  <td class="num">{{ s.get('inningsPitched','') }}</td>
                  <td class="num">{{ s.get('hits','') }}</td>
                  <td class="num">{{ s.get('runs','') }}</td>
                  <td class="num">{{ s.get('earnedRuns','') }}</td>
                  <td class="num">{{ s.get('baseOnBalls','') }}</td>
                  <td class="num">{{ s.get('strikeOuts','') }}</td>
                  <td class="num">{{ s.get('homeRuns','') }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- =======================
     Transactions
     ======================= -->
<div id="tab-tx" class="tab-panel">
  <div class="card">
    <div class="card-header">
      <div class="card-title">Transactions</div>
      <div class="card-subtitle">Entire history • newest first.</div>
    </div>
    <div class="card-body">
      {% if transactions and transactions|length %}
        <div class="tx-list">
          {% for t in transactions %}
            <div class="tx-row">
              <div class="tx-date">{{ t.date }}</div>
              <div class="tx-desc">{{ t.description }}</div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="muted">No transactions found.</div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  (function(){
    const btns = document.querySelectorAll(".tab-btn");
    const panels = document.querySelectorAll(".tab-panel");
    btns.forEach(b => b.addEventListener("click", () => {
      btns.forEach(x => x.classList.remove("active"));
      panels.forEach(p => p.classList.remove("active"));
      b.classList.add("active");
      document.getElementById(b.dataset.tab).classList.add("active");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }));
  })();
</script>

{% endblock %}
