{% extends "base.html" %}
{% block content %}

{# -----------------------
   Headshot URL
   ----------------------- #}
{% set headshot = "https://img.mlbstatic.com/mlb-photos/image/upload/w_540,q_100/v1/people/" ~ (bio.id|string) ~ "/headshot/67/current" %}

{# -----------------------
   Mini stat cards
   ----------------------- #}
{% macro stat_cell(val, bg) %}
  {% if bg %}
    <span class="statcell" style="background: {{ bg }};">{{ val }}</span>
  {% else %}
    {{ val }}
  {% endif %}
{% endmacro %}

{# -----------------------
   Scouting Report color scale
   0 = blue, 50 = light gray, 100 = red
   ----------------------- #}
{% macro sr_color(pct) %}
  {%- if pct is none -%}
    rgba(229,231,235,1)
  {%- else -%}
    {%- set p = pct|int -%}
    {%- if p < 0 -%}{%- set p = 0 -%}{%- endif -%}
    {%- if p > 100 -%}{%- set p = 100 -%}{%- endif -%}

    {# anchor colors (RGB) #}
    {# blue: 37, 99, 235 (#2563eb) #}
    {# gray: 229, 231, 235 (#e5e7eb) #}
    {# red: 239, 68, 68 (#ef4444) #}

    {%- if p <= 50 -%}
      {%- set t = p / 50 -%}
      {%- set r = (37  + (229-37)  * t) | round | int -%}
      {%- set g = (99  + (231-99)  * t) | round | int -%}
      {%- set b = (235 + (235-235) * t) | round | int -%}
      rgb({{ r }}, {{ g }}, {{ b }})
    {%- else -%}
      {%- set t = (p - 50) / 50 -%}
      {%- set r = (229 + (239-229) * t) | round | int -%}
      {%- set g = (231 + (68-231)  * t) | round | int -%}
      {%- set b = (235 + (68-235)  * t) | round | int -%}
      rgb({{ r }}, {{ g }}, {{ b }})
    {%- endif -%}
  {%- endif -%}
{% endmacro %}

{% macro mini_cards(stat, kind, bg_map) %}
  <div class="headline-grid">
    {% if kind == "pitching" %}
      {% for key, label in [
        ('wins','W'),('losses','L'),('era','ERA'),('whip','WHIP'),
        ('inningsPitched','IP'),('strikeOuts','SO'),
        ('saves','SV'),('holds','HLD'),
        ('gamesPlayed','G'),('gamesStarted','GS')
      ] %}
        {% if stat and stat.get(key) is not none and stat.get(key) != '' %}
          <div class="headline-stat"
               {% set _bg = (bg_map.get(key) if bg_map is defined and bg_map else None) %}
               {% if _bg %}style="background: {{ _bg }};"{% endif %}>
            <div class="headline-label">{{ label }}</div>
            <div class="headline-val mono">{{ stat.get(key) }}</div>
          </div>
        {% endif %}
      {% endfor %}
    {% else %}
      {% for key, label in [
        ('avg','AVG'),('obp','OBP'),('slg','SLG'),('ops','OPS'),
        ('homeRuns','HR'),('rbi','RBI'),('runs','R'),
        ('hits','H'),('stolenBases','SB'),('plateAppearances','PA')
      ] %}
        {% if stat and stat.get(key) is not none and stat.get(key) != '' %}
          <div class="headline-stat"
               {% set _bg = (bg_map.get(key) if bg_map is defined and bg_map else None) %}
               {% if _bg %}style="background: {{ _bg }};"{% endif %}>
            <div class="headline-label">{{ label }}</div>
            <div class="headline-val mono">{{ stat.get(key) }}</div>
          </div>
        {% endif %}
      {% endfor %}
    {% endif %}
  </div>
{% endmacro %}

{# -----------------------
   helpers
   ----------------------- #}
{% macro dash(v) -%}
  {%- if v is none or v == '' or v == 'None' or v == '-' -%}-{% else %}{{ v }}{% endif -%}
{%- endmacro %}

<style>
  /* ==========================
     Player page tweaks
     ========================== */
  .player-top{ margin-top:10px; }
  .player-header-card{ align-items:center; }
  .player-header{
    display:flex; gap:14px; align-items:center;
  }
  .player-headshot{
    width:92px; height:92px; border-radius:999px; object-fit:cover;
    border:1px solid rgba(226,232,240,.9); background:#fff;
  }
  .player-meta{ min-width:0; }
  .player-name{
    font-weight:900; font-size:18px; letter-spacing:.2px; color:#111318;
    line-height:1.1;
  }
  .player-lines .muted{ font-size:12px; }
  .player-links{
    margin-top:6px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;
  }
  .player-links a{
    font-size:11px; font-weight:800; padding:5px 10px; border-radius:999px;
    border:1px solid rgba(226,232,240,.9); background:#fff; color:#111318;
    text-decoration:none;
  }
  .player-links a:hover{ opacity:.9; text-decoration:underline; }

  /* ==========================
     Headline grid
     ========================== */
  .headline-grid{
    display:grid;
    grid-template-columns: repeat(5, minmax(0, 1fr));
    gap:10px;
  }
  @media (max-width: 900px){
    .headline-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); }
  }
  @media (max-width: 520px){
    .headline-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
  }
  .headline-stat{
    border:1px solid rgba(226,232,240,.9);
    border-radius:14px;
    background:#fff;
    padding:10px 10px 8px 10px;
    min-width:0;
  }
  .headline-label{
    font-size:10.5px;
    color: var(--muted);
    font-weight:800;
    letter-spacing:.2px;
  }
  .headline-val{
    margin-top:4px;
    font-weight:900;
    font-size:16px;
    color:#111318;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  /* ==========================
     SR (existing hitter scouting)
     ========================== */
  .sr-two-col{
    display:grid;
    grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
    gap:14px;
    align-items:start;
  }
  @media (max-width: 980px){
    .sr-two-col{ grid-template-columns: 1fr; }
  }
  .sr-pill{
    font-weight:900;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#fff;
    color:#111827;
    font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace;
    font-size:11px;
  }
  .sr-wrap{ margin-top:4px; }
  .sr-group-title{
    font-weight:900;
    margin:8px 0 8px 0;
    font-size:12px;
    color:#111318;
  }
  .sr-grid{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .sr-row{
    display:grid;
    grid-template-columns: 140px 1fr;
    gap:10px;
    align-items:center;
  }
  @media (max-width: 520px){
    .sr-row{ grid-template-columns: 120px 1fr; }
  }
  .sr-label{
    font-size:11px;
    font-weight:900;
    color:#111318;
    opacity:.9;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .sr-bar{
    position:relative;
    height:12px;
    border-radius:999px;
    border:1px solid rgba(226,232,240,.9);
    background: rgba(2,6,23,.03);
    overflow:hidden;
  }
  .sr-fill{
    height:100%;
    border-radius:999px;
  }
  .sr-marker{
    position:absolute;
    top:50%;
    transform:translate(-50%,-50%);
    display:flex;
    align-items:center;
    justify-content:center;
    width:22px;
    height:22px;
    border-radius:999px;
    border:1px solid rgba(15,23,42,.22);
    background: rgba(255,255,255,.95);
    font-size:10px;
    font-weight:900;
    color:#111318;
    font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace;
    box-shadow: 0 1px 2px rgba(0,0,0,.08);
    pointer-events:none;
  }
  .sr-muted{
    margin-top:10px;
    font-size:11px;
    color: var(--muted);
  }

  /* ==========================
     Spray Chart (existing)
     ========================== */
  .spray-controls{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
  .spray-controls label{
    display:inline-flex;
    align-items:center;
    gap:6px;
    font-size:12px;
    font-weight:800;
    color:#111827;
    cursor:pointer;
  }

  .spray-legend{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    margin-top:10px;
    font-size:11px;
    color: var(--muted);
  }
  .spray-key{ display:inline-flex; align-items:center; gap:6px; }
  .spray-swatch{ width:10px; height:10px; border-radius:999px; border:1px solid rgba(0,0,0,.15); }

  .spray-wrap{
    margin-top:10px;
    border:1px solid var(--border);
    border-radius:14px;
    background: linear-gradient(180deg, rgba(2,6,23,.05), rgba(2,6,23,0));
    overflow:hidden;
  }
  .spray-svg{
    width:100%;
    height:auto;
    display:block;
    background:#ffffff;
  }
  .spray-note{ margin-top:10px; font-size:11px; color: var(--muted); }

  /* ==========================
     Pitching scouting report
     ========================== */
  .sr-subtabs{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-bottom:10px;
  }
  .sr-subbtn{
    border:1px solid rgba(226,232,240,.9);
    background:#fff;
    border-radius:999px;
    padding:6px 10px;
    font-weight:900;
    font-size:11px;
    cursor:pointer;
  }
  .sr-subbtn.active{
    background: rgba(15,23,42,.04);
  }

  .pit-controls{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    margin-bottom:10px;
  }
  .pit-controls label{
    display:inline-flex;
    align-items:center;
    gap:6px;
    font-size:12px;
    font-weight:800;
    color:#111827;
  }
  .pit-controls select{
    height:34px;
    border-radius:10px;
    border:1px solid rgba(226,232,240,.9);
    background:#fff;
    padding:0 10px;
    font-weight:800;
    font-family: inherit;
    color:#111318;
    outline:none;
  }
  .pit-controls .btn{
    height:34px;
  }

  .pit-grid{
    display:grid;
    grid-template-columns: minmax(0, 1.1fr) minmax(0, .9fr);
    gap:12px;
    align-items:start;
  }
  @media (max-width: 980px){
    .pit-grid{ grid-template-columns: 1fr; }
  }

  .viz-card{
    border:1px solid rgba(226,232,240,.9);
    border-radius:14px;
    background:#fff;
    overflow:hidden;
  }
  .viz-head{
    padding:10px 12px 8px 12px;
    border-bottom:1px solid rgba(226,232,240,.9);
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:10px;
  }
  .viz-title{
    font-weight:900;
    font-size:12px;
    color:#111318;
  }
  .viz-sub{
    font-size:11px;
    color: var(--muted);
    margin-top:2px;
  }
  .viz-body{
    padding:10px 12px 12px 12px;
  }

  .zone-canvas-wrap{
    position:relative;
    width:100%;
    max-width:520px;
    aspect-ratio: 1 / 1.05;
    margin: 0 auto;
  }
  .zone-canvas{
    width:100%;
    height:100%;
    display:block;
    border-radius:12px;
    background:#fff;
    border:1px solid rgba(226,232,240,.9);
  }
  .zone-overlay{
    position:absolute;
    inset:0;
    pointer-events:none;
  }

  .pit-kpis{
    display:grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap:10px;
  }
  @media (max-width: 520px){
    .pit-kpis{ grid-template-columns: 1fr; }
  }
  .kpi{
    border:1px solid rgba(226,232,240,.9);
    border-radius:14px;
    padding:10px;
    background: rgba(15,23,42,.02);
    min-width:0;
  }
  .kpi .k{
    font-size:10.5px;
    color:var(--muted);
    font-weight:800;
  }
  .kpi .v{
    margin-top:4px;
    font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace;
    font-weight:900;
    font-size:13px;
    color:#111318;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .mix-table{
    width:100%;
    border-collapse:collapse;
    font-size:12px;
  }
  .mix-table th, .mix-table td{
    padding:8px 6px;
    border-bottom:1px solid rgba(226,232,240,.9);
    text-align:left;
    vertical-align:middle;
  }
  .mix-table th{
    font-size:11px;
    color: var(--muted);
    font-weight:900;
  }
  .mix-pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
  }
  .swatch{
    width:10px; height:10px; border-radius:999px;
    border:1px solid rgba(0,0,0,.15);
  }
  .mono{ font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace; }

</style>

<!-- =======================
     Header card
     ======================= -->
<div class="card player-top">
  <div class="card-header player-header-card">
    <div class="player-header">
      <img class="player-headshot" src="{{ headshot }}" alt="{{ bio.fullName }}">

      <div class="player-meta">
        <div class="player-name">{{ bio.fullName }}</div>

        <div class="player-lines">
          <div class="muted">
            {% if bio.currentTeam and bio.currentTeam.name %}{{ bio.currentTeam.name }}{% endif %}
            {% if bio.primaryPosition and bio.primaryPosition.name %} • {{ bio.primaryPosition.name }}{% endif %}
          </div>

          {% if bio.currentAge or bio.height or bio.weight %}
            <div class="muted">
              {% if bio.currentAge %}Age {{ bio.currentAge }}{% endif %}
              {% if bio.height %}{% if bio.currentAge %} • {% endif %}{{ bio.height }}{% endif %}
              {% if bio.weight %}{% if bio.currentAge or bio.height %} • {% endif %}{{ bio.weight }} lb{% endif %}
            </div>
          {% endif %}

          {% if (bio.batSide and bio.batSide.code) or (bio.pitchHand and bio.pitchHand.code) %}
            <div class="muted">
              {% if bio.batSide and bio.batSide.code %}Bats: {{ bio.batSide.code }}{% endif %}
              {% if bio.pitchHand and bio.pitchHand.code %}
                {% if bio.batSide and bio.batSide.code %} • {% endif %}
                Throws: {{ bio.pitchHand.code }}
              {% endif %}
            </div>
          {% endif %}
        </div>

        <div class="player-links">
          <a href="https://www.mlb.com/player/{{ bio.id }}" target="_blank" rel="noopener">MLB</a>
          <a href="https://baseballsavant.mlb.com/savant-player/{{ bio.id }}" target="_blank" rel="noopener">Savant</a>
        </div>

      </div>
    </div>
  </div>

  <div class="card-body">
    {% if role == "two-way" %}
      {% if snapshot_hitting %}
        <div style="margin-bottom:12px;">
          <div class="subcard-title">Season Snapshot — Hitting</div>
          {{ mini_cards(snapshot_hitting, "hitting", snapshot_bg_hitting) }}
        </div>
      {% endif %}
      {% if snapshot_pitching %}
        <div>
          <div class="subcard-title">Season Snapshot — Pitching</div>
          {{ mini_cards(snapshot_pitching, "pitching", snapshot_bg_pitching) }}
        </div>
      {% endif %}
      {% if not snapshot_hitting and not snapshot_pitching %}
        <div class="muted">No stats found.</div>
      {% endif %}
    {% elif role == "pitching" %}
      {% if snapshot_pitching %}
        {{ mini_cards(snapshot_pitching, "pitching", snapshot_bg_pitching) }}
      {% else %}
        <div class="muted">No stats found.</div>
      {% endif %}
    {% else %}
      {% if snapshot_hitting %}
        {{ mini_cards(snapshot_hitting, "hitting", snapshot_bg_hitting) }}
      {% else %}
        <div class="muted">No stats found.</div>
      {% endif %}
    {% endif %}
  </div>
</div>

<!-- =======================
     Career Stats
     ======================= -->
<div class="card">
  <div class="card-header">
    <div class="card-title">Career Stats</div>
  </div>

  <div class="card-body">
    {% if role == "two-way" %}
      <div style="margin-bottom:12px;">
        <div class="subcard-title">Hitting</div>
        {% if career_hitting %}{{ mini_cards(career_hitting, "hitting", {}) }}{% else %}<div class="muted">—</div>{% endif %}
      </div>
      <div>
        <div class="subcard-title">Pitching</div>
        {% if career_pitching %}{{ mini_cards(career_pitching, "pitching", {}) }}{% else %}<div class="muted">—</div>{% endif %}
      </div>
    {% elif role == "pitching" %}
      {% if career_pitching %}{{ mini_cards(career_pitching, "pitching", {}) }}{% else %}<div class="muted">—</div>{% endif %}
    {% else %}
      {% if career_hitting %}{{ mini_cards(career_hitting, "hitting", {}) }}{% else %}<div class="muted">—</div>{% endif %}
    {% endif %}
  </div>
</div>

<!-- ===== Tabs ===== -->
<div class="tabs" style="margin-top:12px;">
  <button class="tab-btn active" data-tab="tab-yby">Year-by-Year</button>
  <button class="tab-btn" data-tab="tab-gamelog">Game Logs</button>
  <button class="tab-btn" data-tab="tab-tx">Transactions</button>
  <button class="tab-btn" data-tab="tab-scouting">Scouting Report</button>
</div>

<!-- =======================
     Year-by-Year
     ======================= -->
<div id="tab-yby" class="tab-panel active">

  {% set _hg = (hitting_groups if hitting_groups is defined else []) %}
  {% set _pg = (pitching_groups if pitching_groups is defined else []) %}
  {% set has_hitting = (_hg|length) > 0 %}
  {% set has_pitching = (_pg|length) > 0 %}

  {% if has_hitting %}
  <div class="card" style="margin-top:14px;">
    <div class="card-header">
      <div class="card-title">Year-by-Year Hitting</div>
    </div>

    <div style="overflow:auto;">
      <table class="table" style="width:100%; min-width:900px;">
        <thead>
          <tr>
            <th>Year</th>
            <th>Team</th>
            <th>G</th><th>PA</th><th>AB</th><th>H</th>
            <th>HR</th><th>RBI</th><th>SB</th>
            <th>AVG</th><th>OBP</th><th>SLG</th><th>OPS</th><th>Awards</th>
          </tr>
        </thead>
        <tbody>
          {% for g in _hg %}
            {% set r = g.row or {} %}
            {% set team = g.team or "TOT" %}
            {% set y = g.year or "" %}
            {% set rk = (y|string) ~ ":" ~ (team|string) %}
            {% set bg = (yby_bg_hitting or {}).get(rk, {}) %}
            <tr>
              <td class="mono">{{ y }}</td>
              <td class="mono">{{ team }}</td>
              <td class="mono">{{ dash(r.get('gamesPlayed')) }}</td>
              <td class="mono">{{ dash(r.get('plateAppearances')) }}</td>
              <td class="mono">{{ dash(r.get('atBats')) }}</td>
              <td class="mono">{{ dash(r.get('hits')) }}</td>
              <td class="mono">{{ dash(r.get('homeRuns')) }}</td>
              <td class="mono">{{ dash(r.get('rbi')) }}</td>
              <td class="mono">{{ dash(r.get('stolenBases')) }}</td>
              <td class="mono">{{ stat_cell(dash(r.get('avg')), bg.get('avg')) }}</td>
              <td class="mono">{{ stat_cell(dash(r.get('obp')), bg.get('obp')) }}</td>
              <td class="mono">{{ stat_cell(dash(r.get('slg')), bg.get('slg')) }}</td>
              <td class="mono">{{ stat_cell(dash(r.get('ops')), bg.get('ops')) }}</td>
              <td>
                {% set pills = (award_year_map.get(y|string) if award_year_map is defined else []) %}
                {% if pills %}
                  <div class="pill-row">
                    {% for p in pills %}
                      <span class="pill">{{ p }}</span>
                    {% endfor %}
                  </div>
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {% if has_pitching %}
  <div class="card" style="margin-top:14px;">
    <div class="card-header">
      <div class="card-title">Year-by-Year Pitching</div>
    </div>

    <div style="overflow:auto;">
      <table class="table" style="width:100%; min-width:900px;">
        <thead>
          <tr>
            <th>Year</th>
            <th>Team</th>
            <th>G</th><th>GS</th><th>W</th><th>L</th>
            <th>IP</th><th>ERA</th><th>WHIP</th><th>SO</th><th>BB</th><th>HR</th><th>Awards</th>
          </tr>
        </thead>
        <tbody>
          {% for g in _pg %}
            {% set r = g.row or {} %}
            {% set team = g.team or "TOT" %}
            {% set y = g.year or "" %}
            {% set rk = (y|string) ~ ":" ~ (team|string) %}
            {% set bg = (yby_bg_pitching or {}).get(rk, {}) %}
            <tr>
              <td class="mono">{{ y }}</td>
              <td class="mono">{{ team }}</td>
              <td class="mono">{{ dash(r.get('gamesPlayed')) }}</td>
              <td class="mono">{{ dash(r.get('gamesStarted')) }}</td>
              <td class="mono">{{ dash(r.get('wins')) }}</td>
              <td class="mono">{{ dash(r.get('losses')) }}</td>
              <td class="mono">{{ dash(r.get('inningsPitched')) }}</td>
              <td class="mono">{{ stat_cell(dash(r.get('era')), bg.get('era')) }}</td>
              <td class="mono">{{ stat_cell(dash(r.get('whip')), bg.get('whip')) }}</td>
              <td class="mono">{{ dash(r.get('strikeOuts')) }}</td>
              <td class="mono">{{ dash(r.get('baseOnBalls')) }}</td>
              <td class="mono">{{ dash(r.get('homeRuns')) }}</td>
              <td>
                {% set pills = (award_year_map.get(y|string) if award_year_map is defined else []) %}
                {% if pills %}
                  <div class="pill-row">
                    {% for p in pills %}
                      <span class="pill">{{ p }}</span>
                    {% endfor %}
                  </div>
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {% if not has_hitting and not has_pitching %}
    <div class="card" style="margin-top:14px;">
      <div class="card-body">
        <div class="muted">No year-by-year rows found.</div>
      </div>
    </div>
  {% endif %}
</div>

<!-- =======================
     Game Logs
     ======================= -->
<div id="tab-gamelog" class="tab-panel">
  <div class="card" style="margin-top:14px;">
    <div class="card-header" style="align-items:center;">
      <div>
        <div class="card-title">Game Logs</div>
        <div class="card-subtitle">Regular season only</div>
      </div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <form method="get" action="/player/{{ bio.id }}" style="display:flex; gap:8px; align-items:center;">
          <input type="hidden" name="tab" value="tab-gamelog">
          <label class="mono" style="font-size:11px; opacity:.75;">Season</label>
          <select name="log_year" class="select" style="height:34px;">
            {% for y in years %}
              <option value="{{ y }}" {% if log_year and (y|string)==(log_year|string) %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
          </select>
          <button class="btn" type="submit">Go</button>
        </form>
      </div>
    </div>

    <div class="card-body" style="overflow:auto;">
      {% if role == "two-way" %}
        <div style="margin-bottom:12px;">
          <div class="subcard-title">Hitting</div>
          {% if game_logs and game_logs.hitting and (game_logs.hitting|length)>0 %}
            <table class="table" style="width:100%; min-width:700px;">
              <thead>
                <tr>
                  <th>Date</th><th>Opp</th><th class="num">AB</th><th class="num">H</th><th class="num">HR</th><th class="num">RBI</th><th class="num">BB</th><th class="num">SO</th>
                </tr>
              </thead>
              <tbody>
                {% for g in (game_logs.hitting or []) %}
                  {% set s = g.stat or {} %}
                  <tr>
                    <td>{{ g.date }}</td>
                    <td>{{ g.opponent }}</td>
                    <td class="num">{{ s.get('atBats','') }}</td>
                    <td class="num">{{ s.get('hits','') }}</td>
                    <td class="num">{{ s.get('homeRuns','') }}</td>
                    <td class="num">{{ s.get('rbi','') }}</td>
                    <td class="num">{{ s.get('baseOnBalls','') }}</td>
                    <td class="num">{{ s.get('strikeOuts','') }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <div class="muted">No hitting logs found.</div>
          {% endif %}
        </div>

        <div>
          <div class="subcard-title">Pitching</div>
          {% if game_logs and game_logs.pitching and (game_logs.pitching|length)>0 %}
            <table class="table" style="width:100%; min-width:700px;">
              <thead>
                <tr>
                  <th>Date</th><th>Opp</th><th class="num">IP</th><th class="num">H</th><th class="num">R</th><th class="num">ER</th><th class="num">BB</th><th class="num">SO</th><th class="num">HR</th>
                </tr>
              </thead>
              <tbody>
                {% for g in (game_logs.pitching or []) %}
                  {% set s = g.stat or {} %}
                  <tr>
                    <td>{{ g.date }}</td>
                    <td>{{ g.opponent }}</td>
                    <td class="num">{{ s.get('inningsPitched','') }}</td>
                    <td class="num">{{ s.get('hits','') }}</td>
                    <td class="num">{{ s.get('runs','') }}</td>
                    <td class="num">{{ s.get('earnedRuns','') }}</td>
                    <td class="num">{{ s.get('baseOnBalls','') }}</td>
                    <td class="num">{{ s.get('strikeOuts','') }}</td>
                    <td class="num">{{ s.get('homeRuns','') }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <div class="muted">No pitching logs found.</div>
          {% endif %}
        </div>
      {% elif role == "pitching" %}
        {% if game_logs and game_logs.pitching and (game_logs.pitching|length)>0 %}
          <table class="table" style="width:100%; min-width:700px;">
            <thead>
              <tr>
                <th>Date</th><th>Opp</th><th class="num">IP</th><th class="num">H</th><th class="num">R</th><th class="num">ER</th><th class="num">BB</th><th class="num">SO</th><th class="num">HR</th>
              </tr>
            </thead>
            <tbody>
              {% for g in (game_logs.pitching or []) %}
                {% set s = g.stat or {} %}
                <tr>
                  <td>{{ g.date }}</td>
                  <td>{{ g.opponent }}</td>
                  <td class="num">{{ s.get('inningsPitched','') }}</td>
                  <td class="num">{{ s.get('hits','') }}</td>
                  <td class="num">{{ s.get('runs','') }}</td>
                  <td class="num">{{ s.get('earnedRuns','') }}</td>
                  <td class="num">{{ s.get('baseOnBalls','') }}</td>
                  <td class="num">{{ s.get('strikeOuts','') }}</td>
                  <td class="num">{{ s.get('homeRuns','') }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="muted">No pitching logs found.</div>
        {% endif %}
      {% else %}
        {% if game_logs and game_logs.hitting and (game_logs.hitting|length)>0 %}
          <table class="table" style="width:100%; min-width:700px;">
            <thead>
              <tr>
                <th>Date</th><th>Opp</th><th class="num">AB</th><th class="num">H</th><th class="num">HR</th><th class="num">RBI</th><th class="num">BB</th><th class="num">SO</th>
              </tr>
            </thead>
            <tbody>
              {% for g in (game_logs.hitting or []) %}
                {% set s = g.stat or {} %}
                <tr>
                  <td>{{ g.date }}</td>
                  <td>{{ g.opponent }}</td>
                  <td class="num">{{ s.get('atBats','') }}</td>
                  <td class="num">{{ s.get('hits','') }}</td>
                  <td class="num">{{ s.get('homeRuns','') }}</td>
                  <td class="num">{{ s.get('rbi','') }}</td>
                  <td class="num">{{ s.get('baseOnBalls','') }}</td>
                  <td class="num">{{ s.get('strikeOuts','') }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="muted">No hitting logs found.</div>
        {% endif %}
      {% endif %}
    </div>
  </div>
</div>

<!-- =======================
     Transactions
     ======================= -->
<div id="tab-tx" class="tab-panel">
  <div class="card" style="margin-top:14px;">
    <div class="card-header">
      <div class="card-title">Transactions</div>
      <div class="card-subtitle">Entire history • newest first.</div>
    </div>
    <div class="card-body">
      {% if transactions and transactions|length %}
        <div class="tx-list">
          {% for t in transactions %}
            <div class="tx-row">
              <div class="tx-date">{{ t.date }}</div>
              <div class="tx-desc">{{ t.description }}</div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="muted">No transactions found.</div>
      {% endif %}
    </div>
  </div>
</div>

<!-- =======================
     Scouting Report
     ======================= -->
<div id="tab-scouting" class="tab-panel">
  <div class="card" style="margin-top:14px;">
    <div class="card-header" style="align-items:center;">
      <div>
        <div class="card-title">Scouting Report</div>
        <div class="card-subtitle">Hitting = Savant-style percentiles • Pitching = heatmaps, shapes, and results</div>
      </div>

      {% if season_found %}
        <div class="sr-pill">Season {{ season_found }}</div>
      {% endif %}
    </div>

    <div class="card-body">

      {# --------------------------
         Two-way subtabs
         -------------------------- #}
      {% if role == "two-way" %}
        <div class="sr-subtabs">
          <button class="sr-subbtn active" type="button" data-srsub="sr-hit">Hitting</button>
          <button class="sr-subbtn" type="button" data-srsub="sr-pit">Pitching</button>
        </div>
      {% endif %}

      {# ==========================
         HITTING SCOUTING (existing)
         ========================== #}
      <div id="sr-hit" class="sr-subpanel" {% if role == "two-way" %}style="display:block;"{% endif %}>
        {% if role != "pitching" %}
          <div class="sr-two-col">

            <!-- LEFT: sliders/bars -->
            <div>
              {% if savant_profile and savant_profile.available %}
                <div class="sr-wrap">
                  {% for g in savant_profile.groups %}
                    <div>
                      <div class="sr-group-title">{{ g.title }}</div>

                      <div class="sr-grid">
                        {% for r in g.rows %}
                          <div class="sr-row">
                            <div class="sr-label mono">{{ r.label }}</div>

                            <div class="sr-bar" title="{{ r.label }}">
                              {% if r.pct is not none %}
                                <div class="sr-fill" style="width: {{ r.pct }}%; background: {{ sr_color(r.pct) }};"></div>
                              {% endif %}

                              {% if r.pct is not none %}
                                {% set p = r.pct %}
                                <div class="sr-marker" style="left: {{ p }}%;">
                                  <span>{{ p }}</span>
                                </div>
                              {% else %}
                                <div class="sr-marker" style="left: 0; opacity:.55;">
                                  <span>—</span>
                                </div>
                              {% endif %}
                            </div>

                            <div class="mono" style="font-size:11px; text-align:right; opacity:.85;">
                              {% if r.value is not none %}
                                {% if r.fmt == "3f" %}{{ "%.3f"|format(r.value) }}
                                {% elif r.fmt == "1f" %}{{ "%.1f"|format(r.value) }}
                                {% else %}{{ r.value }}
                                {% endif %}
                                {{ r.suffix if r.suffix is defined else "" }}
                              {% else %}
                                —
                              {% endif %}
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  {% endfor %}
                </div>

                <div class="sr-muted">
                  Percentiles are relative to the season pool. (For K%, Whiff%, Chase%, lower is better.)
                </div>
              {% else %}
                <div class="muted">No Statcast scouting data found for this season yet.</div>
              {% endif %}
            </div>

            <!-- RIGHT: Spray -->
            <div>
              <div class="subcard-title" style="margin:0 0 8px 0;">Spray Chart (Hits)</div>

              <div class="spray-controls" style="margin-bottom:8px;">
                <label title="Season">
                  <span class="mono" style="font-size:11px; opacity:.75;">Season</span>
                  <select id="spraySeason" class="season-select">
                    {% for y in years %}
                      <option value="{{ y }}" {% if season_found and (y|string) == (season_found|string) %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                  </select>
                </label>

                <button id="sprayRefreshBtn" class="btn" type="button">Refresh</button>
              </div>

              <div class="spray-wrap">
                <svg id="spraySvg" class="spray-svg" xmlns="http://www.w3.org/2000/svg" aria-label="Spray chart stadium">
                  <g id="sprayWorld">
                    <g id="sprayOverlay"></g>
                    <g id="sprayPoints"></g>
                  </g>
                </svg>
              </div>

              <div class="spray-legend">
                <span class="spray-key"><span class="spray-swatch" style="background:#22c55e;"></span> 1B</span>
                <span class="spray-key"><span class="spray-swatch" style="background:#3b82f6;"></span> 2B</span>
                <span class="spray-key"><span class="spray-swatch" style="background:#a855f7;"></span> 3B</span>
                <span class="spray-key"><span class="spray-swatch" style="background:#ef4444;"></span> HR</span>
                <span class="spray-key"><span class="spray-swatch" style="background:#f59e0b;"></span> Other Hit</span>
              </div>

              <div class="spray-note">
                MLBAM-style coords scaled into stadium viewBox. Home plate baseline ≈ (125, 199). Stadium SVG: {{ stadium_svg|default('generic.svg') }}.
              </div>
            </div>

          </div>
        {% else %}
          <div class="muted">Hitting scouting report not applicable for this player.</div>
        {% endif %}
      </div>

      {# ==========================
         PITCHING SCOUTING (new)
         ========================== #}
      <div id="sr-pit" class="sr-subpanel" {% if role == "two-way" %}style="display:none;"{% endif %}>
        {% if role != "hitting" %}

          <div class="pit-controls">
            <label>
              <span class="mono" style="font-size:11px; opacity:.75;">Season</span>
              <select id="pitSeason">
                {% for y in years %}
                  <option value="{{ y }}" {% if season_found and (y|string) == (season_found|string) %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
              </select>
            </label>

            <label>
              <span class="mono" style="font-size:11px; opacity:.75;">Game</span>
              <select id="pitGame">
                <option value="ALL">Season (All Games)</option>
              </select>
            </label>

            <label>
              <span class="mono" style="font-size:11px; opacity:.75;">Batter</span>
              <select id="pitBatterSide">
                <option value="ALL">All</option>
                <option value="L">vs L</option>
                <option value="R">vs R</option>
              </select>
            </label>

            <label>
              <span class="mono" style="font-size:11px; opacity:.75;">Pitch</span>
              <select id="pitPitchType">
                <option value="ALL">All Pitches</option>
              </select>
            </label>

            <label>
              <span class="mono" style="font-size:11px; opacity:.75;">Heat</span>
              <select id="pitHeatMode">
                <option value="density">Location Density</option>
                <option value="xwoba">xwOBA (by location)</option>
              </select>
            </label>

            <button id="pitRefreshBtn" class="btn" type="button">Refresh</button>
          </div>

          <div class="pit-grid">

            <div class="viz-card">
              <div class="viz-head">
                <div>
                  <div class="viz-title">Pitch Location Heatmap</div>
                  <div class="viz-sub">Smooth KDE-style surface • Catcher POV • Fixed zone bounds</div>
                </div>
                <div class="mono" id="pitCountLabel" style="font-size:11px; opacity:.75;">—</div>
              </div>
              <div class="viz-body">
                <div class="zone-canvas-wrap">
                  <canvas id="pitHeat" class="zone-canvas" width="520" height="546"></canvas>
                  <svg class="zone-overlay" viewBox="0 0 520 546" preserveAspectRatio="none" aria-hidden="true">
                    <rect id="zoneRect"
                          x="0" y="0" width="0" height="0"
                          fill="rgba(15,23,42,.03)"
                          stroke="rgba(226,232,240,.9)"
                          stroke-width="2"></rect>
                  </svg>
                </div>
                <div class="sr-muted" id="pitHeatNote" style="margin-top:10px;">
                  Select a pitch type to view usage/command by pitch. Switch “Heat” to xwOBA for result quality by location.
                </div>
              </div>
            </div>

            <div class="viz-card">
              <div class="viz-head">
                <div>
                  <div class="viz-title">Pitch Mix & Shape</div>
                  <div class="viz-sub">Usage, velocity/spin, and movement</div>
                </div>
              </div>
              <div class="viz-body">

                <div class="pit-kpis" style="margin-bottom:12px;">
                  <div class="kpi">
                    <div class="k">Whiff%</div>
                    <div class="v" id="kpiWhiff">—</div>
                  </div>
                  <div class="kpi">
                    <div class="k">Chase%</div>
                    <div class="v" id="kpiChase">—</div>
                  </div>
                  <div class="kpi">
                    <div class="k">Zone%</div>
                    <div class="v" id="kpiZone">—</div>
                  </div>
                  <div class="kpi">
                    <div class="k">Avg xwOBA</div>
                    <div class="v" id="kpiXwoba">—</div>
                  </div>
                </div>

                <div style="overflow:auto; margin-bottom:12px;">
                  <table class="mix-table" id="mixTable">
                    <thead>
                      <tr>
                        <th>Pitch</th>
                        <th class="mono">%</th>
                        <th class="mono">Velo</th>
                        <th class="mono">Spin</th>
                        <th class="mono">HB (in)</th>
                        <th class="mono">IVB (in)</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr><td class="muted" colspan="6">No data loaded yet.</td></tr>
                    </tbody>
                  </table>
                </div>

                <div class="viz-card" style="border:none; border-radius:0; box-shadow:none;">
                  <div class="viz-head" style="border:1px solid rgba(226,232,240,.9); border-radius:14px; margin-bottom:10px;">
                    <div>
                      <div class="viz-title">Movement Plot</div>
                      <div class="viz-sub">Horizontal (HB) vs Induced Vertical Break (IVB)</div>
                    </div>
                  </div>
                  <div class="viz-body" style="padding:0;">
                    <div style="padding:0 0 4px 0;">
                      <canvas id="pitMove" class="zone-canvas" width="520" height="360" style="aspect-ratio:auto; height:auto;"></canvas>
                    </div>
                  </div>
                </div>

              </div>
            </div>

          </div>

        {% else %}
          <div class="muted">Pitching scouting report not applicable for this player.</div>
        {% endif %}
      </div>

    </div>
  </div>
</div>

<script>
(function(){
  // -----------------------------
  // Tabs (main)
  // -----------------------------
  const btns = document.querySelectorAll(".tab-btn");
  const panels = document.querySelectorAll(".tab-panel");
  btns.forEach(b => b.addEventListener("click", () => {
    btns.forEach(x => x.classList.remove("active"));
    panels.forEach(p => p.classList.remove("active"));
    b.classList.add("active");
    const id = b.getAttribute("data-tab");
    const panel = document.getElementById(id);
    if(panel) panel.classList.add("active");
  }));

  // Respect ?tab=...
  try{
    const params = new URLSearchParams(window.location.search);
    const t = params.get("tab");
    if(t){
      const b = document.querySelector('.tab-btn[data-tab="'+t+'"]');
      if(b) b.click();
    }
  }catch(e){}

  // -----------------------------
  // Scouting subtabs (two-way only)
  // -----------------------------
  const subBtns = document.querySelectorAll(".sr-subbtn");
  if(subBtns && subBtns.length){
    subBtns.forEach(b => b.addEventListener("click", () => {
      subBtns.forEach(x => x.classList.remove("active"));
      b.classList.add("active");
      const key = b.getAttribute("data-srsub");
      document.querySelectorAll(".sr-subpanel").forEach(p => p.style.display = "none");
      const target = document.getElementById(key);
      if(target) target.style.display = "block";
    }));
  }

  // -----------------------------
  // Spray chart (existing)
  // -----------------------------
  const STADIUM_URL = "/static/stadium_svgs/{{ stadium_svg|default('generic.svg') }}";
  const BASE_W = 250;
  const BASE_H = 250;
  const PLATE = { x: 125, y: 199 };
  const EXTRA_SPREAD = 1.0;

  const spraySvg = document.getElementById("spraySvg");
  const sprayWorld = document.getElementById("sprayWorld");
  const sprayOverlay = document.getElementById("sprayOverlay");
  const sprayPoints = document.getElementById("sprayPoints");
  const spraySeasonSel = document.getElementById("spraySeason");
  const sprayBtn = document.getElementById("sprayRefreshBtn");

  function setViewBoxToBase(){
    if(!spraySvg) return;
    spraySvg.setAttribute("viewBox", `0 0 ${BASE_W} ${BASE_H}`);
  }
  setViewBoxToBase();

  function hitColor(ev){
    const s = (ev || "").toLowerCase();
    if(s.includes("home_run")) return "#ef4444";
    if(s.includes("triple")) return "#a855f7";
    if(s.includes("double")) return "#3b82f6";
    if(s.includes("single")) return "#22c55e";
    return "#f59e0b";
  }

  async function loadStadium(){
    if(!sprayOverlay) return;
    try{
      const res = await fetch(STADIUM_URL, {cache:"force-cache"});
      const txt = await res.text();
      sprayOverlay.innerHTML = txt;
      setViewBoxToBase();
    }catch(e){
      sprayOverlay.innerHTML = "";
    }
  }

  function renderSpray(points){
    if(!sprayPoints) return;
    sprayPoints.innerHTML = "";
    if(!points || !points.length) return;

    // Fit to base viewBox; points are already normalized by your backend
    points.forEach(p=>{
      const cx = p.x, cy = p.y;
      if(cx == null || cy == null) return;
      const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
      c.setAttribute("cx", cx);
      c.setAttribute("cy", cy);
      c.setAttribute("r", 3.2);
      c.setAttribute("fill", hitColor(p.events));
      c.setAttribute("fill-opacity", "0.8");
      c.setAttribute("stroke", "rgba(15,23,42,.25)");
      c.setAttribute("stroke-width", "0.6");
      sprayPoints.appendChild(c);
    });
  }

  async function refreshSpray(){
    if(!spraySeasonSel) return;
    const season = spraySeasonSel.value;
    try{
      const url = `/player/{{ bio.id }}/spray.json?season=${encodeURIComponent(season)}`;
      const res = await fetch(url, {cache:"no-store"});
      const data = await res.json();
      renderSpray(data.points || []);
    }catch(e){
      renderSpray([]);
    }
  }

  if(sprayBtn) sprayBtn.addEventListener("click", refreshSpray);
  if(spraySvg){
    loadStadium().then(refreshSpray);
  }

  // -----------------------------
  // Pitching scouting report (new)
  // -----------------------------
  const role = "{{ role|default('hitting') }}";
  const playerId = {{ bio.id|int }};
  const pitSeason = document.getElementById("pitSeason");
  const pitGame = document.getElementById("pitGame");
  const pitBatterSide = document.getElementById("pitBatterSide");
  const pitPitchType = document.getElementById("pitPitchType");
  const pitHeatMode = document.getElementById("pitHeatMode");
  const pitBtn = document.getElementById("pitRefreshBtn");

  const pitCountLabel = document.getElementById("pitCountLabel");
  const kpiWhiff = document.getElementById("kpiWhiff");
  const kpiChase = document.getElementById("kpiChase");
  const kpiZone = document.getElementById("kpiZone");
  const kpiXwoba = document.getElementById("kpiXwoba");
  const mixTable = document.getElementById("mixTable");

  const heatCanvas = document.getElementById("pitHeat");
  const moveCanvas = document.getElementById("pitMove");
  const zoneRect = document.getElementById("zoneRect");

  // Fixed zone bounds (your requirement)
  const ZONE = {
    top: 3.3942716630565757,
    bot: 1.594602333802632,
    left: -0.83,
    right: 0.83
  };

  // Heatmap plot window (slightly larger than zone)
  // Keep consistent w/ catcher POV and DO NOT flip for batter handedness.
  const WINDOW = {
    xMin: -2.0,
    xMax:  2.0,
    yMin:  0.5,
    yMax:  4.5
  };

  function fmtPct(x){
    if(x == null || isNaN(x)) return "—";
    return (x*100).toFixed(1) + "%";
  }
  function fmt1(x){
    if(x == null || isNaN(x)) return "—";
    return Number(x).toFixed(1);
  }
  function fmt0(x){
    if(x == null || isNaN(x)) return "—";
    return Math.round(Number(x)).toString();
  }

  function setZoneOverlay(){
    if(!heatCanvas || !zoneRect) return;
    const w = heatCanvas.width, h = heatCanvas.height;

    const xScale = (x)=> ( (x - WINDOW.xMin) / (WINDOW.xMax - WINDOW.xMin) ) * w;
    const yScale = (y)=> h - ( (y - WINDOW.yMin) / (WINDOW.yMax - WINDOW.yMin) ) * h;

    const zx = xScale(ZONE.left);
    const zy = yScale(ZONE.top);
    const zw = xScale(ZONE.right) - xScale(ZONE.left);
    const zh = yScale(ZONE.bot) - yScale(ZONE.top);

    zoneRect.setAttribute("x", zx);
    zoneRect.setAttribute("y", zy);
    zoneRect.setAttribute("width", zw);
    zoneRect.setAttribute("height", zh);
  }
  setZoneOverlay();

  function gaussianKernel1D(sigma, radius){
    const k = [];
    const s2 = sigma*sigma;
    let sum = 0;
    for(let i=-radius; i<=radius; i++){
      const v = Math.exp(-(i*i)/(2*s2));
      k.push(v);
      sum += v;
    }
    // normalize
    for(let i=0; i<k.length; i++) k[i] /= sum;
    return k;
  }

  function blurSeparable(grid, gw, gh, sigma){
    // grid is Float32Array length gw*gh
    const radius = Math.max(1, Math.round(sigma*3));
    const k = gaussianKernel1D(sigma, radius);
    const tmp = new Float32Array(gw*gh);
    const out = new Float32Array(gw*gh);

    // horizontal
    for(let y=0; y<gh; y++){
      for(let x=0; x<gw; x++){
        let acc = 0;
        for(let j=-radius; j<=radius; j++){
          const xx = Math.min(gw-1, Math.max(0, x+j));
          acc += grid[y*gw + xx] * k[j+radius];
        }
        tmp[y*gw + x] = acc;
      }
    }

    // vertical
    for(let x=0; x<gw; x++){
      for(let y=0; y<gh; y++){
        let acc = 0;
        for(let j=-radius; j<=radius; j++){
          const yy = Math.min(gh-1, Math.max(0, y+j));
          acc += tmp[yy*gw + x] * k[j+radius];
        }
        out[y*gw + x] = acc;
      }
    }
    return out;
  }

  function drawHeatmap(points, mode){
    if(!heatCanvas) return;
    const ctx = heatCanvas.getContext("2d");
    const W = heatCanvas.width, H = heatCanvas.height;

    // Clear
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = "#fff";
    ctx.fillRect(0,0,W,H);

    if(!points || !points.length){
      ctx.fillStyle = "rgba(91,101,119,.8)";
      ctx.font = '12px "IBM Plex Mono", ui-monospace, Menlo, monospace';
      ctx.fillText("No pitch locations for this filter.", 12, 24);
      setZoneOverlay();
      return;
    }

    // Downsampled grid for speed (KDE-ish)
    const gw = 120, gh = 130;
    const grid = new Float32Array(gw*gh);
    const gridN = new Float32Array(gw*gh); // for xwOBA averaging

    const xToGX = (x)=> Math.floor( ( (x - WINDOW.xMin) / (WINDOW.xMax - WINDOW.xMin) ) * gw );
    const yToGY = (y)=> Math.floor( ( (y - WINDOW.yMin) / (WINDOW.yMax - WINDOW.yMin) ) * gh );

    for(const p of points){
      const x = p.plate_x, y = p.plate_z;
      if(x == null || y == null) continue;
      const gx = xToGX(x), gy = yToGY(y);
      if(gx<0 || gx>=gw || gy<0 || gy>=gh) continue;

      if(mode === "xwoba"){
        const w = (p.xwoba == null ? null : Number(p.xwoba));
        if(w == null || isNaN(w)) continue;
        grid[gx + gy*gw] += w;
        gridN[gx + gy*gw] += 1;
      }else{
        grid[gx + gy*gw] += 1;
      }
    }

    if(mode === "xwoba"){
      for(let i=0;i<grid.length;i++){
        if(gridN[i] > 0) grid[i] = grid[i] / gridN[i];
        else grid[i] = 0;
      }
    }

    // Blur (smooth)
    const blurred = blurSeparable(grid, gw, gh, 1.2);

    // Normalize to 0..1
    let mn = Infinity, mx = -Infinity;
    for(let i=0;i<blurred.length;i++){
      const v = blurred[i];
      if(v < mn) mn = v;
      if(v > mx) mx = v;
    }
    const denom = (mx - mn) || 1;

    // Draw to image buffer at grid resolution then scale up
    const img = ctx.createImageData(gw, gh);
    for(let i=0;i<blurred.length;i++){
      const t = (blurred[i] - mn) / denom; // 0..1

      // Basenerd-ish palette: low = blue-ish, mid = light gray, high = red-ish
      let r,g,b,a;
      if(mode === "xwoba"){
        // xwOBA naturally ~0..1; we normalize to 0..1 anyway.
        // Keep higher = "hotter"
      }
      if(t <= 0.5){
        const u = t / 0.5;
        r = 37  + (229-37)*u;
        g = 99  + (231-99)*u;
        b = 235 + (235-235)*u;
      }else{
        const u = (t-0.5)/0.5;
        r = 229 + (239-229)*u;
        g = 231 + (68-231)*u;
        b = 235 + (68-235)*u;
      }
      a = 220; // opacity
      const idx = i*4;
      img.data[idx+0] = Math.max(0, Math.min(255, r));
      img.data[idx+1] = Math.max(0, Math.min(255, g));
      img.data[idx+2] = Math.max(0, Math.min(255, b));
      img.data[idx+3] = Math.max(0, Math.min(255, a));
    }

    // Paint
    ctx.save();
    ctx.imageSmoothingEnabled = true;
    // drawImage from offscreen
    const off = document.createElement("canvas");
    off.width = gw; off.height = gh;
    off.getContext("2d").putImageData(img, 0, 0);
    ctx.drawImage(off, 0, 0, W, H);
    ctx.restore();

    // Subtle fade outside view window is already white background; overlay zone
    setZoneOverlay();
  }

  function drawMovementPlot(rows){
    if(!moveCanvas) return;
    const ctx = moveCanvas.getContext("2d");
    const W = moveCanvas.width, H = moveCanvas.height;

    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = "#fff";
    ctx.fillRect(0,0,W,H);

    // axes bounds in inches
    const xMin = -25, xMax = 25;   // HB
    const yMin = -5,  yMax = 25;   // IVB

    const xScale = (x)=> ((x - xMin)/(xMax-xMin))*W;
    const yScale = (y)=> H - ((y - yMin)/(yMax-yMin))*H;

    // grid
    ctx.strokeStyle = "rgba(226,232,240,.9)";
    ctx.lineWidth = 1;
    for(let i=0;i<=10;i++){
      const x = (i/10)*W;
      ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();
    }
    for(let i=0;i<=10;i++){
      const y = (i/10)*H;
      ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
    }

    // zero lines
    ctx.strokeStyle = "rgba(15,23,42,.22)";
    ctx.beginPath(); ctx.moveTo(xScale(0),0); ctx.lineTo(xScale(0),H); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(0,yScale(0)); ctx.lineTo(W,yScale(0)); ctx.stroke();

    // labels
    ctx.fillStyle = "rgba(91,101,119,.9)";
    ctx.font = '11px "IBM Plex Mono", ui-monospace, Menlo, monospace';
    ctx.fillText("HB (in)", 10, 18);
    ctx.fillText("IVB (in)", 10, 34);

    if(!rows || !rows.length){
      ctx.fillText("No movement data.", 10, 56);
      return;
    }

    // plot points (one per pitch type centroid)
    rows.forEach((r, idx)=>{
      const hb = r.hb_in, ivb = r.ivb_in;
      if(hb == null || ivb == null) return;

      // deterministic swatch-ish color via hue rotation by index (no hardcoding team colors)
      const hue = (idx*57) % 360;
      const fill = `hsla(${hue}, 75%, 50%, .70)`;
      const stroke = `hsla(${hue}, 75%, 30%, .85)`;

      const cx = xScale(hb);
      const cy = yScale(ivb);

      ctx.beginPath();
      ctx.arc(cx, cy, 6, 0, Math.PI*2);
      ctx.fillStyle = fill;
      ctx.fill();
      ctx.lineWidth = 1;
      ctx.strokeStyle = stroke;
      ctx.stroke();

      // label
      ctx.fillStyle = "rgba(15,23,42,.85)";
      ctx.font = '10px "IBM Plex Mono", ui-monospace, Menlo, monospace';
      ctx.fillText(r.pitch || "", cx+8, cy+3);
    });
  }

  function setMixTable(rows){
    if(!mixTable) return;
    const tbody = mixTable.querySelector("tbody");
    if(!tbody) return;

    if(!rows || !rows.length){
      tbody.innerHTML = `<tr><td class="muted" colspan="6">No pitch mix data for this filter.</td></tr>`;
      return;
    }

    tbody.innerHTML = rows.map((r, idx)=>{
      const hue = (idx*57) % 360;
      const sw = `<span class="swatch" style="background: hsla(${hue},75%,50%,.70)"></span>`;
      return `
        <tr>
          <td>
            <span class="mix-pill">${sw}<span style="font-weight:900;">${r.pitch || "—"}</span></span>
          </td>
          <td class="mono">${(r.usage_pct != null ? (r.usage_pct*100).toFixed(1) : "—")}</td>
          <td class="mono">${(r.vavg != null ? r.vavg.toFixed(1) : "—")}</td>
          <td class="mono">${(r.spin != null ? Math.round(r.spin) : "—")}</td>
          <td class="mono">${(r.hb_in != null ? r.hb_in.toFixed(1) : "—")}</td>
          <td class="mono">${(r.ivb_in != null ? r.ivb_in.toFixed(1) : "—")}</td>
        </tr>
      `;
    }).join("");
  }

  function fillPitchTypeOptions(pitchTypes){
    if(!pitPitchType) return;
    const cur = pitPitchType.value || "ALL";
    const opts = [`<option value="ALL">All Pitches</option>`];
    (pitchTypes || []).forEach(pt=>{
      const v = pt.code || pt.pitch_type || pt;
      const label = pt.name || pt.pitch_name || v;
      if(!v) return;
      opts.push(`<option value="${String(v)}">${label}</option>`);
    });
    pitPitchType.innerHTML = opts.join("");
    // restore if possible
    const exists = Array.from(pitPitchType.options).some(o => o.value === cur);
    pitPitchType.value = exists ? cur : "ALL";
  }

  async function loadPitchingGames(season){
    if(!pitGame) return;
    pitGame.innerHTML = `<option value="ALL">Season (All Games)</option>`;
    try{
      const url = `/player/${playerId}/pitching_games_json?season=${encodeURIComponent(season)}`;
      const res = await fetch(url, {cache:"no-store"});
      const data = await res.json();
      const games = data.games || [];
      // each game: {game_pk, label}
      const extra = games.map(g=>{
        return `<option value="${g.game_pk}">${g.label}</option>`;
      }).join("");
      pitGame.insertAdjacentHTML("beforeend", extra);
    }catch(e){
      // keep season-only option
    }
  }

  async function loadPitchingReport(){
    if(!pitSeason || !heatCanvas) return;

    const season = pitSeason.value;
    const gamePk = (pitGame && pitGame.value) ? pitGame.value : "ALL";
    const batter = (pitBatterSide && pitBatterSide.value) ? pitBatterSide.value : "ALL";
    const pitch = (pitPitchType && pitPitchType.value) ? pitPitchType.value : "ALL";
    const heatMode = (pitHeatMode && pitHeatMode.value) ? pitHeatMode.value : "density";

    // Endpoint contract (expected):
    // {
    //   season, game_pk,
    //   pitch_types:[{code,name}],
    //   pitches:[{pitch_type, pitch_name, plate_x, plate_z, pfx_x, pfx_z, release_speed, release_spin_rate, xwoba, is_whiff, is_chase, is_zone}],
    //   summary:{whiff_pct, chase_pct, zone_pct, xwoba_avg},
    //   mix:[{pitch, usage_pct, vavg, spin, hb_in, ivb_in}]
    // }
    const url = `/player/${playerId}/pitching_report_json?season=${encodeURIComponent(season)}&game_pk=${encodeURIComponent(gamePk)}&batter_side=${encodeURIComponent(batter)}`;

    try{
      const res = await fetch(url, {cache:"no-store"});
      const data = await res.json();

      fillPitchTypeOptions(data.pitch_types || []);

      // filter by pitch type client-side
      let pitches = data.pitches || [];
      if(pitch !== "ALL"){
        pitches = pitches.filter(p=> String(p.pitch_type || p.pitch || "") === String(pitch));
      }

      // count
      if(pitCountLabel){
        pitCountLabel.textContent = `${pitches.length} pitches`;
      }

      // KPIs (prefer server-provided, else compute quick)
      const s = data.summary || {};
      const wh = (s.whiff_pct != null ? s.whiff_pct : null);
      const ch = (s.chase_pct != null ? s.chase_pct : null);
      const zn = (s.zone_pct != null ? s.zone_pct : null);
      const xw = (s.xwoba_avg != null ? s.xwoba_avg : null);

      if(kpiWhiff) kpiWhiff.textContent = (wh != null ? (wh*100).toFixed(1)+"%" : "—");
      if(kpiChase) kpiChase.textContent = (ch != null ? (ch*100).toFixed(1)+"%" : "—");
      if(kpiZone)  kpiZone.textContent = (zn != null ? (zn*100).toFixed(1)+"%" : "—");
      if(kpiXwoba) kpiXwoba.textContent = (xw != null ? (Number(xw).toFixed(3)) : "—");

      // Heatmap data mapping
      const pts = pitches.map(p=>{
        return {
          plate_x: (p.plate_x ?? p.px ?? null),
          plate_z: (p.plate_z ?? p.pz ?? null),
          xwoba: (p.xwoba ?? p.estimated_woba_using_speedangle ?? p.xwOBA ?? null)
        };
      });

      drawHeatmap(pts, heatMode);

      // Mix + movement plot (use server mix if available; else aggregate rough)
      let mix = data.mix || null;

      if(!mix){
        // rough aggregate
        const by = {};
        for(const p of pitches){
          const k = (p.pitch_name || p.pitch_type || "UNK");
          if(!by[k]) by[k] = {pitch:k, n:0, v:0, sp:0, hb:0, ivb:0, hbN:0, ivbN:0};
          by[k].n++;
          const v = Number(p.release_speed ?? p.v ?? p.velo);
          if(!isNaN(v)) by[k].v += v;
          const sp = Number(p.release_spin_rate ?? p.spin ?? p.spin_rate);
          if(!isNaN(sp)) by[k].sp += sp;

          // pfx_x / pfx_z are in feet; convert to inches
          const px = Number(p.pfx_x ?? p.hmov ?? null);
          const pz = Number(p.pfx_z ?? p.ivb ?? null);
          if(!isNaN(px)){ by[k].hb += px*12; by[k].hbN++; }
          if(!isNaN(pz)){ by[k].ivb += pz*12; by[k].ivbN++; }
        }
        const total = Object.values(by).reduce((a,r)=>a+r.n,0) || 1;
        mix = Object.values(by)
          .map(r=>({
            pitch: r.pitch,
            usage_pct: r.n/total,
            vavg: (r.v/r.n),
            spin: (r.sp/r.n),
            hb_in: (r.hbN ? r.hb/r.hbN : null),
            ivb_in: (r.ivbN ? r.ivb/r.ivbN : null)
          }))
          .sort((a,b)=> (b.usage_pct||0) - (a.usage_pct||0));
      }

      setMixTable(mix);
      drawMovementPlot(mix);

    }catch(e){
      if(pitCountLabel) pitCountLabel.textContent = "—";
      if(kpiWhiff) kpiWhiff.textContent = "—";
      if(kpiChase) kpiChase.textContent = "—";
      if(kpiZone)  kpiZone.textContent = "—";
      if(kpiXwoba) kpiXwoba.textContent = "—";
      setMixTable(null);
      drawMovementPlot(null);
      drawHeatmap([], "density");
    }
  }

  async function initPitching(){
    if(role === "hitting") return;
    if(!pitSeason) return;

    await loadPitchingGames(pitSeason.value);
    await loadPitchingReport();
  }

  if(pitSeason){
    pitSeason.addEventListener("change", async ()=>{
      await loadPitchingGames(pitSeason.value);
      if(pitGame) pitGame.value = "ALL";
      await loadPitchingReport();
    });
  }
  if(pitGame){
    pitGame.addEventListener("change", loadPitchingReport);
  }
  if(pitBatterSide){
    pitBatterSide.addEventListener("change", loadPitchingReport);
  }
  if(pitPitchType){
    pitPitchType.addEventListener("change", loadPitchingReport);
  }
  if(pitHeatMode){
    pitHeatMode.addEventListener("change", loadPitchingReport);
  }
  if(pitBtn){
    pitBtn.addEventListener("click", loadPitchingReport);
  }

  // load pitching report when tab becomes visible (simple heuristic)
  // also load on page init for pitchers
  initPitching();

})();
</script>

{% endblock content %}
