{% extends "base.html" %}
{% block content %}

{# -----------------------
   Headshot URL
   ----------------------- #}
{% set headshot = "https://img.mlbstatic.com/mlb-photos/image/upload/w_540,q_100/v1/people/" ~ (bio.id|string) ~ "/headshot/67/current" %}

{# -----------------------
   Mini stat cards
   ----------------------- #}
{% macro stat_cell(val, bg) %}
  {% if bg %}
    <span class="statcell" style="background: {{ bg }};">{{ val }}</span>
  {% else %}
    {{ val }}
  {% endif %}
{% endmacro %}
{# -----------------------
   Scouting Report color scale
   0 = blue, 50 = light gray, 100 = red
   ----------------------- #}
{% macro sr_color(pct) %}
  {%- if pct is none -%}
    rgba(229,231,235,1)
  {%- else -%}
    {%- set p = pct|int -%}
    {%- if p < 0 -%}{%- set p = 0 -%}{%- endif -%}
    {%- if p > 100 -%}{%- set p = 100 -%}{%- endif -%}

    {# anchor colors (RGB) #}
    {# blue: 37, 99, 235 (#2563eb) #}
    {# gray: 229, 231, 235 (#e5e7eb) #}
    {# red: 239, 68, 68 (#ef4444) #}

    {%- if p <= 50 -%}
      {%- set t = p / 50 -%}
      {%- set r = (37  + (229-37)  * t) | round | int -%}
      {%- set g = (99  + (231-99)  * t) | round | int -%}
      {%- set b = (235 + (235-235) * t) | round | int -%}
      rgb({{ r }}, {{ g }}, {{ b }})
    {%- else -%}
      {%- set t = (p - 50) / 50 -%}
      {%- set r = (229 + (239-229) * t) | round | int -%}
      {%- set g = (231 + (68-231)  * t) | round | int -%}
      {%- set b = (235 + (68-235)  * t) | round | int -%}
      rgb({{ r }}, {{ g }}, {{ b }})
    {%- endif -%}
  {%- endif -%}
{% endmacro %}
<div class="mono" style="font-size:12px; opacity:.8; margin:8px 0;">
  DEBUG • savant_profile={{ "yes" if savant_profile else "no" }}
  {% if savant_profile %} • available={{ savant_profile.available }} • season={{ savant_profile.season }}{% endif %}
</div><div class="mono" style="font-size:12px; opacity:.8; margin:8px 0;">
  DEBUG • player route hit • bio.id={{ bio.id }} • season_found={{ season_found }} • log_year={{ log_year }}
</div>
{% macro mini_cards(stat, kind, bg_map) %}
  <div class="headline-grid">
    {% if kind == "pitching" %}
      {% for key, label in [
        ('wins','W'),('losses','L'),('era','ERA'),('whip','WHIP'),
        ('inningsPitched','IP'),('strikeOuts','SO'),
        ('saves','SV'),('holds','HLD'),
        ('gamesPlayed','G'),('gamesStarted','GS')
      ] %}
        {% if stat and stat.get(key) is not none and stat.get(key) != '' %}
          <div class="headline-stat" {% set _bg = (bg_map.get(key) if bg_map is defined and bg_map else None) %}{% if _bg %}style="background: {{ _bg }};"{% endif %}>
            <div class="k">{{ label }}</div>
            <div class="v">{{ stat.get(key) }}</div>
          </div>
        {% endif %}
      {% endfor %}
    {% else %}
      {% for key, label in [
        ('gamesPlayed','G'),('atBats','AB'),('hits','H'),('homeRuns','HR'),
        ('rbi','RBI'),('runs','R'),('stolenBases','SB'),
        ('avg','AVG'),('obp','OBP'),('slg','SLG'),('ops','OPS')
      ] %}
        {% if stat and stat.get(key) is not none and stat.get(key) != '' %}
          <div class="headline-stat" {% set _bg = (bg_map.get(key) if bg_map is defined and bg_map else None) %}{% if _bg %}style="background: {{ _bg }};"{% endif %}>
            <div class="k">{{ label }}</div>
            <div class="v">{{ stat.get(key) }}</div>
          </div>
        {% endif %}
      {% endfor %}
    {% endif %}
  </div>
{% endmacro %}

<style>
  .player-header-card{ align-items:stretch; }
  .player-header{
    display:flex;
    align-items:stretch; /* key: photo fills card height */
    gap:14px;
    width:100%;
  }
  .player-headshot{
    width:150px;
    height:100%;
    min-height:170px;
    object-fit:cover;
    border-radius:12px;
    border:1px solid var(--border);
    background:#0b1220;
    flex:0 0 auto;
  }
  .player-meta{ min-width:0; display:flex; flex-direction:column; justify-content:center; }
  .player-name{ font-size:18px; font-weight:800; letter-spacing:.2px; }
  .player-lines{ margin-top:6px; display:flex; flex-direction:column; gap:4px; }

  .headline-grid{
    display:grid;
    grid-template-columns: repeat(11, minmax(0, 1fr));
    gap:8px;
  }
  @media (max-width: 980px){
    .headline-grid{ grid-template-columns: repeat(5, minmax(0, 1fr)); }
    .player-headshot{ width:170px; }
  }
  .headline-stat{
    border:1px solid var(--border);
    background:#fff;
    border-radius:10px;
    padding:8px 10px;
    overflow:hidden;
  }
  .headline-stat .k{
    font-size:10px;
    color: var(--muted);
    font-weight:700;
    letter-spacing:.2px;
    font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace;
  }
  .headline-stat .v{
    margin-top:2px;
    font-size:14px;
    font-weight:900;
    font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace;
  }

  /* tabs */
  .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
  .tab-btn{
    border:1px solid var(--border);
    background:#fff;
    padding:8px 10px;
    border-radius:10px;
    font-weight:800;
    font-size:12px;
    cursor:pointer;
  }
  .tab-btn.active{ background:#0b1220; color:#fff; border-color:#0b1220; }
  .tab-panel{ display:none; margin-top:10px; }
  .tab-panel.active{ display:block; }

  /* game log year select */
  .season-select{
    border:1px solid var(--border);
    border-radius:10px;
    padding:7px 10px;
    font-weight:700;
    background:#fff;
  }
  .btn{
    border:1px solid var(--border);
    border-radius:10px;
    padding:7px 10px;
    font-weight:800;
    background:#fff;
    cursor:pointer;
  }

  /* transactions */
  .tx-list{ display:flex; flex-direction:column; gap:10px; }
  .tx-row{
    display:grid;
    grid-template-columns: 110px 1fr;
    gap:12px;
    padding:10px 10px;
    border:1px solid var(--border);
    border-radius:12px;
    background:#fff;
  }
  .tx-date{
    font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace;
    font-size:11px;
    font-weight:900;
    color:#394150;
    white-space:nowrap;
  }
  .tx-desc{ font-size:12px; color:#111827; }

  /* Year-by-year expanders (mirrors random-player.html) */
  .yearcell{ display:inline-flex; align-items:center; gap:8px; }
  .yspacer{ display:inline-block; width:18px; height:18px; }
  .yexp{
    width:18px;
    height:18px;
    border-radius:6px;
    border:1px solid var(--border);
    background:#fff;
    color:#111827;
    font-weight:900;
    line-height:1;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    justify-content:center;
  }
  .yexp.open{ transform: rotate(180deg); }

  .acc-pill{
    font-size:10px;
    font-weight:900;
    padding:2px 7px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#fff;
    color:#111827;
    display:inline-block;
    margin-right:6px;
    margin-bottom:4px;
  }

  /* ==========================
     Scouting Report (Savant-style)
     ========================== */
 .sr-wrap{
  display:flex;
  flex-direction:column;
  gap:14px;
}
.sr-group-title{
  font-weight:900;
  letter-spacing:.2px;
  color:#111827;
  margin:6px 0 6px;
  padding-bottom:4px;
  border-bottom:1px dashed var(--border);
}

.sr-grid{
  display:flex;
  flex-direction:column;
  gap:9px;
}

.sr-row{
  display:grid;
  grid-template-columns: 120px 1fr 72px;
  gap:12px;
  align-items:center;
}

@media (max-width: 980px){
  .sr-row{
    grid-template-columns: 110px 1fr 64px;
  }
}

.sr-label{
  font-size:12px;
  font-weight:700;
  color:#374151;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.sr-value{
  text-align:right;
  font-size:12px;
  font-weight:800;
  letter-spacing:.2px;
  font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace;
  color:#111827;
  white-space:nowrap;
}

.sr-marker{
  position:absolute;
  top:50%;
  transform:translate(-50%, -50%);
  width:22px;
  height:22px;
  border-radius:999px;
  background:#0b1220;
  border:2px solid #ffffff;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 4px 10px rgba(0,0,0,.18);
  pointer-events:none;
}

.sr-marker span{
  font-size:10px;
  font-weight:900;
  color:#ffffff;
  font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace;
  line-height:1;
}

.sr-bar{
  position:relative;
  height:14px;
  border-radius:999px;
  overflow:hidden;
  border:1px solid var(--border);
  background:#f1f5f9;
}

.sr-fill{
  position:absolute;
  inset:0 auto 0 0;
  width:0%;
  border-radius:999px;
  /* background is set inline by Jinja */
}
/* we’ll recolor via data attribute shortly */

.sr-muted{
  margin-top:10px;
  font-size:11px;
  color:var(--muted);
}

.sr-pill{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-size:10px;
  font-weight:900;
  padding:3px 8px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#fff;
  color:#111827;
  font-family:"IBM Plex Mono", ui-monospace, Menlo, monospace;
}

  /* ==========================
     Spray Chart
     ========================== */
  .spray-controls{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
  .spray-controls label{
    display:inline-flex;
    align-items:center;
    gap:6px;
    font-size:12px;
    font-weight:800;
    color:#111827;
    cursor:pointer;
  }
  .spray-controls input[type="checkbox"]{ transform: translateY(1px); }
  .spray-legend{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    margin-top:10px;
    font-size:11px;
    color: var(--muted);
  }
  .spray-key{ display:inline-flex; align-items:center; gap:6px; }
  .spray-swatch{ width:10px; height:10px; border-radius:999px; border:1px solid rgba(0,0,0,.15); }
  .spray-wrap{
    margin-top:10px;
    border:1px solid var(--border);
    border-radius:14px;
    background: linear-gradient(180deg, rgba(2,6,23,.05), rgba(2,6,23,0));
    overflow:hidden;
  }
  .spray-svg{
    width:100%;
    height:auto;
    display:block;
    background: radial-gradient(circle at 50% 20%, rgba(34,197,94,.18), rgba(34,197,94,.06) 45%, rgba(15,23,42,.02) 70%);
  }
  .spray-note{ margin-top:10px; font-size:11px; color: var(--muted); }

</style>

<!-- =======================
     Header card
     ======================= -->
<div class="card player-top">
  <div class="card-header player-header-card">
    <div class="player-header">
      <img class="player-headshot" src="{{ headshot }}" alt="{{ bio.fullName }}">

      <div class="player-meta">
        <div class="player-name">{{ bio.fullName }}</div>

        <div class="player-lines">
          <div class="muted">
            {% if bio.currentTeam and bio.currentTeam.name %}{{ bio.currentTeam.name }}{% endif %}
            {% if bio.primaryPosition and bio.primaryPosition.name %} • {{ bio.primaryPosition.name }}{% endif %}
          </div>

          {% if bio.currentAge or bio.height or bio.weight %}
            <div class="muted">
              {% if bio.currentAge %}Age {{ bio.currentAge }}{% endif %}
              {% if bio.height %}{% if bio.currentAge %} • {% endif %}{{ bio.height }}{% endif %}
              {% if bio.weight %}{% if bio.currentAge or bio.height %} • {% endif %}{{ bio.weight }} lb{% endif %}
            </div>
          {% endif %}

          {% if (bio.batSide and bio.batSide.code) or (bio.pitchHand and bio.pitchHand.code) %}
            <div class="muted">
              {% if bio.batSide and bio.batSide.code %}Bats: {{ bio.batSide.code }}{% endif %}
              {% if bio.pitchHand and bio.pitchHand.code %}{% if bio.batSide and bio.batSide.code %} • {% endif %}Throws: {{ bio.pitchHand.code }}{% endif %}
            </div>
          {% endif %}

          {% if bio.mlbDebutDate %}
            <div class="muted">MLB Debut: {{ bio.mlbDebutDate[:10] }}</div>
          {% endif %}

          {% if bio.birthCity or bio.birthStateProvince or bio.birthCountry %}
            <div class="muted">
              Born:
              {% if bio.birthCity %}{{ bio.birthCity }}{% endif %}
              {% if bio.birthStateProvince %}{% if bio.birthCity %}, {% endif %}{{ bio.birthStateProvince }}{% endif %}
              {% if bio.birthCountry %}{% if bio.birthCity or bio.birthStateProvince %} • {% endif %}{{ bio.birthCountry }}{% endif %}
            </div>
          {% endif %}

          {% if bio.education %}
            <div class="muted">{{ bio.education }}</div>
          {% endif %}

          {% if bio.draftYear or bio.draftRound or bio.draftPickNumber %}
            <div class="muted">
              Draft:
              {% if bio.draftYear %}{{ bio.draftYear }}{% endif %}
              {% if bio.draftRound %}{% if bio.draftYear %} • {% endif %}R{{ bio.draftRound }}{% endif %}
              {% if bio.draftPickNumber %}{% if bio.draftYear or bio.draftRound %} • {% endif %}Pick {{ bio.draftPickNumber }}{% endif %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- =======================
     Season Snapshot (from year-by-year source)
     ======================= -->
<div class="card">
  <div class="card-header">
    <div>
      <div class="card-title">{{ season_found if season_found else "—" }} Stats
      </div>
    </div>
  </div>

  <div class="card-body">
    {% if role == "two-way" %}
      {% if snapshot_hitting %}
        <div style="margin-bottom:10px;">
          <div class="subcard-title">Hitting</div>
          {{ mini_cards(snapshot_hitting, "hitting", snapshot_bg_hitting) }}
        </div>
      {% endif %}
      {% if snapshot_pitching %}
        <div>
          <div class="subcard-title">Pitching</div>
          {{ mini_cards(snapshot_pitching, "pitching", snapshot_bg_pitching) }}
        </div>
      {% endif %}
      {% if (not snapshot_hitting) and (not snapshot_pitching) %}
        <div class="muted">No stats found.</div>
      {% endif %}
    {% elif role == "pitching" %}
      {% if snapshot_pitching %}
        {{ mini_cards(snapshot_pitching, "pitching", snapshot_bg_pitching) }}
      {% else %}
        <div class="muted">No stats found.</div>
      {% endif %}
    {% else %}
      {% if snapshot_hitting %}
        {{ mini_cards(snapshot_hitting, "hitting", snapshot_bg_hitting) }}
      {% else %}
        <div class="muted">No stats found.</div>
      {% endif %}
    {% endif %}
  </div>
</div>

<!-- =======================
     Career Stats (directly under snapshot)
     ======================= -->
<div class="card">
  <div class="card-header">
    <div class="card-title">Career Stats</div>
  </div>

  <div class="card-body">
    {% if role == "two-way" %}
      <div style="margin-bottom:12px;">
        <div class="subcard-title">Hitting</div>
        {% if career_hitting %}{{ mini_cards(career_hitting, "hitting", {}) }}{% else %}<div class="muted">—</div>{% endif %}
      </div>
      <div>
        <div class="subcard-title">Pitching</div>
        {% if career_pitching %}{{ mini_cards(career_pitching, "pitching", {}) }}{% else %}<div class="muted">—</div>{% endif %}
      </div>
    {% elif role == "pitching" %}
      {% if career_pitching %}{{ mini_cards(career_pitching, "pitching", {}) }}{% else %}<div class="muted">—</div>{% endif %}
    {% else %}
      {% if career_hitting %}{{ mini_cards(career_hitting, "hitting", {}) }}{% else %}<div class="muted">—</div>{% endif %}
    {% endif %}
  </div>
</div>

<!-- ===== Tabs ===== -->
<div class="tabs" style="margin-top:12px;">
  <button class="tab-btn active" data-tab="tab-yby">Year-by-Year</button>
  <button class="tab-btn" data-tab="tab-gamelog">Game Logs</button>
  <button class="tab-btn" data-tab="tab-tx">Transactions</button>
  <button class="tab-btn" data-tab="tab-scouting">Scouting Report</button>
  <button class="tab-btn" data-tab="tab-spray">Spray Chart</button>
</div>

<!-- =======================
     Year-by-Year (mirrors random-player.html)
     ======================= -->
<div id="tab-yby" class="tab-panel active">

  {% set _hg = (hitting_groups if hitting_groups is defined else []) %}
  {% set _pg = (pitching_groups if pitching_groups is defined else []) %}
  {% set has_hitting = (_hg|length) > 0 %}
  {% set has_pitching = (_pg|length) > 0 %}

  {% if has_hitting %}
  <div class="card" style="margin-top:14px;">
    <div class="card-header">
      <div class="card-title">Year-by-Year Hitting</div>
    </div>

    <div style="overflow:auto;">
      <table class="table" style="width:100%; min-width:900px;">
        <thead>
          <tr>
            <th>Year</th>
            <th>Team</th>
            <th>G</th><th>PA</th><th>AB</th><th>H</th>
            <th>HR</th><th>RBI</th><th>SB</th>
            <th>AVG</th><th>OBP</th><th>SLG</th><th>OPS</th><th>Awards</th>
          </tr>
        </thead>
        <tbody>

          {% for g in _hg %}
            {% set r = g.total %}
            {% if r %}
              {% set s = r.stat %}
              {% set has_parts = (g.parts and (g.parts|length) > 0) %}
              {% set rk = g.year ~ ':Total' %}

              <tr class="year-row">
                <td style="white-space:nowrap;">
                  <span class="yearcell">
                    <span>{{ g.year }}</span>

                    {% if has_parts %}
                      <button class="yexp" type="button" data-kind="hitting" data-year="{{ g.year }}" aria-label="Expand year">▾</button>
                    {% else %}
                      <span class="yspacer"></span>
                    {% endif %}
                  </span>
                </td>

                <td style="min-width:220px;">{{ "Total" if has_parts else r.team }}</td>

                <td>{{ stat_cell(s.gamesPlayed or "—", (yby_bg_hitting.get(rk) or {}).get('gamesPlayed')) }}</td>
                <td>{{ stat_cell(s.plateAppearances or "—", (yby_bg_hitting.get(rk) or {}).get('plateAppearances')) }}</td>
                <td>{{ stat_cell(s.atBats or "—", (yby_bg_hitting.get(rk) or {}).get('atBats')) }}</td>
                <td>{{ stat_cell(s.hits or "—", (yby_bg_hitting.get(rk) or {}).get('hits')) }}</td>
                <td>{{ stat_cell(s.homeRuns or "—", (yby_bg_hitting.get(rk) or {}).get('homeRuns')) }}</td>
                <td>{{ stat_cell(s.rbi or "—", (yby_bg_hitting.get(rk) or {}).get('rbi')) }}</td>
                <td>{{ stat_cell(s.stolenBases or "—", (yby_bg_hitting.get(rk) or {}).get('stolenBases')) }}</td>
                <td>{{ stat_cell(s.avg or "—", (yby_bg_hitting.get(rk) or {}).get('avg')) }}</td>
                <td>{{ stat_cell(s.obp or "—", (yby_bg_hitting.get(rk) or {}).get('obp')) }}</td>
                <td>{{ stat_cell(s.slg or "—", (yby_bg_hitting.get(rk) or {}).get('slg')) }}</td>
                <td>{{ stat_cell(s.ops or "—", (yby_bg_hitting.get(rk) or {}).get('ops')) }}</td>
                <td>
                  {% set y = g.year %}
                  {% if award_year_map is defined and award_year_map[y] is defined %}
                    {% set award_labels = {
                      "mvp":"MVP",
                      "cyyoung":"CY",
                      "roy":"ROY",
                      "goldglove":"GG",
                      "platinumglove":"PG",
                      "silverslugger":"SS",
                      "allstar":"AS",
                      "battingchamp":"BC",
                      "hrderby":"HRD",
                      "wsmvp":"WS-MVP",
                      "wschamp":"WS",
                      "hof":"HOF"
                    } %}
                    {% for k in award_year_map[y] %}
                      <span class="acc-pill acc-{{ k }}">
                        {{ award_labels[k] if award_labels[k] is defined else k|upper }}
                      </span>
                    {% endfor %}
                  {% endif %}
                </td>
              </tr>

              {% if has_parts %}
                {% for p in g.parts %}
                  {% set ps = p.stat %}
                  {% set rk2 = g.year ~ ':' ~ p.team %}
                  <tr class="ychild ychild-hitting ychild-{{ g.year }}" style="display:none; opacity:.92;">
                    <td style="white-space:nowrap; padding-left:16px;">{{ p.year }}</td>
                    <td style="min-width:220px;">{{ p.team }}</td>
                    <td>{{ stat_cell(ps.gamesPlayed or "—", (yby_bg_hitting.get(rk2) or {}).get('gamesPlayed')) }}</td>
                    <td>{{ stat_cell(ps.plateAppearances or "—", (yby_bg_hitting.get(rk2) or {}).get('plateAppearances')) }}</td>
                    <td>{{ stat_cell(ps.atBats or "—", (yby_bg_hitting.get(rk2) or {}).get('atBats')) }}</td>
                    <td>{{ stat_cell(ps.hits or "—", (yby_bg_hitting.get(rk2) or {}).get('hits')) }}</td>
                    <td>{{ stat_cell(ps.homeRuns or "—", (yby_bg_hitting.get(rk2) or {}).get('homeRuns')) }}</td>
                    <td>{{ stat_cell(ps.rbi or "—", (yby_bg_hitting.get(rk2) or {}).get('rbi')) }}</td>
                    <td>{{ stat_cell(ps.stolenBases or "—", (yby_bg_hitting.get(rk2) or {}).get('stolenBases')) }}</td>
                    <td>{{ stat_cell(ps.avg or "—", (yby_bg_hitting.get(rk2) or {}).get('avg')) }}</td>
                    <td>{{ stat_cell(ps.obp or "—", (yby_bg_hitting.get(rk2) or {}).get('obp')) }}</td>
                    <td>{{ stat_cell(ps.slg or "—", (yby_bg_hitting.get(rk2) or {}).get('slg')) }}</td>
                    <td>{{ stat_cell(ps.ops or "—", (yby_bg_hitting.get(rk2) or {}).get('ops')) }}</td>
                    <td></td>
                  </tr>
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}

        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {% if has_pitching %}
  <div class="card" style="margin-top:14px;">
    <div class="card-header">
      <div class="card-title">Year-by-Year Pitching</div>
    </div>

    <div style="overflow:auto;">
      <table class="table" style="width:100%; min-width:980px;">
        <thead>
          <tr>
            <th>Year</th>
            <th>Team</th>
            <th>G</th><th>GS</th><th>IP</th>
            <th>W</th><th>L</th><th>SV</th><th>SO</th>
            <th>ERA</th><th>WHIP</th><th>Awards</th>
          </tr>
        </thead>
        <tbody>

          {% for g in _pg %}
            {% set r = g.total %}
            {% if r %}
              {% set s = r.stat %}
              {% set has_parts = (g.parts and (g.parts|length) > 0) %}
              {% set rk = g.year ~ ':Total' %}

              <tr class="year-row">
                <td style="white-space:nowrap;">
                  <span class="yearcell">
                    <span>{{ g.year }}</span>

                    {% if has_parts %}
                      <button class="yexp" type="button" data-kind="pitching" data-year="{{ g.year }}" aria-label="Expand year">▾</button>
                    {% else %}
                      <span class="yspacer"></span>
                    {% endif %}
                  </span>
                </td>

                <td style="white-space:nowrap;">{{ "Total" if has_parts else r.team }}</td>

                <td>{{ s.gamesPitched or "—" }}</td>
                <td>{{ stat_cell(s.gamesStarted or "—", (yby_bg_pitching.get(rk) or {}).get('gamesStarted')) }}</td>
                <td>{{ stat_cell(s.inningsPitched or "—", (yby_bg_pitching.get(rk) or {}).get('inningsPitched')) }}</td>
                <td>{{ stat_cell(s.wins or "—", (yby_bg_pitching.get(rk) or {}).get('wins')) }}</td>
                <td>{{ stat_cell(s.losses or "—", (yby_bg_pitching.get(rk) or {}).get('losses')) }}</td>
                <td>{{ stat_cell(s.saves or "—", (yby_bg_pitching.get(rk) or {}).get('saves')) }}</td>
                <td>{{ stat_cell(s.strikeOuts or "—", (yby_bg_pitching.get(rk) or {}).get('strikeOuts')) }}</td>
                <td>{{ stat_cell(s.era or "—", (yby_bg_pitching.get(rk) or {}).get('era')) }}</td>
                <td>{{ stat_cell(s.whip or "—", (yby_bg_pitching.get(rk) or {}).get('whip')) }}</td>
                <td>
                  {% set y = g.year %}
                  {% if award_year_map is defined and award_year_map[y] is defined %}
                    {% set award_labels = {
                      "mvp":"MVP",
                      "cyyoung":"CY",
                      "roy":"ROY",
                      "goldglove":"GG",
                      "platinumglove":"PG",
                      "silverslugger":"SS",
                      "allstar":"AS",
                      "battingchamp":"BC",
                      "hrderby":"HRD",
                      "wsmvp":"WS-MVP",
                      "wschamp":"WS",
                      "hof":"HOF"
                    } %}
                    {% for k in award_year_map[y] %}
                      <span class="acc-pill acc-{{ k }}">
                        {{ award_labels[k] if award_labels[k] is defined else k|upper }}
                      </span>
                    {% endfor %}
                  {% endif %}
                </td>
              </tr>

              {% if has_parts %}
                {% for p in g.parts %}
                  {% set ps = p.stat %}
                  {% set rk2 = g.year ~ ':' ~ p.team %}
                  {% set rk2 = g.year ~ ':' ~ p.team %}
                  <tr class="ychild ychild-pitching ychild-{{ g.year }}" style="display:none; opacity:.92;">
                    <td style="white-space:nowrap; padding-left:16px;">{{ p.year }}</td>
                    <td style="white-space:nowrap;">{{ p.team }}</td>
                    <td>{{ ps.gamesPitched or "—" }}</td>
                    <td>{{ stat_cell(ps.gamesStarted or "—", (yby_bg_pitching.get(rk2) or {}).get('gamesStarted')) }}</td>
                    <td>{{ stat_cell(ps.inningsPitched or "—", (yby_bg_pitching.get(rk2) or {}).get('inningsPitched')) }}</td>
                    <td>{{ stat_cell(ps.wins or "—", (yby_bg_pitching.get(rk2) or {}).get('wins')) }}</td>
                    <td>{{ stat_cell(ps.losses or "—", (yby_bg_pitching.get(rk2) or {}).get('losses')) }}</td>
                    <td>{{ stat_cell(ps.saves or "—", (yby_bg_pitching.get(rk2) or {}).get('saves')) }}</td>
                    <td>{{ stat_cell(ps.strikeOuts or "—", (yby_bg_pitching.get(rk2) or {}).get('strikeOuts')) }}</td>
                    <td>{{ stat_cell(ps.era or "—", (yby_bg_pitching.get(rk2) or {}).get('era')) }}</td>
                    <td>{{ stat_cell(ps.whip or "—", (yby_bg_pitching.get(rk2) or {}).get('whip')) }}</td>
                    <td></td>
                  </tr>
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}

        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {% if (not has_hitting) and (not has_pitching) %}
    <div class="card" style="margin-top:14px;">
      <div class="card-body">
        <div class="muted">No year-by-year rows available.</div>
      </div>
    </div>
  {% endif %}

</div>

<!-- =======================
     Game Logs (table)
     ======================= -->
<div id="tab-gamelog" class="tab-panel">
  <div class="card">
    <div class="card-header" style="align-items:center;">
      <div>
        <div class="card-title">Game Logs</div>
        <div class="card-subtitle">Season selector loads one year at a time.</div>
      </div>
      <form method="get" action="/player/{{ bio.id }}" style="display:flex; gap:8px; align-items:center;">
        <select name="log_year" class="season-select">
          {% for y in years %}
            <option value="{{ y }}" {% if y == log_year %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
        <button class="btn" type="submit">Load</button>
      </form>
    </div>

    <div class="card-body">
      {% if role != "pitching" %}
        <div class="subcard-title">Hitting</div>
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Opponent</th>
                <th class="num">AB</th>
                <th class="num">H</th>
                <th class="num">2B</th>
                <th class="num">3B</th>
                <th class="num">HR</th>
                <th class="num">RBI</th>
                <th class="num">R</th>
                <th class="num">BB</th>
                <th class="num">SO</th>
              </tr>
            </thead>
            <tbody>
              {% for g in (game_logs.hitting or []) %}
                {% set s = g.stat or {} %}
                <tr>
                  <td>{{ g.date }}</td>
                  <td>{{ g.opponent }}</td>
                  <td class="num">{{ s.get('atBats','') }}</td>
                  <td class="num">{{ s.get('hits','') }}</td>
                  <td class="num">{{ s.get('doubles','') }}</td>
                  <td class="num">{{ s.get('triples','') }}</td>
                  <td class="num">{{ s.get('homeRuns','') }}</td>
                  <td class="num">{{ s.get('rbi','') }}</td>
                  <td class="num">{{ s.get('runs','') }}</td>
                  <td class="num">{{ s.get('baseOnBalls','') }}</td>
                  <td class="num">{{ s.get('strikeOuts','') }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}

      {% if role != "hitting" %}
        <div class="subcard-title" style="margin-top:16px;">Pitching</div>
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Opponent</th>
                <th class="num">IP</th>
                <th class="num">H</th>
                <th class="num">R</th>
                <th class="num">ER</th>
                <th class="num">BB</th>
                <th class="num">SO</th>
                <th class="num">HR</th>
              </tr>
            </thead>
            <tbody>
              {% for g in (game_logs.pitching or []) %}
                {% set s = g.stat or {} %}
                <tr>
                  <td>{{ g.date }}</td>
                  <td>{{ g.opponent }}</td>
                  <td class="num">{{ s.get('inningsPitched','') }}</td>
                  <td class="num">{{ s.get('hits','') }}</td>
                  <td class="num">{{ s.get('runs','') }}</td>
                  <td class="num">{{ s.get('earnedRuns','') }}</td>
                  <td class="num">{{ s.get('baseOnBalls','') }}</td>
                  <td class="num">{{ s.get('strikeOuts','') }}</td>
                  <td class="num">{{ s.get('homeRuns','') }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- =======================
     Transactions
     ======================= -->
<div id="tab-tx" class="tab-panel">
  <div class="card">
    <div class="card-header">
      <div class="card-title">Transactions</div>
      <div class="card-subtitle">Entire history • newest first.</div>
    </div>
    <div class="card-body">
      {% if transactions and transactions|length %}
        <div class="tx-list">
          {% for t in transactions %}
            <div class="tx-row">
              <div class="tx-date">{{ t.date }}</div>
              <div class="tx-desc">{{ t.description }}</div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="muted">No transactions found.</div>
      {% endif %}
    </div>
  </div>
</div>

<!-- =======================
     Scouting Report
     ======================= -->
<div id="tab-scouting" class="tab-panel">
  <div class="card">
    <div class="card-header" style="align-items:center;">
      <div>
        <div class="card-title">Scouting Report</div>
        <div class="card-subtitle">Statcast-style percentiles • Basenerd theme</div>
      </div>

      {% if season_found %}
        <div class="sr-pill">Season {{ season_found }}</div>
      {% endif %}
    </div>

    <div class="card-body">
      {% if savant_profile and savant_profile.available %}
        <div class="sr-wrap">
          {% for g in savant_profile.groups %}
            <div>
              <div class="sr-group-title">{{ g.title }}</div>

              <div class="sr-grid">
                {% for r in g.rows %}
                  <div class="sr-row">
                    <div class="sr-label mono">{{ r.label }}</div>

                    <div class="sr-bar" title="{{ r.label }}">

                       {% if r.pct is not none %}
                          <div class="sr-fill" style="width: {{ r.pct }}%; background: {{ sr_color(r.pct) }};"></div>
                        {% endif %}
                       {% if r.pct is not none %}
                         {% set p = r.pct %}
                         <div class="sr-marker" style="left: {{ p }}%;">
                           <span>{{ p }}</span>
                         </div>
                       {% else %}
                         <div class="sr-marker" style="left: 0; opacity:.55;">
                           <span>—</span>
                         </div>
                       {% endif %}

                     </div>

                    <div class="sr-value">
                      {% if r.value is none %}
                        —
                      {% else %}
                        {% if r.fmt == "3f" %}{{ "%.3f"|format(r.value) }}
                        {% elif r.fmt == "1f" %}{{ "%.1f"|format(r.value) }}
                        {% else %}{{ r.value }}
                        {% endif %}
                        {{ r.suffix if r.suffix is defined else "" }}
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>

        <div class="sr-muted">
          Percentiles are relative to the season pool. (For K%, Whiff%, Chase%, lower is better.)
        </div>
      {% else %}
        <div class="muted">
          No Statcast scouting data found for this season yet.
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- =======================
     Spray Chart
     ======================= -->
<div id="tab-spray" class="tab-panel">
  <div class="card">
    <div class="card-header" style="align-items:center;">
      <div>
        <div class="card-title">Spray Chart</div>
        <div class="card-subtitle">Batted ball locations • colored by event</div>
      </div>

      <div class="spray-controls">
        <label title="Hits only">
          <input id="sprayHitsOnly" type="checkbox" checked>
          Hits only
        </label>

        <label title="Include outs (field out, GIDP, etc.)">
          <input id="sprayShowOuts" type="checkbox">
          Show outs
        </label>

        <label title="Season">
          <span class="mono" style="font-size:11px; opacity:.75;">Season</span>
          <select id="spraySeason" class="season-select">
            {% for y in years %}
              <option value="{{ y }}" {% if season_found and (y|string) == (season_found|string) %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
          </select>
        </label>

        <button id="sprayRefreshBtn" class="btn" type="button">Refresh</button>
      </div>
    </div>

    <div class="card-body">
      <div class="spray-wrap">
        <svg id="spraySvg" class="spray-svg" viewBox="-260 -560 520 600" xmlns="http://www.w3.org/2000/svg" aria-label="Spray chart field">
          <!-- Field outline -->
          <g opacity="0.9">
            <!-- foul lines -->
            <path d="M 0 0 L -245 -245" fill="none" stroke="rgba(15,23,42,.35)" stroke-width="2"/>
            <path d="M 0 0 L 245 -245" fill="none" stroke="rgba(15,23,42,.35)" stroke-width="2"/>
            <!-- outfield arc (approx) -->
            <path d="M -245 -245 A 360 360 0 0 1 245 -245" fill="none" stroke="rgba(15,23,42,.25)" stroke-width="2"/>
            <!-- infield (approx diamond) -->
            <path d="M 0 0 L -65 -65 L 0 -130 L 65 -65 Z" fill="none" stroke="rgba(15,23,42,.18)" stroke-width="2"/>
            <!-- home plate marker -->
            <circle cx="0" cy="0" r="3" fill="rgba(15,23,42,.55)"/>
          </g>

          <g id="sprayPoints"></g>
        </svg>
      </div>

      <div class="spray-legend">
        <span class="spray-key"><span class="spray-swatch" style="background:#22c55e;"></span> 1B</span>
        <span class="spray-key"><span class="spray-swatch" style="background:#3b82f6;"></span> 2B</span>
        <span class="spray-key"><span class="spray-swatch" style="background:#a855f7;"></span> 3B</span>
        <span class="spray-key"><span class="spray-swatch" style="background:#ef4444;"></span> HR</span>
        <span class="spray-key"><span class="spray-swatch" style="background:#94a3b8;"></span> Out</span>
        <span class="spray-key"><span class="spray-swatch" style="background:#f59e0b;"></span> Other</span>
      </div>

      <div class="spray-note">
        Note: This uses Statcast hit coordinates (hc_x / hc_y) transformed to a fixed catcher’s-view field (LF left, RF right). If you ever notice it’s mirrored, we’ll flip the X-axis once and keep it consistent everywhere.
      </div>
    </div>
  </div>
</div>

<script>
  (function(){
    // Tabs
    const btns = document.querySelectorAll(".tab-btn");
    const panels = document.querySelectorAll(".tab-panel");
    btns.forEach(b => b.addEventListener("click", () => {
      btns.forEach(x => x.classList.remove("active"));
      panels.forEach(p => p.classList.remove("active"));
      b.classList.add("active");
      document.getElementById(b.dataset.tab).classList.add("active");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }));

    // Expand/collapse year children (multi-team seasons) — same behavior as random player
    document.querySelectorAll(".yexp").forEach(b => {
      b.addEventListener("click", () => {
        const year = b.getAttribute("data-year");
        const kind = b.getAttribute("data-kind");
        const rows = document.querySelectorAll(`.ychild-${kind}.ychild-${year}`);
        const isOpen = b.classList.toggle("open");
        rows.forEach(r => r.style.display = isOpen ? "table-row" : "none");
      });
    });

    // -------------------------
    // Spray Chart (player)
    // -------------------------
    const sprayPanel = document.getElementById("tab-spray");
    const spraySvg = document.getElementById("spraySvg");
    const sprayPointsG = document.getElementById("sprayPoints");
    const sprayHitsOnly = document.getElementById("sprayHitsOnly");
    const sprayShowOuts = document.getElementById("sprayShowOuts");
    const spraySeasonSel = document.getElementById("spraySeason");
    const sprayRefreshBtn = document.getElementById("sprayRefreshBtn");

    let sprayCache = null;       // raw points from API
    let sprayTimer = null;

    function sprayColorFor(ev, isHit){
      const e = (ev || "").toLowerCase();
      if(e === "single") return "#22c55e";
      if(e === "double") return "#3b82f6";
      if(e === "triple") return "#a855f7";
      if(e === "home_run") return "#ef4444";
      if(!isHit) return "#94a3b8";
      return "#f59e0b";
    }

    // Statcast hc_x/hc_y -> field coords (based on common Savant/pybaseball transform)
    function statcastToField(hc_x, hc_y){
      // These anchors keep the field in a consistent orientation (catcher POV).
      const plateX = 125.42;
      const plateY = 198.27;
      const x = (hc_x - plateX);      // left/right from home
      const y = (plateY - hc_y);      // distance upfield
      return { x, y };
    }

    function renderSpray(){
      if(!sprayCache || !Array.isArray(sprayCache.points)) return;

      const hitsOnly = sprayHitsOnly && sprayHitsOnly.checked;
      const showOuts = sprayShowOuts && sprayShowOuts.checked;

      // Clear
      while(sprayPointsG.firstChild) sprayPointsG.removeChild(sprayPointsG.firstChild);

      // Filter + draw
      for(const p of sprayCache.points){
        const isHit = !!p.is_hit;
        const isOut = !isHit;

        if(hitsOnly){
          if(isOut && !showOuts) continue;
        }

        const fx = p.hc_x;
        const fy = p.hc_y;
        if(fx === null || fx === undefined || fy === null || fy === undefined) continue;

        const { x, y } = statcastToField(Number(fx), Number(fy));

        // SVG y-axis is down; outfield should go up => invert y
        const sx = x;
        const sy = -y;

        // skip super weird points
        if(!isFinite(sx) || !isFinite(sy)) continue;

        const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        c.setAttribute("cx", sx.toFixed(2));
        c.setAttribute("cy", sy.toFixed(2));
        c.setAttribute("r", "3.2");
        c.setAttribute("fill", sprayColorFor(p.event, isHit));
        c.setAttribute("fill-opacity", "0.85");
        c.setAttribute("stroke", "rgba(15,23,42,.25)");
        c.setAttribute("stroke-width", "0.6");

        const title = document.createElementNS("http://www.w3.org/2000/svg", "title");
        title.textContent = `${p.event || "batted ball"}${p.inning ? " • inn " + p.inning : ""}`;
        c.appendChild(title);

        sprayPointsG.appendChild(c);
      }
    }

    async function loadSpray(){
      const season = spraySeasonSel ? spraySeasonSel.value : "";
      const url = `/player/{{ bio.id }}/spray.json?season=${encodeURIComponent(season)}`;

      try{
        const res = await fetch(url, { cache: "no-store" });
        if(!res.ok) throw new Error(`spray fetch failed: ${res.status}`);
        sprayCache = await res.json();
        renderSpray();
      }catch(err){
        console.error(err);
      }
    }

    function startSprayAuto(){
      stopSprayAuto();
      // refresh every 30s while the tab is open
      sprayTimer = setInterval(() => {
        const active = sprayPanel && sprayPanel.classList.contains("active");
        if(active) loadSpray();
      }, 30000);
    }

    function stopSprayAuto(){
      if(sprayTimer){
        clearInterval(sprayTimer);
        sprayTimer = null;
      }
    }

    // wire up controls
    if(sprayRefreshBtn) sprayRefreshBtn.addEventListener("click", loadSpray);
    if(sprayHitsOnly) sprayHitsOnly.addEventListener("change", renderSpray);
    if(sprayShowOuts) sprayShowOuts.addEventListener("change", renderSpray);
    if(spraySeasonSel) spraySeasonSel.addEventListener("change", loadSpray);

    // when switching tabs, lazily load spray only when opened
    btns.forEach(b => b.addEventListener("click", () => {
      if(b.dataset.tab === "tab-spray"){
        loadSpray();
        startSprayAuto();
      }else{
        // keep timer running only if spray tab is active
        stopSprayAuto();
      }
    }));

  })();
</script>

{% endblock %}
