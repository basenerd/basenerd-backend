{% extends "base.html" %}
{% block content %}

<div class="card">
  <div class="card-header">
    <div>
      <div class="card-title">Standings</div>
      <div class="card-subtitle">Season {{ season }}</div>
    </div>

    <form method="get" action="/standings" style="display:flex; gap:8px; align-items:center;">
      <select name="season">
        {% for y in seasons %}
          <option value="{{ y }}" {% if y == season %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
      <button type="submit">Go</button>
    </form>
  </div>

  {% if error %}
    <div class="card-body">
      <div class="error-banner">{{ error }}</div>
    </div>
  {% endif %}
</div>

<style>
  .pctcell{
    border-radius:8px;
    padding:4px 8px;
    display:inline-block;
    min-width:56px;
    text-align:right;
  }

  /* KILL any pseudo-element "dot" that might be applied to numeric cells */
  td.pctcol::after, td.pctcol::before,
  th.pctcol::after, th.pctcol::before,
  td.pctcol *::after, td.pctcol *::before{
    content: none !important;
  }

  /* Streak alignment: emoji in fixed-width slot on right */
  .streakwrap{
    display:flex;
    justify-content:flex-end;
    align-items:center;
    gap:6px;
  }
  .streakemoji{
    width:16px;
    text-align:center;
    display:inline-block;
    opacity:0.95;
  }

  /* tiny icon column */
  .tagcol{
    width:34px;
    text-align:center;
    white-space:nowrap;
  }
  .tagicon{
    display:inline-block;
    width:18px;
    text-align:center;
  }

  /* TOP playoff block (NOT a table) */
  .pp-block{
    padding:12px 12px 8px;
    border-top:1px solid rgba(255,255,255,0.08);
  }
  .pp-subtitle{
    font-size:11px;
    font-weight:800;
    opacity:0.75;
    margin:0 0 8px 0;
  }
  .pp-row{
    display:flex;
    gap:12px;
    width:100%;
    margin:0 0 12px 0;
  }
  .pp-row:last-child{ margin-bottom:0; }
  .pp-slot{
    flex: 1 1 0;
    min-width: 0;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    padding:6px 8px;
    border-radius:12px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.06);
  }
  .pp-empty{
    opacity:0.55;
  }

  /* E/C/W pill next to division winners */
  .divpill{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:18px;
    height:18px;
    border-radius:999px;
    font-size:11px;
    font-weight:900;
    background: rgba(255,255,255,0.10);
    border: 1px solid rgba(255,255,255,0.14);
    color: rgba(255,255,255,0.85);
    flex: 0 0 auto;
  }
</style>

{% macro teamchip(t) %}
  <a class="teamlink" href="/team/{{ t.team_id }}" style="display:inline-flex; align-items:center; gap:6px; white-space:nowrap;">
    {% if t.logo_url %}
      <img class="teamlogo" src="{{ t.logo_url }}" alt="{{ t.abbrev }} logo" style="height:16px; width:auto;">
    {% endif %}
    <span>{{ t.abbrev }}</span>
  </a>
{% endmacro %}

{# pct background: diverging red/blue, midpoint .500 #}
{% macro pct_badge(pct_value) %}
  {% if pct_value is none %}
    <span class="pctcell" style="background: rgba(255,255,255,0.06);">‚Äî</span>
  {% else %}
    {% set p = pct_value %}
    {% if p < 0 %}{% set p = 0 %}{% endif %}
    {% if p > 1 %}{% set p = 1 %}{% endif %}

    {% if p >= 0.5 %}
      {% set a = (p - 0.5) / 0.5 %}
      {% if a > 1 %}{% set a = 1 %}{% endif %}
      {% set bg = "rgba(255, 70, 70, " ~ (0.10 + 0.35 * a) ~ ")" %}
    {% else %}
      {% set a = (0.5 - p) / 0.5 %}
      {% if a > 1 %}{% set a = 1 %}{% endif %}
      {% set bg = "rgba(70, 140, 255, " ~ (0.10 + 0.35 * a) ~ ")" %}
    {% endif %}

    {# Render exactly like ".432" #}
    {% set s = "%.3f"|format(p) %}
    <span class="pctcell" style="background: {{ bg }};">{{ s[1:] }}</span>
  {% endif %}
{% endmacro %}

{% macro streak_cell(streak) %}
  {% set s = (streak or "") %}
  {% set emoji = "" %}
  {% if s|length >= 2 %}
    {% set kind = s[0] %}
    {% set n = (s[1:]|int(0)) %}
    {% if kind == "W" and n >= 3 %}
      {% set emoji = "üî•" %}
    {% elif kind == "L" and n >= 3 %}
      {% set emoji = "üßä" %}
    {% endif %}
  {% endif %}

  <span class="streakwrap">
    <span>{{ s if s else "‚Äî" }}</span>
    <span class="streakemoji">{{ emoji }}</span>
  </span>
{% endmacro %}

{% macro playoff_block(divs) %}
  {# Flatten teams for this league + find division winners from division_rank #}
  {% set ns = namespace(all=[], east=None, central=None, west=None, wc1=None, wc2=None, wc3=None) %}

  {% for d in divs %}
    {% set dname = d.name|string %}
    {% for t in d.teams %}
      {% set _ = ns.all.append(t) %}

      {% if (t.division_rank|default(0)|int) == 1 %}
        {% if "East" in dname %}{% set ns.east = t %}{% endif %}
        {% if "Central" in dname %}{% set ns.central = t %}{% endif %}
        {% if "West" in dname %}{% set ns.west = t %}{% endif %}
      {% endif %}

      {# Wild cards by rank (authoritative, tie-safe) #}
      {% set wcr = (t.wild_card_rank|default(0)|int) %}
      {% if wcr == 1 %}{% set ns.wc1 = t %}{% endif %}
      {% if wcr == 2 %}{% set ns.wc2 = t %}{% endif %}
      {% if wcr == 3 %}{% set ns.wc3 = t %}{% endif %}
    {% endfor %}
  {% endfor %}

  {% set leader_label = "Division Leaders" if is_current_season else "Division Winners" %}

  <div class="pp-block">
    <div class="pp-subtitle">{{ leader_label }}</div>
    <div class="pp-row">
      <div class="pp-slot">
        <span class="divpill">E</span>
        {% if ns.east %}{{ teamchip(ns.east) }}{% else %}<span class="muted pp-empty">‚Äî</span>{% endif %}
      </div>
      <div class="pp-slot">
        <span class="divpill">C</span>
        {% if ns.central %}{{ teamchip(ns.central) }}{% else %}<span class="muted pp-empty">‚Äî</span>{% endif %}
      </div>
      <div class="pp-slot">
        <span class="divpill">W</span>
        {% if ns.west %}{{ teamchip(ns.west) }}{% else %}<span class="muted pp-empty">‚Äî</span>{% endif %}
      </div>
    </div>

    <div class="pp-subtitle">Wild Card</div>
    <div class="pp-row">
      <div class="pp-slot">
        {% if ns.wc1 %}{{ teamchip(ns.wc1) }}{% else %}<span class="muted pp-empty">‚Äî</span>{% endif %}
      </div>
      <div class="pp-slot">
        {% if ns.wc2 %}{{ teamchip(ns.wc2) }}{% else %}<span class="muted pp-empty">‚Äî</span>{% endif %}
      </div>
      <div class="pp-slot">
        {% if ns.wc3 %}{{ teamchip(ns.wc3) }}{% else %}<span class="muted pp-empty">‚Äî</span>{% endif %}
      </div>
    </div>
  </div>
{% endmacro %}


<div class="grid-2">

  <!-- American League -->
  <div class="card">
    <div class="card-header">
      <div><div class="card-title">American League</div></div>
    </div>

    {{ playoff_block(al_divs) }}

    {% for d in al_divs %}
      <div class="subcard">
        <div class="subcard-title">
          {{ d.name|replace("American League", "AL")|replace("National League", "NL") }}
        </div>
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th class="tagcol"></th>
                <th>Team</th>
                <th class="num">W</th>
                <th class="num">L</th>
                <th class="num pctcol">Pct</th>
                <th class="num">GB</th>
                <th class="num">WC GB</th>
                <th class="num">Streak</th>
                <th class="num">Run Diff</th>
              </tr>
            </thead>
            <tbody>
              {% for t in d.teams %}
                {% set is_winner = (t.division_rank is defined and (t.division_rank|int) == 1) or ((t.division_leader is defined) and (t.division_leader|int) == 1) %}
                {% set is_wc =
                  (((t.wild_card is defined) and ((t.wild_card|int) == 1))
                   or ((t.wild_card_rank is defined) and (((t.wild_card_rank|int) in (1,2,3)))))
                %}
                {% set p = (t.pct|float if t.pct is not none else none) %}
                <tr>
                  <td class="tagcol">
                    {% if is_winner %}<span class="tagicon" title="Division leader">üëë</span>{% endif %}
                    {% if is_wc and not is_winner %}<span class="tagicon" title="Wild card">üÉè</span>{% endif %}
                  </td>
                  <td class="teamcell">
                    {% if t.logo_url %}
                      <img class="teamlogo" src="{{ t.logo_url }}" alt="{{ t.abbrev }} logo">
                    {% endif %}
                    <a class="teamlink" href="/team/{{ t.team_id }}">{{ t.abbrev }}</a>
                  </td>
                  <td class="num">{{ t.w }}</td>
                  <td class="num">{{ t.l }}</td>
                  <td class="num pctcol">{{ pct_badge(p) }}</td>
                  <td class="num">{{ t.gb }}</td>
                  <td class="num">{{ t.wc_gb if t.wc_gb is not none and t.wc_gb != "" else "‚Äî" }}</td>
                  <td class="num">{{ streak_cell(t.streak) }}</td>
                  <td class="num">{{ t.run_diff }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- National League -->
  <div class="card">
    <div class="card-header">
      <div><div class="card-title">National League</div></div>
    </div>

    {{ playoff_block(nl_divs) }}

    {% for d in nl_divs %}
      <div class="subcard">
        <div class="subcard-title">
          {{ d.name|replace("American League", "AL")|replace("National League", "NL") }}
        </div>
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th class="tagcol"></th>
                <th>Team</th>
                <th class="num">W</th>
                <th class="num">L</th>
                <th class="num pctcol">Pct</th>
                <th class="num">GB</th>
                <th class="num">WC GB</th>
                <th class="num">Streak</th>
                <th class="num">Run Diff</th>
              </tr>
            </thead>
            <tbody>
              {% for t in d.teams %}
                {% set is_winner = (t.division_rank is defined and (t.division_rank|int) == 1) or ((t.division_leader is defined) and (t.division_leader|int) == 1) %}
                {% set is_wc =
                  (((t.wild_card is defined) and ((t.wild_card|int) == 1))
                   or ((t.wild_card_rank is defined) and (((t.wild_card_rank|int) in (1,2,3)))))
                %}
                {% set p = (t.pct|float if t.pct is not none else none) %}
                <tr>
                  <td class="tagcol">
                    {% if is_winner %}<span class="tagicon" title="Division leader">üëë</span>{% endif %}
                    {% if is_wc and not is_winner %}<span class="tagicon" title="Wild card">üÉè</span>{% endif %}
                  </td>
                  <td class="teamcell">
                    {% if t.logo_url %}
                      <img class="teamlogo" src="{{ t.logo_url }}" alt="{{ t.abbrev }} logo">
                    {% endif %}
                    <a class="teamlink" href="/team/{{ t.team_id }}">{{ t.abbrev }}</a>
                  </td>
                  <td class="num">{{ t.w }}</td>
                  <td class="num">{{ t.l }}</td>
                  <td class="num pctcol">{{ pct_badge(p) }}</td>
                  <td class="num">{{ t.gb }}</td>
                  <td class="num">{{ t.wc_gb if t.wc_gb is not none and t.wc_gb != "" else "‚Äî" }}</td>
                  <td class="num">{{ streak_cell(t.streak) }}</td>
                  <td class="num">{{ t.run_diff }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endfor %}
  </div>

</div>

{% endblock %}
