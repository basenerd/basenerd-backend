{% extends "base.html" %}
{% block content %}

<div class="card">
  <div class="card-header">
    <div>
      <div class="card-title">Standings</div>
      <div class="card-subtitle">Season {{ season }}</div>
    </div>

    <form method="get" action="/standings" style="display:flex; gap:8px; align-items:center;">
      <select name="season">
        {% for y in seasons %}
          <option value="{{ y }}" {% if y == season %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
      <button type="submit">Go</button>
    </form>
  </div>

  {% if error %}
    <div class="card-body">
      <div class="error-banner">{{ error }}</div>
    </div>
  {% endif %}
</div>

{# ------------------------------ #}
{# Helpers: badges + playoff row   #}
{# ------------------------------ #}

{% macro badge(text, kind) %}
  {# kind: "div" or "wc" #}
  <span class="pill {{ 'pill-div' if kind=='div' else 'pill-wc' }}">
    {{ text }}
  </span>
{% endmacro %}

{% macro teamchip(t) %}
  <a class="teamlink" href="/team/{{ t.team_id }}" style="display:inline-flex; align-items:center; gap:6px;">
    {% if t.logo_url %}
      <img class="teamlogo" src="{{ t.logo_url }}" alt="{{ t.abbrev }} logo" style="height:16px; width:auto;">
    {% endif %}
    <span>{{ t.abbrev }}</span>
  </a>
{% endmacro %}

{% macro playoff_row(divs, league_code) %}
  {# league_code used only for labels if you want; not required #}

  {# Find division winners by division name containing East/Central/West #}
  {% set east = none %}
  {% set central = none %}
  {% set west = none %}
  {% set wc_list = [] %}

  {% for d in divs %}
    {% set dname = d.name|string %}
    {% for t in d.teams %}
      {% if t.division_leader %}
        {% if "East" in dname %}
          {% set east = t %}
        {% elif "Central" in dname %}
          {% set central = t %}
        {% elif "West" in dname %}
          {% set west = t %}
        {% endif %}
      {% endif %}
      {% if t.wild_card %}
        {% set _ = wc_list.append(t) %}
      {% endif %}
    {% endfor %}
  {% endfor %}

  <div class="subcard" style="margin-top:10px;">
    <div class="table-wrap">
      <table class="table" style="margin:0;">
        <thead>
          <tr>
            <th class="num" style="width:60px; text-align:left;">E</th>
            <th class="num" style="width:60px; text-align:left;">C</th>
            <th class="num" style="width:60px; text-align:left;">W</th>
            <th class="num" style="text-align:left;">WC</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="white-space:nowrap;">
              {% if east %}{{ teamchip(east) }}{% else %}<span class="muted">—</span>{% endif %}
            </td>
            <td style="white-space:nowrap;">
              {% if central %}{{ teamchip(central) }}{% else %}<span class="muted">—</span>{% endif %}
            </td>
            <td style="white-space:nowrap;">
              {% if west %}{{ teamchip(west) }}{% else %}<span class="muted">—</span>{% endif %}
            </td>
            <td>
              {% if wc_list|length == 0 %}
                <span class="muted">—</span>
              {% else %}
                <div style="display:flex; flex-wrap:wrap; gap:10px;">
                  {% for t in wc_list %}
                    {{ teamchip(t) }}
                  {% endfor %}
                </div>
              {% endif %}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
{% endmacro %}

{# Minimal CSS hooks; uses your existing design system but adds badge styles #}
<style>
  .pill{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    height:16px;
    min-width:16px;
    padding:0 6px;
    margin-left:6px;
    border-radius:999px;
    font-size:11px;
    line-height:1;
    font-weight:700;
    border:1px solid rgba(255,255,255,0.14);
    background: rgba(255,255,255,0.06);
  }
  .pill-div{
    border-color: rgba(255,255,255,0.18);
  }
  .pill-wc{
    border-color: rgba(255,255,255,0.18);
  }
</style>

{# ------------------------------ #}
{#     MAIN: AL vs NL TABLES       #}
{# ------------------------------ #}

<div class="grid-2">

  <!-- American League -->
  <div class="card">
    <div class="card-header">
      <div>
        <div class="card-title">American League</div>
        <div class="card-subtitle">Divisions</div>
      </div>
    </div>

    {# Playoff picture row #}
    {{ playoff_row(al_divs, "AL") }}

    {% for d in al_divs %}
      <div class="subcard">
        <div class="subcard-title">{{ d.name }}</div>
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Team</th>
                <th class="num">W</th>
                <th class="num">L</th>
                <th class="num">Pct</th>
                <th class="num">GB</th>
                <th class="num">Streak</th>
                <th class="num">Run Diff</th>
              </tr>
            </thead>
            <tbody>
              {% for t in d.teams %}
                <tr>
                  <td class="teamcell">
                    {% if t.logo_url %}
                      <img class="teamlogo" src="{{ t.logo_url }}" alt="{{ t.abbrev }} logo">
                    {% endif %}
                    <a class="teamlink" href="/team/{{ t.team_id }}">{{ t.abbrev }}</a>

                    {# badges: division leader and wild card #}
                    {% if t.division_leader %}
                      {{ badge("1", "div") }}
                    {% endif %}
                    {% if t.wild_card %}
                      {{ badge("WC", "wc") }}
                    {% endif %}
                  </td>
                  <td class="num">{{ t.w }}</td>
                  <td class="num">{{ t.l }}</td>
                  <td class="num">{{ t.pct }}</td>
                  <td class="num">{{ t.gb }}</td>
                  <td class="num">{{ t.streak }}</td>
                  <td class="num">{{ t.run_diff }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- National League -->
  <div class="card">
    <div class="card-header">
      <div>
        <div class="card-title">National League</div>
        <div class="card-subtitle">Divisions</div>
      </div>
    </div>

    {# Playoff picture row #}
    {{ playoff_row(nl_divs, "NL") }}

    {% for d in nl_divs %}
      <div class="subcard">
        <div class="subcard-title">{{ d.name }}</div>
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Team</th>
                <th class="num">W</th>
                <th class="num">L</th>
                <th class="num">Pct</th>
                <th class="num">GB</th>
                <th class="num">Streak</th>
                <th class="num">Run Diff</th>
              </tr>
            </thead>
            <tbody>
              {% for t in d.teams %}
                <tr>
                  <td class="teamcell">
                    {% if t.logo_url %}
                      <img class="teamlogo" src="{{ t.logo_url }}" alt="{{ t.abbrev }} logo">
                    {% endif %}
                    <a class="teamlink" href="/team/{{ t.team_id }}">{{ t.abbrev }}</a>

                    {% if t.division_leader %}
                      {{ badge("1", "div") }}
                    {% endif %}
                    {% if t.wild_card %}
                      {{ badge("WC", "wc") }}
                    {% endif %}
                  </td>
                  <td class="num">{{ t.w }}</td>
                  <td class="num">{{ t.l }}</td>
                  <td class="num">{{ t.pct }}</td>
                  <td class="num">{{ t.gb }}</td>
                  <td class="num">{{ t.streak }}</td>
                  <td class="num">{{ t.run_diff }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endfor %}
  </div>

</div>

{% endblock %}
