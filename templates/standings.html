{% extends "base.html" %}
{% block content %}

<div class="card">
  <div class="card-header">
    <div>
      <div class="card-title">Standings</div>
      <div class="card-subtitle">Season {{ season }}</div>
    </div>

    <form method="get" action="/standings" style="display:flex; gap:8px; align-items:center;">
      <select name="season">
        {% for y in seasons %}
          <option value="{{ y }}" {% if y == season %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>

      <input type="hidden" name="view" value="{{ view or 'division' }}">

      <button type="submit">Go</button>
    </form>
  </div>

  <div class="standings-tabs">
    <a class="standings-tab {% if (view or 'division') == 'division' %}active{% endif %}"
       href="/standings?season={{ season }}&view=division">Regular Season</a>
    <a class="standings-tab {% if (view or 'division') == 'wildcard' %}active{% endif %}"
       href="/standings?season={{ season }}&view=wildcard">Wild Card</a>
    <a class="standings-tab {% if (view or 'division') == 'playoffs' %}active{% endif %}"
       href="/standings?season={{ season }}&view=playoffs">Playoff Picture</a>
  </div>

  {% if error %}
    <div class="card-body">
      <div class="error-banner">{{ error }}</div>
    </div>
  {% endif %}
</div>

<style>
  .pctcell{
    border-radius:8px;
    padding:4px 8px;
    display:inline-block;
    min-width:56px;
    text-align:right;
  }

  td.pctcol::after, td.pctcol::before,
  th.pctcol::after, th.pctcol::before,
  td.pctcol *::after, td.pctcol *::before{
    content: none !important;
  }

  .streakwrap{
    display:flex;
    justify-content:flex-end;
    align-items:center;
    gap:6px;
  }
  .streakemoji{
    width:16px;
    text-align:center;
    display:inline-block;
    opacity:0.95;
  }

  .tagcol{
    width:34px;
    text-align:center;
    white-space:nowrap;
  }
  .tagicon{
    display:inline-block;
    width:18px;
    text-align:center;
    font-size:16px;
    line-height:1;
  }

  .rundiff-pos{ color:#18a558; font-weight:800; }
  .rundiff-neg{ color:#e03a3a; font-weight:800; }

  .pp-block{
    padding:12px 12px 10px;
    border-top:1px solid rgba(255,255,255,0.08);
  }
  .pp-subtitle{
    font-size:11px;
    font-weight:800;
    opacity:0.75;
    margin:0 0 8px 0;
  }
  .pp-row{
    display:flex;
    gap:12px;
    width:100%;
    margin:0 0 12px 0;
  }
  .pp-row:last-child{ margin-bottom:0; }

  .pp-slot{
    flex: 1 1 0;
    min-width: 0;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    padding:6px 8px;
    border-radius:12px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.06);
  }
  .pp-empty{ opacity:0.55; }

  .pp-pill{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    height:18px;
    border-radius:999px;
    font-size:11px;
    font-weight:900;
    background: rgba(255,255,255,0.10);
    border: 1px solid rgba(255,255,255,0.14);
    color: rgba(255,255,255,0.85);
    flex: 0 0 auto;
    width:28px;
  }
  .pp-pill.wc{ width:42px; }

  .standings-tabs{
    display:flex;
    gap:22px;
    padding:10px 12px 0;
  }
  .standings-tab{
    text-decoration:none;
    font-weight:800;
    opacity:0.75;
    padding-bottom:6px;
    border-bottom:2px solid transparent;
  }
  .standings-tab.active{
    opacity:1;
    border-bottom-color: rgba(255,255,255,0.85);
  }

  /* --------------------- */
  /* Playoff Picture styles */
  /* --------------------- */
  .bracket-wrap{
    margin-top:14px;
  }
  .bracket-grid{
    display:grid;
    grid-template-columns: 1fr 1fr 1fr 0.9fr 1fr 1fr 1fr;
    gap:12px;
    align-items:start;
  }
  .bracket-col{
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius:14px;
    padding:10px;
    min-width:0;
  }
  .bracket-title{
    font-size:11px;
    font-weight:900;
    letter-spacing:0.3px;
    opacity:0.8;
    padding:0 2px 10px 2px;
    border-bottom:1px solid rgba(255,255,255,0.08);
    margin-bottom:10px;
    text-align:center;
    text-transform:uppercase;
  }

  .series-card{
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius:14px;
    padding:8px 8px;
    margin-bottom:10px;
  }
  .series-card:last-child{ margin-bottom:0; }

  .series-meta{
    display:flex;
    justify-content:space-between;
    gap:10px;
    font-size:11px;
    opacity:0.75;
    margin-bottom:6px;
  }

  .team-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:6px 6px;
    border-radius:10px;
  }
  .team-row.win{
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.08);
  }

  .team-left{
    display:flex;
    align-items:center;
    gap:8px;
    min-width:0;
  }
  .seedpill{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width:18px;
    height:18px;
    padding:0 6px;
    border-radius:999px;
    font-size:11px;
    font-weight:900;
    background: rgba(255,255,255,0.10);
    border: 1px solid rgba(255,255,255,0.14);
    color: rgba(255,255,255,0.85);
    flex: 0 0 auto;
  }
  .bracket-logo{
    height:16px;
    width:auto;
    display:block;
    flex:0 0 auto;
  }
  .abbrlink{
    text-decoration:none;
    font-weight:900;
    white-space:nowrap;
  }
  .winsbox{
    font-weight:900;
    min-width:18px;
    text-align:right;
    opacity:0.9;
  }

  /* Center column should feel special */
  .bracket-col.center{
    background: rgba(255,255,255,0.03);
    border-color: rgba(255,255,255,0.10);
  }
</style>

{% macro teamchip(t) %}
  <a class="teamlink" href="/team/{{ t.team_id }}" style="display:inline-flex; align-items:center; gap:6px; white-space:nowrap;">
    {% if t.logo_url %}
      <img class="teamlogo" src="{{ t.logo_url }}" alt="{{ t.abbrev }} logo" style="height:16px; width:auto;">
    {% endif %}
    <span>{{ t.abbrev }}</span>
  </a>
{% endmacro %}

{% macro pct_badge(pct_value) %}
  {% if pct_value is none %}
    <span class="pctcell" style="background: rgba(255,255,255,0.06);">‚Äî</span>
  {% else %}
    {% set p = pct_value %}
    {% if p < 0 %}{% set p = 0 %}{% endif %}
    {% if p > 1 %}{% set p = 1 %}{% endif %}

    {% if p >= 0.5 %}
      {% set a = (p - 0.5) / 0.5 %}
      {% if a > 1 %}{% set a = 1 %}{% endif %}
      {% set bg = "rgba(255, 70, 70, " ~ (0.10 + 0.35 * a) ~ ")" %}
    {% else %}
      {% set a = (0.5 - p) / 0.5 %}
      {% if a > 1 %}{% set a = 1 %}{% endif %}
      {% set bg = "rgba(70, 140, 255, " ~ (0.10 + 0.35 * a) ~ ")" %}
    {% endif %}

    {% set s = "%.3f"|format(p) %}
    <span class="pctcell" style="background: {{ bg }};">{{ s[1:] }}</span>
  {% endif %}
{% endmacro %}

{% macro streak_cell(streak) %}
  {% set s = (streak or "") %}
  {% set emoji = "" %}
  {% if s|length >= 2 %}
    {% set kind = s[0] %}
    {% set n = (s[1:]|int(0)) %}
    {% if kind == "W" and n >= 3 %}
      {% set emoji = "üî•" %}
    {% elif kind == "L" and n >= 3 %}
      {% set emoji = "üßä" %}
    {% endif %}
  {% endif %}

  <span class="streakwrap">
    <span>{{ s if s else "‚Äî" }}</span>
    <span class="streakemoji">{{ emoji }}</span>
  </span>
{% endmacro %}

{% macro playoff_render(playoff) %}
  {% set leader_label = "Division Leaders" if is_current_season else "Division Winners" %}

  <div class="pp-block">
    <div class="pp-subtitle">{{ leader_label }}</div>
    <div class="pp-row">
      <div class="pp-slot">
        <span class="pp-pill">E</span>
        {% if playoff and playoff.east %}{{ teamchip(playoff.east) }}{% else %}<span class="muted pp-empty">‚Äî</span>{% endif %}
      </div>
      <div class="pp-slot">
        <span class="pp-pill">C</span>
        {% if playoff and playoff.central %}{{ teamchip(playoff.central) }}{% else %}<span class="muted pp-empty">‚Äî</span>{% endif %}
      </div>
      <div class="pp-slot">
        <span class="pp-pill">W</span>
        {% if playoff and playoff.west %}{{ teamchip(playoff.west) }}{% else %}<span class="muted pp-empty">‚Äî</span>{% endif %}
      </div>
    </div>

    <div class="pp-subtitle">Wild Card</div>
    <div class="pp-row">
      <div class="pp-slot">
        <span class="pp-pill wc">WC1</span>
        {% if playoff and playoff.wc1 %}{{ teamchip(playoff.wc1) }}{% else %}<span class="muted pp-empty">‚Äî</span>{% endif %}
      </div>
      <div class="pp-slot">
        <span class="pp-pill wc">WC2</span>
        {% if playoff and playoff.wc2 %}{{ teamchip(playoff.wc2) }}{% else %}<span class="muted pp-empty">‚Äî</span>{% endif %}
      </div>
      <div class="pp-slot">
        <span class="pp-pill wc">WC3</span>
        {% if playoff and playoff.wc3 %}{{ teamchip(playoff.wc3) }}{% else %}<span class="muted pp-empty">‚Äî</span>{% endif %}
      </div>
    </div>
  </div>
{% endmacro %}

{% macro series_card(series) %}
  <div class="series-card">
    <div class="series-meta">
      <span>{{ series.round_name }}</span>
      {% if series.best_of %}<span>Best of {{ series.best_of }}</span>{% endif %}
    </div>

    {% for tm in series.teams %}
      <div class="team-row {% if tm.is_winner %}win{% endif %}">
        <div class="team-left">
          {% if tm.seed is not none %}
            <span class="seedpill">{{ tm.seed }}</span>
          {% else %}
            <span class="seedpill" style="opacity:0.35;">‚Äî</span>
          {% endif %}

          {% if tm.logo_url %}
            <img class="bracket-logo" src="{{ tm.logo_url }}" alt="{{ tm.abbrev }} logo">
          {% endif %}

          <a class="abbrlink" href="/team/{{ tm.team_id }}">{{ tm.abbrev }}</a>
        </div>

        <div class="winsbox">{{ tm.wins }}</div>
      </div>
    {% endfor %}
  </div>
{% endmacro %}

{% if (view or 'division') == 'playoffs' %}
  <div class="card bracket-wrap">
    <div class="card-header">
      <div><div class="card-title">Playoff Picture</div></div>
    </div>

    <div class="card-body" style="padding-top:12px;">
      <div class="bracket-grid">
        <!-- AL side -->
        <div class="bracket-col">
          <div class="bracket-title">Wild Card</div>
          {% for s in playoff_picture.AL.F %}
            {{ series_card(s) }}
          {% endfor %}
        </div>

        <div class="bracket-col">
          <div class="bracket-title">ALDS</div>
          {% for s in playoff_picture.AL.D %}
            {{ series_card(s) }}
          {% endfor %}
        </div>

        <div class="bracket-col">
          <div class="bracket-title">ALCS</div>
          {% for s in playoff_picture.AL.L %}
            {{ series_card(s) }}
          {% endfor %}
        </div>

        <!-- World Series center -->
        <div class="bracket-col center">
          <div class="bracket-title">World Series</div>
          {% for s in playoff_picture.WS.W %}
            {{ series_card(s) }}
          {% endfor %}
        </div>

        <!-- NL side -->
        <div class="bracket-col">
          <div class="bracket-title">NLCS</div>
          {% for s in playoff_picture.NL.L %}
            {{ series_card(s) }}
          {% endfor %}
        </div>

        <div class="bracket-col">
          <div class="bracket-title">NLDS</div>
          {% for s in playoff_picture.NL.D %}
            {{ series_card(s) }}
          {% endfor %}
        </div>

        <div class="bracket-col">
          <div class="bracket-title">Wild Card</div>
          {% for s in playoff_picture.NL.F %}
            {{ series_card(s) }}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

{% else %}

<div class="grid-2">

  <!-- American League -->
  <div class="card">
    <div class="card-header">
      <div><div class="card-title">American League</div></div>
    </div>

    {{ playoff_render(al_playoff) }}

    {% if (view or 'division') == 'wildcard' %}
      <div class="subcard">
        <div class="subcard-title">AL Wild Card</div>
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th class="tagcol"></th>
                <th>Team</th>
                <th class="num">W</th>
                <th class="num">L</th>
                <th class="num pctcol">Pct</th>
                <th class="num">GB</th>
                <th class="num">Streak</th>
                <th class="num">Run Diff</th>
              </tr>
            </thead>
            <tbody>
              {% for t in al_wc %}
                {% set p = (t.pct|float if t.pct is not none else none) %}
                {% set wcr = (t.wild_card_rank|default(0)|int) %}
                {% set rd = (t.run_diff|int(0)) %}
                <tr>
                  <td class="tagcol">
                    {% if wcr in (1,2,3) %}
                      <span class="pp-pill wc" style="height:20px;">WC{{ wcr }}</span>
                    {% endif %}
                  </td>
                  <td class="teamcell">
                    {% if t.logo_url %}
                      <img class="teamlogo" src="{{ t.logo_url }}" alt="{{ t.abbrev }} logo">
                    {% endif %}
                    <a class="teamlink" href="/team/{{ t.team_id }}">{{ t.abbrev }}</a>
                  </td>
                  <td class="num">{{ t.w }}</td>
                  <td class="num">{{ t.l }}</td>
                  <td class="num pctcol">{{ pct_badge(p) }}</td>
                  <td class="num">{{ t.wc_gb if t.wc_gb is not none and t.wc_gb != "" else "‚Äî" }}</td>
                  <td class="num">{{ streak_cell(t.streak) }}</td>
                  <td class="num">
                    {% if rd > 0 %}
                      <span class="rundiff-pos">{{ rd }}</span>
                    {% elif rd < 0 %}
                      <span class="rundiff-neg">{{ rd }}</span>
                    {% else %}
                      <span>{{ rd }}</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% else %}
      {% for d in al_divs %}
        <div class="subcard">
          <div class="subcard-title">
            {{ d.name|replace("American League", "AL")|replace("National League", "NL") }}
          </div>
          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th class="tagcol"></th>
                  <th>Team</th>
                  <th class="num">W</th>
                  <th class="num">L</th>
                  <th class="num pctcol">Pct</th>
                  <th class="num">GB</th>
                  <th class="num">WC GB</th>
                  <th class="num">Streak</th>
                  <th class="num">Run Diff</th>
                </tr>
              </thead>
              <tbody>
                {% for t in d.teams %}
                  {% set is_winner = ((t.division_rank|default(0)|int) == 1) %}
                  {% set is_wc = ((t.wild_card_rank|default(0)|int) in (1,2,3)) and (not is_winner) %}
                  {% set p = (t.pct|float if t.pct is not none else none) %}
                  {% set rd = (t.run_diff|int(0)) %}
                  <tr>
                    <td class="tagcol">
                      {% if is_winner %}<span class="tagicon" title="Division leader">üëë</span>{% endif %}
                      {% if is_wc %}<span class="tagicon" title="Wild card">üÉè</span>{% endif %}
                    </td>
                    <td class="teamcell">
                      {% if t.logo_url %}
                        <img class="teamlogo" src="{{ t.logo_url }}" alt="{{ t.abbrev }} logo">
                      {% endif %}
                      <a class="teamlink" href="/team/{{ t.team_id }}">{{ t.abbrev }}</a>
                    </td>
                    <td class="num">{{ t.w }}</td>
                    <td class="num">{{ t.l }}</td>
                    <td class="num pctcol">{{ pct_badge(p) }}</td>
                    <td class="num">{{ t.gb }}</td>
                    <td class="num">{{ t.wc_gb if t.wc_gb is not none and t.wc_gb != "" else "‚Äî" }}</td>
                    <td class="num">{{ streak_cell(t.streak) }}</td>
                    <td class="num">
                      {% if rd > 0 %}
                        <span class="rundiff-pos">{{ rd }}</span>
                      {% elif rd < 0 %}
                        <span class="rundiff-neg">{{ rd }}</span>
                      {% else %}
                        <span>{{ rd }}</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endfor %}
    {% endif %}
  </div>

  <!-- National League -->
  <div class="card">
    <div class="card-header">
      <div><div class="card-title">National League</div></div>
    </div>

    {{ playoff_render(nl_playoff) }}

    {% if (view or 'division') == 'wildcard' %}
      <div class="subcard">
        <div class="subcard-title">NL Wild Card</div>
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th class="tagcol"></th>
                <th>Team</th>
                <th class="num">W</th>
                <th class="num">L</th>
                <th class="num pctcol">Pct</th>
                <th class="num">GB</th>
                <th class="num">Streak</th>
                <th class="num">Run Diff</th>
              </tr>
            </thead>
            <tbody>
              {% for t in nl_wc %}
                {% set p = (t.pct|float if t.pct is not none else none) %}
                {% set wcr = (t.wild_card_rank|default(0)|int) %}
                {% set rd = (t.run_diff|int(0)) %}
                <tr>
                  <td class="tagcol">
                    {% if wcr in (1,2,3) %}
                      <span class="pp-pill wc" style="height:20px;">WC{{ wcr }}</span>
                    {% endif %}
                  </td>
                  <td class="teamcell">
                    {% if t.logo_url %}
                      <img class="teamlogo" src="{{ t.logo_url }}" alt="{{ t.abbrev }} logo">
                    {% endif %}
                    <a class="teamlink" href="/team/{{ t.team_id }}">{{ t.abbrev }}</a>
                  </td>
                  <td class="num">{{ t.w }}</td>
                  <td class="num">{{ t.l }}</td>
                  <td class="num pctcol">{{ pct_badge(p) }}</td>
                  <td class="num">{{ t.wc_gb if t.wc_gb is not none and t.wc_gb != "" else "‚Äî" }}</td>
                  <td class="num">{{ streak_cell(t.streak) }}</td>
                  <td class="num">
                    {% if rd > 0 %}
                      <span class="rundiff-pos">{{ rd }}</span>
                    {% elif rd < 0 %}
                      <span class="rundiff-neg">{{ rd }}</span>
                    {% else %}
                      <span>{{ rd }}</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% else %}
      {% for d in nl_divs %}
        <div class="subcard">
          <div class="subcard-title">
            {{ d.name|replace("American League", "AL")|replace("National League", "NL") }}
          </div>
          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th class="tagcol"></th>
                  <th>Team</th>
                  <th class="num">W</th>
                  <th class="num">L</th>
                  <th class="num pctcol">Pct</th>
                  <th class="num">GB</th>
                  <th class="num">WC GB</th>
                  <th class="num">Streak</th>
                  <th class="num">Run Diff</th>
                </tr>
              </thead>
              <tbody>
                {% for t in d.teams %}
                  {% set is_winner = ((t.division_rank|default(0)|int) == 1) %}
                  {% set is_wc = ((t.wild_card_rank|default(0)|int) in (1,2,3)) and (not is_winner) %}
                  {% set p = (t.pct|float if t.pct is not none else none) %}
                  {% set rd = (t.run_diff|int(0)) %}
                  <tr>
                    <td class="tagcol">
                      {% if is_winner %}<span class="tagicon" title="Division leader">üëë</span>{% endif %}
                      {% if is_wc %}<span class="tagicon" title="Wild card">üÉè</span>{% endif %}
                    </td>
                    <td class="teamcell">
                      {% if t.logo_url %}
                        <img class="teamlogo" src="{{ t.logo_url }}" alt="{{ t.abbrev }} logo">
                      {% endif %}
                      <a class="teamlink" href="/team/{{ t.team_id }}">{{ t.abbrev }}</a>
                    </td>
                    <td class="num">{{ t.w }}</td>
                    <td class="num">{{ t.l }}</td>
                    <td class="num pctcol">{{ pct_badge(p) }}</td>
                    <td class="num">{{ t.gb }}</td>
                    <td class="num">{{ t.wc_gb if t.wc_gb is not none and t.wc_gb != "" else "‚Äî" }}</td>
                    <td class="num">{{ streak_cell(t.streak) }}</td>
                    <td class="num">
                      {% if rd > 0 %}
                        <span class="rundiff-pos">{{ rd }}</span>
                      {% elif rd < 0 %}
                        <span class="rundiff-neg">{{ rd }}</span>
                      {% else %}
                        <span>{{ rd }}</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endfor %}
    {% endif %}
  </div>

</div>

{% endif %}

{% endblock %}
