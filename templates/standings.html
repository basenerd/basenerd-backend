{% extends "base.html" %}
{% block content %}

<div class="card">
  <div class="card-header">
    <div>
      <div class="card-title">Standings</div>
      <div class="card-subtitle">Season {{ season }}</div>
    </div>

    <form method="get" action="/standings" style="display:flex; gap:8px; align-items:center;">
      <select name="season">
        {% for y in seasons %}
          <option value="{{ y }}" {% if y == season %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
      <button type="submit">Go</button>
    </form>
  </div>

  {% if error %}
    <div class="card-body">
      <div class="error-banner">{{ error }}</div>
    </div>
  {% endif %}
</div>

{# ------------------------------ #}
{# Helpers: badges + playoff row   #}
{# ------------------------------ #}

<style>
  /* Little "cell/circle" badges */
  .mark{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:18px;
    height:18px;
    margin-left:6px;
    border-radius:999px; /* circle */
    font-size:11px;
    font-weight:800;
    line-height:1;
    border:1px solid rgba(255,255,255,0.18);
    background: rgba(255,255,255,0.06);
    user-select:none;
  }
  .mark-wc{
    width:22px;           /* WC needs a bit more room */
    border-radius:999px;  /* still round-ish */
    font-size:10px;
    letter-spacing:-0.2px;
  }

  /* Pct gradient cell */
  .pctcell{
    border-radius:8px;
    padding:4px 8px;
    display:inline-block;
    min-width:56px;
    text-align:right;
  }
</style>

{% macro badge_1() %}
  <span class="mark" title="Division leader">1</span>
{% endmacro %}

{% macro badge_wc() %}
  <span class="mark mark-wc" title="Wild card">WC</span>
{% endmacro %}

{% macro teamchip(t) %}
  <a class="teamlink" href="/team/{{ t.team_id }}" style="display:inline-flex; align-items:center; gap:6px;">
    {% if t.logo_url %}
      <img class="teamlogo" src="{{ t.logo_url }}" alt="{{ t.abbrev }} logo" style="height:16px; width:auto;">
    {% endif %}
    <span>{{ t.abbrev }}</span>
  </a>
{% endmacro %}

{# pct background: diverging red/blue, midpoint .500 #}
{% macro pct_badge(pct_value, pct_text) %}
  {# pct_value should be a float (0-1). We'll tint background accordingly. #}
  {% set p = pct_value %}
  {% if p is none %}{% set p = 0.5 %}{% endif %}

  {# Clamp-ish (best effort) #}
  {% if p < 0 %}{% set p = 0 %}{% endif %}
  {% if p > 1 %}{% set p = 1 %}{% endif %}

  {# Two-sided intensity from midpoint #}
  {% if p >= 0.5 %}
    {# 0.5 -> 0 intensity, 1.0 -> 1 intensity #}
    {% set a = (p - 0.5) / 0.5 %}
    {% if a > 1 %}{% set a = 1 %}{% endif %}
    {# red tint using rgba #}
    {% set bg = "rgba(255, 70, 70, " ~ (0.10 + 0.35 * a) ~ ")" %}
  {% else %}
    {# 0.5 -> 0 intensity, 0.0 -> 1 intensity #}
    {% set a = (0.5 - p) / 0.5 %}
    {% if a > 1 %}{% set a = 1 %}{% endif %}
    {# blue tint using rgba #}
    {% set bg = "rgba(70, 140, 255, " ~ (0.10 + 0.35 * a) ~ ")" %}
  {% endif %}

  <span class="pctcell" style="background: {{ bg }};">
    {{ pct_text }}
  </span>
{% endmacro %}

{% macro streak_with_emoji(streak) %}
  {% set s = (streak or "") %}
  {% if s|length >= 2 %}
    {% set kind = s[0] %}
    {% set n = (s[1:]|int(0)) %}
    {% if kind == "W" and n >= 3 %}
      {{ s }} ðŸ”¥
    {% elif kind == "L" and n >= 3 %}
      {{ s }} ðŸ§Š
    {% else %}
      {{ s }}
    {% endif %}
  {% else %}
    {{ s if s else "â€”" }}
  {% endif %}
{% endmacro %}

{% macro playoff_row(divs) %}
  {# Jinja scoping fix: namespace so assignments persist #}
  {% set ns = namespace(east=None, central=None, west=None, wc_list=[]) %}

  {% for d in divs %}
    {% set dname = d.name|string %}
    {% for t in d.teams %}

      {# Determine division winner: prefer division_rank == 1, else fallback to division_leader #}
      {% set is_winner = (t.division_rank is defined and t.division_rank == 1) or (t.division_leader is defined and t.division_leader) %}

      {% if is_winner %}
        {% if "East" in dname %}
          {% set ns.east = t %}
        {% elif "Central" in dname %}
          {% set ns.central = t %}
        {% elif "West" in dname %}
          {% set ns.west = t %}
        {% endif %}
      {% endif %}

      {# Wild cards: do not include division winners #}
      {% if t.wild_card and not is_winner %}
        {% set _ = ns.wc_list.append(t) %}
      {% endif %}

    {% endfor %}
  {% endfor %}

  <div class="subcard" style="margin-top:10px;">
    <div class="table-wrap">
      <table class="table" style="margin:0;">
        <thead>
          <tr>
            <th class="num" style="width:70px; text-align:left;">E</th>
            <th class="num" style="width:70px; text-align:left;">C</th>
            <th class="num" style="width:70px; text-align:left;">W</th>
            <th class="num" style="text-align:left;">WC</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="white-space:nowrap;">
              {% if ns.east %}{{ teamchip(ns.east) }}{% else %}<span class="muted">â€”</span>{% endif %}
            </td>
            <td style="white-space:nowrap;">
              {% if ns.central %}{{ teamchip(ns.central) }}{% else %}<span class="muted">â€”</span>{% endif %}
            </td>
            <td style="white-space:nowrap;">
              {% if ns.west %}{{ teamchip(ns.west) }}{% else %}<span class="muted">â€”</span>{% endif %}
            </td>
            <td>
              {% if ns.wc_list|length == 0 %}
                <span class="muted">â€”</span>
              {% else %}
                <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
                  {% for t in ns.wc_list %}
                    {{ teamchip(t) }}
                  {% endfor %}
                </div>
              {% endif %}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
{% endmacro %}

{# ------------------------------ #}
{#     MAIN: AL vs NL TABLES       #}
{# ------------------------------ #}

<div class="grid-2">

  <!-- American League -->
  <div class="card">
    <div class="card-header">
      <div>
        <div class="card-title">American League</div>
        <div class="card-subtitle">Divisions</div>
      </div>
    </div>

    {{ playoff_row(al_divs) }}

    {% for d in al_divs %}
      <div class="subcard">
        <div class="subcard-title">{{ d.name }}</div>
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Team</th>
                <th class="num">W</th>
                <th class="num">L</th>
                <th class="num">Pct</th>
                <th class="num">GB</th>
                <th class="num">WC GB</th>
                <th class="num">Streak</th>
                <th class="num">Run Diff</th>
              </tr>
            </thead>
            <tbody>
              {% for t in d.teams %}
                {% set is_winner = (t.division_rank is defined and t.division_rank == 1) or (t.division_leader is defined and t.division_leader) %}
                {% set p = (t.pct|float if t.pct is not none else none) %}
                <tr>
                  <td class="teamcell">
                    {% if t.logo_url %}
                      <img class="teamlogo" src="{{ t.logo_url }}" alt="{{ t.abbrev }} logo">
                    {% endif %}
                    <a class="teamlink" href="/team/{{ t.team_id }}">{{ t.abbrev }}</a>

                    {% if is_winner %}
                      {{ badge_1() }}
                    {% endif %}
                    {% if t.wild_card and not is_winner %}
                      {{ badge_wc() }}
                    {% endif %}
                  </td>
                  <td class="num">{{ t.w }}</td>
                  <td class="num">{{ t.l }}</td>
                  <td class="num">{{ pct_badge(p, t.pct) }}</td>
                  <td class="num">{{ t.gb }}</td>
                  <td class="num">{{ t.wc_gb if t.wc_gb is not none and t.wc_gb != "" else "â€”" }}</td>
                  <td class="num">{{ streak_with_emoji(t.streak) }}</td>
                  <td class="num">{{ t.run_diff }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- National League -->
  <div class="card">
    <div class="card-header">
      <div>
        <div class="card-title">National League</div>
        <div class="card-subtitle">Divisions</div>
      </div>
    </div>

    {{ playoff_row(nl_divs) }}

    {% for d in nl_divs %}
      <div class="subcard">
        <div class="subcard-title">{{ d.name }}</div>
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Team</th>
                <th class="num">W</th>
                <th class="num">L</th>
                <th class="num">Pct</th>
                <th class="num">GB</th>
                <th class="num">WC GB</th>
                <th class="num">Streak</th>
                <th class="num">Run Diff</th>
              </tr>
            </thead>
            <tbody>
              {% for t in d.teams %}
                {% set is_winner = (t.division_rank is defined and t.division_rank == 1) or (t.division_leader is defined and t.division_leader) %}
                {% set p = (t.pct|float if t.pct is not none else none) %}
                <tr>
                  <td class="teamcell">
                    {% if t.logo_url %}
                      <img class="teamlogo" src="{{ t.logo_url }}" alt="{{ t.abbrev }} logo">
                    {% endif %}
                    <a class="teamlink" href="/team/{{ t.team_id }}">{{ t.abbrev }}</a>

                    {% if is_winner %}
                      {{ badge_1() }}
                    {% endif %}
                    {% if t.wild_card and not is_winner %}
                      {{ badge_wc() }}
                    {% endif %}
                  </td>
                  <td class="num">{{ t.w }}</td>
                  <td class="num">{{ t.l }}</td>
                  <td class="num">{{ pct_badge(p, t.pct) }}</td>
                  <td class="num">{{ t.gb }}</td>
                  <td class="num">{{ t.wc_gb if t.wc_gb is not none and t.wc_gb != "" else "â€”" }}</td>
                  <td class="num">{{ streak_with_emoji(t.streak) }}</td>
                  <td class="num">{{ t.run_diff }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endfor %}
  </div>

</div>

{% endblock %}
