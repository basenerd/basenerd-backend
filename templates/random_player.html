{% extends "base.html" %}
{% block content %}

<!-- ===================== -->
<!-- TOP CARD (Landing / Player Display) -->
<!-- ===================== -->

<div class="card" style="text-align:center;">
  <div class="card-header">
    <div class="card-title">ðŸŽ² Random MLB Player</div>
    <div class="card-subtitle">1990 â†’ Present</div>
  </div>

  <div style="padding:16px;">

    {% if player %}

      {% if headshot_url %}
        <img src="{{ headshot_url }}"
             alt="{{ player.fullName }} headshot"
             style="width:180px; border-radius:14px;"
             onerror="this.style.display='none';" />
      {% endif %}

      <div style="margin-top:10px; font-size:22px; font-weight:800;">
        {{ player.fullName }}
      </div>

      <div style="opacity:.85; margin-top:4px;">
        {% if player.primaryPosition %}
          {{ player.primaryPosition.name }}
        {% endif %}
        {% if player.batSide and player.pitchHand %}
          â€¢ Bats: {{ player.batSide.description }}
          â€¢ Throws: {{ player.pitchHand.description }}
        {% endif %}
      </div>

    {% else %}

      <!-- Landing State -->
      <div style="padding:30px; font-size:18px; font-weight:700;">
        Click the button to draw a random MLB player ðŸŽ²
      </div>

    {% endif %}

    <!-- Roll Button -->
    <div style="margin-top:18px; display:flex; gap:10px; justify-content:center;">
      <button class="btn" id="rollBtn" type="button">Roll Again ðŸŽ²</button>

      {% if player %}
        <a href="/player/{{ player.id }}">
          <button class="btn" type="button">View Player Page â†’</button>
        </a>
      {% endif %}
    </div>

  </div>
</div>


<!-- ===================== -->
<!-- YEAR BY YEAR TABLES -->
<!-- ===================== -->

{% if player and yby and (yby|length) > 0 %}
  {% set has_hitting = (yby | selectattr("kind","equalto","hitting") | list | length) > 0 %}
  {% set has_pitching = (yby | selectattr("kind","equalto","pitching") | list | length) > 0 %}

  {% if has_hitting %}
  <div class="card" style="margin-top:14px;">
    <div class="card-header">
      <div class="card-title">Year-by-Year Hitting</div>
    </div>

    <div style="overflow:auto;">
      <table class="table" style="width:100%; min-width:900px;">
        <thead>
          <tr>
            <th>Year</th>
            <th>Team</th>
            <th>G</th><th>PA</th><th>AB</th><th>H</th>
            <th>HR</th><th>RBI</th><th>SB</th>
            <th>AVG</th><th>OBP</th><th>SLG</th><th>OPS</th>
          </tr>
        </thead>
        <tbody>
          {% for r in yby if r.kind == "hitting" %}
            {% set s = r.stat %}
            <tr>
              <td>{{ r.year }}</td>
              <td style="white-space:nowrap;">{{ r.team }}</td>
              <td>{{ s.games or "â€”" }}</td>
              <td>{{ s.plateAppearances or "â€”" }}</td>
              <td>{{ s.atBats or "â€”" }}</td>
              <td>{{ s.hits or "â€”" }}</td>
              <td>{{ s.homeRuns or "â€”" }}</td>
              <td>{{ s.rbi or "â€”" }}</td>
              <td>{{ s.stolenBases or "â€”" }}</td>
              <td>{{ s.avg or "â€”" }}</td>
              <td>{{ s.obp or "â€”" }}</td>
              <td>{{ s.slg or "â€”" }}</td>
              <td>{{ s.ops or "â€”" }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {% if has_pitching %}
  <div class="card" style="margin-top:14px;">
    <div class="card-header">
      <div class="card-title">Year-by-Year Pitching</div>
    </div>

    <div style="overflow:auto;">
      <table class="table" style="width:100%; min-width:980px;">
        <thead>
          <tr>
            <th>Year</th>
            <th>Team</th>
            <th>G</th><th>GS</th><th>IP</th>
            <th>W</th><th>L</th><th>SV</th><th>SO</th>
            <th>ERA</th><th>WHIP</th>
          </tr>
        </thead>
        <tbody>
          {% for r in yby if r.kind == "pitching" %}
            {% set s = r.stat %}
            <tr>
              <td>{{ r.year }}</td>
              <td style="white-space:nowrap;">{{ r.team }}</td>
              <td>{{ s.gamesPitched or "â€”" }}</td>
              <td>{{ s.gamesStarted or "â€”" }}</td>
              <td>{{ s.inningsPitched or "â€”" }}</td>
              <td>{{ s.wins or "â€”" }}</td>
              <td>{{ s.losses or "â€”" }}</td>
              <td>{{ s.saves or "â€”" }}</td>
              <td>{{ s.strikeOuts or "â€”" }}</td>
              <td>{{ s.era or "â€”" }}</td>
              <td>{{ s.whip or "â€”" }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}
{% endif %}


<!-- ===================== -->
<!-- LOADING OVERLAY -->
<!-- ===================== -->

<div id="loadingOverlay" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  align-items:center;
  justify-content:center;
  z-index:9999;
">
  <div style="text-align:center;">
    <div style="
      width:54px;
      height:54px;
      border:6px solid rgba(255,255,255,.25);
      border-top-color: rgba(255,255,255,.95);
      border-radius:50%;
      animation:spin 0.9s linear infinite;
      margin:0 auto 12px auto;">
    </div>
    <div style="color:white; font-weight:800; letter-spacing:.5px;">
      Shuffling baseball cardsâ€¦
    </div>
  </div>
</div>

<style>
@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>

<script>
  const btn = document.getElementById("rollBtn");
  const overlay = document.getElementById("loadingOverlay");

  btn?.addEventListener("click", () => {
    overlay.style.display = "flex";
    btn.disabled = true;

    setTimeout(() => {
      window.location.href = "/random-player/play";
    }, 2000);
  });
</script>

{% endblock %}
