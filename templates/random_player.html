{% extends "base.html" %}
{% block content %}
<!-- ===================== -->
<!-- TOP CARD (Landing / Player Display) -->
<!-- ===================== -->

<div class="standings-tabs" style="justify-content: center; margin-bottom: 20px;">
    <a class="standings-tab {% if mode != 'active' %}active{% endif %}" 
       href="/random-player/play">
       1990 â†’ Present
    </a>

    <a class="standings-tab {% if mode == 'active' %}active{% endif %}" 
       href="/random-player/play?mode=active">
       Active Only
    </a>
</div>

<div class="card" style="text-align:center;">
  <div class="card-header">
    <div class="card-title">ðŸŽ² Random MLB Player</div>
    <div class="card-subtitle">1990 â†’ Present</div>
  </div>

  <div style="padding:16px;">

    {% if player %}

      <!-- Headshot w/ fallback placeholder -->
      <div style="width:180px; margin:0 auto;">
        <img id="playerHeadshot"
             src="{{ headshot_url }}"
             alt="{{ player.fullName }} headshot"
             style="width:180px; border-radius:14px; display:block;" />

        <div id="noPhotoFallback"
             style="
               display:none;
               width:180px;
               height:180px;
               border-radius:14px;
               background:#222;
               color:#aaa;
               font-weight:700;
               font-size:14px;
               align-items:center;
               justify-content:center;
               text-align:center;
               padding:10px;
             ">
          No photo<br>available
        </div>
      </div>

      <div style="margin-top:10px; font-size:22px; font-weight:800;">
        {{ player.fullName }}
      </div>

      <div style="opacity:.85; margin-top:4px;">
        {% if player.primaryPosition %}
          {{ player.primaryPosition.name }}
        {% endif %}
        {% if player.batSide and player.pitchHand %}
          â€¢ Bats: {{ player.batSide.description }}
          â€¢ Throws: {{ player.pitchHand.description }}
        {% endif %}
      </div>

      <!-- Accolade pills (you'll set colors later via CSS classes) -->
      {% if accolades and (accolades|length) > 0 %}
        <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:8px; justify-content:center;">
          {% for p in accolades %}
            <span class="acc-pill acc-{{ p.key }}">{{ p.label }}</span>
          {% endfor %}
        </div>
      {% endif %}

    {% else %}

      <!-- Landing State -->
      <div style="padding:30px; font-size:18px; font-weight:700;">
        Click the button to draw a random MLB player ðŸŽ²
      </div>

    {% endif %}

    <!-- Roll Button -->
    <div style="margin-top:18px; display:flex; gap:10px; justify-content:center;">
      <button class="btn" id="rollBtn" type="button">Roll Again ðŸŽ²</button>

      {% if player %}
        <a href="/player/{{ player.id }}">
          <button class="btn" type="button">View Player Page â†’</button>
        </a>
      {% endif %}
    </div>

  </div>
</div>


<!-- ===================== -->
<!-- YEAR BY YEAR TABLES -->
<!-- ===================== -->

{% if player %}
  {% set _hg = (hitting_groups if hitting_groups is defined else []) %}
  {% set _pg = (pitching_groups if pitching_groups is defined else []) %}
  {% set has_hitting = (_hg|length) > 0 %}
  {% set has_pitching = (_pg|length) > 0 %}

  {% if has_hitting %}
  <div class="card" style="margin-top:14px;">
    <div class="card-header">
      <div class="card-title">Year-by-Year Hitting</div>
    </div>

    <div style="overflow:auto;">
      <table class="table" style="width:100%; min-width:900px;">
        <thead>
          <tr>
            <th>Year</th>
            <th>Team</th>
            <th>G</th><th>PA</th><th>AB</th><th>H</th>
            <th>HR</th><th>RBI</th><th>SB</th>
            <th>AVG</th><th>OBP</th><th>SLG</th><th>OPS</th><th>Awards</th>
          </tr>
        </thead>
        <tbody>

          {% for g in _hg %}
            {% set r = g.total %}
            {% if r %}
              {% set s = r.stat %}
              {% set has_parts = (g.parts and (g.parts|length) > 0) %}

              <tr class="year-row">
                <td style="white-space:nowrap;">
                  <span class="yearcell">
                    <span>{{ g.year }}</span>

                    {% if has_parts %}
                      <button class="yexp" type="button" data-kind="hitting" data-year="{{ g.year }}" aria-label="Expand year">â–¾</button>
                    {% else %}
                      <span class="yspacer"></span>
                    {% endif %}
                  </span>
                </td>

                <!-- Only show 'Total' when that year has multiple rows -->
                <td style="min-width:220px;">{{ "Total" if has_parts else r.team }}</td>

                <td>{{ s.gamesPlayed or "â€”" }}</td>
                <td>{{ s.plateAppearances or "â€”" }}</td>
                <td>{{ s.atBats or "â€”" }}</td>
                <td>{{ s.hits or "â€”" }}</td>
                <td>{{ s.homeRuns or "â€”" }}</td>
                <td>{{ s.rbi or "â€”" }}</td>
                <td>{{ s.stolenBases or "â€”" }}</td>
                <td>{{ s.avg or "â€”" }}</td>
                <td>{{ s.obp or "â€”" }}</td>
                <td>{{ s.slg or "â€”" }}</td>
                <td>{{ s.ops or "â€”" }}</td>
                <td>
                  {% set y = g.year %}
                  {% if award_year_map[y] is defined %}
                    {% set award_labels = {
                      "mvp":"MVP",
                      "cyyoung":"CY",
                      "roy":"ROY",
                      "goldglove":"GG",
                      "platinumglove":"PG",
                      "silverslugger":"SS",
                      "allstar":"AS",
                      "battingchamp":"BC",
                      "hrderby":"HRD",
                      "wsmvp":"WS-MVP",
                      "wschamp":"WS",
                      "hof":"HOF"
                    } %}
                    {% for k in award_year_map[y] %}
                      <span class="acc-pill acc-{{ k }}" style="font-size:10px; padding:2px 6px;">
                        {{ award_labels[k] if award_labels[k] is defined else k|upper }}
                      </span>
                    {% endfor %}
                  {% endif %}
                </td>
              </tr>

              {% if has_parts %}
                {% for p in g.parts %}
                  {% set ps = p.stat %}
                  <tr class="ychild ychild-hitting ychild-{{ g.year }}" style="display:none; opacity:.92;">
                    <td style="white-space:nowrap; padding-left:16px;">{{ p.year }}</td>
                    <td style="min-width:220px;">{{ p.team }}</td>
                    <td>{{ ps.gamesPlayed or "â€”" }}</td>
                    <td>{{ ps.plateAppearances or "â€”" }}</td>
                    <td>{{ ps.atBats or "â€”" }}</td>
                    <td>{{ ps.hits or "â€”" }}</td>
                    <td>{{ ps.homeRuns or "â€”" }}</td>
                    <td>{{ ps.rbi or "â€”" }}</td>
                    <td>{{ ps.stolenBases or "â€”" }}</td>
                    <td>{{ ps.avg or "â€”" }}</td>
                    <td>{{ ps.obp or "â€”" }}</td>
                    <td>{{ ps.slg or "â€”" }}</td>
                    <td>{{ ps.ops or "â€”" }}</td>
                  </tr>
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}

          {% if career_hitting is defined and career_hitting %}
            <tr class="career-row">
              <td>Career</td>
              <td></td>
              <td>{{ career_hitting.gamesPlayed or "â€”" }}</td>
              <td>{{ career_hitting.plateAppearances or "â€”" }}</td>
              <td>{{ career_hitting.atBats or "â€”" }}</td>
              <td>{{ career_hitting.hits or "â€”" }}</td>
              <td>{{ career_hitting.homeRuns or "â€”" }}</td>
              <td>{{ career_hitting.rbi or "â€”" }}</td>
              <td>{{ career_hitting.stolenBases or "â€”" }}</td>
              <td>{{ career_hitting.avg or "â€”" }}</td>
              <td>{{ career_hitting.obp or "â€”" }}</td>
              <td>{{ career_hitting.slg or "â€”" }}</td>
              <td>{{ career_hitting.ops or "â€”" }}</td>
            </tr>
          {% endif %}

        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {% if has_pitching %}
  <div class="card" style="margin-top:14px;">
    <div class="card-header">
      <div class="card-title">Year-by-Year Pitching</div>
    </div>

    <div style="overflow:auto;">
      <table class="table" style="width:100%; min-width:980px;">
        <thead>
          <tr>
            <th>Year</th>
            <th>Team</th>
            <th>G</th><th>GS</th><th>IP</th>
            <th>W</th><th>L</th><th>SV</th><th>SO</th>
            <th>ERA</th><th>WHIP</th><th>Awards</th>
          </tr>
        </thead>
        <tbody>

          {% for g in _pg %}
            {% set r = g.total %}
            {% if r %}
              {% set s = r.stat %}
              {% set has_parts = (g.parts and (g.parts|length) > 0) %}

              <tr class="year-row">
                <td style="white-space:nowrap;">
                  <span class="yearcell">
                    <span>{{ g.year }}</span>

                    {% if has_parts %}
                      <button class="yexp" type="button" data-kind="pitching" data-year="{{ g.year }}" aria-label="Expand year">â–¾</button>
                    {% else %}
                      <span class="yspacer"></span>
                    {% endif %}
                  </span>
                </td>

                <!-- Only show 'Total' when that year has multiple rows -->
                <td style="white-space:nowrap;">{{ "Total" if has_parts else r.team }}</td>

                <td>{{ s.gamesPitched or "â€”" }}</td>
                <td>{{ s.gamesStarted or "â€”" }}</td>
                <td>{{ s.inningsPitched or "â€”" }}</td>
                <td>{{ s.wins or "â€”" }}</td>
                <td>{{ s.losses or "â€”" }}</td>
                <td>{{ s.saves or "â€”" }}</td>
                <td>{{ s.strikeOuts or "â€”" }}</td>
                <td>{{ s.era or "â€”" }}</td>
                <td>{{ s.whip or "â€”" }}</td>
                <td>
                  {% set y = g.year %}
                  {% if award_year_map[y] is defined %}
                    {% set award_labels = {
                      "mvp":"MVP",
                      "cyyoung":"CY",
                      "roy":"ROY",
                      "goldglove":"GG",
                      "platinumglove":"PG",
                      "silverslugger":"SS",
                      "allstar":"AS",
                      "battingchamp":"BC",
                      "hrderby":"HRD",
                      "wsmvp":"WS-MVP",
                      "wschamp":"WS",
                      "hof":"HOF"
                    } %}                    
                    {% for k in award_year_map[y] %}
                      <span class="acc-pill acc-{{ k }}" style="font-size:10px; padding:2px 6px;">
                        {{ award_labels[k] if award_labels[k] is defined else k|upper }}
                      </span>
                    {% endfor %}
                  {% endif %}
                </td>
              </tr>
              {% if has_parts %}
                {% for p in g.parts %}
                  {% set ps = p.stat %}
                  <tr class="ychild ychild-pitching ychild-{{ g.year }}" style="display:none; opacity:.92;">
                    <td style="white-space:nowrap; padding-left:16px;">{{ p.year }}</td>
                    <td style="white-space:nowrap;">{{ p.team }}</td>
                    <td>{{ ps.gamesPitched or "â€”" }}</td>
                    <td>{{ ps.gamesStarted or "â€”" }}</td>
                    <td>{{ ps.inningsPitched or "â€”" }}</td>
                    <td>{{ ps.wins or "â€”" }}</td>
                    <td>{{ ps.losses or "â€”" }}</td>
                    <td>{{ ps.saves or "â€”" }}</td>
                    <td>{{ ps.strikeOuts or "â€”" }}</td>
                    <td>{{ ps.era or "â€”" }}</td>
                    <td>{{ ps.whip or "â€”" }}</td>
                  </tr>
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}

          {% if career_pitching is defined and career_pitching %}
            <tr class="career-row">
              <td>Career</td>
              <td></td>
              <td>{{ career_pitching.gamesPitched or "â€”" }}</td>
              <td>{{ career_pitching.gamesStarted or "â€”" }}</td>
              <td>{{ career_pitching.inningsPitched or "â€”" }}</td>
              <td>{{ career_pitching.wins or "â€”" }}</td>
              <td>{{ career_pitching.losses or "â€”" }}</td>
              <td>{{ career_pitching.saves or "â€”" }}</td>
              <td>{{ career_pitching.strikeOuts or "â€”" }}</td>
              <td>{{ career_pitching.era or "â€”" }}</td>
              <td>{{ career_pitching.whip or "â€”" }}</td>
            </tr>
          {% endif %}

        </tbody>
      </table>
    </div>
  </div>
  {% endif %}
{% endif %}


<!-- ===================== -->
<!-- LOADING OVERLAY -->
<!-- ===================== -->

<div id="loadingOverlay" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  align-items:center;
  justify-content:center;
  z-index:9999;
">
  <div style="text-align:center;">
    <div style="
      width:54px;
      height:54px;
      border:6px solid rgba(255,255,255,.25);
      border-top-color: rgba(255,255,255,.95);
      border-radius:50%;
      animation:spin 0.9s linear infinite;
      margin:0 auto 12px auto;">
    </div>
    <div style="color:white; font-weight:800; letter-spacing:.5px;">
      Shuffling baseball cardsâ€¦
    </div>
  </div>
</div>

<style>
@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Year cell: keep year aligned; caret always occupies the same space (right side) */
.yearcell{
  display:inline-flex;
  align-items:center;
  gap:8px;
}
.yspacer{
  display:inline-block;
  width:18px;
  height:18px;
}

/* Expand caret */
.yexp{
  width:18px;
  height:18px;
  border-radius:6px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.85);
  font-weight:900;
  line-height: 1;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
}
.yexp.open{
  transform: rotate(180deg);
}

/* Career row is the ONLY bold row */
.career-row td{
  font-weight:900;
}

/* Accolade pills */
.acc-pill{
  font-size:12px;
  font-weight:800;
  padding:4px 9px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.9);
}

/* Individual award colors */
.acc-mvp {
  background:#fbbf24;
  border-color:#fbbf24;
  color:#111;
}

.acc-wsmvp {
  background:#f59e0b;
  border-color:#f59e0b;
  color:#111;
}
  
.acc-cyyoung {
  background:#38bdf8;
  border-color:#38bdf8;
  color:#0b1220;
}

.acc-roy {
  background:#34d399;
  border-color:#34d399;
  color:#0b1220;
}

.acc-goldglove {
  background:#facc15;
  border-color:#facc15;
  color:#111;
}

.acc-platinumglove {
  background:#e5e7eb;
  border-color:#e5e7eb;
  color:#111;
}

.acc-hrderby {
  background:#fb923c;
  border-color:#fb923c;
  color:#111;
}

.acc-silverslugger {
  background:#9ca3af;
  border-color:#9ca3af;
  color:#111;
}

.acc-allstar {
  background:#fb7185;
  border-color:#fb7185;
  color:#111;
}

.acc-battingchamp {
  background:#c084fc;
  border-color:#c084fc;
  color:#111;
}

.acc-wschamp {
  background:#fdba74;
  border-color:#fdba74;
  color:#111;
}

/* Hall of Fame â€“ Cooperstown jacket gold */
.acc-hof {
  background:#d4af37;
  border-color:#d4af37;
  color:#111;
}
</style>

<script>
  // Headshot fallback (only matters after a player is loaded)
  const img = document.getElementById("playerHeadshot");
  const fallback = document.getElementById("noPhotoFallback");
  if (img && fallback) {
    img.onerror = function() {
      img.style.display = "none";
      fallback.style.display = "flex";
    };
  }

  // 2-second suspense before fetching next player
  const btn = document.getElementById("rollBtn");
  const overlay = document.getElementById("loadingOverlay");

  btn?.addEventListener("click", () => {
    overlay.style.display = "flex";
    btn.disabled = true;

    setTimeout(() => {
      window.location.href = "/random-player/play";
    }, 2000);
  });

  // Expand/collapse year children (multi-team seasons)
  document.querySelectorAll(".yexp").forEach(b => {
    b.addEventListener("click", () => {
      const year = b.getAttribute("data-year");
      const kind = b.getAttribute("data-kind");
      const rows = document.querySelectorAll(`.ychild-${kind}.ychild-${year}`);
      const isOpen = b.classList.toggle("open");

      rows.forEach(r => r.style.display = isOpen ? "table-row" : "none");
    });
  });
</script>

{% endblock %}
