{% extends "base.html" %}
{% block content %}

<div class="card">
  <div class="card-header">
    <div>
      <div class="card-title">Stats</div>
    </div>
  </div>

  <div class="card-body">

    <!-- ===================== -->
    <!-- BASIC FILTERS -->
    <!-- ===================== -->
    <div class="stats-controls" style="margin-bottom:8px;">
      <select id="group" class="select">
        <option value="batting" {{ 'selected' if group=='batting' else '' }}>Batting</option>
        <option value="pitching" {{ 'selected' if group=='pitching' else '' }}>Pitching</option>
        <option value="fielding" {{ 'selected' if group=='fielding' else '' }}>Fielding</option>
        <option value="baserunning" {{ 'selected' if group=='baserunning' else '' }}>Baserunning</option>
      </select>

      <select id="season" class="select">
        {% set start = season %}
        {% for y in range(start, start-26, -1) %}
          <option value="{{ y }}" {{ 'selected' if y==season else '' }}>{{ y }}</option>
        {% endfor %}
      </select>

      <select id="league_id" class="select">
        {% for lg in leagues %}
          <option value="{{ lg.id }}">{{ lg.label }}</option>
        {% endfor %}
      </select>

      <select id="team_id" class="select">
        <option value="">All Teams</option>
        {% for t in teams %}
          <option value="{{ t.id }}">{{ t.name }}</option>
        {% endfor %}
      </select>

      <select id="position" class="select">
        <option value="">All Positions</option>
        {% for p in positions %}
          {% if p %}
            <option value="{{ p }}">{{ p }}</option>
          {% endif %}
        {% endfor %}
      </select>

      <!-- Default to QUALIFIED -->
      <select id="pool" class="select">
        <option value="QUALIFIED" selected>Qualified Only</option>
        <option value="ALL">All Players</option>
      </select>

      <button id="applyBasic" class="btn">Apply</button>
      <span class="muted" id="statusText" style="margin-left:6px;"></span>
    </div>

    <!-- ===================== -->
    <!-- SHOW COLUMNS -->
    <!-- ===================== -->
    <details id="colsBox" class="card" style="margin:10px 0; padding:12px;">
      <summary style="cursor:pointer; font-weight:800;">
        Show Columns
      </summary>

      <div style="margin-top:10px;">

        <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
          <div style="font-weight:800;">Columns</div>
          <button id="colsAll" class="btn" type="button">Select all</button>
          <button id="colsNone" class="btn" type="button">Select none</button>
          <button id="colsReset" class="btn" type="button">Reset defaults</button>
          <button id="colsApply" class="btn" type="button">Apply columns</button>
          <span class="muted" id="colsCount"></span>
        </div>

        <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <input id="colSearch" class="select" style="height:34px; width:260px;" placeholder="Search columns (e.g., HR, OPS, homeRuns)" />
          <span class="muted">Tip: click a header to sort by it</span>
        </div>

        <div id="colsWrap" style="margin-top:10px; border:1px solid var(--border); border-radius:12px; padding:10px; max-height:280px; overflow:auto;">
          <div class="muted">Loading columns…</div>
        </div>

      </div>
    </details>

    <!-- ===================== -->
    <!-- ADVANCED FILTERING -->
    <!-- ===================== -->
    <details id="advancedBox" class="card" style="margin:10px 0; padding:12px;">
      <summary style="cursor:pointer; font-weight:800;">
        Advanced Filtering
      </summary>

      <div style="margin-top:10px;">

        <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
          <div style="font-weight:800;">Filters</div>
          <button id="addFilter" class="btn" type="button">Add filter</button>
          <button id="clearFilters" class="btn" type="button">Clear</button>
          <button id="applyFilters" class="btn" type="button">Apply filters</button>
          <span class="muted" id="filterHint"></span>
        </div>

        <div id="filtersWrap" style="margin-top:10px;">
          <!-- filter rows injected here -->
        </div>

      </div>
    </details>

    <!-- ===================== -->
    <!-- TABLE -->
    <!-- ===================== -->
    <div class="table-wrap">
      <table class="table stats-table">
        <thead id="thead"></thead>
        <tbody id="tbody">
          <tr><td class="muted">Loading…</td></tr>
        </tbody>
      </table>
    </div>

    <!-- ===================== -->
    <!-- PAGER -->
    <!-- ===================== -->
    <div class="pager">
      <button id="prev" class="btn">Prev</button>
      <button id="next" class="btn">Next</button>
      <span id="range" class="range-pill">—</span>
      <span class="muted" id="pageLabel"></span>
    </div>

    <div class="pager" id="pageButtons"></div>

  </div>
</div>

<!-- Table overflow + nowrap (ensures no cut-off; horizontal scroll when needed) -->
<style>
  .table-wrap{ overflow-x:auto; }
  .stats-table{ width:max-content; min-width:100%; }
  .stats-table th, .stats-table td{ white-space:nowrap; }
</style>

<script>
(() => {
  const el = (id) => document.getElementById(id);

  // ----------------------------
  // Stat labels (acronyms)
  // ----------------------------
  const STAT_LABELS = {
    // batting
    gamesPlayed: "G",
    plateAppearances: "PA",
    atBats: "AB",
    hits: "H",
    runs: "R",
    rbi: "RBI",
    homeRuns: "HR",
    doubles: "2B",
    triples: "3B",
    totalBases: "TB",
    stolenBases: "SB",
    caughtStealing: "CS",
    stolenBasePercentage: "SB%",
    baseOnBalls: "BB",
    strikeOuts: "SO",
    avg: "AVG",
    obp: "OBP",
    slg: "SLG",
    ops: "OPS",
    babip: "BABIP",
    woba: "wOBA",
    isolatedPower: "ISO",
    onBasePlusSlugging: "OPS",
        // extra mappings
    age: "Age",
    airOuts: "FO",
    atBatsPerHomeRun: "AB/HR",
    catchersInterference: "CI",
    caughtStealingPercentage: "CS%",
    groundIntoDoublePlay: "GIDP",
    groundOuts: "GO",
    groundOutsToAirouts: "GO/FO",
    hitByPitch: "HBP",
    intentionalWalks: "IBB",
    leftOnBase: "LOB",
    sacBunts: "SACB",
    sacFlies: "SF",
    numberOfPitches: "P",


    // pitching
    wins: "W",
    losses: "L",
    saves: "SV",
    holds: "HLD",
    era: "ERA",
    whip: "WHIP",
    inningsPitched: "IP",
    gamesStarted: "GS",
    gamesPitched: "G",
    hitsAllowed: "H",
    runsAllowed: "R",
    earnedRuns: "ER",
    homeRunsAllowed: "HR",
    baseOnBalls: "BB",
    strikeOuts: "SO",
    fip: "FIP",
    strikeoutsPer9Inn: "K/9",
    walksPer9Inn: "BB/9",
    homeRunsPer9Inn: "HR/9",
    strikeoutWalkRatio: "K/BB",

    // fielding
    fielding: "Fld%",
    assists: "A",
    putOuts: "PO",
    errors: "E",
    doublePlays: "DP",
    innings: "Inn",
    games: "G"
  };

  function labelForStatKey(k){
    return STAT_LABELS[k] || k;
  }

  // ----------------------------
  // Defaults
  // ----------------------------
  const defaultColsByGroup = {
    batting: ["gamesPlayed","plateAppearances","avg","obp","slg","ops","homeRuns","rbi","runs","hits","stolenBases"],
    pitching: ["wins","losses","era","whip","inningsPitched","strikeOuts","baseOnBalls","hits","homeRuns"],
    fielding: ["games","innings","fielding","assists","putOuts","errors","doublePlays"],
    baserunning: ["stolenBases","caughtStealing","stolenBasePercentage","runs"]
  };

  const opOptions = [">=","<=",">","<","=","!="];

  // State
  let page = 1;
  let sortStat = "";     // backend sort
  let sortOrder = "desc";
  let availableKeys = [];     // from backend discovery
  let selectedCols = [];      // user-chosen columns
  let filters = [];           // [{stat, op, value}]
  let lastMetaKey = "";       // localStorage scoping

  // ---------------
  // Storage helpers
  // ---------------
  function storageKeyBase(){
    const g = el("group").value;
    const season = el("season").value;
    const lg = el("league_id").value || "";
    const team = el("team_id").value || "";
    const pos = el("position").value || "";
    const pool = el("pool").value || "";
    return `bn_stats:${g}:${season}:lg=${lg}:team=${team}:pos=${pos}:pool=${pool}`;
  }

  function loadPersisted(){
    const base = storageKeyBase();
    lastMetaKey = base;

    try {
      const colsRaw = localStorage.getItem(base + ":cols");
      const filtersRaw = localStorage.getItem(base + ":filters");
      const sortRaw = localStorage.getItem(base + ":sort");
      const orderRaw = localStorage.getItem(base + ":order");

      selectedCols = colsRaw ? JSON.parse(colsRaw) : [];
      filters = filtersRaw ? JSON.parse(filtersRaw) : [];
      sortStat = sortRaw || "";
      sortOrder = orderRaw || "desc";
    } catch (e) {
      selectedCols = [];
      filters = [];
      sortStat = "";
      sortOrder = "desc";
    }

    if (!Array.isArray(selectedCols) || selectedCols.length === 0) {
      selectedCols = (defaultColsByGroup[el("group").value] || []).slice();
    }
    if (!Array.isArray(filters)) filters = [];
    if (!sortOrder || (sortOrder !== "asc" && sortOrder !== "desc")) sortOrder = "desc";
  }

  function persist(){
    const base = storageKeyBase();
    lastMetaKey = base;
    try {
      localStorage.setItem(base + ":cols", JSON.stringify(selectedCols || []));
      localStorage.setItem(base + ":filters", JSON.stringify(filters || []));
      localStorage.setItem(base + ":sort", sortStat || "");
      localStorage.setItem(base + ":order", sortOrder || "desc");
    } catch (e) {}
  }

  // -------------------
  // Build query params
  // -------------------
  function buildQuery(pageNum){
    const p = new URLSearchParams();

    const group = el("group").value;
    const season = el("season").value;
    const league_id = el("league_id").value;
    const team_id = el("team_id").value;
    const position = el("position").value;
    const pool = el("pool").value;

    p.set("group", group);
    p.set("season", season);
    if (league_id) p.set("league_id", league_id);
    if (team_id) p.set("team_id", team_id);
    if (position) p.set("position", position);
    p.set("pool", pool);

    p.set("page", String(pageNum || 1));

    // sorting
    if (sortStat) p.set("sort", sortStat);
    p.set("order", sortOrder || "desc");

    // selected columns + filters
    if (selectedCols && selectedCols.length) p.set("cols", selectedCols.join(","));
    if (filters && filters.length) p.set("filters", JSON.stringify(filters));

    return p.toString();
  }

  // --------------
  // Filter builder
  // --------------
  function renderFilters(){
    const wrap = el("filtersWrap");
    wrap.innerHTML = "";

    if (!filters.length){
      wrap.innerHTML = `<div class="muted">No filters. Example: HR &ge; 20</div>`;
      el("filterHint").textContent = "";
      return;
    }

    el("filterHint").textContent = `${filters.length} active`;

    filters.forEach((f, idx) => {
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.gap = "10px";
      row.style.flexWrap = "wrap";
      row.style.alignItems = "center";
      row.style.marginBottom = "8px";

      const statSel = document.createElement("select");
      statSel.className = "select";
      statSel.style.height = "34px";

      const keys = (availableKeys && availableKeys.length) ? availableKeys : (selectedCols || []);
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Choose stat…";
      statSel.appendChild(opt0);

      keys.forEach(k => {
        const o = document.createElement("option");
        o.value = k;
        o.textContent = `${labelForStatKey(k)}`;
        if ((f.stat || "") === k) o.selected = true;
        statSel.appendChild(o);
      });

      const opSel = document.createElement("select");
      opSel.className = "select";
      opSel.style.height = "34px";
      opOptions.forEach(op => {
        const o = document.createElement("option");
        o.value = op;
        o.textContent = op;
        if ((f.op || "") === op) o.selected = true;
        opSel.appendChild(o);
      });

      const valIn = document.createElement("input");
      valIn.className = "select";
      valIn.style.height = "34px";
      valIn.style.width = "140px";
      valIn.placeholder = "value";
      valIn.value = (f.value !== undefined && f.value !== null) ? String(f.value) : "";

      const rm = document.createElement("button");
      rm.className = "btn";
      rm.type = "button";
      rm.textContent = "Remove";

      statSel.addEventListener("change", () => {
        filters[idx].stat = statSel.value;
        persist();
      });
      opSel.addEventListener("change", () => {
        filters[idx].op = opSel.value;
        persist();
      });
      valIn.addEventListener("input", () => {
        filters[idx].value = valIn.value;
        persist();
      });
      rm.addEventListener("click", () => {
        filters.splice(idx, 1);
        persist();
        renderFilters();
      });

      row.appendChild(statSel);
      row.appendChild(opSel);
      row.appendChild(valIn);
      row.appendChild(rm);

      wrap.appendChild(row);
    });
  }

  // -----------------
  // Columns checklist
  // -----------------
  function normalizeColSet(){
    const set = new Set();
    (selectedCols || []).forEach(k => { if (k) set.add(k); });

    if (availableKeys && availableKeys.length){
      const allowed = new Set(availableKeys);
      selectedCols = Array.from(set).filter(k => allowed.has(k));
    } else {
      selectedCols = Array.from(set);
    }

    if (!selectedCols.length){
      selectedCols = (defaultColsByGroup[el("group").value] || []).slice();
    }
  }

  function renderCols(){
    const wrap = el("colsWrap");

    if (!availableKeys || !availableKeys.length){
      wrap.innerHTML = `<div class="muted">No columns discovered yet.</div>`;
      el("colsCount").textContent = "";
      return;
    }

    normalizeColSet();
    const selected = new Set(selectedCols);

    const q = (el("colSearch").value || "").trim().toLowerCase();
    const keys = availableKeys.filter(k => {
      if (!q) return true;
      const a = labelForStatKey(k).toLowerCase();
      const b = k.toLowerCase();
      return a.includes(q) || b.includes(q);
    });

    const frag = document.createDocumentFragment();

    const grid = document.createElement("div");
    grid.style.display = "grid";
    grid.style.gridTemplateColumns = "repeat(auto-fit, minmax(240px, 1fr))";
    grid.style.gap = "6px";

    keys.forEach(k => {
      const label = document.createElement("label");
      label.style.display = "flex";
      label.style.alignItems = "center";
      label.style.gap = "8px";
      label.style.padding = "6px 8px";
      label.style.border = "1px solid var(--border)";
      label.style.borderRadius = "10px";
      label.style.background = "#fff";
      label.style.cursor = "pointer";
      label.style.userSelect = "none";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = selected.has(k);

      cb.addEventListener("change", () => {
        if (cb.checked) selected.add(k);
        else selected.delete(k);
        selectedCols = Array.from(selected);
        persist();
        el("colsCount").textContent = `${selectedCols.length} selected`;
      });

      const span = document.createElement("span");
      span.textContent = `${labelForStatKey(k)}`;
      span.style.fontWeight = "700";

      label.appendChild(cb);
      label.appendChild(span);
      grid.appendChild(label);
    });

    frag.appendChild(grid);
    wrap.innerHTML = "";
    wrap.appendChild(frag);

    el("colsCount").textContent = `${selectedCols.length} selected`;
  }

  // ----------
  // Table build
  // ----------
  function fmt(v){
    if (v === null || v === undefined || v === "") return "—";
    return String(v);
  }

  function buildThead(){
    const cols = selectedCols || [];
    const thead = el("thead");

    const arrow = (k) => {
      if (!k) return "";
      if (sortStat !== k) return "";
      return sortOrder === "asc" ? " ▲" : " ▼";
    };

    const th = (label, key, isNum=true) => {
      const cls = (isNum ? "num " : "") + "sortable";
      return `<th class="${cls}" data-key="${key}">${label}${arrow(key)}</th>`;
    };

    const header = `
      <tr>
        ${th("#","__rank", true)}
        ${th("Player","__player", false)}
        ${cols.map(k => th(labelForStatKey(k), k, true)).join("")}
      </tr>
    `;
    thead.innerHTML = header;

    thead.querySelectorAll("th.sortable").forEach(node => {
      node.style.cursor = "pointer";
      node.addEventListener("click", () => {
        const key = node.getAttribute("data-key") || "";

        // Rank resets to a sane default and reloads
        if (key === "__rank") {
          const g = el("group").value;
          // reset to a group default (ops/era/fielding/sb), not truly rank
          sortStat = (defaultColsByGroup[g] || [])[5] || (defaultColsByGroup[g] || [])[0] || "";
          sortOrder = "desc";
          persist();
          page = 1;
          load();
          return;
        }

        // Player: local sort only
        if (key === "__player") {
          const next = (sortOrder === "desc") ? "asc" : "desc";
          sortOrder = next;
          persist();
          sortRowsByPlayer(next);
          return;
        }

        // Stat columns: backend sort
        if (sortStat === key) {
          sortOrder = (sortOrder === "desc") ? "asc" : "desc";
        } else {
          sortStat = key;
          sortOrder = "desc";
        }
        persist();
        page = 1;
        load();
      });
    });
  }

  function sortRowsByPlayer(order){
    const tbody = el("tbody");
    const rows = Array.from(tbody.querySelectorAll("tr"));
    if (!rows.length) return;
    if (rows.length === 1 && (rows[0].textContent || "").toLowerCase().includes("no results")) return;

    rows.sort((a,b)=>{
      const an = (a.querySelector(".pname")?.textContent || "").toLowerCase();
      const bn = (b.querySelector(".pname")?.textContent || "").toLowerCase();
      if (an < bn) return order === "asc" ? -1 : 1;
      if (an > bn) return order === "asc" ? 1 : -1;
      return 0;
    });

    tbody.innerHTML = "";
    rows.forEach(r => tbody.appendChild(r));
  }

  function renderRows(data){
    const cols = selectedCols || [];
    const rows = (data.rows || []);
    const offsetRank = data.rankStart || ((data.offset || 0) + 1);

    if (!rows.length){
      el("tbody").innerHTML = `<tr><td colspan="${2 + cols.length}" class="muted">No results.</td></tr>`;
      return;
    }

    const html = rows.map((r, idx) => {
      const rank = offsetRank + idx;
      const pid = r.playerId;
      const name = r.name || "—";
      const headshot = r.headshot || "";
      const teamLogo = r.teamLogo || "";
      const stat = r.stat || {};

      return `
        <tr>
          <td class="num">${rank}</td>
          <td>
            <div class="player-chip">
              ${headshot ? `<img class="mini-headshot" src="${headshot}" alt="">` : ``}
              ${teamLogo ? `<img class="mini-teamlogo" src="${teamLogo}" alt="">` : ``}
              <a class="pname teamlink" href="${pid ? `/player/${pid}` : '#'}">${name}</a>
            </div>
          </td>
          ${cols.map(k => `<td class="num">${fmt(stat[k])}</td>`).join("")}
        </tr>
      `;
    }).join("");

    el("tbody").innerHTML = html;
  }

  function buildPageButtons(currentPage){
    const container = el("pageButtons");
    container.innerHTML = "";
    const start = Math.max(1, currentPage - 3);
    const end = start + 6;

    for (let p = start; p <= end; p++){
      const b = document.createElement("button");
      b.className = "btn";
      const lo = (p - 1) * 50 + 1;
      const hi = p * 50;
      b.textContent = `${lo}-${hi}`;
      if (p === currentPage) b.style.borderColor = "#0b0e13";
      b.addEventListener("click", () => { page = p; load(); });
      container.appendChild(b);
    }
  }

  // ----------
  // Main loader
  // ----------
  async function load(){
    if (!selectedCols || !selectedCols.length){
      selectedCols = (defaultColsByGroup[el("group").value] || []).slice();
    }

    el("statusText").textContent = "Loading…";
    el("tbody").innerHTML = `<tr><td class="muted">Loading…</td></tr>`;

    const qs = buildQuery(page);
    const url = `/stats_json?${qs}`;

    const res = await fetch(url);
    const data = await res.json();

    availableKeys = (data.availableKeys || []).slice().sort();

    if (!selectedCols || !selectedCols.length){
      selectedCols = (data.defaultCols || defaultColsByGroup[el("group").value] || []).slice();
    }

    normalizeColSet();

    // Build table
    buildThead();
    renderRows(data);

    // Pager labels
    el("range").textContent = data.rangeLabel || "—";
    el("pageLabel").textContent = `Page ${data.page || page}`;
    buildPageButtons(data.page || page);

    el("prev").onclick = () => { page = Math.max(1, (data.page || page) - 1); load(); };
    el("next").onclick = () => { page = (data.page || page) + 1; load(); };

    // UI panels
    renderCols();
    renderFilters();

    // Status: "Showing 1-50 of 145"
    const range = (data.rangeLabel || "—");
    let total = null;

    if (data.filteredTotalApprox !== undefined && data.filteredTotalApprox !== null){
      total = Number(data.filteredTotalApprox);
    } else {
      // fallback: use the high end of the rangeLabel if it looks like "1-50"
      const m = String(range).match(/^\s*(\d+)\s*-\s*(\d+)\s*$/);
      total = m ? Number(m[2]) : null;
    }

    el("statusText").textContent = total ? `Showing ${range} of ${total}` : `Showing ${range}`;

    persist();
  }

  // ----------------
  // Button handlers
  // ----------------
  el("applyBasic").addEventListener("click", () => {
    loadPersisted();
    page = 1;
    load();
  });

  el("addFilter").addEventListener("click", () => {
    filters = filters || [];
    filters.push({stat:"", op:">=", value:""});
    persist();
    renderFilters();
  });

  el("clearFilters").addEventListener("click", () => {
    filters = [];
    persist();
    renderFilters();
  });

  el("applyFilters").addEventListener("click", () => {
    filters = (filters || []).filter(f => (f.stat || "").trim() && (f.op || "").trim() && String(f.value).trim() !== "");
    persist();
    page = 1;
    load();
  });

  el("colsAll").addEventListener("click", () => {
    selectedCols = (availableKeys || []).slice();
    persist();
    renderCols();
    buildThead();
    page = 1;
    load();
  });

  el("colsNone").addEventListener("click", () => {
    selectedCols = [];
    persist();
    renderCols();
  });

  el("colsReset").addEventListener("click", () => {
    selectedCols = (defaultColsByGroup[el("group").value] || []).slice();
    persist();
    renderCols();
    buildThead();
    page = 1;
    load();
  });

  el("colsApply").addEventListener("click", () => {
    normalizeColSet();
    persist();
    buildThead();
    page = 1;
    load();
  });

  el("colSearch").addEventListener("input", () => {
    renderCols();
  });

  el("group").addEventListener("change", () => {
    page = 1;
    sortStat = "";
    sortOrder = "desc";
    loadPersisted();
    load();
  });

  ["season","league_id","team_id","position","pool"].forEach(id => {
    el(id).addEventListener("change", () => {
      page = 1;
      loadPersisted();
      load();
    });
  });

  // Init
  loadPersisted();
  load();
})();
</script>

{% endblock %}
