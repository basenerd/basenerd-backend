<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Today's Games</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* your existing styles untouched */
  </style>
</head>
<body>
  <header>
    <!-- your header code unchanged -->
  </header>

  <main>
    <div id="controls">
      <!-- controls unchanged -->
    </div>

    <div id="empty" class="empty" style="display:none"></div>
    <div id="games" class="games"></div>
  </main>

  <footer>
    <div id="updated" class="updated"></div>
  </footer>

  <script>
  // --- Safe element lookups (won’t crash if an element is missing)
  const $games     = document.getElementById('games');
  const $empty     = document.getElementById('empty');
  const $dateLabel = document.getElementById('dateLabel');
  const $updated   = document.getElementById('updated');
  const $liveOnly  = document.getElementById('liveOnly');

  const state = { date: new Date(), timer: null };

  // Format YYYY-MM-DD in ET for the API
  function dateStrET(d){
    return d.toLocaleDateString('en-CA', { timeZone: 'America/New_York' });
  }

  function setDate(d){
    state.date = d;
    if ($dateLabel) {
      $dateLabel.textContent = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }
    load();
  }

  async function fetchJson(url){
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  }

  // Robust “live” detector (works even if server status is a phrase)
  function isLiveGame(g){
    const st = (g.status || '').toLowerCase();
    if (st === 'in_progress') return true;
    const chip = (g.chip || '').toLowerCase();
    return chip.includes('top') || chip.includes('bot'); // e.g., "Top 6th", "Bot 3rd"
  }

  // Inning badge / start time chip
  function chipFor(g){
    if (isLiveGame(g)) return `<span class="chip live">${g.chip || ''}</span>`;
    if ((g.status || '').toLowerCase() === 'final') return `<span class="chip final">Final</span>`;
    return `<span class="chip upcoming">${g.chip || ''}</span>`;
  }

  // One game card (keeps your existing structure/classes)
  function card(g){
    const div = document.createElement('div');
    div.className = 'game-card';
    div.innerHTML = `
      <a class="link" href="/game/${g.gamePk}">
        <div class="row row-top">
          <div class="team">
            <img class="logo" src="https://www.mlbstatic.com/team-logos/${g.away.id}.svg" alt="${g.away.name}">
            <div class="abbr">${g.away.abbr || ''}</div>
          </div>
          <div class="score">${g.away.score ?? ''}</div>
        </div>
        <div class="row row-bot">
          <div class="team">
            <img class="logo" src="https://www.mlbstatic.com/team-logos/${g.home.id}.svg" alt="${g.home.name}">
            <div class="abbr">${g.home.abbr || ''}</div>
          </div>
          <div class="score">${g.home.score ?? ''}</div>
        </div>
        <div class="meta">
          ${chipFor(g)}
          <div class="venue">${g.venue || ''}</div>
        </div>
      </a>
    `;
    return div;
  }

  // Render list safely (no crashes if filters/containers are missing)
  function render(data){
    const all = Array.isArray(data.games) ? data.games : [];
    const liveOnly = !!($liveOnly && $liveOnly.checked);
    const filtered = liveOnly ? all.filter(isLiveGame) : all;

    if ($games) $games.innerHTML = '';

    if (!filtered.length){
      if ($empty){
        $empty.style.display = 'block';
        $empty.textContent = liveOnly ? 'No live games right now.' : 'No games to show for this date.';
      }
      if ($updated) $updated.textContent = 'Updated: ' + new Date().toLocaleString();
      return;
    }

    if ($empty) $empty.style.display = 'none';
    if ($games){
      const frag = document.createDocumentFragment();
      filtered.forEach(g => frag.appendChild(card(g)));
      $games.appendChild(frag);
    }
    if ($updated) $updated.textContent = 'Updated: ' + new Date().toLocaleString();
  }

  // Load + auto-refresh when any game live
  async function load(){
    if (state.timer) { clearTimeout(state.timer); state.timer = null; }
    const et = dateStrET(state.date);
    try {
      const data = await fetchJson("{{ url_for('api_games') }}" + '?date=' + encodeURIComponent(et));
      render(data);
      const anyLive = (data.games || []).some(isLiveGame);
      if (anyLive) state.timer = setTimeout(load, 30000);
    } catch(e){
      console.error(e);
      if ($games) $games.innerHTML = '<div class="empty">Error loading games. Check /api/games on the server.</div>';
    }
  }

  // Wire up next/prev today buttons if present (no-crash guards)
  (function wireControls(){
    const $prev = document.getElementById('prevDay');
    const $next = document.getElementById('nextDay');
    const $today = document.getElementById('today');
    if ($prev) $prev.addEventListener('click', ()=> setDate(new Date(state.date.getTime() - 86400000)));
    if ($next) $next.addEventListener('click', ()=> setDate(new Date(state.date.getTime() + 86400000)));
    if ($today) $today.addEventListener('click', ()=> setDate(new Date()));
    if ($liveOnly) $liveOnly.addEventListener('change', ()=> render({games: (window.__lastGames || [])}));
  })();

  // Initial load
  setDate(new Date());
</script>

</body>
</html>
