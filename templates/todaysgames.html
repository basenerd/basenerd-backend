<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Today's Games</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* your existing styles untouched */
  </style>
</head>
<body>
  <header>
    <!-- your header code unchanged -->
  </header>

  <main>
    <div id="controls">
      <!-- controls unchanged -->
    </div>

    <div id="empty" class="empty" style="display:none"></div>
    <div id="games" class="games"></div>
  </main>

  <footer>
    <div id="updated" class="updated"></div>
  </footer>

  <script>
    const $games = document.getElementById('games');
    const $empty = document.getElementById('empty');
    const $dateLabel = document.getElementById('dateLabel');
    const $updated = document.getElementById('updated');
    const $liveOnly = document.getElementById('liveOnly');

    const state = { date: new Date(), timer: null };

    function dateStrET(d){
      return d.toLocaleDateString('en-CA', { timeZone: 'America/New_York' });
    }

    function setDate(d){
      state.date = d;
      $dateLabel.textContent = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
      load();
    }

    async function fetchJson(url){
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    }

    // NEW: defensive live check
    function isLiveGame(g){
      const st = (g.status || '').toLowerCase();
      if (st === 'in_progress') return true;
      const chip = (g.chip || '').toLowerCase();
      return chip.includes('top') || chip.includes('bot');
    }

    function chipFor(g){
      if (isLiveGame(g)) return `<span class="chip live">${g.chip}</span>`;
      if ((g.status || '').toLowerCase() === 'final') return `<span class="chip final">Final</span>`;
      return `<span class="chip upcoming">${g.chip}</span>`;
    }

    function card(g){
      return Object.assign(document.createElement('div'), {
        className: 'game-card',
        innerHTML: `
          <div class="teams">
            <div class="team">
              <img src="https://www.mlbstatic.com/team-logos/${g.away.id}.svg" alt="${g.away.name}">
              <div class="team-name">${g.away.abbr}</div>
              <div class="team-score">${g.away.score != null ? g.away.score : ''}</div>
            </div>
            <div class="team">
              <img src="https://www.mlbstatic.com/team-logos/${g.home.id}.svg" alt="${g.home.name}">
              <div class="team-name">${g.home.abbr}</div>
              <div class="team-score">${g.home.score != null ? g.home.score : ''}</div>
            </div>
          </div>
          <div class="meta">
            ${chipFor(g)}
            <div class="venue">${g.venue}</div>
          </div>
        `
      });
    }

    function render(data){
      window.__last = data;
      const all = (data.games || []);
      const filtered = $liveOnly.checked ? all.filter(isLiveGame) : all;
      $games.innerHTML = '';
      if (!filtered.length){
        $empty.style.display = 'block';
        $empty.textContent = $liveOnly.checked ? 'No live games right now.' : 'No games to show for this date.';
        return;
      }
      $empty.style.display = 'none';
      const frag = document.createDocumentFragment();
      filtered.forEach(g => frag.appendChild(card(g)));
      $games.appendChild(frag);
      $updated.textContent = 'Updated: ' + new Date().toLocaleString();
    }

    async function load(){
      if (state.timer) { clearTimeout(state.timer); state.timer = null; }
      const et = dateStrET(state.date);
      try {
        const data = await fetchJson("{{ url_for('api_games') }}" + '?date=' + et);
        render(data);
        const anyLive = (data.games||[]).some(isLiveGame);
        if (anyLive) state.timer = setTimeout(load, 30000);
      } catch(e){
        console.error(e);
        $games.innerHTML = '<div class="empty">Error loading games. If this persists, check your server logs for the /api/games endpoint.</div>';
      }
    }

    setDate(new Date());
  </script>
</body>
</html>
