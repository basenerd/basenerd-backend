<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Today's Games • Basenerd</title>

  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600&family=IBM+Plex+Mono:wght@500&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#ffffff; --card:#ffffff; --muted:#5b6577; --text:#111318; --accent:#0b5cab;
      --border:#e2e8f0; --header-bg:#ffffff; --header-text:#0b0e13;
      --chip-live:#e21d48; --chip-final:#32425c; --chip-upcoming:#6b7a94;
    }
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--text);
          font-family:"IBM Plex Sans", system-ui, -apple-system, "Segoe UI", Roboto, Arial; font-size:13.5px; }

    /* Header */
    header{ display:flex; align-items:center; gap:10px; padding:12px 16px; border-bottom:2px solid var(--border); position:sticky; top:0; z-index:10; background:var(--header-bg); }
    header img{ height:32px }
    header h1{ margin:0; font-size:17px; letter-spacing:.2px; font-weight:600; color:var(--header-text) }

    /* Drawer + hamburger */
    .hamburger{ display:inline-flex; flex-direction:column; gap:4px; background:#fff; border:1px solid var(--border); cursor:pointer; padding:8px; border-radius:10px; }
    .hamburger span{ display:block; width:20px; height:2px; background:#394150; transition:transform .2s, opacity .2s; }
    .hamburger[aria-expanded="true"] span:nth-child(1){ transform:translateY(6px) rotate(45deg); }
    .hamburger[aria-expanded="true"] span:nth-child(2){ opacity:0; }
    .hamburger[aria-expanded="true"] span:nth-child(3){ transform:translateY(-6px) rotate(-45deg); }

    .drawer{ position:fixed; inset:0 auto 0 0; width:270px; transform:translateX(-100%); background:var(--card);
             border-right:1px solid var(--border); box-shadow:0 10px 30px rgba(0,0,0,.08); transition:transform .2s ease; z-index:1000; padding:16px; }
    .drawer.open{ transform:translateX(0) }
    .drawer h2{ margin:0 0 10px; font-size:16px; }
    .drawer nav a{ display:block; padding:8px 6px; border-radius:8px; color:#273041; text-decoration:none }
    .drawer nav a:hover{ background:#f4f6f9 }
    .drawer-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.25); opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:900; }
    .drawer-backdrop.show{ opacity:1; pointer-events:auto; }

    /* Toolbar (prev/next/today + live-only + ET date/updated) */
    .toolbar{ display:flex; gap:10px; align-items:center; padding:10px 16px; border-bottom:1px solid var(--border); background:#fff; flex-wrap:wrap }
    .btn{ border:1px solid var(--border); background:#fff; padding:6px 10px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn:hover{ background:#f7f9fc }
    .liveonly{ display:flex; align-items:center; gap:6px; color:#394150; }
    .date-meta{ margin-left:auto; display:flex; gap:12px; align-items:center; color:#5b6577; font-size:12.5px; }
    .date-meta .label{ font-weight:600; color:#2b3345 }

    /* Layout */
    .wrap{ max-width:1100px; margin:0 auto; padding:16px; }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media(max-width:900px){ .grid{ grid-template-columns:1fr } }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; overflow:hidden; box-shadow:0 8px 20px rgba(0,0,0,.05); }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; background:#fff; }

    /* Teams header row */
    .teams{ display:grid; grid-template-columns:auto 1fr auto auto 1fr auto; align-items:center; gap:10px; width:100%; }
    .logo{ width:28px; height:28px; object-fit:contain }
    .team{ display:flex; align-items:center; gap:10px; }
    .team .meta{ display:flex; flex-direction:column; gap:2px; }
    .team .name{ font-weight:700; line-height:1.1 }
    .team .sub{ color:#6a7387; font-size:12px; }
    .score{ font-weight:800; font-size:16px; min-width:20px; text-align:center }

    /* Chips / inning */
    .chips{ display:flex; align-items:center; gap:6px; }
    .chip{ font-family:"IBM Plex Mono", ui-monospace, Menlo, Consolas, monospace; font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #d9e0ea; background:#eef0f3; color:#3a465a }
    .chip.live{ background:#fde4ea; color:#7d0a23; border-color:#fac2d0 }
    .chip.final{ background:#e6ebf2; color:#1f2d44; border-color:#cfd8e6 }
    .chip.upcoming{ background:#eef0f3; color:#3a465a; border-color:#d9e0ea }

    /* Bases diamond */
    .diamond{ position:relative; width:26px; height:26px; display:inline-block; margin-left:8px; }
    .diamond .base{ position:absolute; width:10px; height:10px; transform:rotate(45deg); border:1px solid var(--border); background:#fff; }
    .diamond .on{ background:#ffd147; border-color:#ffd147; }
    .diamond .b2{ top:0; left:50%; transform:translate(-50%, 0) rotate(45deg); }
    .diamond .b1{ top:50%; right:0; transform:translate(0, -50%) rotate(45deg); }
    .diamond .b3{ top:50%; left:0; transform:translate(0, -50%) rotate(45deg); }

    /* Sections inside card */
    .sec{ padding:8px 12px; border-top:1px solid var(--border); background:#fff; }
    .sec h3{ margin:0 0 6px; font-size:12.5px; color:#32425c; }
    .muted{ color:#5b6577 }

    /* Details blocks */
    details{ padding:8px 12px 12px 12px; border-top:1px solid var(--border); background:#fff; }
    details summary{ cursor:pointer; font-weight:700; color:#32425c; margin:4px 0 8px; }

    /* Tables */
    table{ border-collapse:collapse; width:100%; font-size:12.5px; }
    th, td{ border:1px solid var(--border); padding:6px 8px; text-align:left; }
    th{ background:#f7f9fc }

    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media(max-width:700px){ .teams{ grid-template-columns: auto 1fr auto; } .grid-2{ grid-template-columns:1fr } }

    .empty{ color:var(--muted); border:1px dashed var(--border); border-radius:12px; padding:18px; text-align:center; background:#fff; }
  </style>
</head>
<body>
  <header>
    <button class="hamburger" aria-expanded="false" aria-controls="site-drawer" aria-label="Open navigation">
      <span></span><span></span><span></span>
    </button>
    <img alt="Basenerd" src="https://upload.wikimedia.org/wikipedia/commons/7/79/Baseball.svg">
    <h1>Today's Games</h1>
  </header>

  <div class="drawer" id="site-drawer" aria-hidden="true" tabindex="-1">
    <h2>Basenerd</h2>
    <nav>
      <a href="/">Home</a>
      <a href="/todaysgames">Today's Games</a>
      <a href="/standings">Standings</a>
    </nav>
  </div>
  <div class="drawer-backdrop"></div>

  <div class="toolbar">
    <div class="navdates">
      <button class="btn" id="prevDay">◀︎ Prev</button>
      <button class="btn" id="todayBtn">Today</button>
      <button class="btn" id="nextDay">Next ▶︎</button>
    </div>
    <label class="liveonly"><input id="liveOnly" type="checkbox" /> Live only</label>
    <div class="date-meta">
      <span class="label" id="dateLabel">—</span>
      <span id="updated">Updated —</span>
    </div>
  </div>

  <div class="wrap">
    <div id="games" class="grid"></div>
    <div id="empty" class="empty" style="display:none">No games to show for this date.</div>
    <p class="when">Times shown Eastern Time • Source: MLB Stats API</p>
  </div>

  <script>
    // Drawer behavior
    (function(){
      const btn = document.querySelector('.hamburger');
      const drawer = document.getElementById('site-drawer');
      const backdrop = document.querySelector('.drawer-backdrop');
      function openDrawer(){ drawer.classList.add('open'); backdrop.classList.add('show'); drawer.setAttribute('aria-hidden','false'); btn.setAttribute('aria-expanded','true'); document.body.style.overflow='hidden'; }
      function closeDrawer(){ drawer.classList.remove('open'); backdrop.classList.remove('show'); drawer.setAttribute('aria-hidden','true'); btn.setAttribute('aria-expanded','false'); document.body.style.overflow=''; }
      btn?.addEventListener('click', () => { (btn.getAttribute('aria-expanded') === 'true') ? closeDrawer() : openDrawer(); });
      backdrop?.addEventListener('click', closeDrawer);
      document.addEventListener('keydown', (e) => { if(e.key === 'Escape') closeDrawer(); });
    })();

    const $games = document.getElementById('games');
    const $empty = document.getElementById('empty');
    const $dateLabel = document.getElementById('dateLabel');
    const $updated = document.getElementById('updated');
    const $liveOnly = document.getElementById('liveOnly');
    const $prev = document.getElementById('prevDay');
    const $next = document.getElementById('nextDay');
    const $today = document.getElementById('todayBtn');

    // ET formatting
    const fmtET = new Intl.DateTimeFormat('en-US', { timeZone: 'America/New_York', hour:'2-digit', minute:'2-digit', hour12:true, month:'2-digit', day:'2-digit', weekday:'short' });
    function etParts(d){
      const f = fmtET.formatToParts(d);
      const get = t => (f.find(x => x.type===t) || {}).value || '';
      return { wd:get('weekday'), mo:get('month'), da:get('day'), hr:get('hour'), mi:get('minute'), ampm:get('dayPeriod') };
    }
    function fmtDateLabel(dET){ const p = etParts(dET); return `${p.wd} ${p.mo}/${p.da}`; }
    function fmtUpdated(dET){ const p = etParts(dET); return `Updated ${p.hr}:${p.mi} ${p.ampm} ET`; }

    // Team logo path (restore original pattern if different)
    function logoURL(abbr){ return `/static/logos/${abbr}.svg`; }  /* change path if your originals differ */

    // Helpers
    function topBottom(isTop){ if(isTop === true) return 'Top'; if(isTop === false) return 'Bottom'; return ''; }
    function chipHTML(g){
      const cls = g.status==='in_progress' ? 'chip live' : (g.status==='final' ? 'chip final' : 'chip upcoming');
      const txt = g.chip || (g.status==='scheduled' ? 'Scheduled' : (g.status==='final' ? 'Final' : 'Live'));
      return `<span class="${cls}">${txt}</span>`;
    }
    function diamondHTML(b){
      const f = b?.first, s = b?.second, t = b?.third;
      return `<span class="diamond" aria-label="Bases">
        <span class="base b2 ${s?'on':''}"></span>
        <span class="base b1 ${f?'on':''}"></span>
        <span class="base b3 ${t?'on':''}"></span>
      </span>`;
    }

    // Build the header row with logos, scores, chips, bases, records, probables
    function teamsHeader(g){
      const a = g.teams.away, h = g.teams.home;
      const showScores = (a.score != null) || (h.score != null);
      const inningChip = (g.status==='in_progress' && !g.inBreak) ? `<span class="chip">${topBottom(g.isTop)} ${g.inning ?? ''}</span>` : '';
      const probAway = a.probable ? `<div class="sub">Prob: ${a.probable}</div>` : '';
      const probHome = h.probable ? `<div class="sub">Prob: ${h.probable}</div>` : '';
      return `
        <div class="row">
          <div class="teams">
            <img class="logo" src="${logoURL(a.abbr)}" alt="${a.abbr} logo" />
            <div class="team">
              <div class="meta">
                <div class="name">${a.abbr || a.name}</div>
                <div class="sub">${a.record || ''}</div>
                ${g.status==='scheduled' ? probAway : ''}
              </div>
            </div>
            <div class="score">${showScores ? (a.score ?? '') : ''}</div>

            <div class="chips">${chipHTML(g)}${inningChip}${diamondHTML(g.bases)}</div>

            <div class="score">${showScores ? (h.score ?? '') : ''}</div>
            <div class="team" style="justify-self:end; text-align:right">
              <div class="meta" style="align-items:flex-end">
                <div class="name">${h.abbr || h.name}</div>
                <div class="sub">${h.record || ''}</div>
                ${g.status==='scheduled' ? probHome : ''}
              </div>
            </div>
            <img class="logo" src="${logoURL(h.abbr)}" alt="${h.abbr} logo" />
          </div>
        </div>`;
    }

    // Last Play + Statcast (exact)
    function lastPlayBlock(g){
      if(!g.lastPlay && !g.statcast) return '';
      const lp = g.lastPlay ? `<strong>Last Play:</strong> ${g.lastPlay}` : '';
      const sc = g.statcast ? ` <span class="muted">• ${g.statcast}</span>` : '';
      return `<div class="sec">${lp}${sc}</div>`;
    }

    // Find live batter/pitcher quick stats from the mini box tables
    function findPitcherStats(name, teamRows){
      if(!name || !Array.isArray(teamRows)) return null;
      const row = teamRows.find(r => (r.name||'').toLowerCase() === name.toLowerCase());
      if(!row) return null;
      return { ERA: row.ERA, SO: row.SO, BB: row.BB, IP: row.IP, R: row.R, H: row.H, ER: row.ER };
    }
    function findBatterStats(name, teamRows){
      if(!name || !Array.isArray(teamRows)) return null;
      const row = teamRows.find(r => (r.name||'').toLowerCase() === name.toLowerCase());
      if(!row) return null;
      return { AB: row.AB, H: row.H, BB: row.BB, SO: row.SO, RBI: row.RBI, AVG: row.AVG };
    }

    // Live context: show current pitcher/batter with mini stat line
    function livePBBlock(g){
      if(g.status!=='in_progress') return '';
      const a = g.teams.away, h = g.teams.home;
      const aPitch = (g.pitchers && g.pitchers.away) || [];
      const hPitch = (g.pitchers && g.pitchers.home) || [];
      const aBat = (g.batters && g.batters.away) || [];
      const hBat = (g.batters && g.batters.home) || [];

      const hp = h.currentPitcher ? findPitcherStats(h.currentPitcher, hPitch) : null;
      const ap = a.currentPitcher ? findPitcherStats(a.currentPitcher, aPitch) : null;
      const hb = h.currentBatter ? findBatterStats(h.currentBatter, hBat) : null;
      const ab = a.currentBatter ? findBatterStats(a.currentBatter, aBat) : null;

      const left = g.dueUp ? `<div class="muted">Due up: ${g.dueUp}</div>` : '';
      const rows = [];
      if(h.currentPitcher){
        const t = hp ? ` — ${hp.IP||'-'} IP, ${hp.H||0} H, ${hp.R||0} R, ${hp.SO||0} K, ERA ${hp.ERA||'-'}` : '';
        rows.push(`<div><strong>Home P:</strong> ${h.currentPitcher}${t}</div>`);
      }
      if(a.currentPitcher){
        const t = ap ? ` — ${ap.IP||'-'} IP, ${ap.H||0} H, ${ap.R||0} R, ${ap.SO||0} K, ERA ${ap.ERA||'-'}` : '';
        rows.push(`<div><strong>Away P:</strong> ${a.currentPitcher}${t}</div>`);
      }
      if(h.currentBatter){
        const t = hb ? ` — ${hb.AB||0} AB, ${hb.H||0} H, ${hb.RBI||0} RBI, ${hb.SO||0} K, AVG ${hb.AVG||'-'}` : '';
        rows.push(`<div><strong>Home B:</strong> ${h.currentBatter}${t}</div>`);
      }
      if(a.currentBatter){
        const t = ab ? ` — ${ab.AB||0} AB, ${ab.H||0} H, ${ab.RBI||0} RBI, ${ab.SO||0} K, AVG ${ab.AVG||'-'}` : '';
        rows.push(`<div><strong>Away B:</strong> ${a.currentBatter}${t}</div>`);
      }
      if(!rows.length && !left) return '';
      return `<div class="sec">${left}${rows.join('')}</div>`;
    }

    /* Linescore + mini box score dropdowns */
    function makeLinescore(ls){
      if(!ls || !ls.innings) return '';
      const head = ls.innings.map(i=>`<th>${i.num}</th>`).join('');
      const away = ls.innings.map(i=>`<td>${i.away ?? ''}</td>`).join('');
      const home = ls.innings.map(i=>`<td>${i.home ?? ''}</td>`).join('');
      const aT = ls.totals?.away || {}, hT = ls.totals?.home || {};
      return `
        <table>
          <thead><tr><th></th>${head}<th>R</th><th>H</th><th>E</th></tr></thead>
          <tbody>
            <tr><th>Away</th>${away}<td>${aT.runs ?? ''}</td><td>${aT.hits ?? ''}</td><td>${aT.errors ?? ''}</td></tr>
            <tr><th>Home</th>${home}<td>${hT.runs ?? ''}</td><td>${hT.hits ?? ''}</td><td>${hT.errors ?? ''}</td></tr>
          </tbody>
        </table>`;
    }

    function battersTable(rows){
      if(!rows || !rows.length) return '<div class="muted">No batting data</div>';
      const head = '<thead><tr><th>Player</th><th>AB</th><th>H</th><th>BB</th><th>SO</th><th>RBI</th><th>AVG</th></tr></thead>';
      const body = rows.map(r=>`<tr><td>${r.name||''}</td><td>${r.AB??''}</td><td>${r.H??''}</td><td>${r.BB??''}</td><td>${r.SO??''}</td><td>${r.RBI??''}</td><td>${r.AVG??''}</td></tr>`).join('');
      return `<table>${head}<tbody>${body}</tbody></table>`;
    }
    function pitchersTable(rows){
      if(!rows || !rows.length) return '<div class="muted">No pitching data</div>';
      const head = '<thead><tr><th>Pitcher</th><th>IP</th><th>H</th><th>R</th><th>ER</th><th>BB</th><th>SO</th><th>ERA</th></tr></thead>';
      const body = rows.map(r=>`<tr><td>${r.name||''}</td><td>${r.IP??''}</td><td>${r.H??''}</td><td>${r.R??''}</td><td>${r.ER??''}</td><td>${r.BB??''}</td><td>${r.SO??''}</td><td>${r.ERA??''}</td></tr>`).join('');
      return `<table>${head}<tbody>${body}</tbody></table>`;
    }

    function dropdowns(g){
      const showLS = !!g.linescore;
      const showBox = g.batters || g.pitchers;
      const aB = (g.batters && g.batters.away) || [];
      const hB = (g.batters && g.batters.home) || [];
      const aP = (g.pitchers && g.pitchers.away) || [];
      const hP = (g.pitchers && g.pitchers.home) || [];
      let html = '';
      if(showLS){
        html += `<details><summary>Box score</summary>${makeLinescore(g.linescore)}</details>`;
      }
      if(showBox){
        html += `<details><summary>Lineups</summary>
          <div class="grid-2">
            <div>
              <h3>Batting — Away</h3>${battersTable(aB)}
              <h3>Pitching — Away</h3>${pitchersTable(aP)}
            </div>
            <div>
              <h3>Batting — Home</h3>${battersTable(hB)}
              <h3>Pitching — Home</h3>${pitchersTable(hP)}
            </div>
          </div>
        </details>`;
      }
      return html;
    }

    function cardHTML(g){
      return `
        <article class="card">
          ${teamsHeader(g)}
          ${lastPlayBlock(g)}
          ${g.status==='in_progress' ? livePBBlock(g) : ''} <!-- Win Prob removed for non-live -->
          ${dropdowns(g)}
        </article>`;
    }

    // Data flow
    let state = { date: new Date(), timer: null, liveOnly: false };

    function setDate(d){
      state.date = d;
      const etDate = new Date(d.toLocaleString('en-US', { timeZone: 'America/New_York' }));
      $dateLabel.textContent = fmtDateLabel(etDate);
      load();
    }

    function shiftDays(n){
      const d = new Date(state.date);
      d.setDate(d.getDate() + n);
      setDate(d);
    }

    async function fetchJson(url){
      const r = await fetch(url, { cache:'no-store' });
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }

    function render(data){
      let games = data.games || [];
      if (state.liveOnly) games = games.filter(g => g.status === 'in_progress');
      $empty.style.display = games.length ? 'none' : 'block';
      $games.innerHTML = games.map(cardHTML).join('');
      $updated.textContent = fmtUpdated(new Date());
      // Auto-refresh if any live
      const anyLive = games.some(g => g.status === 'in_progress');
      clearTimeout(state.timer);
      if (anyLive) state.timer = setTimeout(load, 30000);
    }

    async function load(){
      try{
        const iso = state.date.toISOString().slice(0,10);
        const data = await fetchJson('/api/games?date='+iso);
        render(data);
      }catch(e){
        console.error(e);
        $games.innerHTML = '<div class="empty">Error loading games. If this persists, check your server logs for the /api/games endpoint.</div>';
      }
    }

    // Controls
    $prev.addEventListener('click', ()=>shiftDays(-1));
    $next.addEventListener('click', ()=>shiftDays(1));
    $today.addEventListener('click', ()=>setDate(new Date()));
    $liveOnly.addEventListener('change', (e)=>{ state.liveOnly = e.target.checked; load(); });

    // Init
    setDate(new Date());
  </script>
</body>
</html>
