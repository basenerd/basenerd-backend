<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Today's Games</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/static/styles.css">
</head>
<body>
<div id="games-container"></div>

<script>
const API_GAMES = "/api/games";

// Helper: format ET date string
function dateStrET(d) {
  const dt = new Date(d);
  return dt.toLocaleDateString("en-CA", { timeZone: "America/New_York" });
}

// NEW: MLB API fallback
async function fetchMlbSchedule(etDate) {
  const mlbUrl = `https://statsapi.mlb.com/api/v1/schedule?sportId=1&date=${etDate}&hydrate=team,linescore,probablePitcher`;
  const r = await fetch(mlbUrl, { cache: "no-store" });
  if (!r.ok) throw new Error("MLB schedule fetch failed");
  const raw = await r.json();
  const games = [];
  const dates = raw.dates || [];
  for (const d of dates) {
    for (const g of (d.games || [])) {
      const detailed = (g.status || {}).detailedState || "";
      const abs = (g.status || {}).abstractGameState || "";
      const status = (abs || "").toLowerCase() || "scheduled";
      const chip = status === "scheduled"
        ? (g.gameDate ? new Date(g.gameDate).toLocaleTimeString("en-US", {hour:"numeric", minute:"2-digit", timeZone:"America/New_York"}) + " ET" : detailed)
        : detailed;
      games.push({
        gamePk: g.gamePk,
        status,
        chip,
        venue: g.venue?.name || "",
        teams: {
          away: {
            abbr: g.teams?.away?.team?.abbreviation || "",
            score: g.teams?.away?.score ?? null,
            id: g.teams?.away?.team?.id || null
          },
          home: {
            abbr: g.teams?.home?.team?.abbreviation || "",
            score: g.teams?.home?.score ?? null,
            id: g.teams?.home?.team?.id || null
          }
        },
        bases: { first:false, second:false, third:false },
        inBreak: false,
        inning: null,
        isTop: null,
        lastPlay: "",
        statcast: "",
        linescore: (function(ls){
          if (!ls) return null;
          try {
            const innings = ls.innings || [];
            const n = Math.max(9, innings.length);
            const away = Array.from({length:n}, (_,i)=> (innings[i] && innings[i].away && innings[i].away.runs) ?? "");
            const home = Array.from({length:n}, (_,i)=> (innings[i] && innings[i].home && innings[i].home.runs) ?? "");
            const totals = {
              away: { R: ls.teams?.away?.runs, H: ls.teams?.away?.hits, E: ls.teams?.away?.errors },
              home: { R: ls.teams?.home?.runs, H: ls.teams?.home?.hits, E: ls.teams?.home?.errors },
            };
            return { n, away, home, totals };
          } catch(_) { return null; }
        })(g.linescore || null),
        batters: { away: [], home: [] },
        pitchers: { away: [], home: [] },
        scoring: [],
        lineups: { away: [], home: [] }
      });
    }
  }
  console.info("[fallback] MLB schedule used for", etDate, "games:", games.length);
  return { date: etDate, games };
}

async function fetchJson(url) {
  const r = await fetch(url, { cache: "no-store" });
  if (!r.ok) throw new Error("Network error");
  return await r.json();
}

async function load() {
  const et = dateStrET(new Date());
  let data = await fetchJson(API_GAMES + '?date=' + et);
  if (!data || !Array.isArray(data.games) || data.games.length === 0) {
    try {
      data = await fetchMlbSchedule(et);
    } catch (err) {
      console.warn("Fallback MLB API fetch failed", err);
    }
  }
  render(data);
}

function render(data) {
  const container = document.getElementById("games-container");
  container.innerHTML = "";
  if (!data || !data.games || data.games.length === 0) {
    container.innerHTML = "<p>No games to show for this date.</p>";
    return;
  }
  for (const g of data.games) {
    const div = document.createElement("div");
    div.className = "game-card";
    div.innerHTML = `
      <h3>${g.teams.away.abbr} @ ${g.teams.home.abbr}</h3>
      <p>${g.venue} â€” ${g.chip}</p>
      <p>${g.status}</p>
    `;
    container.appendChild(div);
  }
}

document.addEventListener("DOMContentLoaded", load);
</script>
</body>
</html>
