
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Today's Games • Basenerd</title>
  <style>
    :root{
      --bg:#ffffff; --card:#ffffff; --muted:#5b6577; --text:#111318; --accent:#0b5cab;
      --row:#fafbfc; --rowAlt:#f4f6f9; --border:#e2e8f0;
      --chip-live:#e21d48; --chip-final:#32425c; --chip-upcoming:#6b7a94;
      --subtle:#8a94ab;
    }
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial; font-size:14px; }
    header{ display:flex; align-items:center; gap:10px; padding:12px 16px; border-bottom:1px solid var(--border); position:sticky; top:0; z-index:10; background:var(--card); }
    header h1{margin:0; font-size:18px; letter-spacing:.2px; font-weight:600}
    .toolbar{ display:flex; gap:8px; align-items:center; margin-left:auto; }
    input[type="date"]{ padding:6px 8px; border:1px solid var(--border); border-radius:8px; }
    main{ max-width:1100px; margin:24px auto; padding:0 16px; display:grid; gap:12px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:0 6px 18px rgba(0,0,0,.04); }
    .row{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .teams{ display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:8px; }
    .team{ display:flex; flex-direction:column; gap:2px; }
    .team .name{ font-weight:600; }
    .team .sub{ color:var(--muted); font-size:12px; }
    .chip{ font-size:12px; padding:4px 8px; border-radius:999px; background:#eef1f6; color:#243042; }
    .chip.live{ background:#fde4ea; color:#7d0a23 }
    .chip.final{ background:#e6ebf2; color:#1f2d44 }
    .chip.upcoming{ background:#eef0f3; color:#3a465a }
    details{ margin-top:8px; border-top:1px dashed var(--border); padding-top:8px; }
    .section{ margin-top:8px; }
    .muted{ color:var(--muted); }
    .empty{ padding:20px; text-align:center; color:var(--muted); border:1px dashed var(--border); border-radius:12px; }
    table{ width:100%; border-collapse:collapse; margin-top:8px; font-size:13px; }
    th, td{ border:1px solid var(--border); padding:6px 8px; text-align:left; }
    th{ background:#f7f9fc; }
  </style>
</head>
<body>
  <header>
    <h1>Today's Games</h1>
    <div class="toolbar">
      <input id="date" type="date">
    </div>
  </header>
  <main id="games"></main>

  <script>
    const $date = document.getElementById('date');
    const $games = document.getElementById('games');

    function fmtChip(g){
      const s = g.status;
      const cls = s==='in_progress' ? 'chip live' : (s==='final' ? 'chip final' : 'chip upcoming');
      const text = g.chip || (s==='scheduled' ? 'Scheduled' : s==='in_progress' ? 'Live' : 'Final');
      return `<span class="${cls}">${text}</span>`;
    }

    function makeLinescore(ls){
      if(!ls || !ls.innings) return '';
      const head = ls.innings.map(i=>`<th>${i.num}</th>`).join('');
      const away = ls.innings.map(i=>`<td>${i.away ?? ''}</td>`).join('');
      const home = ls.innings.map(i=>`<td>${i.home ?? ''}</td>`).join('');
      return `
        <table>
          <thead><tr><th></th>${head}<th>R</th><th>H</th><th>E</th></tr></thead>
          <tbody>
            <tr><th>Away</th>${away}<td>${ls.totals.away.runs ?? ''}</td><td>${ls.totals.away.hits ?? ''}</td><td>${ls.totals.away.errors ?? ''}</td></tr>
            <tr><th>Home</th>${home}<td>${ls.totals.home.runs ?? ''}</td><td>${ls.totals.home.hits ?? ''}</td><td>${ls.totals.home.errors ?? ''}</td></tr>
          </tbody>
        </table>`;
    }

    function tableBatters(arr){
      if(!arr || !arr.length) return '<div class="muted">No batting data</div>';
      const head = '<tr><th>Name</th><th>AB</th><th>H</th><th>BB</th><th>SO</th><th>RBI</th><th>AVG</th></tr>';
      const rows = arr.map(r=>`<tr><td>${r.name||''}</td><td>${r.AB??''}</td><td>${r.H??''}</td><td>${r.BB??''}</td><td>${r.SO??''}</td><td>${r.RBI??''}</td><td>${r.AVG??''}</td></tr>`).join('');
      return `<table><thead>${head}</thead><tbody>${rows}</tbody></table>`;
    }

    function tablePitchers(arr){
      if(!arr || !arr.length) return '<div class="muted">No pitching data</div>';
      const head = '<tr><th>Name</th><th>IP</th><th>H</th><th>R</th><th>ER</th><th>BB</th><th>SO</th><th>ERA</th></tr>';
      const rows = arr.map(r=>`<tr><td>${r.name||''}</td><td>${r.IP??''}</td><td>${r.H??''}</td><td>${r.R??''}</td><td>${r.ER??''}</td><td>${r.BB??''}</td><td>${r.SO??''}</td><td>${r.ERA??''}</td></tr>`).join('');
      return `<table><thead>${head}</thead><tbody>${rows}</tbody></table>`;
    }

    async function loadGames(d){
      try{
        const qs = d ? ('?date='+encodeURIComponent(d)) : '';
        const res = await fetch('/api/games'+qs, {cache:'no-store'});
        if(!res.ok){
          throw new Error('HTTP '+res.status);
        }
        const data = await res.json();
        const games = data.games || [];
        if(!games.length){
          $games.innerHTML = '<div class="empty">No games for this date.</div>';
          return;
        }
        $games.innerHTML = games.map(g=>{
          const home = g.teams.home, away = g.teams.away;
          const last = g.lastPlay ? `<div class="section"><strong>Last Play:</strong> ${g.lastPlay}${g.statcast? ' • <span class="muted">'+g.statcast+'</span>':''}</div>` : '';
          const ctx = (g.dueUp || home.currentPitcher || away.currentPitcher) ? 
            `<div class="section muted">
              ${g.dueUp ? 'Due up: '+g.dueUp : ''}
              ${home.currentPitcher ? ' • HP: '+home.currentPitcher : ''}
              ${away.currentPitcher ? ' • AP: '+away.currentPitcher : ''}
            </div>` : '';
          const dropdown = (g.linescore || (g.batters && (g.batters.home.length||g.batters.away.length)) || (g.pitchers && (g.pitchers.home.length||g.pitchers.away.length))) ?
            `<details><summary>Box score &amp; linescore</summary>
              ${makeLinescore(g.linescore)}
              <h4>Batting — Away</h4>${tableBatters((g.batters && g.batters.away)||[])}
              <h4>Batting — Home</h4>${tableBatters((g.batters && g.batters.home)||[])}
              <h4>Pitching — Away</h4>${tablePitchers((g.pitchers && g.pitchers.away)||[])}
              <h4>Pitching — Home</h4>${tablePitchers((g.pitchers && g.pitchers.home)||[])}
            </details>` : '';
          return `
            <article class="card">
              <div class="row">
                <div class="teams">
                  <div class="team"><div class="name">${away.abbr||away.name}</div><div class="sub">${away.record||''}</div></div>
                  <div>${fmtChip(g)}</div>
                  <div class="team" style="text-align:right"><div class="name">${home.abbr||home.name}</div><div class="sub">${home.record||''}</div></div>
                </div>
              </div>
              ${last}
              ${ctx}
              ${dropdown}
            </article>`;
        }).join('');
      }catch(e){
        console.error(e);
        $games.innerHTML = '<div class="empty">Error loading games. If this persists, check your server logs for the /api/games endpoint.</div>';
      }
    }

    function setDate(dt){
      const iso = dt.toISOString().slice(0,10);
      $date.value = iso;
      loadGames(iso);
    }

    $date.addEventListener('change', (e)=>loadGames(e.target.value));
    setDate(new Date());
  </script>
</body>
</html>
